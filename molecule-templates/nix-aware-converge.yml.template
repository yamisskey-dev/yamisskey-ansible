---
# Nix-only Molecule converge template
# This template requires Nix environment and does not fall back to system package managers
- name: Converge {{role_name}} role
  hosts: all
  become: true
  gather_facts: true
  
  pre_tasks:
    - name: Check if running in Nix environment
      shell: command -v nix >/dev/null 2>&1
      register: nix_available
      failed_when: false
      changed_when: false
      tags:
        - always

    - name: Ensure Nix environment for testing
      fail:
        msg: |
          âŒ Molecule tests now require Nix environment!
          
          ğŸ“‹ All packages are managed via Nix Flake:
          - Docker: Available via Nix
          - Python packages: Available via Nix
          - Role-specific packages: Managed by Home Manager
          
          ğŸš€ Run tests in nix develop environment:
          1. nix develop
          2. yamisskey-provision test {{role_name}}
      when: nix_available.rc != 0
      tags:
        - always

    - name: Display Nix-based test environment status
      debug:
        msg: |
          âœ… Nix-based Test Environment ({{role_name}}):
          ğŸ“¦ All packages provided by Nix Flake
          ğŸ§ª Ready for infrastructure testing!
      tags:
        - always

    - name: Verify essential tools are available
      command: "{{ item }}"
      register: tool_check
      failed_when: false
      changed_when: false
      loop:
        - "docker --version"
        - "python3 --version"
        - "nix --version"
      tags:
        - verification

    - name: Display tool versions
      debug:
        msg: |
          ğŸ”§ Available tools (Nix-managed):
          {% for result in tool_check.results %}
          - {{ result.cmd[0] }}: {{ result.stdout if result.rc == 0 else 'not available' }}
          {% endfor %}
      tags:
        - verification
        
    - name: Create test directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/test

  tasks:
    - name: Apply {{role_name}} role
      include_role:
        name: yamisskey.servers.{{role_name}}
      vars:
        # Role-specific test variables should be added here
        ansible_user: "root"
        test_mode: true
        
    - name: Basic role verification
      debug:
        msg: "{{role_name}} role applied successfully in Nix environment"

  post_tasks:
    - name: Show test environment status
      shell: echo "Nix-based test environment completed for {{role_name}}"
      register: test_status
      changed_when: false
      
    - name: Display test status
      debug:
        var: test_status.stdout