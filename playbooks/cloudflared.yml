---
# Cloudflared automation playbook
# Unified playbook using the enhanced cloudflared role

- name: Setup Cloudflared with full automation
  hosts: all
  become: false
  gather_facts: true
  # Cloudflare API credentials are loaded from group_vars/all/secrets.yml
  # Override default settings if needed:
  # vars:
  #   cloudflared_skip_install: false  # Set to false to enable automatic installation
  #   cloudflared_app_name: "custom-app"  # Override default "yaminio"
  #   cloudflared_hostname: "custom.yami.ski"  # Override default hostname

  roles:
    - yamisskey.servers.cloudflared

  tags:
    - cloudflared
    - tunnel
    - automation

  post_tasks:
    - name: Display completion status
      debug:
        msg: |
          =============================================================
          ğŸ‰ CLOUDFLARED SETUP COMPLETED
          =============================================================

          {% if tunnel_uuid is defined %}
          âœ… Full automation mode: All tasks completed successfully
          âœ… Tunnel: {{ cloudflared_tunnel_name }} ({{ tunnel_uuid }})
          âœ… DNS: {{ cloudflared_hostname }} configured
          âœ… Service: Running and enabled

          ğŸ”— Test URL: https://{{ cloudflared_hostname }}

          {% else %}
          âš ï¸  Manual mode: Configuration deployed, manual steps required

          ğŸ“‹ Next steps:
          2. Complete tunnel setup as shown in role output

          {% endif %}
          =============================================================
