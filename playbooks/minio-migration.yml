---
- name: MinIO Migration - Unified Role with Tag-based Control
  hosts: all
  become: true
  gather_facts: true

  vars:
    # Migration source and target configuration
    minio_source_host: "{{ migrate_source | default('raspberrypi') }}"
    minio_target_host: "{{ migrate_target | default('balthasar') }}"

    # Default bucket configuration
    bucket_name_misskey: "{{ minio_bucket_name_for_misskey | default('files') }}"
    bucket_name_outline: "{{ minio_bucket_name_for_outline | default('assets') }}"

    # Migration buckets
    buckets_to_migrate:
      - "{{ bucket_name_misskey }}"
      - "{{ bucket_name_outline }}"

  pre_tasks:
    - name: Display migration overview
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    MinIO Migration                         â•‘
          â•‘                   Unified Role v1.0                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ”„ Migration Configuration:
          â”œâ”€ Source: {{ minio_source_host }}
          â”œâ”€ Target: {{ minio_target_host }}
          â”œâ”€ Buckets: {{ buckets_to_migrate | join(', ') }}
          â””â”€ Mode: {{ ansible_run_tags | default(['all']) | join(', ') }}

          ğŸ·ï¸  Available execution tags:
          â”œâ”€ setup: MinIO CLI installation and configuration
          â”œâ”€ validate: Pre-migration validation
          â”œâ”€ migrate: Data migration execution
          â”œâ”€ verify: Post-migration verification
          â”œâ”€ cleanup: Temporary files cleanup
          â””â”€ all: Execute all phases

          ğŸ’¡ Example usage:
          ansible-playbook minio-migration.yml --tags setup,validate

          ğŸ”„ For raspberrypiâ†’balthasar migration:
          ansible-playbook -i deploy/servers/inventory deploy/servers/playbooks/minio-migration.yml \
            -e "migrate_source=raspberrypi migrate_target=balthasar" \
            --limit balthasar --ask-become-pass
      tags: ['always']

    - name: Validate required variables
      assert:
        that:
          - migrate_source is defined and migrate_source != ""
          - migrate_target is defined and migrate_target != ""
          - migrate_source != migrate_target or migrate_source == inventory_hostname
        fail_msg: |
          âŒ Required migration variables missing or invalid:
          - migrate_source: {{ migrate_source | default('UNDEFINED') }}
          - migrate_target: {{ migrate_target | default('UNDEFINED') }}

          Please provide: -e "migrate_source=SOURCE_HOST migrate_target=TARGET_HOST"
      tags: ['always']

  roles:
    - role: yamihost.servers.minio_migration
      vars:
        # Pass through migration configuration
        source_minio_host: "{{ minio_source_host }}"
        target_minio_host: "{{ minio_target_host }}"

        # Bucket configuration - use different variable name to avoid recursion
        migration_buckets: "{{ buckets_to_migrate }}"

        # Enable all features by default
        enable_encryption: true
        generate_validation_report: true
        generate_migration_report: true

        # Safety settings
        require_confirmation: false  # Skip confirmation in automated runs
        backup_before_migration: true
        verify_after_migration: true

  post_tasks:
    - name: Display migration completion summary
      debug:
        msg: |
          âœ… MinIO Migration Process Completed
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“Š Migration Summary:
          â”œâ”€ Source: {{ minio_source_host }}
          â”œâ”€ Target: {{ minio_target_host }}
          â”œâ”€ Buckets: {{ buckets_to_migrate | join(', ') }}
          â”œâ”€ Executed Tags: {{ ansible_run_tags | default(['all']) | join(', ') }}
          â””â”€ Status: âœ… Completed

          ğŸ“ Next Steps:
          {% if 'migrate' in (ansible_run_tags | default(['all'])) %}
          â”œâ”€ Update application configurations with new MinIO endpoint
          â”œâ”€ Test file upload/download functionality
          â”œâ”€ Verify federation image display
          â”œâ”€ Update DNS records if needed
          â””â”€ Consider stopping source MinIO after thorough testing
          {% else %}
          â”œâ”€ Execute remaining phases as needed
          â””â”€ Run full migration: --tags all
          {% endif %}

          ğŸ¯ Phase-specific execution examples:
          â”œâ”€ ansible-playbook minio-migration.yml --tags setup
          â”œâ”€ ansible-playbook minio-migration.yml --tags validate
          â”œâ”€ ansible-playbook minio-migration.yml --tags migrate
          â”œâ”€ ansible-playbook minio-migration.yml --tags verify
          â””â”€ ansible-playbook minio-migration.yml --tags cleanup
      tags: ['always']

    - name: Display troubleshooting information
      debug:
        msg: |
          ğŸ”§ Troubleshooting:
          â”œâ”€ Logs: /tmp/minio-migration/migration.log
          â”œâ”€ Reports: /tmp/minio-migration/*_report_*.md
          â”œâ”€ Debug mode: -e "debug_mode=true"
          â””â”€ Verbose: -v or -vv

          ğŸ“ Support:
          â”œâ”€ Issues: https://github.com/yamisskey-dev/yamisskey-provision/issues
          â””â”€ Docs: README.md in minio_migration role
      when: ansible_run_tags is undefined or 'all' in ansible_run_tags
      tags: ['always']
