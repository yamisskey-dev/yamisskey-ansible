version: '3'

# yamisskey-provision: Modern Infrastructure Management with Task + direnv + Go
# Install: go install github.com/go-task/task/v3/cmd/task@latest

env:
  # Paths
  REPO_ROOT: '{{.USER_WORKING_DIR}}'
  SHIM_DIR: '{{.USER_WORKING_DIR}}/.bin'
  GALAXY_DIR: '{{.USER_WORKING_DIR}}/.vendor/collections'
  LOG_DIR: '{{.USER_WORKING_DIR}}/logs'
  BACKUP_DIR: '{{.USER_WORKING_DIR}}/backups'

  # Ansible configuration
  ANSIBLE_COLLECTIONS_PATH: '{{.GALAXY_DIR}}:{{.REPO_ROOT}}:{{.HOME}}/.ansible/collections'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  ANSIBLE_CACHE_PLUGIN: 'memory'
  ANSIBLE_FORCE_HANDLERS: 'true'

  # SOPS/Age configuration
  SOPS_AGE_KEY_FILE: '{{.HOME}}/.sops/key.txt'

  # UV configuration
  UV_PY: '3.11'

vars:
  # Configuration variables
  COLLECTION_NS: 'yamisskey'
  TARGET: '{{.TARGET | default "servers"}}'
  DEPLOY_DIR: 'deploy/{{.TARGET}}'
  INV: '{{.DEPLOY_DIR}}/inventory'
  PLAY: '{{.DEPLOY_DIR}}/playbooks'
  CONFIG: '{{.DEPLOY_DIR}}/ansible.cfg'
  COLLECTION_NAME_servers: '{{.COLLECTION_NS}}.servers'
  COLLECTION_NAME_appliances: '{{.COLLECTION_NS}}.appliances'
  SOPS_GROUP_FILE_servers: 'deploy/servers/group_vars/all/secrets.yml'
  SOPS_GROUP_FILE_appliances: 'deploy/appliances/group_vars/all/secrets.yml'
  TIMESTAMP: '{{now | date "20060102T150405"}}'
  ANSIBLE_CORE_SPEC: '{{.ANSIBLE_CORE_VERSION | default "ansible-core"}}'

tasks:
  default:
    desc: Show available tasks and help
    cmds:
      - task: help

  # === Setup & Installation ===
  install:
    desc: "Install modern toolchain (uv tools + Go-based SOPS/Age)"
    cmds:
      - |
        echo "üì¶ Installing Ansible toolchain via uv tools..."

        # Install uv if not present
        if ! command -v uv >/dev/null; then
          echo "üì• Installing uv..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
        fi

        # Install Ansible tools via uv tool install
        echo "üîß Installing Ansible tools via uv tool install..."
        uv tool install --python {{.UV_PY}} ansible-lint
        uv tool install --python {{.UV_PY}} pre-commit

        echo "üîß Creating repo-local shims in {{.SHIM_DIR}}..."
        mkdir -p "{{.SHIM_DIR}}"

        # Create Ansible shims using uvx
        cat > "{{.SHIM_DIR}}/ansible" << 'EOF'
        #!/bin/sh
        exec uvx --python {{.UV_PY}} --from "{{.ANSIBLE_CORE_SPEC}}" ansible "$@"
        EOF
        chmod +x "{{.SHIM_DIR}}/ansible"

        cat > "{{.SHIM_DIR}}/ansible-playbook" << 'EOF'
        #!/bin/sh
        exec uvx --python {{.UV_PY}} --from "{{.ANSIBLE_CORE_SPEC}}" ansible-playbook "$@"
        EOF
        chmod +x "{{.SHIM_DIR}}/ansible-playbook"

        cat > "{{.SHIM_DIR}}/ansible-galaxy" << 'EOF'
        #!/bin/sh
        exec uvx --python {{.UV_PY}} --from "{{.ANSIBLE_CORE_SPEC}}" ansible-galaxy "$@"
        EOF
        chmod +x "{{.SHIM_DIR}}/ansible-galaxy"

        cat > "{{.SHIM_DIR}}/pre-commit" << 'EOF'
        #!/bin/sh
        exec uvx --python {{.UV_PY}} --from pre-commit pre-commit "$@"
        EOF
        chmod +x "{{.SHIM_DIR}}/pre-commit"

        echo "üîê Installing SOPS and Age via Go..."
        if ! command -v go >/dev/null 2>&1; then
          echo "‚ùå Go is required for SOPS and Age installation. Please install Go first."
          exit 1
        fi

        if ! command -v sops >/dev/null 2>&1; then
          echo "üì• Installing SOPS (latest version) via go install..."
          go install github.com/getsops/sops/v3/cmd/sops@latest
          echo "‚úÖ SOPS installed successfully"
        else
          echo "‚úÖ SOPS already installed: $(sops --version)"
        fi

        if ! command -v age >/dev/null 2>&1; then
          echo "üì• Installing Age (latest version) via go install..."
          go install filippo.io/age/cmd/age@latest
          go install filippo.io/age/cmd/age-keygen@latest
          echo "‚úÖ Age installed successfully"
        else
          echo "‚úÖ Age already installed: $(age --version)"
        fi

        echo "üåå Installing Galaxy collections to {{.GALAXY_DIR}}..."
        mkdir -p "{{.GALAXY_DIR}}" "{{.LOG_DIR}}" "{{.BACKUP_DIR}}"

        ANSIBLE_CONFIG="{{.REPO_ROOT}}/ansible.cfg" \
        ANSIBLE_GALAXY_CACHE_DIR="{{.REPO_ROOT}}/.vendor/.cache" \
        ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}" \
        "{{.SHIM_DIR}}/ansible-galaxy" collection install -p "{{.GALAXY_DIR}}" -r requirements-dev.yml

        echo "‚úÖ Ansible and Collections installed via uv tools"
        echo "üîç Verifying installation:"
        env -i PATH="{{.SHIM_DIR}}:/usr/bin:/bin:$HOME/.local/bin" ansible --version | head -n1 || true
        uvx --python {{.UV_PY}} --from ansible-lint ansible-lint --version || true
        uvx --python {{.UV_PY}} --from pre-commit pre-commit --version || true
        ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}" env -i PATH="{{.SHIM_DIR}}:/usr/bin:/bin:$HOME/.local/bin" ansible-galaxy collection list | grep yamisskey || true

        echo "üß™ Molecule runtime (uvx) check:"
        uvx --python {{.UV_PY}} --from molecule --with "molecule-plugins[docker]" molecule --version && echo "‚úÖ Molecule available via uvx" || echo "‚ö†Ô∏è Molecule check failed (ensure Docker is available)"

        echo "üîê SOPS/Age verification:"
        if command -v sops >/dev/null 2>&1 || [ -x "{{.SHIM_DIR}}/sops" ]; then echo "‚úÖ SOPS available"; else echo "‚ùå SOPS not found"; fi
        if command -v age >/dev/null 2>&1; then echo "‚úÖ Age available: $(age --version)"; else echo "‚ùå Age not found"; fi

  update:
    desc: "Update Galaxy collections to latest versions and clear caches"
    cmds:
      - |
        echo "üîÑ Updating Galaxy collections to latest versions..."
        echo "üßπ Clearing ansible caches and temporary files..."
        rm -rf "{{.REPO_ROOT}}/.vendor/.cache" || true
        rm -rf "{{.HOME}}/.ansible/collections" || true
        rm -rf "{{.HOME}}/.cache/ansible-compat" || true
        rm -rf "{{.REPO_ROOT}}/.ansible" || true
        mkdir -p "{{.REPO_ROOT}}/.vendor/.cache" "{{.GALAXY_DIR}}"

        echo "üåå Installing fresh Galaxy collections..."
        ANSIBLE_CONFIG="{{.REPO_ROOT}}/ansible.cfg" \
        ANSIBLE_GALAXY_CACHE_DIR="{{.REPO_ROOT}}/.vendor/.cache" \
        ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}" \
        "{{.SHIM_DIR}}/ansible-galaxy" collection install --force -p "{{.GALAXY_DIR}}" -r requirements-dev.yml

        echo "üîç Verifying updated collections:"
        ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}" env -i PATH="{{.SHIM_DIR}}:/usr/bin:/bin:$HOME/.local/bin" ansible-galaxy collection list | grep yamisskey || true
        echo "‚úÖ Galaxy collections updated successfully!"

  # === Core Functions ===
  run:
    desc: "Run playbook (Usage: task run PLAYBOOK=<name> [TARGET=servers|appliances] [LIMIT=<hosts>] [TAGS=<tags>])"
    cmds:
      - |
        if [ -z "{{.PLAYBOOK}}" ]; then
          echo "‚ùå Usage: task run PLAYBOOK=<name> [TARGET={{.TARGET}}] [LIMIT=<hosts>] [TAGS=<tags>]"
          exit 1
        fi
        if [ ! -f "{{.PLAY}}/{{.PLAYBOOK}}.yml" ]; then
          echo "‚ùå Playbook {{.PLAYBOOK}}.yml not found in {{.PLAY}}/"
          exit 1
        fi
        echo "üöÄ Running {{.COLLECTION_NS}}.{{.TARGET}}: {{.PLAYBOOK}}"
        export ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}"
        if [ -f "{{.CONFIG}}" ]; then export ANSIBLE_CONFIG="$(realpath {{.CONFIG}})"; fi
        export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
        "{{.SHIM_DIR}}/ansible-playbook" -i "{{.INV}}" "{{.PLAY}}/{{.PLAYBOOK}}.yml" \
          $([ -n "{{.LIMIT}}" ] && echo "--limit {{.LIMIT}}") \
          $([ -n "{{.TAGS}}" ] && echo "--tags {{.TAGS}}") \
          {{.CLI_ARGS}}

  check:
    desc: "Check playbook (dry-run with diff preview)"
    cmds:
      - |
        if [ -z "{{.PLAYBOOK}}" ]; then
          echo "‚ùå Usage: task check PLAYBOOK=<name> [TARGET={{.TARGET}}] [LIMIT=<hosts>]"
          exit 1
        fi
        if [ ! -f "{{.PLAY}}/{{.PLAYBOOK}}.yml" ]; then
          echo "‚ùå Playbook {{.PLAYBOOK}}.yml not found in {{.PLAY}}/"
          exit 1
        fi
        echo "üîç Checking {{.COLLECTION_NS}}.{{.TARGET}}: {{.PLAYBOOK}}"
        export ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}"
        if [ -f "{{.CONFIG}}" ]; then export ANSIBLE_CONFIG="$(realpath {{.CONFIG}})"; fi
        "{{.SHIM_DIR}}/ansible-playbook" -i "{{.INV}}" "{{.PLAY}}/{{.PLAYBOOK}}.yml" \
          $([ -n "{{.LIMIT}}" ] && echo "--limit {{.LIMIT}}") \
          --check --diff {{.CLI_ARGS}}

  secure:
    desc: "Secure execution with memory protection and authentication"
    cmds:
      - |
        if [ -z "{{.PLAYBOOK}}" ]; then
          echo "‚ùå Usage: task secure PLAYBOOK=<name> [TARGET={{.TARGET}}] [LIMIT=<hosts>]"
          exit 1
        fi
        if [ ! -f "{{.PLAY}}/{{.PLAYBOOK}}.yml" ]; then
          echo "‚ùå Playbook {{.PLAYBOOK}}.yml not found in {{.PLAY}}/"
          exit 1
        fi
        echo "üîí Secure execution: {{.COLLECTION_NS}}.{{.TARGET}}: {{.PLAYBOOK}}"
        ulimit -c 0
        export ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}"
        export ANSIBLE_CONFIG="$(realpath {{.CONFIG}})"
        export ANSIBLE_NO_LOG=true
        export ANSIBLE_FORCE_COLOR=false
        "{{.SHIM_DIR}}/ansible-playbook" -i "{{.INV}}" "{{.PLAY}}/{{.PLAYBOOK}}.yml" \
          $([ -n "{{.LIMIT}}" ] && echo "--limit {{.LIMIT}}") \
          $([ -n "{{.TAGS}}" ] && echo "--tags {{.TAGS}}") \
          --ask-become-pass {{.CLI_ARGS}}

  deploy:
    desc: "Deploy multiple playbooks sequentially"
    cmds:
      - |
        if [ -z "{{.PLAYBOOKS}}" ]; then
          echo "‚ùå Usage: task deploy PLAYBOOKS='<p1> <p2>' [TARGET={{.TARGET}}] [LIMIT=<hosts>]"
          exit 1
        fi
        echo "üöÄ Deploying {{.TARGET}}: {{.PLAYBOOKS}}"
        for pb in {{.PLAYBOOKS}}; do
          task run PLAYBOOK=$pb TARGET={{.TARGET}} $([ -n "{{.LIMIT}}" ] && echo "LIMIT={{.LIMIT}}") $([ -n "{{.TAGS}}" ] && echo "TAGS={{.TAGS}}") || exit 1
        done

  # === Inventory Management ===
  inventory:
    desc: "Create inventory from template (Usage: task inventory [TYPE=local] [TARGET=servers|appliances])"
    cmds:
      - |
        if [ "{{.TYPE}}" = "local" ]; then
          echo "üìã Creating self-provisioning inventory for current host..."
          INV_DIR="{{.INV}}"
          INV_PATH="$INV_DIR/hosts.yml"
          TEMPLATE_PATH="{{.DEPLOY_DIR}}/inventory.local.yaml.template"
          if [ ! -f "$TEMPLATE_PATH" ]; then echo "‚ùå Local template not found: $TEMPLATE_PATH"; exit 1; fi
          mkdir -p "$INV_DIR"
          if [ -f "$INV_PATH" ]; then
            echo "‚ö†Ô∏è Inventory already exists. Creating backup..."
            cp "$INV_PATH" "{{.BACKUP_DIR}}/{{.TARGET}}-inventory-local-{{.TIMESTAMP}}.bak"
          fi
          CURRENT_HOST=$(hostname)
          CURRENT_USER=$(whoami)
          HOST_IP=$(ip route get 1.1.1.1 | awk '{print $7; exit}' 2>/dev/null || hostname -i 2>/dev/null | awk '{print $1}' || echo "127.0.0.1")
          DOMAIN="${DOMAIN:-yami.ski}"
          NETWORK="${INTERNAL_NETWORK:-192.168.0.0/24}"
          HOST_ROLE="${HOST_ROLE:-monitor}"
          echo "üñ•Ô∏è Detected system information:"
          echo "   - Hostname: $CURRENT_HOST"
          echo "   - User: $CURRENT_USER"
          echo "   - IP: $HOST_IP"
          echo "   - Role: $HOST_ROLE"
          echo "   - Domain: $DOMAIN"
          echo "üìÑ Processing local template..."
          # Use sed for variable substitution (no envsubst dependency)
          sed -e "s|\${HOSTNAME}|$CURRENT_HOST|g" \
              -e "s|\${USER}|$CURRENT_USER|g" \
              -e "s|\${HOST_IP}|$HOST_IP|g" \
              -e "s|\${DOMAIN}|$DOMAIN|g" \
              -e "s|\${NETWORK}|$NETWORK|g" \
              -e "s|\${HOST_ROLE}|$HOST_ROLE|g" \
              "$TEMPLATE_PATH" > "$INV_PATH"
          # Create symlinks for host_vars and group_vars if they don't exist
          [ ! -e "$INV_DIR/host_vars" ] && ln -s ../host_vars "$INV_DIR/host_vars" 2>/dev/null || true
          [ ! -e "$INV_DIR/group_vars" ] && ln -s ../group_vars "$INV_DIR/group_vars" 2>/dev/null || true
          echo "‚úÖ Local inventory created at $INV_PATH"
        else
          echo "üìã Creating {{.TARGET}} inventory from template..."
          INV_DIR="{{.INV}}"
          INV_PATH="$INV_DIR/hosts.yml"
          TEMPLATE_PATH="{{.DEPLOY_DIR}}/inventory.yaml.template"
          if [ ! -f "$TEMPLATE_PATH" ]; then echo "‚ùå Template not found: $TEMPLATE_PATH"; exit 1; fi
          mkdir -p "$INV_DIR"
          if [ -f "$INV_PATH" ]; then
            echo "‚ö†Ô∏è Inventory already exists. Creating backup..."
            cp "$INV_PATH" "{{.BACKUP_DIR}}/{{.TARGET}}-inventory-{{.TIMESTAMP}}.bak"
          fi
          echo "üìÑ Processing template with Tailscale IPs..."
          CURRENT_HOST=$(hostname)
          CURRENT_USER=$(whoami)
          DOMAIN="yami.ski"
          NETWORK="100.64.0.0/10"
          IP_BALTHASAR=$(tailscale ip -4 balthasar 2>/dev/null)
          IP_CASPAR=$(tailscale ip -4 caspar 2>/dev/null)
          IP_LINODE=$(tailscale ip -4 linode-prox 2>/dev/null)
          IP_JOSEPH=$(tailscale ip -4 joseph 2>/dev/null)
          IP_RASPBERRY=$(tailscale ip -4 raspberrypi 2>/dev/null)
          if [ -z "$IP_BALTHASAR" ] || [ -z "$IP_CASPAR" ] || [ -z "$IP_LINODE" ]; then
            echo "‚ùå Failed to resolve required Tailscale IPs. Check 'tailscale status'"
            exit 1
          fi
          if [ "{{.TARGET}}" = "servers" ] && [ -z "$IP_RASPBERRY" ]; then
            echo "‚ùå raspberrypi not found in Tailscale"
            exit 1
          fi
          if [ "{{.TARGET}}" = "appliances" ] && [ -z "$IP_JOSEPH" ]; then
            echo "‚ùå joseph not found in Tailscale"
            exit 1
          fi
          # Use sed for variable substitution (no envsubst dependency)
          sed -e "s|\${HOSTNAME}|$CURRENT_HOST|g" \
              -e "s|\${USER}|$CURRENT_USER|g" \
              -e "s|\${DOMAIN}|$DOMAIN|g" \
              -e "s|\${NETWORK}|$NETWORK|g" \
              -e "s|\${IP_BALTHASAR}|$IP_BALTHASAR|g" \
              -e "s|\${IP_CASPAR}|$IP_CASPAR|g" \
              -e "s|\${IP_LINODE}|$IP_LINODE|g" \
              -e "s|\${IP_JOSEPH}|$IP_JOSEPH|g" \
              -e "s|\${IP_RASPBERRY}|$IP_RASPBERRY|g" \
              "$TEMPLATE_PATH" > "$INV_PATH"
          # Create symlinks for host_vars and group_vars if they don't exist
          [ ! -e "$INV_DIR/host_vars" ] && ln -s ../host_vars "$INV_DIR/host_vars" 2>/dev/null || true
          [ ! -e "$INV_DIR/group_vars" ] && ln -s ../group_vars "$INV_DIR/group_vars" 2>/dev/null || true
          echo "‚úÖ {{.TARGET}} inventory created from template at $INV_PATH"
        fi

  # === Discovery & Status ===
  list:
    desc: "List available playbooks"
    cmds:
      - |
        echo "üìã Available {{.TARGET}} playbooks:"
        ls "{{.PLAY}}"/*.yml 2>/dev/null | sed 's|.*/||; s|\.yml$$||' | sort | sed 's/^/  /'

  status:
    desc: "Infrastructure health check"
    cmds:
      - |
        echo "üîç Infrastructure Status Check"
        echo "========================================"
        echo ""
        echo "üåê Network & DNS:"
        ping -c 1 -W 3 yami.ski >/dev/null 2>&1 && echo "   ‚úÖ yami.ski reachable" || echo "   ‚ùå yami.ski unreachable"
        ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1 && echo "   ‚úÖ Internet connectivity" || echo "   ‚ùå Internet connectivity failed"
        nslookup yami.ski >/dev/null 2>&1 && echo "   ‚úÖ DNS resolution working" || echo "   ‚ùå DNS resolution failed"
        echo ""
        echo "üöÄ Tailscale Status:"
        if command -v tailscale >/dev/null 2>&1; then
          if tailscale status >/dev/null 2>&1; then
            echo "   ‚úÖ Tailscale connected"
            for host in balthasar caspar joseph raspberrypi linode-prox; do
              ip=$(tailscale ip -4 $host 2>/dev/null || echo "")
              if [ -n "$ip" ]; then
                echo "   ‚úÖ $host: $ip"
              else
                echo "   ‚ùå $host: offline"
              fi
            done
          else
            echo "   ‚ùå Tailscale disconnected"
          fi
        else
          echo "   ‚ö†Ô∏è Tailscale not installed"
        fi
        echo ""
        echo "üóÑÔ∏è Storage Services:"
        if command -v curl >/dev/null 2>&1; then
          echo -n "   MinIO (drive): "
          STATUS_CODE=$(curl -s -w "%{http_code}" -o /dev/null --max-time 10 https://drive.yami.ski/minio/health/live 2>/dev/null)
          if [ "$STATUS_CODE" = "200" ]; then echo "‚úÖ OK"
          elif [ "$STATUS_CODE" = "403" ]; then echo "‚úÖ OK (403 expected)"
          elif [ "$STATUS_CODE" = "000" ]; then echo "‚ùå NO RESPONSE"
          else echo "‚ö†Ô∏è HTTP $STATUS_CODE"; fi
        fi
        echo ""
        echo "üìä Monitoring Services:"
        if command -v curl >/dev/null 2>&1; then
          echo -n "   Grafana: "
          STATUS_CODE=$(curl -s -w "%{http_code}" -o /dev/null --max-time 5 https://grafana.yami.ski/api/health 2>/dev/null)
          if [ "$STATUS_CODE" = "200" ]; then echo "‚úÖ OK"
          elif [ "$STATUS_CODE" = "000" ]; then echo "‚ùå NO RESPONSE"
          else echo "‚ö†Ô∏è HTTP $STATUS_CODE"; fi
        fi

  logs:
    desc: "View recent log files"
    cmds:
      - |
        echo "üìã Recent logs:"
        find {{.LOG_DIR}} -name "*.log" -mtime -1 2>/dev/null | head -3 | xargs tail -20 2>/dev/null || echo "  No recent logs"

  backup:
    desc: "Backup current inventory"
    cmds:
      - |
        echo "üíæ Backing up {{.TARGET}} inventory..."
        test -f "{{.INV}}/hosts.yml" && cp "{{.INV}}/hosts.yml" "{{.BACKUP_DIR}}/{{.TARGET}}-inventory-{{.TIMESTAMP}}.bak" || true
        echo "‚úÖ Backup created"

  # === Testing (Molecule via uvx) ===
  test:
    desc: "Molecule testing (Usage: task test [ROLE=name] [MODE=syntax|converge|cleanup|test])"
    cmds:
      - |
        ROLES_DIR="ansible_collections/{{.COLLECTION_NS}}/{{.TARGET}}/roles"
        MODE_EFF="{{.MODE | default "test"}}"
        SUBCMD="test"
        EXTRA=""
        case "$MODE_EFF" in
          syntax) SUBCMD="syntax";;
          converge) SUBCMD="converge";;
          cleanup) SUBCMD="cleanup"; EXTRA="destroy || true";;
          test) SUBCMD="test";;
          *) echo "‚ùå Invalid MODE. Use: syntax, converge, cleanup, or test"; exit 1;;
        esac

        if ! command -v docker >/dev/null 2>&1; then echo "‚ùå Docker not found. Install & start docker."; exit 1; fi
        if ! docker info >/dev/null 2>&1; then echo "‚ùå Docker daemon is not running."; exit 1; fi

        export ANSIBLE_COLLECTIONS_PATH="{{.ANSIBLE_COLLECTIONS_PATH}}"
        if [ -f "{{.CONFIG}}" ]; then export ANSIBLE_CONFIG="{{.CONFIG}}"; fi

        if [ -n "{{.ROLE}}" ]; then
          ROLE_EFF="{{.ROLE}}"
          [ "$ROLE_EFF" = "modsecurity" ] && ROLE_EFF="modsecurity-nginx"
          ROLE_DIR="$ROLES_DIR/$ROLE_EFF"
          if [ ! -d "$ROLE_DIR" ]; then echo "‚ùå Role not found: {{.ROLE}} in $ROLES_DIR"; exit 1; fi
          if [ ! -f "$ROLE_DIR/molecule/default/molecule.yml" ]; then echo "‚ùå Molecule scenario missing for role: {{.ROLE}}"; exit 1; fi
          echo "üß™ {{.COLLECTION_NS}}.{{.TARGET}} ‚Ä¢ {{.ROLE}} ‚Ä¢ molecule $SUBCMD (uvx runtime py{{.UV_PY}})"
          (cd "$ROLE_DIR" && uvx --python {{.UV_PY}} --from molecule --with "molecule-plugins[docker]" molecule $SUBCMD)
          if [ -n "$EXTRA" ]; then (cd "$ROLE_DIR" && uvx --python {{.UV_PY}} --from molecule --with "molecule-plugins[docker]" molecule $EXTRA); fi
        else
          ROLES=$(find "$ROLES_DIR" -mindepth 1 -maxdepth 1 -type d -exec test -f {}/molecule/default/molecule.yml \; -print 2>/dev/null | sort)
          if [ -z "$ROLES" ]; then echo "‚ö†Ô∏è No roles with Molecule found under $ROLES_DIR"; exit 0; fi
          COUNT=$(echo "$ROLES" | wc -w | tr -d ' ')
          echo "üß™ {{.COLLECTION_NS}}.{{.TARGET}} ‚Ä¢ $COUNT roles ‚Ä¢ molecule $SUBCMD (uvx runtime py{{.UV_PY}})"
          for r in $ROLES; do
            role_name=$(basename "$r")
            echo "üìã Testing $role_name..."
            (cd "$r" && uvx --python {{.UV_PY}} --from molecule --with "molecule-plugins[docker]" molecule $SUBCMD)
            if [ -n "$EXTRA" ]; then (cd "$r" && uvx --python {{.UV_PY}} --from molecule --with "molecule-plugins[docker]" molecule $EXTRA); fi
          done
        fi

  # === Secrets Management (SOPS) ===
  secrets:
    desc: "SOPS secrets management (Usage: task secrets OPERATION=<install|edit|view|status|updatekeys|migrate|list> [TARGET=servers|appliances] [HOST=hostname] [FILE=path/to/file.yml])"
    cmds:
      - |
        if [ -z "{{.OPERATION}}" ]; then
          echo "‚ùå Usage: task secrets OPERATION=<install|edit|view|status|updatekeys|migrate|migrate-role|migrate-all|validate-migration> [TARGET={{.TARGET}}] [HOST=hostname] [FILE=path/to/file.yml]"
          exit 1
        fi

        OPERATION_EFF="{{.OPERATION}}"
        TARGET_EFF="{{.TARGET}}"
        FILE_EFF="{{.FILE}}"
        HOST_EFF="{{.HOST}}"
        HOST_PATH="$HOST_EFF"
        if [ -n "$HOST_PATH" ]; then HOST_PATH=$(printf '%s' "$HOST_PATH" | tr '-' '_'); fi

        case "$OPERATION_EFF" in
          install)
            echo "üîß Installing SOPS and Age..."
            if command -v sops >/dev/null 2>&1; then echo "‚úÖ SOPS already installed: $(sops --version)"
            else echo "‚ùå SOPS not found. Install from: https://github.com/getsops/sops"; fi
            if command -v age >/dev/null 2>&1; then echo "‚úÖ Age already installed: $(age --version)"
            else echo "‚ùå Age not found. Install from: https://github.com/FiloSottile/age"; fi
            if [ -f "{{.SOPS_AGE_KEY_FILE}}" ]; then echo "‚úÖ Age key file found: {{.SOPS_AGE_KEY_FILE}}"
            else echo "‚ùå Age key file missing: {{.SOPS_AGE_KEY_FILE}}"; fi
            ;;
          edit)
            echo "‚úèÔ∏è Editing secrets..."
            if [ -n "$FILE_EFF" ]; then SOPS_FILE_PATH="$FILE_EFF"
            elif [ -n "$HOST_EFF" ]; then
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/host_vars/$HOST_PATH/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/host_vars/$HOST_PATH/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            else
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/group_vars/all/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/group_vars/all/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            fi
            if [ ! -f "$SOPS_FILE_PATH" ]; then
              echo "‚ÑπÔ∏è Initializing new SOPS file at $SOPS_FILE_PATH"
              mkdir -p "$(dirname "$SOPS_FILE_PATH")"
              touch "$SOPS_FILE_PATH"
            fi
            if [ ! -f "$SOPS_FILE_PATH" ]; then echo "‚ùå Secrets file not found: $SOPS_FILE_PATH"; exit 1; fi
            export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
            sops "$SOPS_FILE_PATH"
            ;;
          view)
            echo "üëÅÔ∏è Viewing secrets..."
            if [ -n "$FILE_EFF" ]; then SOPS_FILE_PATH="$FILE_EFF"
            elif [ -n "$HOST_EFF" ]; then
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/host_vars/$HOST_PATH/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/host_vars/$HOST_PATH/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            else
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/group_vars/all/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/group_vars/all/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            fi
            if [ ! -f "$SOPS_FILE_PATH" ]; then echo "‚ùå Secrets file not found: $SOPS_FILE_PATH"; exit 1; fi
            export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
            sops -d "$SOPS_FILE_PATH"
            ;;
          status)
            echo "üîç Validating secrets..."
            if [ -n "$FILE_EFF" ]; then SOPS_FILE_PATH="$FILE_EFF"
            elif [ -n "$HOST_EFF" ]; then
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/host_vars/$HOST_PATH/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/host_vars/$HOST_PATH/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            else
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/group_vars/all/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/group_vars/all/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            fi
            if [ ! -f "$SOPS_FILE_PATH" ]; then echo "‚ùå Secrets file not found: $SOPS_FILE_PATH"; exit 1; fi
            echo "üìÑ File: $SOPS_FILE_PATH"
            if grep -q "sops:" "$SOPS_FILE_PATH"; then echo "‚úÖ SOPS metadata found"
            else echo "‚ùå Not a SOPS-encrypted file"; exit 1; fi
            export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
            if sops -d "$SOPS_FILE_PATH" >/dev/null 2>&1; then echo "‚úÖ Decryption successful"
            else echo "‚ùå Decryption failed"; exit 1; fi
            ;;
          updatekeys)
            echo "üîÑ Updating encryption keys..."
            if [ -n "$FILE_EFF" ]; then SOPS_FILE_PATH="$FILE_EFF"
            elif [ -n "$HOST_EFF" ]; then
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/host_vars/$HOST_PATH/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/host_vars/$HOST_PATH/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            else
              if [ "$TARGET_EFF" = "servers" ]; then SOPS_FILE_PATH="deploy/servers/group_vars/all/secrets.yml"
              elif [ "$TARGET_EFF" = "appliances" ]; then SOPS_FILE_PATH="deploy/appliances/group_vars/all/secrets.yml"
              else echo "‚ùå Invalid TARGET. Use servers or appliances, or specify FILE=path/to/file.yml"; exit 1; fi
            fi
            if [ ! -f "$SOPS_FILE_PATH" ]; then echo "‚ùå Secrets file not found: $SOPS_FILE_PATH"; exit 1; fi
            export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
            sops updatekeys "$SOPS_FILE_PATH"
            ;;
          migrate)
            echo "üîÑ Migrating legacy secrets to SOPS format..."
            if [ -n "$FILE_EFF" ]; then LEGACY_FILE="$FILE_EFF"
            else echo "‚ùå FILE parameter required for migrate operation. Use: task secrets OPERATION=migrate FILE=path/to/secrets.yml"; exit 1; fi
            if [ ! -f "$LEGACY_FILE" ]; then echo "‚ùå Legacy secrets file not found: $LEGACY_FILE"; exit 1; fi
            if grep -q "sops:" "$LEGACY_FILE"; then echo "‚ö†Ô∏è File already appears to be SOPS-encrypted: $LEGACY_FILE"; exit 1; fi
            SOPS_FILE="${LEGACY_FILE%.yml}.sops.yml"
            if [ -f "$SOPS_FILE" ]; then echo "‚ùå SOPS file already exists: $SOPS_FILE"; exit 1; fi
            echo "üìÑ Migrating: $LEGACY_FILE ‚Üí $SOPS_FILE"
            export SOPS_AGE_KEY_FILE="{{.SOPS_AGE_KEY_FILE}}"
            sops -e "$LEGACY_FILE" > "$SOPS_FILE"
            if [ $? -eq 0 ]; then echo "‚úÖ Migration successful: $SOPS_FILE"
            echo "‚ö†Ô∏è Please verify the migrated file and remove the legacy file manually: $LEGACY_FILE"
            else echo "‚ùå Migration failed"; exit 1; fi
            ;;
          migrate-role)
            echo "üîÑ Migrating all secrets in role..."
            if [ -z "{{.ROLE}}" ]; then echo "‚ùå ROLE parameter required. Use: task secrets OPERATION=migrate-role ROLE=minio"; exit 1; fi
            ROLES_DIR="ansible_collections/{{.COLLECTION_NS}}/{{.TARGET}}/roles"
            ROLE_DIR="$ROLES_DIR/{{.ROLE}}"
            if [ ! -d "$ROLE_DIR" ]; then echo "‚ùå Role directory not found: $ROLE_DIR"; exit 1; fi
            SECRETS_FILES=$(find "$ROLE_DIR" -name "secrets.yml" -type f 2>/dev/null)
            if [ -z "$SECRETS_FILES" ]; then echo "‚ö†Ô∏è No secrets.yml files found in role: {{.ROLE}}"; exit 0; fi
            echo "üìã Found secrets files in {{.ROLE}}:"
            echo "$SECRETS_FILES" | sed 's/^/  - /'
            for file in $SECRETS_FILES; do
              if ! grep -q "sops:" "$file"; then
                echo "üîÑ Migrating: $file"
                task secrets OPERATION=migrate FILE="$file" TARGET={{.TARGET}}
              else echo "‚è≠Ô∏è Skipping already encrypted: $file"; fi
            done
            ;;
          migrate-all)
            echo "üîÑ Migrating all legacy secrets in project..."
            ROLES_DIR="ansible_collections/{{.COLLECTION_NS}}/{{.TARGET}}/roles"
            SECRETS_FILES=$(find "$ROLES_DIR" -name "secrets.yml" -type f 2>/dev/null)
            if [ -z "$SECRETS_FILES" ]; then echo "‚ö†Ô∏è No secrets.yml files found in {{.TARGET}}"; exit 0; fi
            echo "üìã Found legacy secrets files:"
            echo "$SECRETS_FILES" | sed 's/^/  - /'
            for file in $SECRETS_FILES; do
              if ! grep -q "sops:" "$file"; then
                echo "üîÑ Migrating: $file"
                task secrets OPERATION=migrate FILE="$file" TARGET={{.TARGET}}
              else echo "‚è≠Ô∏è Skipping already encrypted: $file"; fi
            done
            ;;
          validate-migration)
            echo "üîç Validating migration status..."
            ROLES_DIR="ansible_collections/{{.COLLECTION_NS}}/{{.TARGET}}/roles"
            LEGACY_FILES=$(find "$ROLES_DIR" -name "secrets.yml" -type f -exec grep -L "sops:" {} \; 2>/dev/null)
            SOPS_FILES=$(find "$ROLES_DIR" -name "*.sops.yml" -type f 2>/dev/null)
            echo "üìä Migration Status Report:"
            if [ -n "$LEGACY_FILES" ]; then echo "‚ùå Legacy files (need migration):"; echo "$LEGACY_FILES" | sed 's/^/  - /'; else echo "‚úÖ No legacy secrets.yml files found"; fi
            if [ -n "$SOPS_FILES" ]; then echo "‚úÖ SOPS encrypted files:"; echo "$SOPS_FILES" | sed 's/^/  - /'; else echo "‚ö†Ô∏è No SOPS files found"; fi
            ;;
          *)
            echo "‚ùå Invalid OPERATION. Use: install, edit, view, status, updatekeys, migrate, migrate-role, migrate-all, validate-migration"
            exit 1
            ;;
        esac

  # === Help ===
  help:
    desc: "Show comprehensive help information"
    cmds:
      - |
        echo "üöÄ yamisskey-provision: Unified Ansible Infrastructure Management"
        echo "================================================================="
        echo ""
        echo "üìã Environment Variables"
        echo "  TARGET     servers|appliances (default: servers)"
        echo "  FILE       Path to specific YAML file for flexible SOPS management"
        echo "  ROLE       Role name for role-specific operations (e.g., minio, matrix)"
        echo "  LIMIT      Restrict to specific hosts (e.g., caspar,balthasar)"
        echo "  TAGS       Run specific tags only (e.g., install,config)"
        echo "  PLAYBOOK   Single playbook name"
        echo "  PLAYBOOKS  Space-separated playbook list for deploy"
        echo "  MODE       Molecule test mode: syntax|converge|cleanup|test (default: test)"
        echo "  OPERATION  SOPS operation: install|edit|view|status|updatekeys|migrate|migrate-role|migrate-all|validate-migration"
        echo ""
        echo "üì¶ Setup & Installation"
        echo "  task install                         Install uv tools + Go-based SOPS/Age + Galaxy collections"
        echo "  task inventory [TARGET=servers]      Create inventory from template"
        echo "  task inventory TYPE=local            Create local self-provisioning inventory"
        echo ""
        echo "üîç Discovery & Status"
        echo "  task status                          Health check (Tailscale, DNS, services)"
        echo "  task list [TARGET=servers]           List available playbooks"
        echo ""
        echo "üöÄ Playbook Execution"
        echo "  task run PLAYBOOK=name               Standard execution with sudo"
        echo "  task secure PLAYBOOK=name           Secure execution (memory protection)"
        echo "  task deploy PLAYBOOKS='p1 p2'       Sequential multi-playbook deployment"
        echo ""
        echo "üß™ Testing & Validation"
        echo "  task check PLAYBOOK=name             Dry-run with diff preview"
        echo "  task test [ROLE=name] [MODE=syntax]  Molecule testing (syntax|converge|test)"
        echo ""
        echo "üîê Secrets Management (SOPS)"
        echo "  task secrets OPERATION=install                                   Check/install SOPS and Age"
        echo "  task secrets OPERATION=edit [TARGET=servers] [FILE=file.yml]     Edit encrypted secrets"
        echo "  task secrets OPERATION=view [TARGET=servers] [FILE=secrets.yml]  View decrypted secrets"
        echo "  task secrets OPERATION=status [TARGET=servers]                   Validate secret configuration"
        echo "  task secrets OPERATION=updatekeys [TARGET=servers]               Rotate encryption recipients"
        echo "  task secrets OPERATION=migrate-role ROLE=minio                   Migrate entire role"
        echo "  task secrets OPERATION=migrate-all                               Migrate all legacy files"
        echo "  task secrets OPERATION=validate-migration                        Check migration status"
        echo ""
        echo "üóÑÔ∏è Maintenance"
        echo "  task backup [TARGET=servers]         Backup current inventory"
        echo "  task logs                            View recent log files"
        echo "  task update                          Update Galaxy collections to latest versions"
        echo ""
        echo "üí° Examples:"
        echo "  task run PLAYBOOK=minio TARGET=servers LIMIT=balthasar TAGS=buckets"
        echo "  task check PLAYBOOK=security TARGET=servers"
        echo "  task secrets OPERATION=edit TARGET=servers HOST=balthasar"
        echo "  task test ROLE=minio MODE=syntax"
        echo "  task deploy PLAYBOOKS='common security minio' TARGET=servers LIMIT=balthasar"
