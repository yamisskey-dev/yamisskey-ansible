---
# Cloudflared automation playbook
# Unified playbook using the enhanced cloudflared role
# Supports both manual (make install) and automatic installation modes

- name: Setup Cloudflared with full automation
  hosts: all
  become: false
  gather_facts: true
  vars:
    # Cloudflare API credentials from vault
    cloudflare_api_token: "{{ vault_cloudflare_api_token | default(omit) }}"
    cloudflare_zone_id: "{{ vault_cloudflare_zone_id | default(omit) }}"
    cloudflare_account_id: "{{ vault_cloudflare_account_id | default(omit) }}"

    # Override default settings if needed
    # cloudflared_skip_install: false  # Set to false to enable automatic installation
    # cloudflared_app_name: "custom-app"  # Override default "yaminio"
    # cloudflared_hostname: "custom.yami.ski"  # Override default hostname

  roles:
    - cloudflared

  tags:
    - cloudflared
    - tunnel
    - automation

  post_tasks:
    - name: Display completion status
      debug:
        msg: |
          =============================================================
          ğŸ‰ CLOUDFLARED SETUP COMPLETED
          =============================================================

          {% if tunnel_uuid is defined %}
          âœ… Full automation mode: All tasks completed successfully
          âœ… Tunnel: {{ cloudflared_tunnel_name }} ({{ tunnel_uuid }})
          âœ… DNS: {{ cloudflared_hostname }} configured
          âœ… Service: Running and enabled

          ğŸ”— Test URL: https://{{ cloudflared_hostname }}

          {% else %}
          âš ï¸  Manual mode: Configuration deployed, manual steps required

          ğŸ“‹ Next steps:
          1. make install  # Install cloudflared binary
          2. Complete tunnel setup as shown in role output

          {% endif %}
          =============================================================
