name: üîç Code Quality (Lint)

on:
  pull_request:
    branches: ["**"]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}-quality
  cancel-in-progress: true

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Run yamllint (Collections-aware)
        run: |
          yamllint .github ansible_collections playbooks group_vars host_vars requirements.yml || echo "‚ö†Ô∏è Some YAML validation warnings (non-blocking)"

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters and tools
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint

      - name: Install external Collections (skip local yamisskey)
        run: |
          set -euo pipefail
          cat > requirements-ci.yml <<'YAML'
          ---
          collections:
            - name: community.docker
              version: ">=3.0.0"
            - name: community.sops
              version: ">=1.6.0"
            - name: ansible.posix
              version: ">=1.5.0"
            - name: community.general
              version: ">=8.0.0"
          YAML
          ansible-galaxy collection install -r requirements-ci.yml
          echo "‚úÖ External Collections installed"

      - name: Run ansible-lint for yamisskey Collection
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: ansible.cfg
        run: |
          echo "üîç Linting yamisskey Collection..."
          ansible-lint --offline -v ansible_collections/yamisskey

  ansible-test-sanity:
    name: Ansible Sanity Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Install external Collections
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Prepare collection structure for ansible-test
        run: |
          # ansible-test expects ansible_collections/{namespace}/{name}/
          mkdir -p ansible_collections/yamisskey
          ln -s ../yamisskey ansible_collections/yamisskey/servers

      - name: Run ansible-test sanity for yamisskey.servers
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
        run: |
          set -euo pipefail
          echo "üß™ ansible-test sanity for yamisskey.servers"
          pushd ansible_collections/yamisskey/servers
          ansible-test sanity --python 3.11 -v
          popd

  verify-structure:
    name: Verify Collections Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Collections Structure
        run: |
          echo "üîç Verifying Collections structure..."
          ls -la ansible_collections/
          echo "‚úÖ yamisskey collection:"
          find ansible_collections/yamisskey -name "*.yml" | wc -l
          echo "‚úÖ Collections verification complete"
