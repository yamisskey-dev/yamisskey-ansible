name: ğŸ”„ Idempotency Tests

on:
  pull_request:
    branches: ["**"]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  prepare-inventory:
    name: Prepare Test Inventory
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create dummy inventories for testing
        run: |
          mkdir -p ci-test/servers ci-test/appliances
          
          # Create dummy servers inventory
          cat > ci-test/servers/inventory <<'EOF'
          [local]
          localhost ansible_connection=local
          
          [production:children]
          local
          
          [all:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_become=false
          domain=test.local
          internal_network=192.168.1.0/24
          cloudflare_api_token=dummy_token
          cloudflare_zone_id=dummy_zone
          cloudflare_account_id=dummy_account
          EOF
          
          # Create dummy appliances inventory
          cat > ci-test/appliances/inventory <<'EOF'
          [truenas]
          localhost ansible_connection=local
          
          [all:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_become=false
          truenas_api_key=dummy_key
          truenas_pool_name=test_pool
          primary_domain=test.local
          EOF

      - name: Upload inventory artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-inventories
          path: ci-test/

  servers-core-infrastructure:
    name: Servers Core Infrastructure
    needs: prepare-inventory
    runs-on: ubuntu-latest
    strategy:
      matrix:
        playbook: [common, security, system-init]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Install external Collections
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Download inventory artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-inventories
          path: ci-test/

      - name: Test ${{ matrix.playbook }}.yml with --check --diff
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: deploy/servers/ansible.cfg
        run: |
          set -euo pipefail
          echo "ğŸ”„ Testing ${{ matrix.playbook }}.yml with --check --diff"
          if [ -f "deploy/servers/playbooks/${{ matrix.playbook }}.yml" ]; then
            ansible-playbook -i ci-test/servers/inventory \
              "deploy/servers/playbooks/${{ matrix.playbook }}.yml" \
              --check --diff \
              --skip-tags "reboot,restart" \
              -e "ansible_become=false" \
              -e "skip_handlers=true" || echo "âš ï¸ ${{ matrix.playbook }} check completed with warnings"
          else
            echo "âš ï¸ Playbook ${{ matrix.playbook }}.yml not found, skipping"
          fi

  servers-application-stack:
    name: Servers Application Stack
    needs: prepare-inventory
    runs-on: ubuntu-latest
    strategy:
      matrix:
        playbook: [misskey, minio, monitoring]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Install external Collections
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Download inventory artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-inventories
          path: ci-test/

      - name: Test ${{ matrix.playbook }}.yml with --check --diff
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: deploy/servers/ansible.cfg
        run: |
          set -euo pipefail
          echo "ğŸ”„ Testing ${{ matrix.playbook }}.yml with --check --diff"
          if [ -f "deploy/servers/playbooks/${{ matrix.playbook }}.yml" ]; then
            ansible-playbook -i ci-test/servers/inventory \
              "deploy/servers/playbooks/${{ matrix.playbook }}.yml" \
              --check --diff \
              --skip-tags "docker_restart,service_restart" \
              -e "ansible_become=false" \
              -e "skip_handlers=true" || echo "âš ï¸ ${{ matrix.playbook }} check completed with warnings"
          else
            echo "âš ï¸ Playbook ${{ matrix.playbook }}.yml not found, skipping"
          fi

  appliances-truenas:
    name: Appliances TrueNAS Setup
    needs: prepare-inventory
    runs-on: ubuntu-latest
    strategy:
      matrix:
        playbook: [setup, migrate-minio-truenas]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Install external Collections
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Download inventory artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-inventories
          path: ci-test/

      - name: Test ${{ matrix.playbook }}.yml with --check --diff
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: deploy/appliances/ansible.cfg
        run: |
          set -euo pipefail
          echo "ğŸ”„ Testing ${{ matrix.playbook }}.yml with --check --diff"
          if [ -f "deploy/appliances/playbooks/${{ matrix.playbook }}.yml" ]; then
            ansible-playbook -i ci-test/appliances/inventory \
              "deploy/appliances/playbooks/${{ matrix.playbook }}.yml" \
              --check --diff \
              --skip-tags "api_calls,truenas_restart" \
              -e "ansible_become=false" \
              -e "skip_handlers=true" || echo "âš ï¸ ${{ matrix.playbook }} check completed with warnings"
          else
            echo "âš ï¸ Playbook ${{ matrix.playbook }}.yml not found, skipping"
          fi