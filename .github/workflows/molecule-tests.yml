name: ⚛ Molecule Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'ansible_collections/**'
      - '.github/workflows/molecule-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ansible_collections/**'
      - '.github/workflows/molecule-tests.yml'

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-roles: ${{ steps.changes.outputs.roles }}
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Detect changed roles
        id: changes
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
          fi

          PAIRS=$(echo "$CHANGED_FILES" \
            | awk -F/ '/^ansible_collections\/[^/]+\/[^/]+\/roles\// {print $3 "/" $5}' \
            | sort -u || true)

          if [ -n "$PAIRS" ]; then
            CHANGED_ROLES=$(printf '%s\n' "$PAIRS" | awk -F/ '{print $2}' | sort -u | tr '\n' ' ')
            MATRIX_JSON=$(printf '%s\n' "$PAIRS" | awk -F/ '{print "{\"collection\":\""$1"\",\"role\":\""$2"\"}"}' | jq -s -c '.')
            echo "roles=$CHANGED_ROLES" >> "$GITHUB_OUTPUT"
            echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          else
            echo "roles=" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
          fi

  # 変更分＋（未テスト or 前回失敗）を合流して最終マトリクスを作る
  build-matrix:
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      final-matrix: ${{ steps.make_matrix.outputs.final_matrix }}
      count: ${{ steps.make_matrix.outputs.count }}
      cache-key-prefix: ${{ steps.cache_key.outputs.prefix }}
    steps:
      - uses: actions/checkout@v4

      # 前回までのテスト結果インデックスをキャッシュから復元
      - name: Restore status cache
        id: restore_cache
        uses: actions/cache/restore@v4
        with:
          path: .cache/molecule-status/test-index.json
          key: molecule-status-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            molecule-status-${{ github.ref_name }}-

      - name: Ensure status index exists
        run: |
          mkdir -p .cache/molecule-status
          if [ ! -s .cache/molecule-status/test-index.json ]; then
            echo '{}' > .cache/molecule-status/test-index.json
          fi
          jq '.' .cache/molecule-status/test-index.json

      - name: Scan all roles with molecule scenarios
        id: scan
        shell: bash
        run: |
          # yamisskey/<collection>/roles/<role>/molecule/*
          MAP_LINES=$(find ansible_collections/yamisskey -type d -path '*/roles/*/molecule' \
            | awk -F/ '{print $(NF-3) "\t" $(NF-1)}')

          if [ -z "$MAP_LINES" ]; then
            echo "pairs=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # タブ区切り "collection<TAB>role" を JSON 配列へ
          MATRIX=$(printf '%s\n' "$MAP_LINES" \
            | jq -R -s -c 'split("\n")[:-1] | map( split("\t") | {collection: .[0], role: .[1]} )')

          echo "pairs=$MATRIX" >> "$GITHUB_OUTPUT"

          # デバッグ（任意）
          echo "Scanned matrix:"
          echo "$MATRIX" | jq .

      - name: Build final matrix (changed + untested/failed)
        id: make_matrix
        shell: bash
        env:
          CHANGED: ${{ needs.detect-changes.outputs.matrix }}
        run: |
          STATUS=.cache/molecule-status/test-index.json
          ALL=${{ steps.scan.outputs.pairs }}
          if [ -z "$ALL" ] || [ "$ALL" = "[]" ]; then
            echo "final_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          STATUS=.cache/molecule-status/test-index.json
          ALL=${{ steps.scan.outputs.pairs }}
          if [ -z "$ALL" ] || [ "$ALL" = "[]" ]; then
            echo "final_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          STATUS=.cache/molecule-status/test-index.json

          # ✅ JSONを壊さないポイント：式展開は必ずシングルクォートで囲む
          ALL='${{ steps.scan.outputs.pairs }}'
          CHANGED_JSON='${{ needs.detect-changes.outputs.matrix }}'
          # 空なら [] にフォールバック
          [ -n "$CHANGED_JSON" ] || CHANGED_JSON='[]'

          # 早期リターン
          if [ -z "$ALL" ] || [ "$ALL" = "[]" ]; then
            echo "final_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # STATUS をバリデーション（壊れてたら {} に）
          if [ -s "$STATUS" ] && jq -e . "$STATUS" >/dev/null 2>&1; then
            STATUS_JSON="$(cat "$STATUS")"
          else
            echo "(!) STATUS index missing or invalid; fallback to {}"
            STATUS_JSON='{}'
          fi

          # ファイル経由で渡すとさらに安全
          ALL_FILE="$(mktemp)"; IDX_FILE="$(mktemp)"
          printf '%s' "$ALL" > "$ALL_FILE"
          printf '%s' "$STATUS_JSON" > "$IDX_FILE"

          # sanity check
          jq -e . "$ALL_FILE" >/dev/null || { echo "ALL invalid JSON"; sed -n '1,5p' "$ALL_FILE"; exit 1; }
          jq -e . "$IDX_FILE"  >/dev/null || { echo "IDX invalid JSON";  sed -n '1,5p' "$IDX_FILE";  exit 1; }

          UNTESTED_OR_FAILED="$(
            jq -c -n \
              --rawfile all "$ALL_FILE" \
              --rawfile idx "$IDX_FILE" \
              '
              ($all|fromjson) as $all
              | ($idx|fromjson) as $idx
              | [ $all[]
                  | select( (( $idx[.collection + "/" + .role] // {status:"untested"}).status) != "pass" )
                ]
              '
          )"

          # 合流して uniq
          FINAL="$(
            jq -c -s '
              add | unique_by(.collection + "/" + .role)
            ' <(printf '%s' "$CHANGED_JSON") <(printf '%s' "$UNTESTED_OR_FAILED")
          )"

          COUNT="$(jq 'length' <<<"$FINAL")"
          echo "final_matrix=$FINAL" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Matrix count: $COUNT"
          echo "---- DEBUG ----"
          jq -e . "$ALL_FILE" >/dev/null || { echo "ALL invalid JSON"; head -c 400 "$ALL_FILE"; echo; }
          jq -e . "$IDX_FILE" >/dev/null || { echo "IDX invalid JSON"; head -c 400 "$IDX_FILE"; echo; }
          echo "--------------"

      - name: Expose cache key prefix
        id: cache_key
        run: echo "prefix=molecule-status-${{ github.ref_name }}" >> "$GITHUB_OUTPUT"

  molecule-test:
    needs: build-matrix
    if: ${{ needs.build-matrix.outputs.count != '0' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.build-matrix.outputs.final-matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (pin ansible-core < 2.19)
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade --force-reinstall 'ansible-core<2.19'
          pip install molecule molecule-plugins[docker] ansible-lint

      - name: Check Docker availability
        run: |
          docker --version
          docker info | sed -n '1,30p'

      - name: Install required Ansible collections (remote only)
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Run Molecule test (capture status)
        id: run
        working-directory: ansible_collections/yamisskey/${{ matrix.collection }}/roles/${{ matrix.role }}
        shell: bash
        env:
          ANSIBLE_LOCAL_TEMP: ${{ runner.temp }}/ansible-local
          ANSIBLE_REMOTE_TEMP: /tmp/ansible
          MOLECULE_EPHEMERAL_DIRECTORY: ${{ runner.temp }}/molecule
          MOLECULE_STATE_DIRECTORY: ${{ runner.temp }}/molecule-state
          XDG_CACHE_HOME: ${{ runner.temp }}/.cache
          ANSIBLE_GALAXY_CACHE_DIR: ${{ runner.temp }}/galaxy-cache
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible.cfg
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/.vendor/collections"
          mkdir -p .vendor/collections
          rm -rf ansible_collections
          ln -s "$GITHUB_WORKSPACE/ansible_collections" ansible_collections

          set +e
          molecule --version
          ansible --version || true
          molecule test
          EXIT_CODE=$?
          set -e

          mkdir -p "$GITHUB_WORKSPACE/.tmp-status"
          STATUS_FILE="$GITHUB_WORKSPACE/.tmp-status/${{ matrix.collection }}__${{ matrix.role }}.json"
          if [ $EXIT_CODE -eq 0 ]; then
            STATUS="pass"
          else
            STATUS="fail"
          fi
          jq -n --arg c "${{ matrix.collection }}" --arg r "${{ matrix.role }}" --arg s "$STATUS" \
               --arg t "$(date -u +%FT%TZ)" \
               '{collection:$c, role:$r, status:$s, timestamp:$t}' > "$STATUS_FILE"
          echo "wrote $STATUS_FILE"

          # 再スローして job の成功/失敗は正しく反映
          exit $EXIT_CODE

      - name: Upload role status artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-status-${{ matrix.collection }}-${{ matrix.role }}
          path: .tmp-status/*.json
          if-no-files-found: ignore
          retention-days: 7

  # すべてのロール結果を取り込み、インデックスJSONを更新→キャッシュ保存
  update-status-cache:
    needs: [build-matrix, molecule-test]
    if: ${{ needs.build-matrix.outputs.count != '0' && always() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore previous status cache
        uses: actions/cache/restore@v4
        with:
          path: .cache/molecule-status/test-index.json
          key: molecule-status-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            molecule-status-${{ github.ref_name }}-

      - name: Ensure status index exists
        run: |
          mkdir -p .cache/molecule-status
          if [ ! -s .cache/molecule-status/test-index.json ]; then
            echo '{}' > .cache/molecule-status/test-index.json
          fi

      - name: Download all role status artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: molecule-status-*
          merge-multiple: true
          path: .tmp-status-merged

      - name: Merge statuses into index
        shell: bash
        run: |
          INDEX=.cache/molecule-status/test-index.json
          for f in .tmp-status-merged/*.json; do
            [ -e "$f" ] || continue
            c=$(jq -r '.collection' "$f")
            r=$(jq -r '.role' "$f")
            k="${c}/${r}"
            tmp=$(mktemp)
            jq --arg k "$k" --slurpfile rec "$f" '
              .[$k] = ($rec[0])
            ' "$INDEX" > "$tmp" && mv "$tmp" "$INDEX"
          done
          echo "Final index:"
          jq '.' "$INDEX"

      - name: Save updated status cache
        uses: actions/cache/save@v4
        with:
          path: .cache/molecule-status/test-index.json
          key: molecule-status-${{ github.ref_name }}-${{ github.run_id }}
