name: âš› Molecule Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'ansible_collections/**'
      - '.github/workflows/molecule-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ansible_collections/**'
      - '.github/workflows/molecule-tests.yml'

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  # Job to detect which roles have been changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-roles: ${{ steps.changes.outputs.roles }}
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed roles
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
          fi
          
          # Extract unique collection/role pairs from changed files
          # Path pattern: ansible_collections/<ns>/<collection>/roles/<role>/...
          PAIRS=$(echo "$CHANGED_FILES" \
            | awk -F/ '/^ansible_collections\/[^^/]+\/[^^/]+\/roles\// {print $3 "/" $5}' \
            | sort -u || true)

          # Prepare outputs
          if [ -n "$PAIRS" ]; then
            # Space-separated role list (kept for quick checks)
            CHANGED_ROLES=$(printf '%s\n' "$PAIRS" | awk -F/ '{print $2}' | sort -u | tr '\n' ' ')
            # Compact JSON array for matrix include
            MATRIX_JSON=$(printf '%s\n' "$PAIRS" | awk -F/ '{print "{\"collection\":\""$1"\",\"role\":\""$2"\"}"}' | jq -s -c '.')
            echo "roles=$CHANGED_ROLES" >> "$GITHUB_OUTPUT"
            echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          else
            echo "roles=" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
          fi

  # Syntax check for all changed roles
  syntax-check:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-roles != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (pin ansible-core < 2.19)
        run: |
          python -m pip install --upgrade pip
          pip install 'ansible-core<2.19' molecule molecule-plugins[docker] ansible-lint

      - name: Check Docker availability
        run: |
          docker --version
          docker info | sed -n '1,30p'

      - name: Install required Ansible collections (remote only)
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Run Molecule syntax check
        working-directory: ansible_collections/yamisskey/${{ matrix.collection }}/roles/${{ matrix.role }}
        run: |
          set -euo pipefail
          mkdir -p "${{ runner.temp }}/home" \
                   "${{ runner.temp }}/ansible-local" \
                   "${{ runner.temp }}/molecule" \
                   "${{ runner.temp }}/molecule-state"
          pwd && ls -la
          echo "ANSIBLE_CONFIG=${ANSIBLE_CONFIG}"
          echo "HOME=${HOME}"
          molecule --version
          ansible --version || true
          ansible-galaxy collection list || true
          molecule syntax
        env:
          HOME: ${{ runner.temp }}/home
          ANSIBLE_LOCAL_TEMP: ${{ runner.temp }}/ansible-local
          ANSIBLE_REMOTE_TEMP: /tmp/ansible-remote
          MOLECULE_EPHEMERAL_DIRECTORY: ${{ runner.temp }}/molecule
          MOLECULE_STATE_DIRECTORY: ${{ runner.temp }}/molecule-state
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible.cfg

  # Full Molecule test for changed roles
  molecule-test:
    needs: [detect-changes, syntax-check]
    if: needs.detect-changes.outputs.changed-roles != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (pin ansible-core < 2.19)
        run: |
          python -m pip install --upgrade pip
          pip install 'ansible-core<2.19' molecule molecule-plugins[docker] ansible-lint

      - name: Check Docker availability
        run: |
          docker --version
          docker info | sed -n '1,30p'

      - name: Install required Ansible collections (remote only)
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Run Molecule test
        working-directory: ansible_collections/yamisskey/${{ matrix.collection }}/roles/${{ matrix.role }}
        run: |
          set -euo pipefail
          mkdir -p "${{ runner.temp }}/home" \
                   "${{ runner.temp }}/ansible-local" \
                   "${{ runner.temp }}/molecule" \
                   "${{ runner.temp }}/molecule-state"
          pwd && ls -la
          molecule --version
          ansible --version || true
          ansible-galaxy collection list || true
          molecule test
        env:
          HOME: ${{ runner.temp }}/home
          ANSIBLE_LOCAL_TEMP: ${{ runner.temp }}/ansible-local
          ANSIBLE_REMOTE_TEMP: /tmp/ansible-remote
          MOLECULE_EPHEMERAL_DIRECTORY: ${{ runner.temp }}/molecule
          MOLECULE_STATE_DIRECTORY: ${{ runner.temp }}/molecule-state
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible.cfg

  # Optional: Full test suite for main branch
  full-test-suite:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        collection: [servers, appliances]
        mode: [syntax]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (pin ansible-core < 2.19)
        run: |
          python -m pip install --upgrade pip
          pip install 'ansible-core<2.19' molecule molecule-plugins[docker] ansible-lint

      - name: Check Docker availability
        run: |
          docker --version
          docker info | sed -n '1,30p'

      - name: Install required Ansible collections (remote only)
        run: |
          ansible-galaxy collection install community.docker ansible.posix community.sops community.general

      - name: Run full test suite
        run: |
          make test TARGET=${{ matrix.collection }} MODE=${{ matrix.mode }}
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}:$HOME/.ansible/collections:/usr/share/ansible/collections
