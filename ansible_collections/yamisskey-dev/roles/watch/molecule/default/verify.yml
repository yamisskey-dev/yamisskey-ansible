---
- name: Verify
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Check if Node Exporter service is running
      systemd:
        name: prometheus-node-exporter
      register: node_exporter_service
      failed_when: false

    - name: Debug Node Exporter service status
      debug:
        var: node_exporter_service

    - name: Verify Node Exporter service status
      assert:
        that:
          - node_exporter_service.status is defined
          - node_exporter_service.status.ActiveState == "active"
        fail_msg: "Node Exporter service is not running"
        success_msg: "Node Exporter service is running correctly"
      when: node_exporter_service.status is defined

    - name: Alternative check - Node Exporter service status
      shell: "systemctl is-active prometheus-node-exporter"
      register: node_exporter_status_check
      failed_when: false
      when: node_exporter_service.status is not defined

    - name: Debug alternative service check
      debug:
        var: node_exporter_status_check
      when: node_exporter_service.status is not defined

    - name: Verify Node Exporter service status (alternative)
      assert:
        that:
          - node_exporter_status_check.stdout == "active"
        fail_msg: "Node Exporter service is not running (alternative check)"
        success_msg: "Node Exporter service is running correctly (alternative check)"
      when:
        - node_exporter_service.status is not defined
        - node_exporter_status_check is defined

    - name: Check if Node Exporter service exists at all
      shell: "systemctl list-unit-files | grep prometheus-node-exporter"
      register: node_exporter_exists_check
      failed_when: false
      when:
        - node_exporter_service.status is not defined
        - node_exporter_status_check is not defined

    - name: Debug service existence check
      debug:
        var: node_exporter_exists_check
      when:
        - node_exporter_service.status is not defined
        - node_exporter_status_check is not defined

    - name: Fail if Node Exporter service does not exist
      fail:
        msg: "Node Exporter service (prometheus-node-exporter) does not exist on the system"
      when:
        - node_exporter_service.status is not defined
        - node_exporter_status_check is not defined
        - node_exporter_exists_check.rc != 0

    - name: Check Node Exporter HTTP endpoint
      uri:
        url: "http://localhost:9100/metrics"
        method: GET
        status_code: 200
        return_content: true
      register: node_exporter_metrics
      retries: 3
      delay: 5
      failed_when: false

    - name: Debug Node Exporter metrics response
      debug:
        var: node_exporter_metrics

    - name: Verify Node Exporter metrics content
      assert:
        that:
          - node_exporter_metrics.status == 200
          - "'node_' in node_exporter_metrics.content"
        fail_msg: "Node Exporter metrics do not contain expected content or endpoint is not accessible"
        success_msg: "Node Exporter is exposing metrics correctly"
      when: node_exporter_metrics.status is defined

    - name: Check if Node Exporter service is actually running (fallback)
      shell: "ps aux | grep node_exporter | grep -v grep"
      register: node_exporter_process_check
      failed_when: false
      when: node_exporter_metrics.status is not defined

    - name: Debug Node Exporter process check
      debug:
        var: node_exporter_process_check
      when: node_exporter_metrics.status is not defined

    - name: Fail if Node Exporter is not accessible
      fail:
        msg: "Node Exporter is not accessible on port 9100. Service may not be running or listening on the expected port."
      when:
        - node_exporter_metrics.status is not defined
        - node_exporter_process_check.rc != 0

    - name: Check if cAdvisor container is running
      community.docker.docker_container_info:
        name: cadvisor
      register: cadvisor_container
      failed_when: false

    - name: Debug cAdvisor container status
      debug:
        var: cadvisor_container

    - name: Verify cAdvisor container status
      assert:
        that:
          - cadvisor_container.container.State.Status == "running"
        fail_msg: "cAdvisor container is not running"
        success_msg: "cAdvisor container is running correctly"
      when:
        - cadvisor_container.exists
        - cadvisor.enabled | default(true)

    - name: Check cAdvisor HTTP endpoint
      uri:
        url: "http://localhost:8085/metrics"
        method: GET
        status_code: 200
      register: cadvisor_metrics
      retries: 3
      delay: 5
      failed_when: false
      when: cadvisor.enabled | default(true)

    - name: Debug cAdvisor metrics
      debug:
        var: cadvisor_metrics
      when: cadvisor.enabled | default(true)

    - name: Verify cAdvisor metrics content
      assert:
        that:
          - cadvisor_metrics.status == 200
          - "'container_' in cadvisor_metrics.content"
        fail_msg: "cAdvisor metrics do not contain expected content or endpoint is not accessible"
        success_msg: "cAdvisor is exposing container metrics correctly"
      when:
        - cadvisor.enabled | default(true)
        - cadvisor_metrics is defined
        - cadvisor_metrics.status is defined
        - cadvisor_metrics.status == 200

    - name: Skip cAdvisor checks (disabled)
      debug:
        msg: "cAdvisor is disabled in test environment, skipping container and metrics checks"
      when: not (cadvisor.enabled | default(true))

    - name: Skip cAdvisor metrics check (not accessible)
      debug:
        msg: "cAdvisor metrics endpoint is not accessible, skipping metrics content verification"
      when:
        - cadvisor.enabled | default(true)
        - cadvisor_metrics is defined
        - cadvisor_metrics.status is defined
        - cadvisor_metrics.status != 200


    - name: Check Node Exporter configuration file exists (systemd)
      ansible.builtin.stat:
        path: "/lib/systemd/system/prometheus-node-exporter.service"
      register: node_exporter_config_systemd

    - name: Check Node Exporter configuration file exists (custom)
      ansible.builtin.stat:
        path: "/etc/systemd/system/prometheus-node-exporter.service"
      register: node_exporter_config_custom

    - name: Verify Node Exporter configuration file exists
      assert:
        that:
          - node_exporter_config_systemd.stat.exists or node_exporter_config_custom.stat.exists
        fail_msg: "Node Exporter configuration file does not exist in /lib/systemd/system/ or /etc/systemd/system/"
        success_msg: "Node Exporter configuration file exists"


    - name: Check if Node Exporter service is enabled
      systemd:
        name: prometheus-node-exporter
      register: node_exporter_enabled
      failed_when: false

    - name: Verify Node Exporter service is enabled
      assert:
        that:
          - node_exporter_enabled.status is defined
          - node_exporter_enabled.status.UnitFileState == "enabled"
        fail_msg: "Node Exporter service is not enabled"
        success_msg: "Node Exporter service is enabled"
      when: node_exporter_enabled.status is defined

    - name: Check Node Exporter process existence
      shell: "pgrep -f node_exporter"
      register: node_exporter_process
      failed_when: false


    - name: Check cAdvisor container process
      shell: "docker ps | grep cadvisor"
      register: cadvisor_process_check
      failed_when: false
      when: cadvisor.enabled | default(true)

    - name: Verify cAdvisor container process
      assert:
        that:
          - cadvisor_process_check.rc == 0
        fail_msg: "cAdvisor container process is not running"
        success_msg: "cAdvisor container process is running"
      when: cadvisor.enabled | default(true)

    - name: Verify Node Exporter process is running
      assert:
        that:
          - node_exporter_process.rc == 0
        fail_msg: "Node Exporter process is not running"
        success_msg: "Node Exporter process is running"
