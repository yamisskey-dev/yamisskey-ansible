---
# MinIO Migration Role - Migration Tasks
# Based on proven migrate role logic with tag support

- name: Set default variables (proven logic)
  set_fact:
    # Migration configuration with defaults
    minio_bucket_name_for_misskey: "{{ minio_bucket_name_for_misskey | default('files') }}"
    minio_bucket_name_for_outline: "{{ minio_bucket_name_for_outline | default('assets') }}"
    source_minio_port: "{{ source_minio_port | default(9000) }}"
    target_minio_port: "{{ target_minio_port | default(9000) }}"
    migration_temp_dir: "{{ migration_temp_dir | default('/tmp/minio-migration') }}"
    # MinIO aliases with unique timestamps
    source_minio_alias: "source_{{ ansible_date_time.epoch }}"
    target_minio_alias: "target_{{ ansible_date_time.epoch }}"
    # Bucket list
    buckets_to_migrate:
      - "{{ minio_bucket_name_for_misskey }}"
      - "{{ minio_bucket_name_for_outline }}"
  tags: ['migrate']

- name: Get source host IP address from dynamic inventory
  set_fact:
    source_minio_ip: "{{ hostvars[source_minio_host]['ansible_host'] | default(source_minio_host) }}"
  when: source_minio_host in hostvars
  tags: ['migrate']

- name: Fallback to hostname if IP not available
  set_fact:
    source_minio_ip: "{{ source_minio_host }}"
  when: source_minio_ip is not defined
  tags: ['migrate']

- name: Display host resolution results
  debug:
    msg: |
      Host resolution results:
      - Source host: {{ source_minio_host }}
      - Resolved IP: {{ source_minio_ip }}
      - Target host: {{ inventory_hostname }}
      - Available hosts in inventory: {{ groups['all'] }}
  tags: ['migrate', 'info']

- name: Gather MinIO credentials from inventory
  set_fact:
    source_minio_inventory: "{{ (hostvars[source_minio_host] | default({})).minio | default({}) }}"
    target_minio_inventory: "{{ (hostvars[inventory_hostname] | default({})).minio | default({}) }}"
  tags: ['migrate']

- name: Build MinIO credential dictionaries
  set_fact:
    source_secrets:
      minio:
        root_user: "{{ source_minio_inventory.root_user | default('CHANGE_ME_SOURCE_ROOT_USER') }}"
        root_password: "{{ source_minio_inventory.root_password | default('CHANGE_ME_SOURCE_ROOT_PASSWORD') }}"
    target_secrets:
      minio:
        root_user: "{{ target_minio_inventory.root_user | default('CHANGE_ME_TARGET_ROOT_USER') }}"
        root_password: "{{ target_minio_inventory.root_password | default('CHANGE_ME_TARGET_ROOT_PASSWORD') }}"
  tags: ['migrate']

- name: Warn about placeholder migration credentials
  debug:
    msg: >-
      MinIO {{ item.role }} credentials are placeholders. Update host_vars/{{ item.host }}/secrets.yml â†’ minio.root_user/minio.root_password.
  loop:
    - { role: 'source', host: "{{ source_minio_host }}", user: "{{ source_secrets.minio.root_user }}", password: "{{ source_secrets.minio.root_password }}" }
    - { role: 'target', host: "{{ inventory_hostname }}", user: "{{ target_secrets.minio.root_user }}", password: "{{ target_secrets.minio.root_password }}" }
  when: item.user is search('^CHANGE_ME_') or item.password is search('^CHANGE_ME_')
  tags: ['migrate', 'info']

- name: Install MinIO CLI if not present
  block:
    - name: Check if MinIO CLI exists
      ansible.builtin.stat:
        path: /usr/local/bin/mc
      register: mc_exists

    - name: Download and install MinIO CLI
      ansible.builtin.get_url:
        url: "https://dl.min.io/client/mc/release/linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/mc"
        dest: /usr/local/bin/mc
        mode: '0755'
        owner: root
        group: root
      when: not mc_exists.stat.exists
      become: true

    - name: Verify MinIO CLI installation
      command: /usr/local/bin/mc --version
      register: mc_version
      changed_when: false
      when: not mc_exists.stat.exists

- name: Display MinIO CLI version
  debug:
    msg: "MinIO CLI installed: {{ mc_version.stdout_lines[0] | default('Version check skipped') }}"
  when: mc_version is defined and mc_version.stdout_lines is defined
  tags: ['migrate']

- name: Display migration summary (proven format)
  debug:
    msg: |
      ==============================================
      MinIO Migration Plan
      ==============================================
      Source: {{ source_minio_host }} ({{ source_minio_ip }}:{{ source_minio_port }})
      Target: {{ inventory_hostname }} (localhost:{{ target_minio_port }})
      Buckets: {{ buckets_to_migrate | join(', ') }}
      Encryption: Enabled (KMS)
      Method: API-based with transparent encryption
      Temp Dir: {{ migration_temp_dir }}
      ==============================================
  tags: ['migrate', 'info']

- name: Verify source MinIO connectivity (proven logic)
  uri:
    url: "http://{{ source_minio_ip }}:{{ source_minio_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: source_health
  failed_when: false
  when: source_minio_host != inventory_hostname and not ansible_check_mode
  tags: ['migrate']

- name: Skip source connectivity for local migration
  set_fact:
    source_health:
      status: 200
      msg: "Local migration - source connectivity check skipped"
  when: source_minio_host == inventory_hostname
  tags: ['migrate']

- name: Skip source connectivity in check mode
  set_fact:
    source_health:
      status: 200
      msg: "Check mode - source connectivity check skipped"
  when: source_minio_host != inventory_hostname and ansible_check_mode
  tags: ['migrate']

- name: Handle source connectivity failure
  fail:
    msg: |
      Failed to connect to source MinIO at {{ source_minio_ip }}:{{ source_minio_port }}
      Status: {{ source_health.status | default('Connection failed') }}
      Please ensure:
      1. Source MinIO is running
      2. Network connectivity exists between hosts
      3. Firewall allows access to port {{ source_minio_port }}
  when: source_health.status | default(200) != 200 and not ansible_check_mode
  tags: ['migrate']

- name: Verify target MinIO connectivity (proven logic)
  uri:
    url: "http://localhost:{{ target_minio_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: target_health
  failed_when: false
  when: not ansible_check_mode
  tags: ['migrate']

- name: Skip target connectivity in check mode
  set_fact:
    target_health:
      status: 200
      msg: "Check mode - target connectivity check skipped"
  when: ansible_check_mode
  tags: ['migrate']

- name: Handle target connectivity failure
  fail:
    msg: |
      Failed to connect to target MinIO at localhost:{{ target_minio_port }}
      Status: {{ target_health.status | default('Connection failed') }}
      Please ensure target MinIO is running and accessible.
  when: target_health.status | default(200) != 200 and not ansible_check_mode
  tags: ['migrate']

- name: Create migration temporary directory
  file:
    path: "{{ migration_temp_dir }}"
    state: directory
    mode: '0700'
  tags: ['migrate']

- name: Setup source MinIO alias (proven logic)
  command: >
    /usr/local/bin/mc alias set {{ source_minio_alias }}
    http://{{ source_minio_ip }}:{{ source_minio_port }}
    "{{ source_secrets.minio.root_user }}"
    "{{ source_secrets.minio.root_password }}"
  register: source_alias_result
  changed_when: source_alias_result.rc == 0
  tags: ['migrate']

- name: Setup target MinIO alias (proven logic)
  command: >
    /usr/local/bin/mc alias set {{ target_minio_alias }}
    http://localhost:{{ target_minio_port }}
    "{{ target_secrets.minio.root_user }}"
    "{{ target_secrets.minio.root_password }}"
  register: target_alias_result
  changed_when: target_alias_result.rc == 0
  tags: ['migrate']

- name: Verify source MinIO alias
  command: /usr/local/bin/mc ls {{ source_minio_alias }}/
  register: source_ls_result
  changed_when: false
  failed_when: false
  tags: ['migrate']

- name: Handle source alias verification failure
  fail:
    msg: |
      Failed to list source MinIO buckets. Error: {{ source_ls_result.stderr }}
      Please check source credentials and connectivity.
  when: source_ls_result.rc != 0
  tags: ['migrate']

- name: Display source bucket information
  debug:
    msg: |
      Source MinIO buckets found:
      {{ source_ls_result.stdout }}
  tags: ['migrate', 'info']

- name: Check source buckets existence and get statistics (API-based)
  block:
    - name: Check source buckets existence
      command: /usr/local/bin/mc ls {{ source_minio_alias }}/{{ item }}/
      loop: "{{ buckets_to_migrate }}"
      register: source_bucket_check
      ignore_errors: true
      changed_when: false

    - name: Display source bucket statistics
      command: /usr/local/bin/mc du {{ source_minio_alias }}/{{ buckets_to_migrate[ansible_loop_index] }}/
      loop: "{{ range(buckets_to_migrate | length) | list }}"
      loop_control:
        index_var: ansible_loop_index
      register: source_bucket_stats
      ignore_errors: true
      changed_when: false
      when: source_bucket_check.results[ansible_loop_index].rc == 0

    - name: Display bucket statistics
      debug:
        msg: |
          Source bucket statistics:
          {% for i in range(buckets_to_migrate | length) %}
          {{ buckets_to_migrate[i] }}:
          {% if source_bucket_check.results[i].rc == 0 %}
            âœ… Available {% if source_bucket_stats.results[i] is defined %}({{ source_bucket_stats.results[i].stdout }}){% endif %}
          {% else %}
            âŒ Not found or empty
          {% endif %}
          {% endfor %}
  tags: ['migrate', 'info']

- name: Create migration script
  template:
    src: minio_migration_script.sh.j2
    dest: "{{ migration_temp_dir }}/migrate.sh"
    mode: '0700'
  tags: ['migrate']

- name: Set migration start time
  set_fact:
    migration_start_time: "{{ ansible_date_time.epoch }}"
  tags: ['migrate']

- name: Display migration start notification
  debug:
    msg: |
      ğŸš€ MinIO Migration Starting
      ==========================================
      â° Start Time: {{ ansible_date_time.iso8601 }}
      ğŸ“‚ Source: {{ source_minio_host }} ({{ source_minio_ip }}:{{ source_minio_port }})
      ğŸ¯ Target: {{ inventory_hostname }} (localhost:{{ target_minio_port }})
      ğŸ“¦ Buckets: {{ buckets_to_migrate | join(', ') }}
      ğŸ” Encryption: KMS enabled
      ==========================================

      Progress will be displayed every 10 seconds...
  tags: ['migrate', 'info']

- name: Execute MinIO migration with encryption (proven logic)
  command: bash "{{ migration_temp_dir }}/migrate.sh"
  register: migration_result
  failed_when: migration_result.rc != 0
  async: 3600  # 1æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (original proven setting)
  poll: 10     # 10ç§’é–“éš”ã§ãƒãƒ¼ãƒªãƒ³ã‚° (original proven setting)
  tags: ['migrate']

- name: Monitor migration progress during execution
  debug:
    msg: |
      ğŸ”„ MinIO Migration Progress Monitor
      ==========================================
      â±ï¸  Elapsed Time: {{ (ansible_date_time.epoch | int) - (migration_start_time | int) }}ç§’
      ğŸ“Š Status: {{ migration_result.finished | default(0) | ternary('âœ… å®Œäº†', 'ğŸ”„ é€²è¡Œä¸­') }}

      Progress Checklist:
      - SSH Connection: âœ… Established
      - Source MinIO: âœ… Connected
      - Target MinIO: âœ… Connected
      - Migration Script: âœ… Generated
      - Data Transfer: {{ migration_result.finished | default(0) | ternary('âœ… Complete', 'ğŸ”„ In Progress') }}

      Current Buckets: {{ buckets_to_migrate | join(', ') }}
      ==========================================
      {% if not migration_result.finished | default(false) %}
      âš¡ Migration is actively running in background...
      {% endif %}
  until: migration_result.finished | default(false)
  retries: 360  # æœ€å¤§1æ™‚é–“ (original proven setting)
  delay: 10     # 10ç§’é–“éš” (original proven setting)
  tags: ['migrate', 'monitor']

- name: Display migration results
  debug:
    var: migration_result.stdout_lines
  tags: ['migrate', 'info']

- name: Verify migration completeness (proven logic)
  block:
    - name: Check target bucket file counts
      command: /usr/local/bin/mc ls --recursive {{ target_minio_alias }}/{{ item }}/ | wc -l
      loop: "{{ buckets_to_migrate }}"
      register: target_file_counts
      changed_when: false
      failed_when: false

    - name: Check source bucket file counts
      command: /usr/local/bin/mc ls --recursive {{ source_minio_alias }}/{{ item }}/ | wc -l
      loop: "{{ buckets_to_migrate }}"
      register: source_file_counts
      changed_when: false
      failed_when: false

    - name: Compare file counts
      debug:
        msg: |
          Migration verification:
          {% for i in range(buckets_to_migrate | length) %}
          {{ buckets_to_migrate[i] }}:
            Source: {{ source_file_counts.results[i].stdout | default('N/A') }} files
            Target: {{ target_file_counts.results[i].stdout | default('N/A') }} files
            Status: {% if source_file_counts.results[i].stdout | default('0') == target_file_counts.results[i].stdout | default('0') %}âœ… Match{% else %}âŒ Mismatch{% endif %}
          {% endfor %}
  tags: ['migrate', 'verify']

- name: Display migration completion
  debug:
    msg: |
      âœ… Migration Phase Completed (Proven Logic)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Status: {{ 'Success' if migration_result.rc == 0 else 'Failed' }}
      â”œâ”€ Duration: {{ (ansible_date_time.epoch | int) - (migration_start_time | int) }} seconds
      â”œâ”€ Buckets: {{ buckets_to_migrate | join(', ') }}
      â””â”€ Logic: Based on proven migrate role

      ğŸ“‹ Migration Complete - Original proven logic preserved
  tags: ['migrate', 'info']
