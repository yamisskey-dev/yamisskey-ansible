---
- name: Configure source MinIO alias
  shell: |
    mc alias set {{ source_minio_alias }} \
      http://{{ source_minio_address }}:{{ source_minio_port }} \
      "{{ source_secrets.minio.root_user }}" \
      "{{ source_secrets.minio.root_password }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  no_log: true
  changed_when: false

- name: Configure target MinIO alias (Tunnel)
  shell: |
    mc alias set {{ target_minio_alias }} \
      {{ target_minio_endpoint }} \
      "{{ target_secrets.minio.root_user }}" \
      "{{ target_secrets.minio.root_password }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  no_log: true
  changed_when: false

- name: Test source connectivity
  shell: mc ls {{ source_minio_alias }}/
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  register: source_test
  changed_when: false

- name: Test target connectivity (Tunnel)
  shell: mc ls {{ target_minio_alias }}/
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  register: target_test
  changed_when: false

- name: Create target buckets
  shell: mc mb {{ target_minio_alias }}/{{ item }} --ignore-existing
  loop: "{{ buckets_to_migrate }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  changed_when: false
  loop_control:
    label: "{{ item }}"

- name: Set bucket encryption (KMS)
  shell: |
    mc encrypt set sse-kms "{{ target_secrets.minio.kms_key_id | default('minio-default-key') }}" \
      {{ target_minio_alias }}/{{ item }}
  loop: "{{ buckets_to_migrate }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  when: target_secrets.minio.kms_key_id is defined
  loop_control:
    label: "{{ item }}"
