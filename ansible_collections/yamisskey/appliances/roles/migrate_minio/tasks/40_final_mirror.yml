---
- name: Final incremental sync (non-destructive)
  when:
    - perform_incremental_sync | default(true)
    - not ansible_check_mode
    - not migration_dry_run | default(false)
    - not truenas_skip_health_check | default(false)
  shell: |
    mc mirror \
      --overwrite \
      --preserve \
      --max-workers {{ mc_workers | default(8) }} \
      {{ source_minio_alias | default('source') }}/{{ item }}/ \
      {{ target_minio_alias | default('target') }}/{{ item }}/
  loop: "{{ buckets_to_migrate }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  register: final_inc_results
  retries: 3
  delay: 10
  until: final_inc_results.rc == 0
  loop_control:
    label: "{{ item }}"

- name: Final mirror (destructive sync with --remove)
  when:
    - perform_final_remove | default(false)
    - not ansible_check_mode
    - not migration_dry_run | default(false)
    - not truenas_skip_health_check | default(false)
  shell: |
    mc mirror \
      --overwrite \
      --remove \
      --preserve \
      --max-workers {{ mc_workers | default(8) }} \
      {{ source_minio_alias | default('source') }}/{{ item }}/ \
      {{ target_minio_alias | default('target') }}/{{ item }}/
  loop: "{{ buckets_to_migrate }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  register: final_results
  retries: 3
  delay: 10
  until: final_results.rc == 0
  loop_control:
    label: "{{ item }}"
