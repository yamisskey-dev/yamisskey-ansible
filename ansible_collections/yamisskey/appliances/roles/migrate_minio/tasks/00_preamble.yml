---
- name: Display TrueNAS Cloudflare Tunnel migration plan
  debug:
    msg: |
      ==============================================
      TrueNAS Scale Cloudflare Tunnel Migration
      ==============================================
      Source: {{ source_minio_host | default('source-host') }} ({{ source_minio_ip | default('0.0.0.0') }}:{{ source_minio_port | default('9000') }})
      Target: {{ target_minio_endpoint | default('https://minio.example.invalid') }} (Cloudflare Tunnel)
      Buckets: {{ (buckets_to_migrate | default([])) | join(', ') }}
      Method: MinIO Client via HTTPS (Tunnel)
      Security: End-to-End TLS + Tunnel isolation
      ==============================================

- name: Verify source MinIO connectivity
  uri:
    url: "http://{{ source_minio_address }}:{{ source_minio_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: source_health
  failed_when: source_health.status != 200
  when:
    - not ansible_check_mode
    - not truenas_skip_health_check | default(false)

- name: Wait for TrueNAS MinIO via Cloudflare Tunnel
  uri:
    url: "{{ target_minio_endpoint }}/minio/health/live"
    method: GET
    timeout: 30
    validate_certs: yes
  register: target_health
  retries: 10
  delay: 15
  until: target_health.status == 200
  when:
    - not ansible_check_mode
    - not truenas_skip_health_check | default(false)

- name: Set source credentials from variables
  set_fact:
    source_secrets:
      minio:
        root_user: "{{ source_minio_root_user | default('minioadmin') }}"
        root_password: "{{ source_minio_root_password | default('minioadmin') }}"

- name: Set target credentials from variables
  set_fact:
    target_secrets:
      minio:
        root_user: "{{ truenas_minio_root_user | default('minioadmin') }}"
        root_password: "{{ truenas_minio_root_password | default('minioadmin') }}"
        kms_key_id: "{{ truenas_minio_kms_key | default('minio-default-key') }}"

- name: Set compatibility vars (align with servers-side naming)
  set_fact:
    minio_root_user: "{{ truenas_minio_root_user | default('minioadmin') }}"
    minio_root_password: "{{ truenas_minio_root_password | default('minioadmin') }}"
    minio_kms_master_key: "{{ truenas_minio_kms_key | default('minio-default-key') }}"

- name: Map servers-style vars to appliances-style (domain/token)
  set_fact:
    truenas_minio_domain: "{{ truenas_minio_domain | default(minio_api_server_name | default('minio.example.invalid')) }}"
    truenas_tunnel_token: "{{ truenas_tunnel_token | default(cloudflare_tunnel_token | default('')) }}"

- name: Create migration workspace
  file:
    path: "{{ migration_temp_dir }}"
    state: directory
    mode: '0700'
  register: workspace_result
  changed_when: workspace_result.changed and not (migration_dry_run | default(false))

- name: Check if Minio Client exists
  stat:
    path: /usr/local/bin/mc
  register: mc_check

- name: Download Minio Client (architecture-aware)
  get_url:
    url: "https://dl.min.io/client/mc/release/linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/mc"
    dest: /usr/local/bin/mc
    mode: '0755'
  when:
    - not mc_check.stat.exists
    - not ansible_check_mode
