---
- name: Preflight | Assert required variables
  assert:
    that:
      - truenas_minio_root_user is defined
      - truenas_minio_root_password is defined
      - source_minio_address is defined
      - source_minio_root_user is defined
      - source_minio_root_password is defined
      - mc_release_sha256 is defined
      - mc_release_sha256 | length >= 64
    fail_msg: "Missing required variables for migration. Check host_vars/group_vars (see README Common Variables)."
  when: not truenas_skip_preflight_checks | default(false)

- name: Preflight | Ensure dataset path exists on TrueNAS
  stat:
    path: "{{ truenas_minio_data_path }}"
  register: truenas_data_path
  when: not truenas_skip_preflight_checks | default(false)

- name: Preflight | Fail if dataset path missing
  fail:
    msg: "Dataset path {{ truenas_minio_data_path }} does not exist on TrueNAS. Create dataset or adjust truenas_minio_data_path."
  when:
    - not truenas_skip_preflight_checks | default(false)
    - truenas_data_path is defined
    - not truenas_data_path.stat.exists

- name: Preflight | Check free space on dataset mount
  command: df -h "{{ truenas_minio_data_path }}"
  register: df_out
  changed_when: false
  when: not truenas_skip_preflight_checks | default(false)
