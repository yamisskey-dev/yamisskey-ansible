version: "3.8"
networks: { appnet: {} }

services:
  minio:
    image: quay.io/minio/minio:RELEASE.2025-08-10T00-00-00Z
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_REGION: ap-northeast-3
      MINIO_DOMAIN: ${MINIO_DOMAIN}         # 例: s3.example.com
      MINIO_SERVER_URL: ${MINIO_SERVER_URL} # 例: https://s3.example.com
      MINIO_BROWSER: "off"
      MINIO_COMPRESS: "on"
      MINIO_KMS_SECRET_KEY: ${MINIO_KMS_SECRET_KEY}
      MINIO_KMS_AUTO_ENCRYPTION: "on"
    command: server /data --console-address ":9001"
    volumes:
      - {{ truenas_minio_data_path | default('/mnt/pool/data/minio') }}:/data:rw
    networks: [appnet]
    # healthcheck は未設定（必要なら sidecar で）

  # URL直接アクセス禁止用Nginxプロキシ
  minio-nginx:
    image: nginx:alpine
    restart: unless-stopped
    depends_on: [minio]
    ports:
      - "9000:9000"  # MinIOのAPIポートをプロキシ経由で公開
    volumes:
      - {{ truenas_apps_config_path | default('/mnt/pool/apps') }}/minio/nginx.conf:/etc/nginx/nginx.conf:ro
      - {{ truenas_apps_config_path | default('/mnt/pool/apps') }}/minio/minio.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [appnet]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    depends_on: [minio-nginx]
    command: tunnel run
    environment:
      TUNNEL_TOKEN: ${TUNNEL_TOKEN}
    volumes:
      - {{ truenas_cloudflared_config_path | default('/mnt/pool/apps/cloudflared') }}:/etc/cloudflared:ro
    networks: [appnet]
    # Note: Cloudflare tunnel accesses minio-nginx:9000 internally
