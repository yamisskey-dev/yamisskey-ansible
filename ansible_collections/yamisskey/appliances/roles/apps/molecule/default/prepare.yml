---
- name: Prepare Molecule instance for Nix
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Ensure /tmp/.ansible-tmp exists
      raw: |
        mkdir -p /tmp/.ansible-tmp
        chmod 1777 /tmp/.ansible-tmp
        chown root:root /tmp/.ansible-tmp

    - name: Build python via Nix if missing (pure)
      raw: |
        if [ ! -x /tmp/nix-python/bin/python3 ]; then
          rm -f /tmp/nix-python
          nix --extra-experimental-features 'nix-command flakes' build nixpkgs#python312 -o /tmp/nix-python
        fi

    - name: Confirm python availability
      raw: /tmp/nix-python/bin/python3 --version
