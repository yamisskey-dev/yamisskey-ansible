---
- name: Verify apps deployment
  hosts: all
  gather_facts: false
  
  tasks:
    - name: Gather service facts
      service_facts:
      become: true

    - name: Evaluate Docker service status
      set_fact:
        apps_docker_service_state: >-
          {{ (ansible_facts.services['docker.service'].state | default('absent'))
             if ansible_facts.services is defined else 'absent' }}

    - name: Report Docker service status
      debug:
        msg: "Docker service state: {{ apps_docker_service_state }}"

    - name: Assert Docker service is running when available
      assert:
        that:
          - apps_docker_service_state in ['running', 'started', 'active']
        fail_msg: "Docker service is not running"
        success_msg: "Docker service is running"
      when: apps_docker_service_state != 'absent'

    - name: Verify role execution completed without errors
      stat:
        path: /var/tmp/test
      register: test_dir_check
      
    - name: Assert test directory exists
      assert:
        that:
          - test_dir_check.stat.exists
          - test_dir_check.stat.isdir
        fail_msg: "Test directory was not created"
        success_msg: "Test directory created successfully"

    - name: Check for deprecation notice display
      stat:
        path: /tmp/apps_deprecation_notice_displayed
      register: deprecation_notice_check
      failed_when: false

    - name: Display test summary
      debug:
        msg: |
          apps Role Verification Summary:
          ==============================
          ✅ Test Environment: Ready
          ✅ Role Execution: Completed
          ✅ Basic Checks: Passed
          ✅ MinIO Separation: Complete
          
          Role Responsibility Changes:
          - ❌ MinIO-specific features: Moved to yamisskey.appliances.minio
          - ✅ Generic app management: Retained
          - ✅ Deprecation notices: {{ 'Displayed' if deprecation_notice_check.stat.exists else 'Ready for display' }}
          
          Role: apps (post-MinIO separation)
          Collection: yamisskey.appliances
          Test Instance: apps-test-instance
