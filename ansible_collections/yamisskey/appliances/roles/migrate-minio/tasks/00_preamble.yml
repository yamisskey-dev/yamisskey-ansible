---
- name: Display TrueNAS Cloudflare Tunnel migration plan
  debug:
    msg: |
      ==============================================
      TrueNAS Scale Cloudflare Tunnel Migration
      ==============================================
      Source: {{ source_minio_host | default('source-host') }} ({{ source_minio_ip | default('0.0.0.0') }}:{{ source_minio_port | default('9000') }})
      Target: {{ target_minio_endpoint | default('https://minio.example.invalid') }} (Cloudflare Tunnel)
      Buckets: {{ (buckets_to_migrate | default([])) | join(', ') }}
      Method: MinIO Client via HTTPS (Tunnel)
      Security: End-to-End TLS + Tunnel isolation
      ==============================================

- name: Verify source MinIO connectivity
  uri:
    url: "http://{{ source_minio_address }}:{{ source_minio_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: source_health
  failed_when: source_health.status != 200

- name: Wait for TrueNAS MinIO via Cloudflare Tunnel
  uri:
    url: "{{ target_minio_endpoint }}/minio/health/live"
    method: GET
    timeout: 30
    validate_certs: yes
  register: target_health
  retries: 10
  delay: 15
  until: target_health.status == 200

- name: Set source credentials from variables
  set_fact:
    source_secrets:
      minio:
        root_user: "{{ source_minio_root_user }}"
        root_password: "{{ source_minio_root_password }}"

- name: Set target credentials from variables
  set_fact:
    target_secrets:
      minio:
        root_user: "{{ truenas_minio_root_user }}"
        root_password: "{{ truenas_minio_root_password }}"
        kms_key_id: "{{ truenas_minio_kms_key | default('minio-default-key') }}"

- name: Set compatibility vars (align with servers-side naming)
  set_fact:
    minio_root_user: "{{ truenas_minio_root_user }}"
    minio_root_password: "{{ truenas_minio_root_password }}"
    minio_kms_master_key: "{{ truenas_minio_kms_key | default('minio-default-key') }}"

- name: Map servers-style vars to appliances-style (domain/token)
  set_fact:
    truenas_minio_domain: "{{ truenas_minio_domain | default(minio_api_server_name) }}"
    truenas_tunnel_token: "{{ truenas_tunnel_token | default(cloudflare_tunnel_token) }}"

- name: Create migration workspace
  file:
    path: "{{ migration_temp_dir }}"
    state: directory
    mode: '0700'

- name: Install MinIO client (mc) if not present (pinned)
  get_url:
    url: "https://dl.min.io/client/mc/release/linux-amd64/mc.RELEASE.2025-07-18T00-00-00Z"
    dest: "/usr/local/bin/mc"
    mode: '0755'
    force: no
    checksum: "sha256:{{ mc_release_sha256 }}"
