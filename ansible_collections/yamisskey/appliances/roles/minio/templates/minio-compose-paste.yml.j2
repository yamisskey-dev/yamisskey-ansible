version: "3.8"
networks: { appnet: {} }

services:
  minio:
    image: quay.io/minio/minio:{{ truenas_minio_version | default('RELEASE.2024-10-02T17-50-41Z') }}
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: {{ truenas_minio_root_user | default('minioadmin') | to_json }}
      MINIO_ROOT_PASSWORD: {{ truenas_minio_root_password | default('minioadmin123') | to_json }}
      MINIO_REGION: {{ truenas_minio_region | default('ap-northeast-3') | to_json }}
      MINIO_DOMAIN: {{ truenas_minio_domain | default('minio.example.com') | to_json }}
      MINIO_SERVER_URL: {{ ('https://' ~ (truenas_minio_domain | default('minio.example.com'))) | to_json }}
      MINIO_BROWSER: "off"
      MINIO_COMPRESS: "on"
      MINIO_KMS_SECRET_KEY: {{ truenas_minio_kms_key | default('my-master-key-32-chars-long-123456') | to_json }}
      MINIO_KMS_AUTO_ENCRYPTION: "on"
    command: server /data --console-address ":9001"
    volumes:
      - {{ truenas_minio_data_path | default('/mnt/pool/data/minio') }}:/data:rw
    networks: [appnet]

  cloudflared:
    image: cloudflare/cloudflared:{{ truenas_cloudflared_version | default('latest') }}
    restart: unless-stopped
    command: tunnel run
    environment:
      TUNNEL_TOKEN: {{ truenas_tunnel_token | default('') | to_json }}
    volumes:
      - {{ truenas_cloudflared_config_path | default('/mnt/pool/apps/cloudflared') }}:/etc/cloudflared:ro
    networks: [appnet]
