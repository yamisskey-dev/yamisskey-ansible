---
# TrueNAS SCALE MinIO App Deployment
# 責任: MinIO環境の構築のみ（移行は別ロール）

- name: MinIO TrueNAS Scale Deployment
  debug:
    msg: |
      ==============================================
      TrueNAS Scale MinIO Deployment
      Target: {{ inventory_hostname }}
      App: {{ truenas_minio_app_name }}
      Domain: {{ truenas_minio_domain }}
      ==============================================

# 0) 互換性レイヤ（servers側の命名を受けても動くように）
- name: Load compatibility variable mapping
  import_tasks: 00_compat.yml

# 1) ディレクトリ構造の作成
- name: Ensure MinIO config directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ truenas_apps_config_path }}"
    - "{{ truenas_apps_config_path }}/minio"
    - "{{ truenas_cloudflared_config_path }}"

# 2) 設定ファイルの配備
- name: Deploy cloudflared credentials (named tunnel)
  copy:
    content: "{{ truenas_tunnel_credentials | default('') }}"
    dest: "{{ truenas_cloudflared_config_path }}/{{ truenas_tunnel_id | default('tunnel') }}.json"
    mode: '0600'
  when: truenas_tunnel_id is defined
  no_log: true

- name: Deploy cloudflared config.yml
  template:
    src: cloudflared-config.yml.j2
    dest: "{{ truenas_cloudflared_config_path }}/config.yml"
    mode: '0644'
  when: truenas_minio_domain is defined

- name: Deploy MinIO Nginx main configuration
  template:
    src: minio-nginx-main.conf.j2
    dest: "{{ truenas_apps_config_path }}/minio/nginx.conf"
    mode: '0644'

- name: Deploy MinIO Nginx server configuration
  template:
    src: minio-nginx.conf.j2
    dest: "{{ truenas_apps_config_path }}/minio/minio.conf"
    mode: '0644'

- name: Deploy MinIO docker-compose.yml
  template:
    src: minio-compose.yml.j2
    dest: "{{ truenas_apps_config_path }}/minio/docker-compose.yml"
    mode: '0644'
  register: compose_file_result

# 3) Compose をbase64化（APIに流す用）
- name: Read compose for encoding
  slurp:
    src: "{{ truenas_apps_config_path }}/minio/docker-compose.yml"
  register: compose_slurp_result
  when: truenas_manage_custom_compose | default(true)

- name: Set compose b64 fact
  set_fact:
    truenas_minio_compose_b64: "{{ compose_slurp_result.content }}"
  when: truenas_manage_custom_compose | default(true)

# 4) TrueNAS Custom App への貼り付け可能なcompose出力
- name: Compute compose export directory
  set_fact:
    truenas_compose_export_path: >-
      {{ truenas_compose_export_dir | default((playbook_dir | default('/tmp')) ~ '/out') }}

- name: Ensure local export directory exists
  become: false
  file:
    path: "{{ truenas_compose_export_path }}"
    state: directory
    mode: '0755'

- name: Render paste-ready docker compose
  become: false
  template:
    src: minio-compose-paste.yml.j2
    dest: "{{ truenas_compose_export_path ~ '/minio-docker-compose.paste.yml' }}"
    mode: '0600'
  no_log: true

# 5) アプリケーション管理
- name: Query app existence
  command:
    argv:
      - midclt
      - -j
      - call
      - app.query
      - "{{ ([['name', '=', truenas_minio_app_name]]) | to_json }}"
  register: app_query
  changed_when: false

- name: Set app_exists flag
  set_fact:
    truenas_minio_exists: "{{ (app_query.stdout | from_json | length) > 0 }}"

- name: Gather current app configuration
  when:
    - truenas_minio_exists
    - truenas_update_secrets | default(true)
  command:
    argv:
      - midclt
      - -j
      - call
      - app.config
      - "{{ truenas_minio_app_name }}"
  register: app_config_raw
  changed_when: false

- name: Parse current environment configuration
  when:
    - truenas_minio_exists
    - truenas_update_secrets | default(true)
    - app_config_raw.stdout | default('') | length > 0
  set_fact:
    truenas_minio_current_env: "{{ (app_config_raw.stdout | from_json).environment | default({}) }}"

- name: Ensure current environment fact has default
  when: truenas_update_secrets | default(true)
  set_fact:
    truenas_minio_current_env: "{{ truenas_minio_current_env | default({}) }}"

- name: Build desired environment configuration
  when: truenas_update_secrets | default(true)
  set_fact:
    truenas_minio_desired_env:
      MINIO_ROOT_USER: "{{ truenas_minio_root_user | default(omit, true) }}"
      MINIO_ROOT_PASSWORD: "{{ truenas_minio_root_password | default(omit, true) }}"
      MINIO_KMS_SECRET_KEY: "{{ truenas_minio_kms_key | default(omit, true) }}"
      MINIO_DOMAIN: "{{ truenas_minio_domain | default(omit, true) }}"
      MINIO_SERVER_URL: "{{ ('https://' ~ truenas_minio_domain) if (truenas_minio_domain is defined) else omit }}"
      TUNNEL_TOKEN: "{{ truenas_tunnel_token | default(omit, true) }}"

- name: Determine if environment update is required
  when: truenas_update_secrets | default(true)
  set_fact:
    truenas_minio_env_needs_update: >-
      {{ (truenas_minio_current_env | default({}) | dictsort)
         != (truenas_minio_desired_env | default({}) | dictsort) }}

- name: Create MinIO Custom App (first time)
  when: not truenas_minio_exists
  command:
    argv:
      - midclt
      - -j
      - call
      - app.create
      - >-
        {{ {
             "name": truenas_minio_app_name,
             "custom_compose_config": { "compose": truenas_minio_compose_b64 }
           } | to_json }}
  register: app_create

- name: Update MinIO Custom App (compose changed)
  when:
    - truenas_minio_exists
    - compose_file_result.changed
  command:
    argv:
      - midclt
      - -j
      - call
      - app.update
      - "{{ truenas_minio_app_name }}"
      - >-
        {{ {
             "custom_compose_config": { "compose": truenas_minio_compose_b64 }
           } | to_json }}
  register: app_update

# 6) 環境変数の注入
- name: Inject/Update environment secrets
  command:
    argv:
      - midclt
      - -j
      - call
      - app.update
      - "{{ truenas_minio_app_name }}"
      - >-
        {{ {"environment": truenas_minio_desired_env} | to_json }}
  when:
    - truenas_update_secrets | default(true)
    - (truenas_minio_desired_env | default({}) | length) > 0
    - truenas_minio_env_needs_update | default(false)
  no_log: true
  register: app_env_update

# 7) 変更があれば再デプロイ
- name: Redeploy app if updated
  command:
    argv: [midclt, -j, call, app.redeploy, "{{ truenas_minio_app_name }}"]
  when:
    - truenas_minio_exists
    - (compose_file_result.changed or (app_env_update is defined and app_env_update.changed))

# 8) アプリがRUNNINGになるまで待機
- name: Poll app state until RUNNING
  vars:
    query_payload: "{{ ([['name', '=', truenas_minio_app_name]]) | to_json }}"
  command:
    argv: [midclt, -j, call, app.query, "{{ query_payload }}"]
  register: app_state_raw
  changed_when: false
  retries: 30
  delay: 10
  until: >-
    (app_state_raw.stdout | from_json | length) > 0 and
    (((app_state_raw.stdout | from_json)[0].state | lower) in ['running'])

- name: Parse app state
  set_fact:
    app_state: "{{ (app_state_raw.stdout | from_json)[0] if (app_state_raw.stdout | from_json | length) > 0 else {} }}"

# 9) ヘルスチェック
- name: Health check via Cloudflare Tunnel
  uri:
    url: "https://{{ truenas_minio_domain }}/minio/health/live"
    method: GET
    timeout: 30
    validate_certs: yes
  register: minio_health
  retries: 10
  delay: 12
  until: minio_health.status == 200
  when:
    - not truenas_skip_health_check | default(false)
    - inventory_hostname != 'apps-test-instance'

# 10) バケット・IAM・CORS設定（MinIO構築の一部）
- name: Install MinIO client for bucket/IAM operations
  get_url:
    url: "https://dl.min.io/client/mc/release/linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/mc"
    dest: /usr/local/bin/mc
    mode: '0755'
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Set MinIO client alias for management
  command: >
    /usr/local/bin/mc alias set truenas-mgmt http://{{ truenas_minio_domain }}:{{ truenas_minio_port | default(9000) }}
    "{{ truenas_minio_root_user }}"
    "{{ truenas_minio_root_password }}"
  register: mc_alias_result
  until: mc_alias_result.rc == 0
  retries: 15
  delay: 10
  changed_when: mc_alias_result.rc == 0
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Create MinIO buckets
  command: /usr/local/bin/mc mb truenas-mgmt/{{ item }} --ignore-existing
  loop:
    - "{{ minio_bucket_name_for_misskey | default('files') }}"
    - "{{ minio_bucket_name_for_outline | default('assets') }}"
  register: bucket_create_result
  changed_when: bucket_create_result.rc == 0
  failed_when: false
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Enable bucket encryption (SSE-S3)
  command: /usr/local/bin/mc encrypt set sse-s3 truenas-mgmt/{{ item }}
  loop:
    - "{{ minio_bucket_name_for_misskey | default('files') }}"
    - "{{ minio_bucket_name_for_outline | default('assets') }}"
  register: encryption_result
  failed_when: false
  changed_when: encryption_result.rc == 0
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Create IAM policy template
  copy:
    dest: /tmp/minio_iam_policy.json
    mode: '0600'
    content: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "s3:GetObject",
              "s3:PutObject",
              "s3:DeleteObject",
              "s3:ListBucket"
            ],
            "Resource": [
              "arn:aws:s3:::{{ minio_bucket_name_for_misskey | default('files') }}/*",
              "arn:aws:s3:::{{ minio_bucket_name_for_outline | default('assets') }}/*",
              "arn:aws:s3:::{{ minio_bucket_name_for_misskey | default('files') }}",
              "arn:aws:s3:::{{ minio_bucket_name_for_outline | default('assets') }}"
            ]
          }
        ]
      }
  when: not ansible_check_mode

- name: Generate Misskey S3 access key
  set_fact:
    generated_s3_access_key: "{{ ansible_hostname }}-{{ ansible_date_time.epoch }}"
    generated_s3_secret_key: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when:
    - misskey_s3_access_key is not defined
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Use provided or generated access key
  set_fact:
    final_s3_access_key: "{{ misskey_s3_access_key | default(generated_s3_access_key) }}"
    final_s3_secret_key: "{{ misskey_s3_secret_key | default(generated_s3_secret_key) }}"
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Create IAM user for applications
  command: /usr/local/bin/mc admin user add truenas-mgmt "{{ final_s3_access_key }}" "{{ final_s3_secret_key }}"
  register: iam_user_result
  changed_when: iam_user_result.rc == 0
  failed_when: false
  no_log: true
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Create IAM policy
  command: /usr/local/bin/mc admin policy create truenas-mgmt misskey-policy /tmp/minio_iam_policy.json
  register: policy_create_result
  changed_when: policy_create_result.rc == 0
  failed_when: false
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Attach policy to user
  command: /usr/local/bin/mc admin policy attach truenas-mgmt misskey-policy --user "{{ final_s3_access_key }}"
  register: policy_attach_result
  changed_when: policy_attach_result.rc == 0
  failed_when: false
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Set bucket anonymous policy for federation
  command: /usr/local/bin/mc anonymous set download truenas-mgmt/{{ item }}
  loop:
    - "{{ minio_bucket_name_for_misskey | default('files') }}"
    - "{{ minio_bucket_name_for_outline | default('assets') }}"
  register: bucket_policy_result
  changed_when: bucket_policy_result.rc == 0
  failed_when: false
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

- name: Clean up temporary files
  file:
    path: /tmp/minio_iam_policy.json
    state: absent
  when:
    - not ansible_check_mode
    - not truenas_skip_bucket_iam_setup | default(false)

# 11) デプロイ完了サマリー
- name: MinIO Deployment Summary
  debug:
    msg: |
      ==============================================
      ✅ MinIO Deployed on TrueNAS Scale
      App: {{ truenas_minio_app_name }}
      State: {{ app_state.state | default('unknown') }}
      Public: https://{{ truenas_minio_domain }}
      Health: {{ 'OK' if (minio_health is defined and minio_health.status is defined and minio_health.status == 200) else ('SKIPPED' if (inventory_hostname == 'apps-test-instance') else 'FAILED') }}
      
      ✅ Buckets Created:
        - {{ minio_bucket_name_for_misskey | default('files') }}
        - {{ minio_bucket_name_for_outline | default('assets') }}
      
      ✅ IAM Configuration:
        - User: {{ final_s3_access_key | default('Not configured') }}
        - Policy: misskey-policy (applied)
        - Federation access: enabled
      
      Next Steps:
        1. MinIO is ready for production use
        2. Run migration: ansible-playbook migrate-minio.yml
        3. Update applications with new credentials
      ==============================================
