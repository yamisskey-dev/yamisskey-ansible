---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check MinIO config directories exist
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - /mnt/tank/apps
        - /mnt/tank/apps/minio
        - /mnt/tank/apps/cloudflared
      check_mode: true
      register: dir_check

    - name: Verify configuration files are created
      file:
        path: "{{ item }}"
        state: file
      loop:
        - /mnt/tank/apps/minio/docker-compose.yml
        - /mnt/tank/apps/minio/nginx.conf
        - /mnt/tank/apps/minio/minio.conf
        - /mnt/tank/apps/cloudflared/config.yml
      check_mode: true
      register: file_check

    - name: Check export directory exists
      file:
        path: "{{ playbook_dir | default('/tmp') }}/out"
        state: directory
      check_mode: true
      register: export_check

    - name: Check for bucket creation verification files
      stat:
        path: "{{ item }}"
      loop:
        - /tmp/minio_buckets_created.txt
        - /tmp/minio_iam_configured.txt
      register: bucket_iam_files
      failed_when: false

    - name: Display verification results
      debug:
        msg: |
          MinIO role verification completed:
          - Directories: {{ 'OK' if dir_check is succeeded else 'FAILED' }}
          - Config files: {{ 'OK' if file_check is succeeded else 'FAILED' }}
          - Export directory: {{ 'OK' if export_check is succeeded else 'FAILED' }}
          - Bucket/IAM setup: {{ 'OK' if bucket_iam_files.results | selectattr('stat.exists') | list | length > 0 else 'SKIPPED (no MinIO running)' }}