---
- name: Load Outline secrets from inventory
  set_fact:
    outline_inventory_secrets: "{{ hostvars[inventory_hostname].outline | default({}) }}"

- name: Prepare Outline secret values
  set_fact:
    outline_secret_key: "{{ outline_inventory_secrets.secret_key | default('CHANGE_ME_OUTLINE_SECRET_KEY') }}"
    outline_utils_secret: "{{ outline_inventory_secrets.utils_secret | default('CHANGE_ME_OUTLINE_UTILS_SECRET') }}"
    outline_aws_access_key_id: "{{ outline_inventory_secrets.aws_access_key_id | default('') }}"
    outline_aws_secret_access_key: "{{ outline_inventory_secrets.aws_secret_access_key | default('') }}"
    outline_oidc_client_id: "{{ outline_inventory_secrets.oidc_client_id | default('') }}"
    outline_oidc_client_secret: "{{ outline_inventory_secrets.oidc_client_secret | default('') }}"
    outline_smtp_password: "{{ outline_inventory_secrets.smtp_password | default('') }}"
    outline_slack_client_id: "{{ outline_inventory_secrets.slack_client_id | default('') }}"
    outline_slack_client_secret: "{{ outline_inventory_secrets.slack_client_secret | default('') }}"
    outline_github_client_id: "{{ outline_inventory_secrets.github_client_id | default('') }}"
    outline_github_client_secret: "{{ outline_inventory_secrets.github_client_secret | default('') }}"
    outline_github_app_id: "{{ outline_inventory_secrets.github_app_id | default('') }}"
    outline_github_app_private_key: "{{ outline_inventory_secrets.github_app_private_key | default('') }}"

- name: Warn about placeholder Outline secrets
  debug:
    msg: >-
      Outline secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ outline.{{ item.key }}.
  loop:
    - { key: secret_key, value: "{{ outline_secret_key }}" }
    - { key: utils_secret, value: "{{ outline_utils_secret }}" }
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Create Outline directory
  file:
    path: "{{ outline_dir }}"
    state: directory
    mode: '0755'

- name: Create Docker Compose file
  template:
    src: outline_docker-compose.yml.j2
    dest: "{{ outline_dir }}/docker-compose.yml"
    mode: '0644'
  notify: Restart Outline

- name: Create Outline environment file
  template:
    src: outline_docker.env.yml.j2
    dest: "{{ outline_dir }}/docker.env"
    mode: '0600'
  notify: Restart Outline

- name: Start Outline services with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ outline_dir }}"
    pull: "{{ 'never' if (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != '' else 'missing' }}"
    remove_orphans: true
  failed_when: false
  register: outline_compose_result
  changed_when: outline_compose_result.changed | default(false)
  when:
    - (ansible_env.MOLECULE_SCENARIO_NAME | default('')) == ''
    - ansible_virtualization_type | default('') not in ['docker', 'container']

- name: Start Outline services with Docker Compose v2 (test environment)
  community.docker.docker_compose_v2:
    project_src: "{{ outline_dir }}"
    pull: never
    remove_orphans: true
  failed_when: false
  register: outline_compose_test_result
  changed_when: false
  when: (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != ''
