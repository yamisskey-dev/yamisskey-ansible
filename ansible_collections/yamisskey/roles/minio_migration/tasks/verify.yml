---
# MinIO Migration Role - Verification Tasks
# Post-migration verification and testing

- name: Display verification phase banner
  debug:
    msg: |
      ğŸ” Verification Phase: Post-Migration Checks
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ File count verification
      â”œâ”€ Data integrity checks
      â”œâ”€ Encryption verification
      â”œâ”€ API access testing
      â””â”€ Application configuration guidance
  tags: ['verify', 'info']

- name: Verify migration completeness
  block:
    - name: Check target bucket file counts
      command: /usr/local/bin/mc ls --recursive {{ target_minio_alias }}/{{ item }}/ | wc -l
      loop: "{{ buckets_to_migrate }}"
      register: target_file_counts
      changed_when: false
      failed_when: false

    - name: Check source bucket file counts
      command: /usr/local/bin/mc ls --recursive {{ source_minio_alias }}/{{ item }}/ | wc -l
      loop: "{{ buckets_to_migrate }}"
      register: source_file_counts
      changed_when: false
      failed_when: false

    - name: Compare file counts
      debug:
        msg: |
          Migration verification:
          {% for i in range(buckets_to_migrate | length) %}
          {{ buckets_to_migrate[i] }}:
            Source: {{ source_file_counts.results[i].stdout | default('N/A') }} files
            Target: {{ target_file_counts.results[i].stdout | default('N/A') }} files
            Status: {% if source_file_counts.results[i].stdout | default('0') == target_file_counts.results[i].stdout | default('0') %}âœ… Match{% else %}âŒ Mismatch{% endif %}
          {% endfor %}

    - name: Set verification status
      set_fact:
        migration_verified: >-
          {% set ns = namespace(verified=true) %}
          {% for i in range(buckets_to_migrate | length) %}
          {% if source_file_counts.results[i].stdout | default('0') != target_file_counts.results[i].stdout | default('0') %}
          {% set ns.verified = false %}
          {% endif %}
          {% endfor %}
          {{ ns.verified }}
  tags: ['verify', 'counts']

- name: Verify encryption status (if enabled)
  block:
    - name: Check sample file encryption on disk
      shell: |
        SAMPLE_FILE=$(ls {{ migration_temp_dir }}/../**/{{ minio_bucket_name_for_misskey }}/ 2>/dev/null | head -1)
        if [ -n "$SAMPLE_FILE" ]; then
          file "$SAMPLE_FILE"
        else
          echo "No files found to check encryption"
        fi
      register: encryption_check
      changed_when: false
      failed_when: false

    - name: Display encryption verification
      debug:
        msg: |
          Encryption verification:
          {{ encryption_check.stdout }}
          {% if 'data' in encryption_check.stdout %}
          âœ… Files are encrypted on disk
          {% else %}
          âš ï¸ Files may not be encrypted (or check inconclusive)
          {% endif %}
  when: enable_encryption | default(true)
  tags: ['verify', 'encryption']

- name: Test API access functionality
  block:
    - name: Test MinIO API access with sample file
      shell: |
        SAMPLE_FILE=$(mc ls {{ target_minio_alias }}/{{ minio_bucket_name_for_misskey }}/ | head -1 | awk '{print $NF}')
        if [ -n "$SAMPLE_FILE" ]; then
          mc cat {{ target_minio_alias }}/{{ minio_bucket_name_for_misskey }}/"$SAMPLE_FILE" | file -
        else
          echo "No files found to test API access"
        fi
      register: api_test
      changed_when: false
      failed_when: false

    - name: Display API access test results
      debug:
        msg: |
          API Access Test:
          {{ api_test.stdout }}
          {% if 'image' in api_test.stdout or 'text' in api_test.stdout or 'data' in api_test.stdout %}
          âœ… MinIO API correctly decrypts and serves files
          {% else %}
          âš ï¸ API access test inconclusive
          {% endif %}
  tags: ['verify', 'api']

- name: Verify target MinIO health
  block:
    - name: Check target MinIO health endpoint
      uri:
        url: "http://localhost:{{ target_minio_port }}/minio/health/live"
        method: GET
        timeout: 10
      register: target_health_verify

    - name: Check target MinIO readiness
      uri:
        url: "http://localhost:{{ target_minio_port }}/minio/health/ready"
        method: GET
        timeout: 10
      register: target_ready_verify
      failed_when: false

    - name: Display health verification
      debug:
        msg: |
          Target MinIO Health Check:
          â”œâ”€ Live: {{ 'âœ… Healthy' if target_health_verify.status == 200 else 'âŒ Unhealthy' }}
          â””â”€ Ready: {{ 'âœ… Ready' if target_ready_verify.status == 200 else 'âš ï¸ Not Ready' }}
  tags: ['verify', 'health']

- name: Generate verification report
  block:
    - name: Create comprehensive verification report
      copy:
        content: |
          # MinIO Migration Verification Report

          **Generated:** {{ ansible_date_time.iso8601 }}
          **Host:** {{ inventory_hostname }}
          **Migration Status:** {{ 'âœ… VERIFIED' if migration_verified else 'âŒ FAILED' }}

          ## Migration Configuration
          - **Source:** {{ source_minio_host }}:{{ source_minio_port }}
          - **Target:** {{ target_minio_host }}:{{ target_minio_port }}
          - **Buckets:** {{ buckets_to_migrate | join(', ') }}
          - **Encryption:** {{ 'Enabled' if enable_encryption else 'Disabled' }}

          ## File Count Verification
          {% for i in range(buckets_to_migrate | length) %}
          ### {{ buckets_to_migrate[i] }}
          - Source Files: {{ source_file_counts.results[i].stdout | default('N/A') }}
          - Target Files: {{ target_file_counts.results[i].stdout | default('N/A') }}
          - Status: {% if source_file_counts.results[i].stdout | default('0') == target_file_counts.results[i].stdout | default('0') %}âœ… Verified{% else %}âŒ Mismatch{% endif %}

          {% endfor %}

          ## Service Health
          - Target MinIO Live: {{ 'âœ… Healthy' if target_health_verify.status == 200 else 'âŒ Unhealthy' }}
          - Target MinIO Ready: {{ 'âœ… Ready' if target_ready_verify.status == 200 else 'âš ï¸ Not Ready' }}

          ## API Access Test
          - API Functionality: {{ 'âœ… Working' if 'image' in api_test.stdout or 'text' in api_test.stdout or 'data' in api_test.stdout else 'âš ï¸ Needs Review' }}

          {% if enable_encryption %}
          ## Encryption Status
          - Disk Encryption: {{ 'âœ… Verified' if 'data' in encryption_check.stdout else 'âš ï¸ Inconclusive' }}
          {% endif %}

          ## Next Steps
          {% if migration_verified %}
          1. âœ… Update application configurations with new MinIO endpoint
          2. âœ… Test file upload/download functionality in applications
          3. âœ… Verify federation image display (if applicable)
          4. âœ… Update DNS records if needed
          5. âœ… Consider stopping source MinIO after thorough testing
          {% else %}
          1. âŒ Review file count mismatches
          2. âŒ Check migration logs for errors
          3. âŒ Re-run migration if necessary
          4. âŒ Contact support if issues persist
          {% endif %}
        dest: "{{ report_output_dir }}/verification_report_{{ ansible_date_time.epoch }}.md"
        mode: '0644'
      when: generate_validation_report | default(true)

    - name: Display verification report location
      debug:
        msg: "ğŸ“„ Verification report saved: {{ report_output_dir }}/verification_report_{{ ansible_date_time.epoch }}.md"
      when: generate_validation_report | default(true)
  tags: ['verify', 'report']

- name: Display application configuration guidance
  debug:
    msg: |
      ğŸ”§ Application Configuration Update Required
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ“ Misskey Configuration:
      Update .env file on {{ source_minio_host }}:
      ```
      S3_ENDPOINT=http://{{ ansible_default_ipv4.address }}:{{ target_minio_port }}
      S3_ACCESS_KEY={{ target_secrets.minio.root_user if target_secrets is defined else 'UPDATE_ME' }}
      S3_SECRET_KEY={{ target_secrets.minio.root_password if target_secrets is defined else 'UPDATE_ME' }}
      ```

      ğŸ“ Outline Configuration:
      ```
      AWS_ACCESS_KEY_ID={{ target_secrets.minio.root_user if target_secrets is defined else 'UPDATE_ME' }}
      AWS_SECRET_ACCESS_KEY={{ target_secrets.minio.root_password if target_secrets is defined else 'UPDATE_ME' }}
      AWS_S3_UPLOAD_BUCKET_URL=http://{{ ansible_default_ipv4.address }}:{{ target_minio_port }}
      ```

      ğŸŒ DNS Update (if applicable):
      drive.yami.ski â†’ {{ ansible_default_ipv4.address }}
  tags: ['verify', 'config', 'info']

- name: Fail if verification failed
  fail:
    msg: |
      âŒ Migration verification failed!
      File counts do not match between source and target.
      Please check the migration logs and consider re-running the migration.
  when: not migration_verified and fail_on_validation_error | default(true)
  tags: ['verify']

- name: Display verification completion
  debug:
    msg: |
      âœ… Verification Phase Completed
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Migration Status: {{ 'âœ… VERIFIED' if migration_verified else 'âŒ FAILED' }}
      â”œâ”€ File Counts: {{ 'âœ… Match' if migration_verified else 'âŒ Mismatch' }}
      â”œâ”€ API Access: âœ… Tested
      {% if enable_encryption %}
      â”œâ”€ Encryption: âœ… Checked
      {% endif %}
      â””â”€ Health: âœ… Verified

      {% if migration_verified %}
      ğŸ‰ Migration completed successfully!
      Your MinIO data has been successfully migrated with verification.
      {% else %}
      âš ï¸ Migration verification failed. Please review and re-run if needed.
      {% endif %}
  tags: ['verify', 'info']
