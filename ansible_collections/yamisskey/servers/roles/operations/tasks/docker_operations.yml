---
# Status Operation
- name: Get Docker container status
  shell: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Ports{{ '}}' }}"
  register: docker_status
  changed_when: false
  when: operation == 'status'

- name: Get specific service status
  shell: |
    cd {{ single_service_dir }}
    echo "=== Status for {{ target_service }} ==="
    docker compose ps
  register: service_status
  changed_when: false
  failed_when: false
  when: operation == 'status' and target_service != 'all'

- name: Display status results
  ansible.builtin.debug:
    msg: |
      {% if target_service == 'all' %}
      üê≥ All Docker Containers:
      {{ docker_status.stdout_lines | join('\n') }}
      {% else %}
      {{ service_status.stdout_lines | join('\n') }}
      {% endif %}
  when: operation == 'status'

# Service Management Operations
- name: Check if docker-compose.yml exists for specific service
  ansible.builtin.stat:
    path: "{{ single_service_dir }}/docker-compose.yml"
  register: compose_file_check
  when: operation in ['restart', 'stop', 'start', 'update'] and target_service != 'all'

- name: Warn if docker-compose.yml not found
  ansible.builtin.debug:
    msg: "‚ö†Ô∏è docker-compose.yml not found in {{ single_service_dir }}. Skipping {{ operation }} for {{ target_service }}."
  when:
    - operation in ['restart', 'stop', 'start', 'update']
    - target_service != 'all'
    - not compose_file_check.stat.exists

- name: Check for docker-compose.yml in each service directory
  ansible.builtin.stat:
    path: "{{ item.path }}/docker-compose.yml"
  register: compose_files_check
  loop: "{{ service_dirs.files }}"
  when: operation in ['restart', 'stop', 'start', 'update'] and target_service == 'all'

# Restart Operations
- name: Restart specific service
  shell: |
    cd {{ single_service_dir }}
    echo "Restarting {{ target_service }}..."
    docker compose restart
  register: restart_result
  when:
    - operation == 'restart'
    - target_service != 'all'
    - compose_file_check.stat.exists

- name: Restart all services
  shell: |
    cd {{ item.item.path }}
    echo "Restarting service in {{ item.item.path }}"
    docker compose restart
  register: restart_all_result
  failed_when: false
  loop: "{{ compose_files_check.results }}"
  when:
    - operation == 'restart'
    - target_service == 'all'
    - item.stat.exists

# Stop/Start Operations
- name: Stop/Start specific service
  shell: |
    cd {{ single_service_dir }}
    echo "{{ operation | title }}ping {{ target_service }}..."
    docker compose {{ operation }}
  register: stop_start_result
  when:
    - operation in ['stop', 'start']
    - target_service != 'all'
    - compose_file_check.stat.exists

- name: Stop/Start all services
  shell: |
    cd {{ item.path }}
    echo "{{ operation | title }}ping service in {{ item.path }}"
    docker compose {{ operation }}
  register: stop_start_all_result
  failed_when: false
  loop: "{{ service_dirs.files }}"
  when: operation in ['stop', 'start'] and target_service == 'all'

# Update Operations
- name: Update specific service
  shell: |
    cd {{ single_service_dir }}
    echo "Updating {{ target_service }}..."
    docker compose pull
    docker compose up -d
  register: update_result
  when:
    - operation == 'update'
    - target_service != 'all'
    - compose_file_check.stat.exists

- name: Update all services
  shell: |
    cd {{ item.path }}
    echo "Updating service in {{ item.path }}"
    docker compose pull
    docker compose up -d
  register: update_all_result
  failed_when: false
  loop: "{{ service_dirs.files }}"
  when: operation == 'update' and target_service == 'all'

# Cleanup Operations
- name: Docker system cleanup
  shell: |
    echo "üßπ Cleaning up Docker system..."
    docker system prune -f
    docker volume prune -f
    docker image prune -f
  register: cleanup_result
  when: operation == 'cleanup'

# Results Display
- name: Display Docker operation results
  ansible.builtin.debug:
    msg: |
      {% if operation == 'restart' %}
      üîÑ Restart Results:
      {% if target_service != 'all' %}
      {{ restart_result.stdout_lines | join('\n') }}
      {% else %}
      {% for result in restart_all_result.results %}
      {{ result.stdout_lines | join('\n') }}
      {% endfor %}
      {% endif %}
      {% elif operation in ['stop', 'start'] %}
      {{ operation | title }} Results:
      {% if target_service != 'all' %}
      {{ stop_start_result.stdout_lines | join('\n') }}
      {% else %}
      {% for result in stop_start_all_result.results %}
      {{ result.stdout_lines | join('\n') }}
      {% endfor %}
      {% endif %}
      {% elif operation == 'update' %}
      üì¶ Update Results:
      {% if target_service != 'all' %}
      {{ update_result.stdout_lines | join('\n') }}
      {% else %}
      {% for result in update_all_result.results %}
      {{ result.stdout_lines | join('\n') }}
      {% endfor %}
      {% endif %}
      {% elif operation == 'cleanup' %}
      üßπ Cleanup Results:
      {{ cleanup_result.stdout_lines | join('\n') }}
      {% endif %}
  when: operation in ['restart', 'stop', 'start', 'update', 'cleanup']

# Final Status Check
- name: Final status check after operations
  shell: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
  register: final_status
  changed_when: false
  when: operation in ['restart', 'start', 'update']

- name: Display final status
  ansible.builtin.debug:
    msg: |
      üìä Final Service Status:
      {{ final_status.stdout_lines | join('\n') }}
  when: operation in ['restart', 'start', 'update']
