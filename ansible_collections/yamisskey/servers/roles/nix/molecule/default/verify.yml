---
- name: Verify Nix installation
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Test - Nix binary should be discoverable via multiple methods
      block:
        - name: Test 1 - Direct binary existence check
          stat:
            path: "{{ item }}"
          register: binary_check
          loop:
            - /root/.nix-profile/bin/nix
            - /nix/var/nix/profiles/default/bin/nix
            - /usr/local/bin/nix
          failed_when: false

        - name: Test 2 - Profile script should source successfully
          shell: |
            set -e
            for script in \
              /root/.nix-profile/etc/profile.d/nix.sh \
              /nix/var/nix/profiles/default/etc/profile.d/nix.sh \
              /etc/profile.d/nix.sh; do
              if [ -f "$script" ]; then
                echo "Found script: $script"
                . "$script"
                command -v nix && echo "SUCCESS: nix command available after sourcing $script"
                exit 0
              fi
            done
            echo "ERROR: No working profile script found"
            exit 1
          register: profile_test
          failed_when: false

        - name: Test 3 - Nix binary should be in PATH after profile sourcing
          shell: |
            set -e
            # Try to source profile and find nix
            for script in \
              /root/.nix-profile/etc/profile.d/nix.sh \
              /nix/var/nix/profiles/default/etc/profile.d/nix.sh \
              /etc/profile.d/nix.sh; do
              if [ -f "$script" ]; then
                . "$script"
                if command -v nix >/dev/null 2>&1; then
                  nix --version
                  exit 0
                fi
              fi
            done
            echo "ERROR: nix command not found after sourcing profiles"
            exit 1
          register: nix_version_test

        - name: Display test results
          debug:
            msg: |
              Binary existence tests: {{ binary_check.results | map(attribute='stat.exists') | list }}
              Profile script test: {{ 'PASSED' if profile_test.rc == 0 else 'FAILED' }}
              Nix version test: {{ 'PASSED' if nix_version_test.rc == 0 else 'FAILED' }}

        - name: Verify at least one test method succeeded
          assert:
            that:
              - nix_version_test.rc == 0
            fail_msg: "Nix installation verification failed - binary not accessible via profile scripts"
            success_msg: "Nix installation verified successfully"
