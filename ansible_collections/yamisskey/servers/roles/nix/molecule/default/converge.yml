---
- name: Converge nix role
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for instance SSH availability
      wait_for_connection:
        timeout: 30

  tasks:
    - name: Apply nix role
      include_role:
        name: yamisskey.servers.nix

    - name: Display nix role result context
      debug:
        msg: "Nix role applied"

  post_tasks:
    - name: Capture Nix environment details
      shell: |
        . /root/.nix-profile/etc/profile.d/nix.sh
        nix --version
      register: nix_env_details
      changed_when: false

    - name: Show Nix environment details
      debug:
        var: nix_env_details.stdout_lines
