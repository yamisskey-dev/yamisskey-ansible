---
- name: Check if Nix binary already exists
  ansible.builtin.stat:
    path: /root/.nix-profile/bin/nix
  register: nix_binary

- name: Install Nix prerequisites on APT-based systems
  ansible.builtin.apt:
    update_cache: true
    name:
      - curl
      - ca-certificates
      - xz-utils
  when:
    - ansible_pkg_mgr == 'apt'
    - not nix_binary.stat.exists

- name: Install Nix prerequisites on Portage-based systems
  ansible.builtin.package:
    name:
      - net-misc/curl
      - app-misc/ca-certificates
      - app-arch/xz-utils
    state: present
  when:
    - ansible_pkg_mgr == 'portage'
    - not nix_binary.stat.exists

- name: Ensure Nix is installed (single-user)
  ansible.builtin.shell: |
    set -euo pipefail
    curl --proto '=https' --tlsv1.2 -sSf https://nixos.org/nix/install | sh -s -- --no-daemon
  args:
    executable: /bin/bash
    creates: /root/.nix-profile/bin/nix
  when: not nix_binary.stat.exists

- name: Refresh Nix binary fact
  ansible.builtin.stat:
    path: /root/.nix-profile/bin/nix
  register: nix_binary

- name: Locate potential Nix profile scripts
  ansible.builtin.stat:
    path: "{{ item }}"
  register: nix_profile_candidates
  loop:
    - /root/.nix-profile/etc/profile.d/nix.sh
    - /root/.nix-profile/etc/profile.d/nix-daemon.sh

- name: Determine Nix profile script path
  ansible.builtin.set_fact:
    nix_profile_script_path: "{{ item.stat.path }}"
  loop: "{{ nix_profile_candidates.results }}"
  when: item.stat.exists
  loop_control:
    label: "{{ item.stat.path }}"

- name: Fail if no Nix profile script was found
  ansible.builtin.fail:
    msg: "Nix profile script not found after installation"
  when: nix_profile_script_path is not defined

- name: Ensure Nix profile is loaded in root shells
  ansible.builtin.lineinfile:
    path: /root/.bashrc
    line: '. {{ nix_profile_script_path }}'
    state: present
  when: nix_profile_script_path is defined

- name: Verify Nix installation
  ansible.builtin.shell: |
    set -euo pipefail
    . {{ nix_profile_script_path }}
    nix --version
  args:
    executable: /bin/bash
  when: nix_profile_script_path is defined
  changed_when: false

- name: Ensure nix binary is globally available
  ansible.builtin.file:
    src: /root/.nix-profile/bin/nix
    dest: /usr/local/bin/nix
    state: link
    force: true
    follow: false
  when: nix_binary.stat.exists

- name: Check if Home Manager command exists
  ansible.builtin.shell: |
    . {{ nix_profile_script_path }}
    command -v home-manager
  args:
    executable: /bin/bash
  register: home_manager_available
  changed_when: false
  failed_when: false
  when: nix_profile_script_path is defined
  environment:
    PATH: "/root/.nix-profile/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"

- name: Install Home Manager
  ansible.builtin.shell: |
    set -euo pipefail
    . {{ nix_profile_script_path }}
    nix-channel --add https://github.com/nix-community/home-manager/archive/release-23.11.tar.gz home-manager
    nix-channel --update
    nix-shell '<home-manager>' -A install
  args:
    executable: /bin/bash
  when:
    - nix_profile_script_path is defined
    - home_manager_available.rc != 0
  environment:
    PATH: "/root/.nix-profile/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
  become: false

- name: Determine Home Manager configuration profile
  ansible.builtin.set_fact:
    resolved_home_manager_config: "{{ home_manager_config | default(nix_home_manager_config | default('server')) }}"
  when: nix_profile_script_path is defined

- name: Ensure Home Manager configuration directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/home-manager"
    state: directory
    mode: '0755'
  become: false
  when: nix_profile_script_path is defined

- name: Deploy Home Manager configuration
  ansible.builtin.template:
    src: home.nix.j2
    dest: "{{ ansible_user_dir }}/.config/home-manager/home.nix"
    mode: '0644'
  become: false
  when: nix_profile_script_path is defined
  vars:
    home_manager_config: "{{ resolved_home_manager_config }}"

- name: Apply Home Manager configuration
  ansible.builtin.command: home-manager switch
  become: false
  register: home_manager_switch
  changed_when: "'Building' in home_manager_switch.stderr"
  when: nix_profile_script_path is defined
  environment:
    PATH: "/root/.nix-profile/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
