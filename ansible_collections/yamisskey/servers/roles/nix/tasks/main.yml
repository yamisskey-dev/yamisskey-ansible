---
- name: Check if Nix is already installed
  become: false
  ansible.builtin.command: nix --version
  register: nix_version_check
  changed_when: false
  failed_when: false

- name: Record Nix installation status
  ansible.builtin.set_fact:
    nix_already_installed: "{{ nix_version_check.rc == 0 }}"

- name: Install Nix prerequisites on Debian-based systems
  ansible.builtin.apt:
    update_cache: true
    name:
      - curl
      - ca-certificates
      - xz-utils
    state: present
  when:
    - ansible_os_family == 'Debian'
    - not nix_already_installed
  become: true

- name: Install Nix prerequisites on RedHat-based systems
  ansible.builtin.yum:
    name:
      - curl
      - ca-certificates
      - xz
    state: present
  when:
    - ansible_os_family == 'RedHat'
    - not nix_already_installed
  become: true

- name: Decide Nix installer mode
  ansible.builtin.set_fact:
    nix_install_effective_mode: >-
      {{
        (nix_install_mode | default('auto')) != 'auto'
        | ternary(
            nix_install_mode,
            (ansible_user_id == 'root') | ternary('daemon', 'no-daemon')
          )
      }}

- name: Install Nix
  ansible.builtin.shell: |
    set -eu
    curl -L --fail https://nixos.org/nix/install | sh -s -- --{{ nix_install_effective_mode }} --yes
  args:
    executable: /bin/sh
  when: not nix_already_installed
  register: nix_install_result

- name: Ensure Nix profile is sourced for the remote user
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: '. {{ ansible_user_dir }}/.nix-profile/etc/profile.d/nix.sh'
    state: present
    create: true

- name: Verify Nix installation
  ansible.builtin.shell: |
    set -eu
    if [ -f "{{ ansible_user_dir }}/.nix-profile/etc/profile.d/nix.sh" ]; then
      . "{{ ansible_user_dir }}/.nix-profile/etc/profile.d/nix.sh"
    fi
    nix --version
  args:
    executable: /bin/sh
  register: nix_verify
  changed_when: false

- name: Display Nix version
  ansible.builtin.debug:
    msg: "Nix version: {{ nix_verify.stdout | default('Unavailable') }}"
