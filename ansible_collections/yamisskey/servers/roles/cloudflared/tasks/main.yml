---
# Cloudflared role with full automation capabilities
# Supports both manual (make install) and automatic installation modes

# Installation phase (conditional based on cloudflared_skip_install)
- name: Install cloudflared
  include_tasks: install.yml
  when: not cloudflared_skip_install

# Directory setup
- name: Ensure cloudflared config directory exists
  file:
    path: "{{ cloudflared_config_dir }}"
    state: directory
    owner: "{{ cloudflared_user }}"
    ansible.builtin.file: "{{ cloudflared_group }}"
    mode: '0755'

- name: Ensure system cloudflared config directory exists
  file:
    path: "{{ cloudflared_system_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

# Tunnel management (if API credentials are provided)
- name: Create and configure tunnel
  include_tasks: tunnel_create.yml
  when:
    - cloudflare_api_token is defined
    - cloudflare_zone_id is defined
    - cloudflare_account_id is defined

# DNS management (if API credentials and tunnel creation was successful)
- name: Update DNS records
  include_tasks: dns_update.yml
  when:
    - cloudflare_api_token is defined
    - cloudflare_zone_id is defined
    - tunnel_uuid is defined

# Configuration deployment
- name: Deploy configuration
  include_tasks: config_deploy.yml

# Service setup
- name: Setup systemd service
  include_tasks: service_setup.yml

# Verification
- name: Verify tunnel connectivity
  include_tasks: verify.yml
  when: tunnel_uuid is defined

# Display status (enhanced with automation info)
- name: Display cloudflared setup status
  debug:
    msg: |
      =============================================================
      CLOUDFLARED CONFIGURATION {{ 'FULLY AUTOMATED' if tunnel_uuid is defined else 'DEPLOYED' }}
      =============================================================

      âœ… Configuration: {{ cloudflared_config_dir }}/config.yml
      âœ… MinIO routing: {{ cloudflared_hostname }} â†’ localhost:{{ cloudflared_service_port }}
      {% if tunnel_uuid is defined %}
      âœ… Tunnel: {{ cloudflared_tunnel_name }} ({{ tunnel_uuid }})
      âœ… DNS: {{ cloudflared_hostname }} â†’ {{ tunnel_uuid }}.cfargotunnel.com
      âœ… Service: systemd cloudflared.service installed and running
      {% else %}

      ðŸ“‹ Manual steps required (follow project README.md):

      1. Install cloudflared (if not using automation):
         make install

      2. Login and create tunnel:
         cloudflared tunnel login
         cloudflared tunnel create {{ cloudflared_tunnel_name }}
         cloudflared tunnel route dns {{ cloudflared_tunnel_name }} {{ cloudflared_hostname }}

      3. Update config with tunnel UUID:
         Edit {{ cloudflared_config_dir }}/config.yml
         Replace <Tunnel-UUID> with actual tunnel UUID

      4. Setup systemd service:
         sudo mkdir -p {{ cloudflared_system_config_dir }}
         sudo cp {{ cloudflared_config_dir }}/config.yml {{ cloudflared_system_config_dir }}/
         sudo cloudflared service install
         sudo systemctl enable cloudflared
         sudo systemctl start cloudflared
      {% endif %}

      ðŸ“Š Service status: {{ cloudflared_service_status.status.ActiveState | default('not installed') }}
      ðŸ”— Expected URL: https://{{ cloudflared_hostname }}
      =============================================================

# Store service status for display
- name: Check cloudflared service status
  systemd:
    name: cloudflared
  register: cloudflared_service_status
  failed_when: false
