---
# Cloudflared Connectivity Verification

- name: Wait for tunnel to be ready
  ansible.builtin.pause:
    seconds: 15

- name: Test tunnel connectivity
  uri:
    url: "https://{{ item }}/cdn-cgi/trace"
    method: GET
    timeout: 30
    validate_certs: true
  loop: "{{ cloudflared_hostnames }}"
  register: connectivity_test
  retries: 5
  delay: 10
  failed_when: false

- name: Display connectivity test results
  debug:
    msg: |
      Connectivity Test Results:
      {% for result in connectivity_test.results %}
      {{ result.item }}: {{ 'OK' if result.status == 200 else 'FAILED (' + (result.status | string) + ')' }}
      {% endfor %}

- name: Test specific service endpoints
  uri:
    url: "https://{{ item }}/minio/health/live"
    method: GET
    timeout: 30
    validate_certs: true
  loop:
    - "drive.{{ domain }}"
  register: service_test
  retries: 3
  delay: 5
  failed_when: false
  when: "'drive.' in item"

- name: Display service test results
  debug:
    msg: |
      Service Test Results:
      {% for result in service_test.results %}
      {% if result.item is defined %}
      {{ result.item }}: {{ 'OK' if result.status == 200 else 'FAILED (' + (result.status | string) + ')' }}
      {% endif %}
      {% endfor %}
  when: service_test.results is defined

- name: Get tunnel status
  command: cloudflared tunnel --config {{ cloudflared_config_file }} info {{ cloudflared_tunnel_name }}
  register: tunnel_info
  changed_when: false
  failed_when: false

- name: Display tunnel information
  debug:
    msg: |
      Tunnel Status:
      {{ tunnel_info.stdout if tunnel_info.rc == 0 else tunnel_info.stderr }}

- name: Final verification summary
  debug:
    msg: |
      ==============================================
      Cloudflared Verification Summary
      ==============================================
      Tunnel Name: {{ cloudflared_tunnel_name }}
      Tunnel UUID: {{ cloudflared_tunnel_uuid }}

      Status Checks:
      {% for result in connectivity_test.results %}
      - {{ result.item }}: {{ 'PASS' if result.status == 200 else 'FAIL' }}
      {% endfor %}

      Next Steps:
      1. Verify all services are accessible
      2. Test application functionality
      3. Monitor tunnel health
      ==============================================
