---
- name: Load Authentik secrets from inventory
  set_fact:
    authentik_inventory_secrets: "{{ hostvars[inventory_hostname].authentik | default({}) }}"
    authentik_inventory_postgresql: "{{ (hostvars[inventory_hostname].authentik | default({})).postgresql | default({}) }}"

- name: Prepare Authentik secret values
  set_fact:
    authentik_secret_key: "{{ authentik_inventory_secrets.secret_key | default('CHANGE_ME_AUTHENTIK_SECRET_KEY') }}"
    postgresql_user: "{{ authentik_inventory_postgresql.user | default('authentik') }}"
    postgresql_password: "{{ authentik_inventory_postgresql.password | default('CHANGE_ME_AUTHENTIK_DB_PASSWORD') }}"
    postgresql_database: "{{ authentik_inventory_postgresql.database | default('authentik') }}"

- name: Warn about placeholder Authentik secrets
  debug:
    msg: >-
      Authentik secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ authentik.{{ item.key }}.
  loop:
    - { key: secret_key, value: "{{ authentik_secret_key }}" }
    - { key: postgresql_password, value: "{{ postgresql_password }}" }
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Create Authentik directory
  file:
    path: "{{ authentik_dir }}"
    state: directory
    mode: '0755'

- name: Create Authentik data directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ authentik_dir }}/media"
    - "{{ authentik_dir }}/certs"
    - "{{ authentik_dir }}/custom-templates"

- name: Create Docker Compose file
  template:
    src: authentik_docker-compose.yml.j2
    dest: "{{ authentik_dir }}/docker-compose.yml"
    mode: '0644'

- name: Start Authentik services with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ authentik_dir }}"
    pull: "{{ 'never' if (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != '' else 'missing' }}"
    remove_orphans: true
  failed_when: false
  register: authentik_compose_result
  changed_when: authentik_compose_result.changed | default(false)
  when:
    - (ansible_env.MOLECULE_SCENARIO_NAME | default('')) == ''
    - ansible_virtualization_type | default('') not in ['docker', 'container']

- name: Start Authentik services with Docker Compose v2 (test environment)
  community.docker.docker_compose_v2:
    project_src: "{{ authentik_dir }}"
    pull: never
    remove_orphans: true
  failed_when: false
  register: authentik_compose_test_result
  changed_when: false
  when: (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != ''
