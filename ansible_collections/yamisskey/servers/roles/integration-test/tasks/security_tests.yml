---
# Integration Test - Security Tests
# Tests security configurations and vulnerabilities

- name: Test SSL/TLS certificate validity
  uri:
    url: "https://{{ ansible_default_ipv4.address | default('localhost') }}"
    method: GET
    validate_certs: true
    timeout: 10
  register: ssl_cert_test
  failed_when: false
  when: security_checks.ssl_validation | default(true)
  tags: ['security', 'ssl', 'certificates']

- name: Test for open ports (security scan)
  shell: |-
    # Check for unexpected open ports
    netstat -tuln | grep LISTEN | awk '{print $4}' | sed 's/.*://' | sort -n | uniq | while read port; do
      case $port in
        22|80|443|3000|5432|6379|9000|9001) echo "expected:$port" ;;
        *) echo "unexpected:$port" ;;
      esac
    done
  register: port_scan_test
  changed_when: false
  tags: ['security', 'ports', 'network']

- name: Test Docker container security
  shell: |-
    docker ps --format "{{.Names}}" | while read container; do
      # Check if container is running as root
      user=$(docker exec $container whoami 2>/dev/null || echo "unknown")
      # Check if container has privileged mode
      privileged=$(docker inspect $container --format '{{.HostConfig.Privileged}}' 2>/dev/null || echo "false")
      echo "$container:$user:$privileged"
    done
  register: container_security_test
  changed_when: false
  failed_when: false
  tags: ['security', 'containers', 'privileges']

- name: Test file permissions on sensitive files
  stat:
    path: "{{ item }}"
  register: file_permissions_test
  failed_when: false
  loop:
    - "/etc/passwd"
    - "/etc/shadow"
    - "/root/.ssh"
    - "{{ ansible_env.HOME }}/.ssh"
    - "/var/log"
  when: security_checks.file_permissions | default(true)
  tags: ['security', 'permissions', 'files']

- name: Test for default credentials
  shell: |-
    # Check for common default passwords in environment variables
    docker ps --format "{{.Names}}" | while read container; do
      env_vars=$(docker exec $container env 2>/dev/null | grep -i "password\|passwd\|pwd" | grep -v "POSTGRES_PASSWORD" || true)
      if [ ! -z "$env_vars" ]; then
        echo "$container:potential_default_creds"
      else
        echo "$container:no_obvious_defaults"
      fi
    done
  register: default_creds_test
  changed_when: false
  failed_when: false
  tags: ['security', 'credentials', 'defaults']

- name: Test firewall status
  shell: |-
    # Check if firewall is active
    if command -v ufw >/dev/null 2>&1; then
      ufw status | grep -q "Status: active" && echo "ufw:active" || echo "ufw:inactive"
    elif command -v firewalld >/dev/null 2>&1; then
      systemctl is-active firewalld >/dev/null && echo "firewalld:active" || echo "firewalld:inactive"
    elif command -v iptables >/dev/null 2>&1; then
      rules=$(iptables -L | wc -l)
      [ "$rules" -gt 8 ] && echo "iptables:configured" || echo "iptables:minimal"
    else
      echo "no_firewall:detected"
    fi
  register: firewall_test
  changed_when: false
  tags: ['security', 'firewall', 'network']

- name: Test for security updates
  shell: |-
    if command -v apt >/dev/null 2>&1; then
      # Ubuntu/Debian
      updates=$(apt list --upgradable 2>/dev/null | grep -c security || echo "0")
      echo "security_updates:$updates"
    elif command -v yum >/dev/null 2>&1; then
      # CentOS/RHEL
      updates=$(yum --security check-update 2>/dev/null | grep -c "needed for security" || echo "0")
      echo "security_updates:$updates"
    else
      echo "security_updates:unknown"
    fi
  register: security_updates_test
  changed_when: false
  failed_when: false
  tags: ['security', 'updates', 'patches']

- name: Test password policies
  shell: |-
    # Check basic password policy settings
    if [ -f "/etc/pam.d/common-password" ]; then
      grep -q "minlen" /etc/pam.d/common-password && echo "password_policy:configured" || echo "password_policy:basic"
    elif [ -f "/etc/pam.d/system-auth" ]; then
      grep -q "minlen" /etc/pam.d/system-auth && echo "password_policy:configured" || echo "password_policy:basic"
    else
      echo "password_policy:unknown"
    fi
  register: password_policy_test
  changed_when: false
  failed_when: false
  tags: ['security', 'passwords', 'policy']

- name: Test SSH configuration security
  shell: |-
    if [ -f "/etc/ssh/sshd_config" ]; then
      root_login=$(grep "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}' || echo "unknown")
      password_auth=$(grep "^PasswordAuthentication" /etc/ssh/sshd_config | awk '{print $2}' || echo "unknown")
      empty_passwords=$(grep "^PermitEmptyPasswords" /etc/ssh/sshd_config | awk '{print $2}' || echo "unknown")
      echo "root_login:$root_login,password_auth:$password_auth,empty_passwords:$empty_passwords"
    else
      echo "ssh_config:not_found"
    fi
  register: ssh_security_test
  changed_when: false
  tags: ['security', 'ssh', 'configuration']

- name: Evaluate security test results
  set_fact:
    security_results:
      ssl_certificate: >-
        {{ 'pass' if ssl_cert_test.status | default(0) == 200
           else 'fail' if ssl_cert_test is defined
           else 'skip' }}
      port_security: >-
        {{ 'pass' if port_scan_test.stdout_lines | select('match', '^unexpected:') | list | length == 0
           else 'fail' }}
      container_security: >-
        {% set privileged_containers = container_security_test.stdout_lines | select('match', '.*:.*:true$') | list %}
        {{ 'pass' if privileged_containers | length == 0 else 'fail' }}
      file_permissions: >-
        {% set secure_files = 0 %}
        {% for result in file_permissions_test.results %}
          {% if result.stat.exists and result.stat.mode != '0644' and result.stat.mode != '0755' %}
            {% set secure_files = secure_files + 1 %}
          {% endif %}
        {% endfor %}
        {{ 'pass' if secure_files >= 2 else 'warn' }}
      credential_security: >-
        {% set containers_with_defaults = container_security_test.stdout_lines | select('match', '.*:potential_default_creds$') | list %}
        {{ 'pass' if containers_with_defaults | length == 0 else 'fail' }}
      firewall_status: >-
        {{ 'pass' if 'active' in firewall_test.stdout or 'configured' in firewall_test.stdout
           else 'warn' }}
      security_updates: >-
        {% set update_count = security_updates_test.stdout | regex_replace('.*:(\\d+)', '\\1') | int %}
        {{ 'pass' if update_count == 0 else 'warn' if update_count < 5 else 'fail' }}
      password_policy: >-
        {{ 'pass' if 'configured' in password_policy_test.stdout
           else 'warn' if 'basic' in password_policy_test.stdout
           else 'fail' }}
      ssh_security: >-
        {% set ssh_config = ssh_security_test.stdout %}
        {% set secure = true %}
        {% if 'root_login:yes' in ssh_config %}{% set secure = false %}{% endif %}
        {% if 'password_auth:yes' in ssh_config and 'empty_passwords:yes' in ssh_config %}{% set secure = false %}{% endif %}
        {{ 'pass' if secure else 'fail' }}
  tags: ['security', 'results']

- name: Display security test results
  debug:
    msg: |-
      üîí Security Test Results:
      {% for test, result in security_results.items() %}
      - {{ test | replace('_', ' ') | title }}: {{ result | upper }}
      {% endfor %}
      
      üö® Security Findings:
      {% if security_results.port_security == 'fail' %}
      - Unexpected open ports detected: {{ port_scan_test.stdout_lines | select('match', '^unexpected:') | join(', ') }}
      {% endif %}
      {% if security_results.container_security == 'fail' %}
      - Privileged containers found: {{ container_security_test.stdout_lines | select('match', '.*:.*:true$') | join(', ') }}
      {% endif %}
      {% if security_results.credential_security == 'fail' %}
      - Potential default credentials: {{ default_creds_test.stdout_lines | select('match', '.*:potential_default_creds$') | join(', ') }}
      {% endif %}
      {% if security_results.security_updates == 'fail' %}
      - Critical security updates needed: {{ security_updates_test.stdout | regex_replace('.*:(\\d+)', '\\1') }}
      {% endif %}
      
      ‚ö†Ô∏è  Security Warnings:
      {% if security_results.firewall_status == 'warn' %}
      - Firewall not active or configured
      {% endif %}
      {% if security_results.password_policy == 'warn' %}
      - Basic password policy detected
      {% elif security_results.password_policy == 'fail' %}
      - No password policy configured
      {% endif %}
  tags: ['security', 'info']