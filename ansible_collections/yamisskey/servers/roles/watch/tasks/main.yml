---
# ==================================================
# Watch Role - System-level Monitoring Components
# ==================================================
# This role manages monitoring agents that run directly on host systems

# ==================================================
# Prerequisites Setup
# ==================================================
- name: Create monitoring network for watch components
  community.docker.docker_network:
    name: "{{ monitor_network.name }}"
  when: monitor_network.create | default(true)

# ==================================================
# Node Exporter Setup
# ==================================================
- name: Node Exporter setup
  block:
    - name: Install Node Exporter (Debian/Ubuntu)
      ansible.builtin.apt:
        name: "{{ node_exporter.package_name }}"
        state: present
        update_cache: yes
      when:
        - node_exporter.enabled | default(true)
        - ansible_os_family == "Debian"
        - not (skip_system_checks | default(false) | bool)
      tags:
        - node_exporter

    # NOTE: Gentoo support disabled due to missing community.general collection
    # - name: Install Node Exporter (Gentoo)
    #   community.general.portage:
    #     package: "{{ node_exporter_gentoo.package_name }}"
    #     state: present
    #   when:
    #     - node_exporter.enabled | default(true)
    #     - ansible_os_family == "Gentoo"
    #     - not (skip_system_checks | default(false) | bool)
    #   tags:
    #     - node_exporter

    - name: Start and enable Node Exporter service
      systemd:
        name: "{{ node_exporter.service_name }}"
        state: started
        enabled: yes
      when:
        - node_exporter.enabled | default(true)
        - ansible_service_mgr | default('') == 'systemd'
        - not (skip_system_checks | default(false) | bool)
      tags:
        - node_exporter

    - name: Verify Node Exporter metrics endpoint
      uri:
        url: "http://localhost:{{ node_exporter.port }}/metrics"
        method: GET
        status_code: 200
        timeout: "{{ watch_health_checks.timeout }}"
      retries: "{{ watch_health_checks.retries }}"
      delay: "{{ watch_health_checks.delay }}"
      when:
        - node_exporter.enabled | default(true)
        - watch_health_checks.enabled | default(true)
        - not (skip_system_checks | default(false) | bool)
      tags:
        - node_exporter

# ==================================================
# cAdvisor Setup
# ==================================================
- name: cAdvisor container setup
  block:
    - name: Deploy cAdvisor container
      community.docker.docker_container:
        name: "{{ cadvisor.container_name }}"
        image: "{{ cadvisor.image }}"
        state: started
        restart_policy: "{{ cadvisor.restart_policy }}"
        ports:
          - "{{ cadvisor.port }}:8080"
        networks:
          - name: "{{ monitor_network.name }}"
        volumes:
          - "/:/rootfs:ro"
          - "/var/run:/var/run:ro"
          - "/sys:/sys:ro"
          - "/var/lib/docker/:/var/lib/docker:ro"
          - "/dev/disk/:/dev/disk:ro"
        privileged: yes
        comparisons:
          image: strict
          networks: strict
      when:
        - cadvisor.enabled | default(true)
      tags:
        - cadvisor

    - name: Wait for cAdvisor to be ready
      ansible.builtin.pause:
        seconds: 15
      when:
        - cadvisor.enabled | default(true)
      tags:
        - cadvisor

    - name: Verify cAdvisor metrics endpoint
      uri:
        url: "http://localhost:{{ cadvisor.port }}/metrics"
        method: GET
        status_code: 200
        timeout: "{{ watch_health_checks.timeout }}"
      retries: "{{ watch_health_checks.retries }}"
      delay: "{{ watch_health_checks.delay }}"
      when:
        - cadvisor.enabled | default(true)
        - watch_health_checks.enabled | default(true)
      tags:
        - cadvisor


# ==================================================
# Final Health Summary
# ==================================================
- name: Set component status facts
  set_fact:
    node_exporter_status: "{{ 'ENABLED' if (node_exporter is defined and node_exporter.enabled | default(true)) else 'DISABLED' }}{{ ' (Port: ' + node_exporter.port + ')' if (node_exporter is defined and node_exporter.enabled | default(true) and node_exporter.port is defined) else '' }}"
    cadvisor_status: "{{ 'ENABLED' if (cadvisor is defined and cadvisor.enabled | default(true)) else 'DISABLED' }}{{ ' (Port: ' + cadvisor.port + ')' if (cadvisor is defined and cadvisor.enabled | default(true) and cadvisor.port is defined) else '' }}"

- name: Report watch components status
  debug:
    msg: |
      Watch Role Deployment Summary:
      - Node Exporter: {{ node_exporter_status }}
      - cAdvisor: {{ cadvisor_status }}
      - Monitoring Network: {{ monitor_network.name }}
  tags:
    - always
