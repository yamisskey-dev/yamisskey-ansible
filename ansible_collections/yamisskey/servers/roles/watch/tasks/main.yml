---
# ==================================================
# Watch Role - System-level Monitoring Components
# ==================================================
# This role manages monitoring agents that run directly on host systems

- name: Check if running in Nix environment
  shell: command -v nix >/dev/null 2>&1
  register: nix_available
  failed_when: false
  changed_when: false

- name: Ensure Nix environment
  fail:
    msg: |
      ‚ùå Watch role requires Nix environment!
      
      üìã Monitoring packages now managed via Nix Flake:
      - prometheus-node-exporter: Available via Home Manager
      
      Please run in nix develop environment.
  when: nix_available.rc != 0

- name: Display watch package status
  debug:
    msg: |
      ‚úÖ Watch packages managed via Nix Flake
      üì¶ Available tools: prometheus-node-exporter
      üìä Ready for monitoring setup!

# ==================================================
# Prerequisites Setup
# ==================================================
- name: Create monitor network (for monitor role compatibility)
  community.docker.docker_network:
    name: "{{ monitor_network.name }}"
  when: monitor_network.create | default(true)

- name: Create watch network (for watch role components)
  community.docker.docker_network:
    name: "{{ watch_network.name }}"
  when: watch_network.create | default(true)

- name: Wait for networks to be ready
  pause:
    seconds: 5
  when: monitor_network.create | default(true) or watch_network.create | default(true)

# ==================================================
# Node Exporter Setup
# ==================================================
- name: Node Exporter setup
  block:
    - name: Node Exporter status (Nix managed)
      debug:
        msg: |
          üéØ Node Exporter managed via Nix Flake
          üì¶ prometheus-node-exporter: Available via Home Manager
          
          üìã To verify installation: systemctl --user status prometheus-node-exporter
      tags:
        - node_exporter

    - name: Start and enable Node Exporter service
      systemd:
        name: "{{ node_exporter_gentoo.service_name if ansible_os_family == 'Gentoo' else node_exporter.service_name }}"
        state: started
        enabled: yes
      when:
        - node_exporter.enabled | default(true)
        - ansible_service_mgr | default('') == 'systemd'
        - not (skip_system_checks | default(false) | bool)
      tags:
        - node_exporter

    - name: Verify Node Exporter metrics endpoint
      uri:
        url: "http://localhost:{{ node_exporter.port }}/metrics"
        method: GET
        status_code: 200
        timeout: "{{ watch_health_checks.timeout }}"
      retries: "{{ watch_health_checks.retries }}"
      delay: "{{ watch_health_checks.delay }}"
      when:
        - node_exporter.enabled | default(true)
        - watch_health_checks.enabled | default(true)
        - not (skip_system_checks | default(false) | bool)
      tags:
        - node_exporter

# ==================================================
# cAdvisor Setup
# ==================================================
- name: cAdvisor container setup
  block:
    - name: Ensure watch network exists for cAdvisor
      community.docker.docker_network:
        name: "{{ watch_network.name }}"
      when: cadvisor.enabled | default(true)

    - name: Wait for network to be fully ready
      pause:
        seconds: 3
      when: cadvisor.enabled | default(true)

    - name: Deploy cAdvisor container
      community.docker.docker_container:
        name: "{{ cadvisor.container_name }}"
        image: "{{ cadvisor.image }}"
        state: started
        restart_policy: "{{ cadvisor.restart_policy }}"
        ports:
          - "{{ cadvisor.port }}:8080"
        networks:
          - name: "{{ watch_network.name }}"
        volumes:
          - "/:/rootfs:ro"
          - "/var/run:/var/run:ro"
          - "/sys:/sys:ro"
          - "/var/lib/docker/:/var/lib/docker:ro"
          - "/dev/disk/:/dev/disk:ro"
        privileged: yes
        comparisons:
          image: strict
          networks: strict
      when:
        - cadvisor.enabled | default(true)
      tags:
        - cadvisor

    - name: Wait for cAdvisor to be ready
      pause:
        seconds: 15
      when:
        - cadvisor.enabled | default(true)
      tags:
        - cadvisor

    - name: Verify cAdvisor metrics endpoint
      uri:
        url: "http://localhost:{{ cadvisor.port }}/metrics"
        method: GET
        status_code: 200
        timeout: "{{ watch_health_checks.timeout }}"
      retries: "{{ watch_health_checks.retries }}"
      delay: "{{ watch_health_checks.delay }}"
      when:
        - cadvisor.enabled | default(true)
        - watch_health_checks.enabled | default(true)
      tags:
        - cadvisor


# ==================================================
# Final Health Summary
# ==================================================
- name: Set component status facts
  set_fact:
    node_exporter_status: "{{ 'ENABLED (Nix)' if (node_exporter is defined and node_exporter.enabled | default(true)) else 'DISABLED' }}{{ ' (Port: ' + (node_exporter.port | string) + ')' if (node_exporter is defined and node_exporter.enabled | default(true) and node_exporter.port is defined) else '' }}"
    cadvisor_status: "{{ 'ENABLED' if (cadvisor is defined and cadvisor.enabled | default(true)) else 'DISABLED' }}{{ ' (Port: ' + (cadvisor.port | string) + ')' if (cadvisor is defined and cadvisor.enabled | default(true) and cadvisor.port is defined) else '' }}"

- name: Report watch components status
  debug:
    msg: |
      Watch Role Deployment Summary:
      - Node Exporter: {{ node_exporter_status }}
      - cAdvisor: {{ cadvisor_status }}
      - Monitor Network: {{ monitor_network.name }}
      - Watch Network: {{ watch_network.name }}
  tags:
    - always