---
# Repository Manager - Clone Repositories Tasks
# Handles initial git clone operations

- name: Clone repositories that don't exist yet
  git:
    repo: "{{ item.item.url }}"
    dest: "{{ item.item.dest }}"
    version: "{{ item.item.branch | default('HEAD') }}"
    force: "{{ git_force_update | bool }}"
    accept_hostkey: "{{ git_accept_hostkey | bool }}"
    recursive: "{{ git_recursive_submodules | bool }}"
  loop: "{{ repo_exists.results }}"
  when: 
    - not item.stat.exists
    - item.item.name in (target_repositories | map(attribute='name') | list)
  become: "{{ item.item.become_required | default(false) }}"
  register: clone_results
  failed_when:
    - clone_results.failed
    - item.item.required | default(false)
  tags: ['clone', 'git']

- name: Set ownership for newly cloned repositories
  file:
    path: "{{ item.item.dest }}"
    owner: "{{ item.item.owner | default('root') }}"
    group: "{{ item.item.owner | default('root') }}"
    recurse: true
  loop: "{{ clone_results.results }}"
  when:
    - clone_results is defined
    - clone_results.results is defined
    - item.changed | default(false)
    - not item.failed | default(false)
    - item.item is defined
    - item.item.dest is defined
  become: "{{ item.item.become_required | default(false) }}"
  failed_when: false
  tags: ['clone', 'ownership']

- name: Display clone results
  debug:
    msg: |
      ðŸ”„ Repository Clone Results:
      {% if clone_results is defined and clone_results.results | length > 0 %}
      {% for result in clone_results.results %}
      {% if result.item.item is defined %}
      - {{ result.item.item.name }}: {{ 'âœ… Cloned successfully' if result.changed else ('âŒ Clone failed' if result.failed else 'â­ï¸ Skipped (already exists)') }}
      {% if result.changed %}
        ðŸ“ Location: {{ result.item.item.dest }}
        ðŸŒ¿ Branch: {{ result.item.item.branch | default('HEAD') }}
      {% endif %}
      {% endif %}
      {% endfor %}
      {% else %}
      â„¹ï¸ No repositories needed cloning
      {% endif %}
  when: clone_results is defined
  tags: ['clone', 'info']

- name: Debug clone results structure
  debug:
    msg: |
      Clone results debug:
      - Results count: {{ clone_results.results | length | default(0) }}
      - First result keys: {{ clone_results.results[0].keys() | default([]) if clone_results.results | length > 0 else 'No results' }}
      - First result item keys: {{ clone_results.results[0].item.keys() | default([]) if clone_results.results | length > 0 and clone_results.results[0].item is defined else 'No item' }}
  when: 
    - clone_results is defined
    - clone_results.results is defined
    - clone_results.results | length > 0
  tags: ['clone', 'debug']

- name: Validate cloned repositories
  stat:
    path: "{{ item.item.dest }}/.git"
  register: clone_validation
  loop: "{{ clone_results.results }}"
  when: 
    - clone_results is defined
    - item.changed | default(false)
    - item.item is defined
    - item.item.dest is defined
  tags: ['clone', 'validation']

- name: Report clone validation failures
  fail:
    msg: "Clone validation failed for required repository: {{ item.item.name }}"
  loop: "{{ clone_validation.results }}"
  when:
    - clone_validation is defined
    - not item.stat.exists | default(true)
    - item.item.required | default(false)
  tags: ['clone', 'validation']