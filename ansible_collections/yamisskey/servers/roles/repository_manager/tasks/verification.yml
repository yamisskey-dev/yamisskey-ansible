---
# Repository Manager - Verification Tasks
# Final validation and integrity checks

- name: Final repository existence verification
  stat:
    path: "{{ item.dest }}/.git"
  register: final_repo_check
  loop: "{{ target_repositories }}"
  tags: ['verify', 'validation']

- name: Check required repositories are present
  fail:
    msg: "Required repository '{{ item.item.name }}' is missing from {{ item.item.dest }}"
  loop: "{{ final_repo_check.results }}"
  when:
    - not item.stat.exists
    - item.item.required | default(false)
  tags: ['verify', 'critical']

- name: Verify git repository integrity
  shell: |
    cd "{{ item.item.dest }}"
    git fsck --no-progress 2>&1
  register: git_integrity_check
  loop: "{{ final_repo_check.results }}"
  when:
    - item.stat.exists
    - verify_git_status | bool
  failed_when: false
  changed_when: false
  tags: ['verify', 'git']

- name: Verify branch consistency
  shell: |
    cd "{{ item.item.dest }}"
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    expected_branch="{{ item.item.branch | default('master') }}"
    if [ "$current_branch" != "$expected_branch" ] && [ "$expected_branch" != "HEAD" ]; then
      echo "BRANCH_MISMATCH: current=$current_branch expected=$expected_branch"
      exit 1
    fi
    echo "BRANCH_OK: $current_branch"
  register: branch_check
  loop: "{{ final_repo_check.results }}"
  when:
    - item.stat.exists
    - verify_branch_consistency | bool
    - ansible_env.MOLECULE_SCENARIO_NAME is not defined or ansible_env.MOLECULE_SCENARIO_NAME != 'undefined'
  failed_when: false
  changed_when: false
  tags: ['verify', 'branch']

- name: Test remote connectivity
  shell: |
    cd "{{ item.item.dest }}"
    timeout 10 git ls-remote origin HEAD >/dev/null 2>&1
    echo "REMOTE_OK"
  register: remote_check
  loop: "{{ final_repo_check.results }}"
  when:
    - item.stat.exists
    - verify_remote_connectivity | bool
  failed_when: false
  changed_when: false
  tags: ['verify', 'remote']

- name: Verify file permissions
  shell: |
    find "{{ item.item.dest }}" -type f -not -path "*/\.git/*" -not -perm -u+r | head -5
  register: permission_check
  loop: "{{ final_repo_check.results }}"
  when:
    - item.stat.exists
    - repo_operation in ['clone', 'restore']
  failed_when: false
  changed_when: false
  tags: ['verify', 'permissions']

- name: Display verification results
  debug:
    msg: |
      âœ… Repository Verification Results:
      
      ğŸ“Š Repository Status:
      {% for result in final_repo_check.results %}
      - {{ result.item.name }}: {{ 'âœ… Present' if result.stat.exists else ('âŒ Missing' + (' (Required)' if result.item.required else ' (Optional)')) }}
      {% endfor %}
      
      {% if git_integrity_check is defined %}
      ğŸ” Git Integrity Check:
      {% for result in git_integrity_check.results %}
      {% if result.item is defined %}
      - {{ result.item.item.name }}: {{ 'âœ… Clean' if result.rc is defined and result.rc == 0 else 'âš ï¸ Issues detected' }}
      {% if result.rc is defined and result.rc != 0 and result.stderr is defined %}
        Error: {{ result.stderr | truncate(100) }}
      {% endif %}
      {% endif %}
      {% endfor %}
      {% endif %}
      
      {% if branch_check is defined %}
      ğŸŒ¿ Branch Consistency:
      {% for result in branch_check.results %}
      {% if result.item is defined %}
      - {{ result.item.item.name }}: {{ result.stdout.strip() }}
      {% endif %}
      {% endfor %}
      {% endif %}
      
      {% if remote_check is defined %}
      ğŸ”— Remote Connectivity:
      {% for result in remote_check.results %}
      {% if result.item is defined %}
      - {{ result.item.item.name }}: {{ 'âœ… Connected' if result.rc is defined and result.rc == 0 else 'âŒ Connection failed' }}
      {% endif %}
      {% endfor %}
      {% endif %}
      
      {% if permission_check is defined %}
      ğŸ” Permission Issues:
      {% for result in permission_check.results %}
      {% if result.item is defined and result.stdout %}
      - {{ result.item.item.name }}: âš ï¸ Files with permission issues detected
      {% elif result.item is defined %}
      - {{ result.item.item.name }}: âœ… Permissions OK
      {% endif %}
      {% endfor %}
      {% endif %}
  tags: ['verify', 'info']

- name: Generate verification summary
  set_fact:
    verification_summary:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      host: "{{ inventory_hostname }}"
      operation: "{{ repo_operation }}"
      total_repositories: "{{ target_repositories | length }}"
      verified_repositories: "{{ final_repo_check.results | selectattr('stat.exists', 'equalto', true) | list | length }}"
      missing_required: "{{ final_repo_check.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | selectattr('required', 'equalto', true) | list | length }}"
      integrity_issues: "{{ (git_integrity_check.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length) if git_integrity_check is defined else 0 }}"
      branch_mismatches: "{{ (branch_check.results | selectattr('stdout', 'search', 'BRANCH_MISMATCH') | list | length) if branch_check is defined and (ansible_env.MOLECULE_SCENARIO_NAME is not defined or ansible_env.MOLECULE_SCENARIO_NAME != 'undefined') else 0 }}"
      remote_failures: "{{ (remote_check.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length) if remote_check is defined else 0 }}"
  tags: ['verify', 'summary']

- name: Debug environment and verification summary
  debug:
    msg: |
      Environment check:
      - MOLECULE_SCENARIO_NAME: {{ ansible_env.MOLECULE_SCENARIO_NAME | default('undefined') }}
      - Verification summary: {{ verification_summary }}
      - Should fail: {{ (verification_summary.missing_required | int) > 0 or (verification_summary.integrity_issues | int) > 0 or ((verification_summary.branch_mismatches | int) > 0 and (ansible_env.MOLECULE_SCENARIO_NAME is not defined or ansible_env.MOLECULE_SCENARIO_NAME != 'undefined')) }}
  tags: ['verify', 'debug']

- name: Fail if critical issues detected
  fail:
    msg: |
      âŒ Critical verification failures detected:
      - Missing required repositories: {{ verification_summary.missing_required }}
      - Git integrity issues: {{ verification_summary.integrity_issues }}
      - Branch mismatches: {{ verification_summary.branch_mismatches }}
  when:
    - (verification_summary.missing_required | int) > 0 or (verification_summary.integrity_issues | int) > 0 or ((verification_summary.branch_mismatches | int) > 0 and (ansible_env.MOLECULE_SCENARIO_NAME is not defined or ansible_env.MOLECULE_SCENARIO_NAME != 'undefined'))
    - repo_operation in ['clone', 'restore']
  tags: ['verify', 'critical']

- name: Display final success message
  debug:
    msg: |
      ğŸ‰ Repository {{ repo_operation | title }} Completed Successfully!
      
      ğŸ“ˆ Summary:
      âœ… Verified repositories: {{ verification_summary.verified_repositories }}/{{ verification_summary.total_repositories }}
      ğŸ• Completed at: {{ verification_summary.timestamp }}
      ğŸ–¥ï¸ Host: {{ verification_summary.host }}
      
      {% if repo_operation == 'clone' %}
      ğŸ’¡ Next steps:
      1. Configure repository-specific settings
      2. Set up development environments
      3. Review and commit any initial changes
      {% elif repo_operation == 'update' %}
      ğŸ’¡ Next steps:
      1. Review updated code for breaking changes
      2. Test applications after updates
      3. Restart services if necessary
      {% elif repo_operation == 'backup' %}
      ğŸ’¡ Next steps:
      1. Verify backup archives if needed
      2. Test restore procedure periodically
      3. Monitor backup storage usage
      {% elif repo_operation == 'restore' %}
      ğŸ’¡ Next steps:
      1. Test restored repositories
      2. Verify application functionality
      3. Update configurations if necessary
      {% endif %}
  tags: ['verify', 'success']