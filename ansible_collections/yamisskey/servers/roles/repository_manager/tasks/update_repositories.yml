---
# Repository Manager - Update Repositories Tasks
# Handles git pull operations for existing repositories

- name: Update existing repositories
  git:
    repo: "{{ item.item.url }}"
    dest: "{{ item.item.dest }}"
    version: "{{ item.item.branch | default('HEAD') }}"
    force: "{{ git_force_update | bool }}"
    update: true
    accept_hostkey: "{{ git_accept_hostkey | bool }}"
    recursive: "{{ git_recursive_submodules | bool }}"
  loop: "{{ repo_exists.results }}"
  when:
    - item.stat.exists
    - item.item.name in (target_repositories | map(attribute='name') | list)
  become: "{{ item.item.become_required | default(false) }}"
  register: update_results
  failed_when: (item.rc is defined and item.rc != 0) and (item.item.required | default(false))
  tags: ['update', 'git']

- name: Check for local modifications before update
  shell: |
    cd "{{ item.item.dest }}"
    git status --porcelain
  register: local_changes_check
  loop: "{{ repo_exists.results }}"
  when:
    - item.stat.exists
    - item.item.name in (target_repositories | map(attribute='name') | list)
  failed_when: false
  changed_when: false
  tags: ['update', 'validation']

- name: Display update results with change information
  debug:
    msg: |
      üîÑ Repository Update Results:
      {% if update_results is defined and update_results.results | length > 0 %}
      {% for result in update_results.results %}
      {% if result.item.item is defined %}
      - {{ result.item.item.name }}:
        {% if result.rc is defined and result.rc != 0 %}
        ‚ùå Update failed: {{ result.stderr | default('Unknown error') }}
        {% elif result.changed %}
        ‚úÖ Updated successfully
        üìç Location: {{ result.item.item.dest }}
        üåø Branch: {{ result.item.item.branch | default('HEAD') }}
        {% if result.before is defined and result.after is defined %}
        üìù Commit: {{ result.before[:8] }} ‚Üí {{ result.after[:8] }}
        {% endif %}
        {% else %}
        ‚úÖ Already up-to-date
        {% endif %}
      {% endif %}
      {% endfor %}
      {% else %}
      ‚ÑπÔ∏è No repositories were updated
      {% endif %}
  when: update_results is defined
  tags: ['update', 'info']

- name: Show local modifications warning
  debug:
    msg: |
      ‚ö†Ô∏è Local modifications detected in {{ item.item.name }}:
      {{ item.stdout_lines | join('\n') }}
      {% if git_force_update %}
      üîß Force update enabled - local changes may be overwritten
      {% else %}
      üí° Consider committing changes or use force update mode
      {% endif %}
  loop: "{{ local_changes_check.results }}"
  when:
    - local_changes_check is defined
    - item.stdout_lines is defined
    - item.stdout_lines | length > 0
  tags: ['update', 'warning']

- name: Verify successful updates
  stat:
    path: "{{ item.item.dest }}/.git/refs/heads/{{ item.item.branch | default('master') }}"
  register: update_verification
  loop: "{{ update_results.results }}"
  when:
    - update_results is defined
    - item.changed | default(false)
  tags: ['update', 'validation']

- name: Report update validation issues
  debug:
    msg: "‚ö†Ô∏è Update verification warning for {{ item.item.name }}: Branch reference may not exist"
  loop: "{{ update_verification.results }}"
  when:
    - update_verification is defined
    - not item.stat.exists | default(true)
  tags: ['update', 'validation']