---
# Repository Manager - Repository Check Tasks
# Validates repository existence and status

- name: Check if repositories already exist
  stat:
    path: "{{ item.dest }}/.git"
  register: repo_exists
  loop: "{{ target_repositories }}"
  tags: ['check', 'git']

- name: Set repository status facts
  set_fact:
    existing_repos: "{{ repo_exists.results | selectattr('stat.exists', 'equalto', true) | map(attribute='item') | list }}"
    missing_repos: "{{ repo_exists.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | list }}"
    required_missing: "{{ repo_exists.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | selectattr('required', 'equalto', true) | list }}"

- name: Display repository status
  debug:
    msg: |
      ğŸ“Š Repository Status Summary:
      {% if existing_repos | length > 0 %}
      âœ… Existing repositories ({{ existing_repos | length }}):
      {% for repo in existing_repos %}
      - {{ repo.name }}: {{ repo.dest }}
      {% endfor %}
      {% endif %}
      {% if missing_repos | length > 0 %}
      âŒ Missing repositories ({{ missing_repos | length }}):
      {% for repo in missing_repos %}
      - {{ repo.name }}: {{ repo.dest }}{{ ' (Required)' if repo.required else ' (Optional)' }}
      {% endfor %}
      {% endif %}
  when: repo_exists is defined
  tags: ['info', 'status']

- name: Check for critical failures
  fail:
    msg: "Required repository '{{ item.name }}' is missing from {{ item.dest }}"
  loop: "{{ required_missing }}"
  when: 
    - repo_operation in ['status', 'update', 'backup']
    - required_missing | length > 0
  tags: ['validation', 'critical']

- name: Check git status for existing repositories
  shell: |
    cd "{{ item.dest }}"
    git status --porcelain
  register: git_status_check
  loop: "{{ existing_repos }}"
  failed_when: false
  changed_when: false
  when: 
    - verify_git_status | bool
    - repo_operation in ['status', 'backup']
  tags: ['git', 'status']

- name: Display git status information
  debug:
    msg: |
      ğŸ“‹ Git Status for {{ item.item.name }}:
      {% if item.stdout_lines is defined and item.stdout_lines | length > 0 %}
      âš ï¸  Uncommitted changes detected:
      {{ item.stdout_lines | join('\n') }}
      {% else %}
      âœ… Working directory clean
      {% endif %}
  loop: "{{ git_status_check.results }}"
  when: 
    - git_status_check is defined
    - item.item is defined
    - item.stdout_lines is defined
  tags: ['git', 'info']