---
# Repository Manager - Directory Setup Tasks
# Creates necessary directories with proper ownership and permissions

- name: Filter repositories based on target
  set_fact:
    target_repositories: >-
      {{
        repositories if repo_target == 'all' 
        else repositories | selectattr('name', 'in', repo_target.split(',')) | list
      }}

- name: Display target repositories for directory setup
  debug:
    msg: |
      ðŸ“ Setting up directories for:
      {% for repo in target_repositories %}
      - {{ repo.name }}: {{ repo.dest }}
      {% endfor %}
  when: target_repositories | length > 0

- name: Create directories for repositories requiring elevated privileges
  file:
    path: "{{ item.dest }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.owner }}"
    mode: "{{ default_dir_mode }}"
  loop: "{{ target_repositories }}"
  when: item.become_required | default(false)
  become: true
  tags: ['directories', 'sudo']

- name: Create directories for user repositories
  file:
    path: "{{ item.dest }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.owner }}"
    mode: "{{ default_dir_mode }}"
  loop: "{{ target_repositories }}"
  when: not (item.become_required | default(false))
  tags: ['directories', 'user']

- name: Create backup directory if backup operation
  file:
    path: "{{ backup_base_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ default_dir_mode }}"
  when: repo_operation == 'backup'
  become: true
  tags: ['backup', 'directories']