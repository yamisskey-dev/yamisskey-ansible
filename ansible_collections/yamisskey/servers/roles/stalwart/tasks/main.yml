---
- name: Load Stalwart secrets from inventory
  ansible.builtin.set_fact:
    stalwart_secrets: "{{ hostvars[inventory_hostname].stalwart | default({}) }}"

- name: Prepare Stalwart admin credentials
  ansible.builtin.set_fact:
    admin_user: "{{ stalwart_secrets.admin_user | default('admin') }}"
    admin_password: "{{ stalwart_secrets.admin_password | default('CHANGE_ME_STALWART_PASSWORD') }}"

- name: Warn about placeholder Stalwart password
  ansible.builtin.debug:
    msg: >-
      Stalwart admin_password is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ stalwart.admin_password.
  when: admin_password == 'CHANGE_ME_STALWART_PASSWORD'

- name: Create Stalwart directory structure
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  loop:
    - '{{ stalwart_dir }}'
    - '{{ stalwart_dir }}/data'
    - '{{ stalwart_dir }}/etc'
    - '{{ stalwart_dir }}/blobs'

- name: Copy docker-compose.yml
  ansible.builtin.template:
    src: stalwart_docker-compose.yml.j2
    dest: '{{ stalwart_dir }}/docker-compose.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'

- name: Copy Stalwart config
  ansible.builtin.template:
    src: stalwart_config.toml.j2
    dest: '{{ stalwart_dir }}/etc/config.toml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'

- name: Start Stalwart container
  community.docker.docker_compose_v2:
    project_src: '{{ stalwart_dir }}'
    state: restarted

- name: Show admin credentials and next steps
  ansible.builtin.debug:
    msg:
      - 'Admin credentials:'
      - '  User: {{ admin_user }}'
      - '  Password: {{ admin_password }}'
      - 'Web Interface: http://{{ stalwart_server_name }}:8088'
      - 'Required DNS records will be shown in the web interface after first login'
