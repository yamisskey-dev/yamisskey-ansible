---
# Integration Test Role - Main Tasks
# Comprehensive end-to-end testing suite with scoring system

- name: Display integration test plan
  debug:
    msg: |-
      ğŸ§ª Integration Test Suite Starting:
      ğŸ“‹ Categories: {{ integration_test_categories.keys() | list | join(', ') }}
      ğŸ¯ Target Host: {{ inventory_hostname }}
      ğŸ”§ Infrastructure: {{ 'enabled' if integration_test_categories.infrastructure else 'disabled' }}
      ğŸš€ Application: {{ 'enabled' if integration_test_categories.application else 'disabled' }}
      ğŸ› ï¸  Services: {{ 'enabled' if integration_test_categories.service else 'disabled' }}
      âš¡ Performance: {{ 'enabled' if integration_test_categories.performance else 'disabled' }}
      ğŸ”’ Security: {{ 'enabled' if integration_test_categories.security else 'disabled' }}
  tags: ['info', 'plan']

- name: Include infrastructure tests
  include_tasks: infrastructure_tests.yml
  when: integration_test_categories.infrastructure | default(true)
  tags: ['infrastructure', 'infra']

- name: Include application tests  
  include_tasks: application_tests.yml
  when: integration_test_categories.application | default(true)
  tags: ['application', 'app']

- name: Include service tests
  include_tasks: service_tests.yml
  when: integration_test_categories.service | default(true)
  tags: ['service', 'svc']

- name: Include performance tests
  include_tasks: performance_tests.yml
  when: integration_test_categories.performance | default(true)
  tags: ['performance', 'perf']

- name: Include security tests
  include_tasks: security_tests.yml
  when: integration_test_categories.security | default(true)
  tags: ['security', 'sec']

- name: Calculate comprehensive test score
  set_fact:
    final_test_score: |-
      {% set base_score = 0 %}
      {% set max_score = 100 %}
      
      {# Infrastructure tests (20 points) #}
      {% for test, result in infrastructure_results.items() %}
        {% if result == 'pass' %}{% set base_score = base_score + 3 %}{% endif %}
      {% endfor %}
      
      {# Application tests (25 points) #}
      {% for test, result in application_results.items() %}
        {% if result == 'pass' %}{% set base_score = base_score + 4 %}{% endif %}
      {% endfor %}
      
      {# Service tests (20 points) #}
      {% for test, result in service_results.items() %}
        {% if result == 'pass' %}{% set base_score = base_score + 3 %}{% endif %}
      {% endfor %}
      
      {# Performance tests (15 points) #}
      {% for test, result in performance_results.items() %}
        {% if result == 'pass' %}{% set base_score = base_score + 2 %}{% endif %}
      {% endfor %}
      
      {# Security tests (20 points) #}
      {% for test, result in security_results.items() %}
        {% if result == 'pass' %}
          {% set base_score = base_score + 2 %}
        {% elif result == 'warn' %}
          {% set base_score = base_score + 1 %}
        {% endif %}
      {% endfor %}
      
      {{ [base_score, max_score] | min }}
    
    test_summary:
      total_tests: |-
        {% set count = 0 %}
        {% set count = count + (infrastructure_results | length) %}
        {% set count = count + (application_results | length) %}
        {% set count = count + (service_results | length) %}
        {% set count = count + (performance_results | length) %}
        {% set count = count + (security_results | length) %}
        {{ count }}
      passed_tests: |-
        {% set count = 0 %}
        {% for result in infrastructure_results.values() %}
          {% if result == 'pass' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in application_results.values() %}
          {% if result == 'pass' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in service_results.values() %}
          {% if result == 'pass' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in performance_results.values() %}
          {% if result == 'pass' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in security_results.values() %}
          {% if result == 'pass' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {{ count }}
      warned_tests: |-
        {% set count = 0 %}
        {% for result in infrastructure_results.values() %}
          {% if result == 'warn' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in application_results.values() %}
          {% if result == 'warn' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in service_results.values() %}
          {% if result == 'warn' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in performance_results.values() %}
          {% if result == 'warn' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {% for result in security_results.values() %}
          {% if result == 'warn' %}{% set count = count + 1 %}{% endif %}
        {% endfor %}
        {{ count }}
  tags: ['summary', 'score']

- name: Display integration test summary
  debug:
    msg: |-
      ğŸ§ª Integration Test Summary:
      ğŸ“Š Final Score: {{ final_test_score }}/100 ({{ 'PASS' if final_test_score | int >= 80 else 'FAIL' }})
      
      ğŸ“ˆ Test Statistics:
      {% set total_tests = test_summary.total_tests | int %}
      {% set passed_tests = test_summary.passed_tests | int %}
      {% set warned_tests = test_summary.warned_tests | int %}
      - Total Tests: {{ test_summary.total_tests }}
      - Passed: {{ test_summary.passed_tests }} ({% if total_tests > 0 %}{{ ((passed_tests * 100.0) / total_tests) | round(1) }}%{% else %}N/A{% endif %})
      - Warned: {{ test_summary.warned_tests }}
      - Failed: {{ (total_tests - passed_tests - warned_tests) }}
      
      ğŸ”§ Infrastructure Tests: {{ infrastructure_results.values() | select('equalto', 'pass') | list | length }}/{{ infrastructure_results | length }} passed
      ğŸš€ Application Tests: {{ application_results.values() | select('equalto', 'pass') | list | length }}/{{ application_results | length }} passed
      ğŸ› ï¸  Service Tests: {{ service_results.values() | select('equalto', 'pass') | list | length }}/{{ service_results | length }} passed
      âš¡ Performance Tests: {{ performance_results.values() | select('equalto', 'pass') | list | length }}/{{ performance_results | length }} passed
      ğŸ”’ Security Tests: {{ security_results.values() | select('equalto', 'pass') | list | length }}/{{ security_results | length }} passed
      
      {% if final_test_score | int >= 95 %}
      ğŸŒŸ Excellent! All systems performing optimally
      {% elif final_test_score | int >= 80 %}
      âœ… All critical systems operational
      {% else %}
      âŒ Critical issues detected - review failed tests
      {% endif %}
      
      ğŸš€ Integration test suite completed with comprehensive validation across all service layers
  tags: ['summary', 'info']
