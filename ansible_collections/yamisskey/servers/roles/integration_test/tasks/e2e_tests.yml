---
# Integration Test - End-to-End Tests  
# Tests complete user workflows

- name: E2E Test - Full deployment workflow
  block:
    - name: Test system initialization
      include_role:
        name: yamisskey.servers.system_init
      vars:
        install_docker: true
        install_tailscale: false
        install_cloudflare: false
      register: init_test
      failed_when: false

    - name: Test service operations
      include_role:
        name: yamisskey.servers.operations
      vars:
        op: status
        service: all
      register: ops_test
      failed_when: false
      
  rescue:
    - name: E2E workflow failed
      debug:
        msg: "E2E test workflow failed at some stage"
  tags: ['e2e', 'workflow']

- name: E2E Test - Migration workflow
  block:
    - name: Test migration validation
      include_role:
        name: yamisskey.servers.migration_validator
      vars:
        validation_phase: pre_migration
        source_minio_host: "{{ inventory_hostname }}"
        target_minio_host: "{{ inventory_hostname }}"
      register: migration_validation_test
      failed_when: false

  rescue:
    - name: Migration test failed
      debug:
        msg: "Migration test workflow failed"
  tags: ['e2e', 'migration']

- name: Set E2E test results
  set_fact:
    e2e_results:
      deployment_workflow: "{{ 'pass' if init_test is not failed and repo_test is not failed and ops_test is not failed else 'fail' }}"
      migration_workflow: "{{ 'pass' if migration_validation_test is not failed else 'fail' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  tags: ['e2e', 'results']