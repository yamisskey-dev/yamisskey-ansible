---
# Integration Test - Test Report Generation
# Creates comprehensive test execution reports

- name: Calculate overall test score
  set_fact:
    overall_test_score: |
      {%- set total_score = 0 -%}
      {%- set total_tests = 0 -%}
      
      {# Infrastructure tests #}
      {%- if infrastructure_results is defined -%}
        {%- for test, result in infrastructure_results.items() -%}
          {%- if result == 'pass' -%}
            {%- set total_score = total_score + 1 -%}
          {%- endif -%}
          {%- set total_tests = total_tests + 1 -%}
        {%- endfor -%}
      {%- endif -%}
      
      {# E2E tests #}
      {%- if e2e_results is defined -%}
        {%- for test, result in e2e_results.items() -%}
          {%- if test != 'timestamp' -%}
            {%- if result == 'pass' -%}
              {%- set total_score = total_score + 1 -%}
            {%- endif -%}
            {%- set total_tests = total_tests + 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      
      {{ (total_score * 100 / total_tests) | round | int if total_tests > 0 else 0 }}

- name: Display comprehensive test report
  debug:
    msg: |
      ğŸ§ª Integration Test Report:
      =========================
      ğŸ“… Generated: {{ ansible_date_time.iso8601 }}
      ğŸ–¥ï¸ Host: {{ inventory_hostname }}
      ğŸ“Š Overall Score: {{ overall_test_score }}%
      
      ğŸ“ˆ Test Results Summary:
      {% if infrastructure_results is defined %}
      ğŸ—ï¸ Infrastructure Tests:
      {% for test, result in infrastructure_results.items() %}
      - {{ test | replace('_', ' ') | title }}: {{ result | upper }}
      {% endfor %}
      {% endif %}
      
      {% if e2e_results is defined %}
      ğŸ”„ End-to-End Tests:
      {% for test, result in e2e_results.items() %}
      {% if test != 'timestamp' %}
      - {{ test | replace('_', ' ') | title }}: {{ result | upper }}
      {% endif %}
      {% endfor %}
      {% endif %}
      
      {% if overall_test_score | int >= 80 %}
      âœ… Integration tests PASSED - System ready for production
      {% elif overall_test_score | int >= 60 %}
      âš ï¸ Integration tests WARNING - Some issues detected
      {% else %}
      âŒ Integration tests FAILED - Critical issues require attention
      {% endif %}
  tags: ['report', 'summary']

- name: Generate test report file
  copy:
    content: |
      # Integration Test Report
      Generated: {{ ansible_date_time.iso8601 }}
      Host: {{ inventory_hostname }}
      Overall Score: {{ overall_test_score }}%
      
      ## Test Results
      
      {% if infrastructure_results is defined %}
      ### Infrastructure Tests
      {% for test, result in infrastructure_results.items() %}
      - {{ test | replace('_', ' ') | title }}: **{{ result | upper }}**
      {% endfor %}
      {% endif %}
      
      {% if e2e_results is defined %}
      ### End-to-End Tests
      {% for test, result in e2e_results.items() %}
      {% if test != 'timestamp' %}
      - {{ test | replace('_', ' ') | title }}: **{{ result | upper }}**
      {% endif %}
      {% endfor %}
      {% endif %}
      
      ## Summary
      {% if overall_test_score | int >= 80 %}
      âœ… **PASSED** - System ready for production
      {% elif overall_test_score | int >= 60 %}
      âš ï¸ **WARNING** - Some issues detected, review recommended
      {% else %}
      âŒ **FAILED** - Critical issues require immediate attention
      {% endif %}
      
      ---
      Report generated by integration-test role
    dest: "/tmp/integration_test_{{ ansible_date_time.epoch }}.md"
    mode: '0644'
  when: save_report_to_file | bool
  tags: ['report', 'file']

- name: Display report location
  debug:
    msg: "ğŸ“„ Integration test report saved to: /tmp/integration_test_{{ ansible_date_time.epoch }}.md"
  when: save_report_to_file | bool
  tags: ['report', 'file']