---
# Integration Test - Infrastructure Tests
# Tests basic infrastructure components

- name: Test Docker service status
  systemd:
    name: docker
  register: docker_status
  failed_when: false
  tags: ['infra', 'docker']

- name: Debug Docker service status
  debug:
    var: docker_status
  when: docker_status is defined
  tags: ['infra', 'debug']

- name: Test available disk space
  shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
  register: disk_usage
  changed_when: false
  tags: ['infra', 'disk']

- name: Test memory availability
  shell: free -m | grep '^Mem:' | awk '{print ($3/$2)*100}'
  register: memory_usage
  changed_when: false
  tags: ['infra', 'memory']

- name: Test network connectivity
  wait_for:
    host: "{{ item }}"
    port: 80
    timeout: 10
  register: network_test
  failed_when: false
  loop:
    - google.com
    - github.com
  tags: ['infra', 'network']

- name: Test critical service ports
  wait_for:
    port: "{{ item }}"
    timeout: 5
  register: port_test
  failed_when: false
  loop:
    - 22    # SSH
    - 80    # HTTP
    - 443   # HTTPS
    - 9000  # MinIO
  tags: ['infra', 'ports']

- name: Set infrastructure test results
  set_fact:
    infrastructure_results:
      docker_status: "{{ 'pass' if docker_status.status is defined and docker_status.status.ActiveState == 'active' else 'fail' }}"
      disk_usage: "{{ 'pass' if disk_usage.stdout | int < 90 else 'fail' }}"
      memory_usage: "{{ 'pass' if memory_usage.stdout | float < 90 else 'fail' }}"
      network_connectivity: "{{ 'pass' if network_test.results | selectattr('failed', 'equalto', false) | list | length > 0 else 'fail' }}"
      port_accessibility: "{{ 'pass' if port_test.results | selectattr('failed', 'equalto', false) | list | length >= 2 else 'fail' }}"
  when: docker_status.status is defined and docker_status.status.ActiveState is defined
  tags: ['infra', 'results']

- name: Set default infrastructure test results
  set_fact:
    infrastructure_results:
      docker_status: "fail"
      disk_usage: "{{ 'pass' if disk_usage.stdout | int < 90 else 'fail' }}"
      memory_usage: "{{ 'pass' if memory_usage.stdout | float < 90 else 'fail' }}"
      network_connectivity: "{{ 'pass' if network_test.results | selectattr('failed', 'equalto', false) | list | length > 0 else 'fail' }}"
      port_accessibility: "{{ 'pass' if port_test.results | selectattr('failed', 'equalto', false) | list | length >= 2 else 'fail' }}"
  when: docker_status.status is not defined or docker_status.status.ActiveState is not defined
  tags: ['infra', 'results']