---
# Repository Manager - Restore Repositories Tasks
# Restores repositories from backup archives

- name: Validate restore parameters
  fail:
    msg: "Restore operation requires 'restore_backup_date' variable (format: YYYYMMDD_HHMMSS)"
  when: 
    - repo_operation == 'restore'
    - restore_backup_date is not defined
  tags: ['restore', 'validation']

- name: Check if backup directory exists
  stat:
    path: "{{ backup_base_dir }}/{{ restore_backup_date }}"
  register: backup_dir_check
  when: restore_backup_date is defined
  tags: ['restore', 'validation']

- name: Fail if backup directory doesn't exist
  fail:
    msg: "Backup directory not found: {{ backup_base_dir }}/{{ restore_backup_date }}"
  when:
    - backup_dir_check is defined
    - not backup_dir_check.stat.exists
  tags: ['restore', 'validation']

- name: Read backup manifest
  slurp:
    src: "{{ backup_base_dir }}/{{ restore_backup_date }}/backup_manifest.ini"
  register: backup_manifest_raw
  when: 
    - backup_dir_check.stat.exists | default(false)
    - restore_backup_date is defined
  tags: ['restore', 'manifest']

- name: Parse backup manifest
  set_fact:
    backup_manifest: "{{ backup_manifest_raw.content | b64decode }}"
  when: backup_manifest_raw is defined
  tags: ['restore', 'manifest']

- name: Display restore information
  debug:
    msg: |
      ğŸ”„ Repository Restore Plan:
      ğŸ“… Backup date: {{ restore_backup_date }}
      ğŸ“ Backup location: {{ backup_base_dir }}/{{ restore_backup_date }}
      ğŸ“¦ Repositories to restore:
      {% for repo in target_repositories %}
      - {{ repo.name }}: {{ repo.dest }}
      {% endfor %}
      
      âš ï¸  WARNING: This will overwrite existing repositories!
  when: backup_manifest is defined
  tags: ['restore', 'info']

- name: Confirm destructive operation
  pause:
    prompt: "âš ï¸  This restore operation will overwrite existing repositories. Type 'yes' to continue"
  register: restore_confirmation
  when:
    - backup_manifest is defined
    - not (restore_force | default(false) | bool)
  tags: ['restore', 'confirmation']

- name: Validate confirmation
  fail:
    msg: "Restore operation cancelled by user"
  when:
    - restore_confirmation is defined
    - restore_confirmation.user_input != 'yes'
  tags: ['restore', 'validation']

- name: Backup existing repositories before restore
  ansible.builtin.archive:
    path: "{{ item.dest }}"
    dest: "{{ backup_base_dir }}/pre_restore_{{ ansible_date_time.epoch }}_{{ item.name }}.tar.gz"
    format: gz
  loop: "{{ target_repositories }}"
  when:
    - backup_manifest is defined
    - existing_repos is defined
    - item.name in (existing_repos | map(attribute='name') | list)
    - create_pre_restore_backup | default(true)
  register: pre_restore_backup
  tags: ['restore', 'backup']

- name: Remove existing repositories
  file:
    path: "{{ item.dest }}"
    state: absent
  loop: "{{ target_repositories }}"
  when: 
    - backup_manifest is defined
    - item.name in (target_repositories | map(attribute='name') | list)
  become: "{{ item.become_required | default(false) }}"
  tags: ['restore', 'cleanup']

- name: Extract repositories from backup
  unarchive:
    src: "{{ backup_base_dir }}/{{ restore_backup_date }}/{{ item.name }}_{{ restore_backup_date }}.tar.gz"
    dest: "{{ item.dest | dirname }}"
    owner: "{{ item.owner }}"
    group: "{{ item.owner }}"
    remote_src: true
  loop: "{{ target_repositories }}"
  when:
    - backup_manifest is defined
    - item.name in (target_repositories | map(attribute='name') | list)
  become: "{{ item.become_required | default(false) }}"
  register: restore_results
  tags: ['restore', 'extract']

- name: Verify restored repositories
  stat:
    path: "{{ item.dest }}/.git"
  register: restore_verification
  loop: "{{ target_repositories }}"
  when:
    - restore_results is defined
    - item.name in (target_repositories | map(attribute='name') | list)
  tags: ['restore', 'verification']

- name: Display restore results
  debug:
    msg: |
      ğŸ”„ Repository Restore Results:
      {% if restore_results is defined and restore_results.results | length > 0 %}
      {% for result in restore_results.results %}
      - {{ result.item.name }}: {{ 'âœ… Restored successfully' if not result.failed else 'âŒ Restore failed' }}
      {% if not result.failed %}
        ğŸ“ Location: {{ result.item.dest }}
        ğŸ“¦ Source: {{ result.item.name }}_{{ restore_backup_date }}.tar.gz
      {% endif %}
      {% endfor %}
      {% else %}
      â„¹ï¸ No repositories were restored
      {% endif %}
      
      {% if pre_restore_backup is defined %}
      ğŸ’¾ Pre-restore backups created for existing repositories
      {% endif %}
  when: restore_results is defined
  tags: ['restore', 'info']

- name: Check restoration integrity
  shell: |
    cd "{{ item.item.dest }}"
    git fsck --no-progress
  register: integrity_check
  loop: "{{ restore_verification.results }}"
  when:
    - restore_verification is defined
    - item.stat.exists | default(false)
  failed_when: false
  changed_when: false
  tags: ['restore', 'integrity']

- name: Report integrity issues
  debug:
    msg: |
      âš ï¸ Git integrity check for {{ item.item.item.name }}:
      {% if item.rc == 0 %}
      âœ… Repository integrity verified
      {% else %}
      âŒ Integrity issues detected:
      {{ item.stderr_lines | join('\n') }}
      {% endif %}
  loop: "{{ integrity_check.results }}"
  when:
    - integrity_check is defined
    - item.item is defined
  tags: ['restore', 'integrity']
