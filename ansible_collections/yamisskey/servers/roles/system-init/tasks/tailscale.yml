---
- name: Ensure keyring directory exists (tailscale)
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
  when: ansible_os_family == 'Debian' and (install_tailscale | default(true))

- name: Install Tailscale archive key (noarmor)
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/{{ os_name }}/{{ codename }}.noarmor.gpg"
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: '0644'
  when: ansible_os_family == 'Debian' and (install_tailscale | default(true))

- name: Add Tailscale apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/{{ os_name }} {{ codename }} main"
    filename: tailscale
    state: present
  when: ansible_os_family == 'Debian' and (install_tailscale | default(true))

- name: Install Tailscale package
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian' and (install_tailscale | default(true))

- name: Verify Tailscale installation
  ansible.builtin.command: tailscale version
  register: tailscale_version
  changed_when: false
  failed_when: false

- name: Display Tailscale installation result
  ansible.builtin.debug:
    msg: |
      âœ… Tailscale installation check
      Version: {{ tailscale_version.stdout if tailscale_version.rc == 0 else 'Not installed / verification failed' }}
