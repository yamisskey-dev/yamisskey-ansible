---
dependency:
  name: galaxy
  options:
    requirements-file: ../../requirements.yml
driver:
  name: docker
platforms:
  - name: monitor-test-instance
    image: nixos/nix:2.21.5
    pre_build_image: true
    cgroupns_mode: host
    tmpfs:
      - /run
      - /tmp
    command: bash -c "if ! command -v /tmp/nix-python/bin/python3 >/dev/null 2>&1; then nix profile install --accept-flake-config --profile /root/.nix-profile nixpkgs#python312 >/dev/null 2>&1 || exit 1; fi; mkdir -p /tmp/.ansible-tmp && chmod 1777 /tmp/.ansible-tmp && chown root:root /tmp/.ansible-tmp && touch /tmp/.ansible-tmp/.ansible-test && while true; do sleep 30; done"
    networks:
      - name: molecule-test-network
provisioner:
  name: ansible
  playbooks:
    prepare: prepare.yml
  inventory:
    group_vars:
      all:
        ansible_python_interpreter: /tmp/nix-python/bin/python3
    host_vars:
      monitor-test-instance:
        # Test configuration for Docker-based monitoring
        domain: "test.local"
        primary_domain: "test.local"
        monitor_compose_dir: "/opt/monitor"
        grafana_admin_password: "testpassword123"
        
        # Service port configuration for testing
        monitor_services:
          prometheus: 9090
          grafana: 3000
          alertmanager: 9093
          blackbox: 9115
        
        # Test monitoring targets (simplified for testing)
        monitor_targets:
          - name: "localhost"
            host: "localhost"
            port: 9100
            role: "test-server"
            cadvisor_port: 8085
        
        # External endpoints for testing (simplified)
        monitor_external_endpoints:
          - "http://localhost:3000"
          - "http://localhost:9090"
        
        # Enable health checks
        health_check_timeout: 60
        health_check_retries: 3
        
        # Alertmanager configuration for testing
        alertmanager_group_wait: "10s"
        alertmanager_group_interval: "10s"
        alertmanager_repeat_interval: "1h"
verifier:
  name: ansible
