---
# Docker-based Monitoring Stack for Gentoo/Universal Compatibility
# This role provides Prometheus, Grafana, and AlertManager as Docker containers

- name: Create monitoring compose directory
  file:
    path: '{{ monitor_compose_dir }}'
    state: directory
    mode: '0755'

- name: Create monitoring config directories
  file:
    path: '{{ monitor_compose_dir }}/config/{{ item }}'
    state: directory
    mode: '0755'
  loop:
    - prometheus
    - alertmanager
    - rules
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
    - blackbox
{% endif %}
    - grafana/provisioning/datasources
    - grafana/provisioning/dashboards
    - grafana/dashboards

- name: Create Docker network for monitoring
  community.docker.docker_network:
    name: monitor

- name: Deploy Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: '{{ monitor_compose_dir }}/config/prometheus/prometheus.yml'
    mode: '0644'
  register: prometheus_config
  notify: Restart monitoring stack

- name: Deploy AlertManager configuration
  template:
    src: alertmanager.yml.j2
    dest: '{{ monitor_compose_dir }}/config/alertmanager/alertmanager.yml'
    mode: '0644'
  register: alertmanager_config

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
- name: Deploy Blackbox Exporter configuration
  template:
    src: blackbox.yml.j2
    dest: '{{ monitor_compose_dir }}/config/blackbox/blackbox.yml'
    mode: '0644'
  register: blackbox_config
{% endif %}

# ==================================================
# Grafana Configuration
# ==================================================
- name: Deploy Grafana datasource configuration
  template:
    src: grafana/provisioning/datasources/prometheus.yml.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/provisioning/datasources/prometheus.yml'
    mode: '0644'
  register: grafana_datasource_config

- name: Deploy Grafana dashboard configuration
  template:
    src: grafana/provisioning/dashboards/dashboard.yml.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/provisioning/dashboards/dashboard.yml'
    mode: '0644'
  register: grafana_dashboard_config

- name: Deploy cAdvisor dashboard
  template:
    src: grafana/dashboards/cadvisor.json.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/dashboards/cadvisor.json'
    mode: '0644'
  register: grafana_cadvisor_dashboard

- name: Deploy Node Exporter dashboard
  template:
    src: grafana/dashboards/node-exporter.json.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/dashboards/node-exporter.json'
    mode: '0644'
  register: grafana_node_dashboard

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
- name: Deploy Blackbox Exporter dashboard
  template:
    src: grafana/dashboards/blackbox.json.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/dashboards/blackbox.json'
    mode: '0644'
  register: grafana_blackbox_dashboard
{% endif %}

- name: Deploy monitoring Docker Compose
  template:
    src: docker-compose.yml.j2
    dest: '{{ monitor_compose_dir }}/docker-compose.yml'
    mode: '0644'
  register: compose_config

- name: Create .env file for Docker Compose
  copy:
    content: |
      DOMAIN={{ primary_domain }}
      GRAFANA_PASSWORD={{ grafana_admin_password }}
    dest: '{{ monitor_compose_dir }}/.env'
    mode: '0600'

- name: Pull Docker images for monitoring stack
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - "prom/prometheus:{{ monitor_prometheus_version | default('latest') }}"
    - "grafana/grafana:{{ monitor_grafana_version | default('latest') }}"
    - "prom/alertmanager:{{ monitor_alertmanager_version | default('latest') }}"
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
    - "prom/blackbox-exporter:{{ monitor_blackbox_version | default('latest') }}"
{% endif %}

- name: Stop existing containers if config changed
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  loop:
    - alertmanager
    - prometheus
    - grafana
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
    - blackbox
{% endif %}
  when: alertmanager_config.changed or prometheus_config.changed or compose_config.changed{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %} or blackbox_config.changed{% endif %}

- name: Ensure config files exist before starting containers
  stat:
    path: "{{ item }}"
  register: config_files_check
  loop:
    - "{{ monitor_compose_dir }}/config/prometheus/prometheus.yml"
    - "{{ monitor_compose_dir }}/config/alertmanager/alertmanager.yml"
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
    - "{{ monitor_compose_dir }}/config/blackbox/blackbox.yml"
{% endif %}

- name: Verify all config files exist
  fail:
    msg: "Missing configuration file: {{ item.item }}"
  when: not item.stat.exists
  loop: "{{ config_files_check.results }}"

- name: Start Prometheus container
  community.docker.docker_container:
    name: prometheus
    image: "prom/prometheus:{{ monitor_prometheus_version | default('latest') }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ monitor_services.prometheus }}:9090"
    volumes:
      - "{{ monitor_compose_dir }}/config/prometheus:/etc/prometheus"
    networks:
      - name: monitor
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    comparisons:
      image: strict
      networks: strict
  register: prometheus_container

- name: Start Grafana container
  community.docker.docker_container:
    name: grafana
    image: "grafana/grafana:{{ monitor_grafana_version | default('latest') }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ monitor_services.grafana }}:3000"
    env:
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    networks:
      - name: monitor
    comparisons:
      image: strict
      networks: strict
  register: grafana_container

- name: Start AlertManager container
  community.docker.docker_container:
    name: alertmanager
    image: "prom/alertmanager:{{ monitor_alertmanager_version | default('latest') }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ monitor_services.alertmanager }}:9093"
    volumes:
      - "{{ monitor_compose_dir }}/config/alertmanager:/etc/alertmanager"
    networks:
      - name: monitor
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:{{ monitor_services.alertmanager }}'
    comparisons:
      image: strict
      networks: strict
  register: alertmanager_container

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
- name: Start Blackbox Exporter container
  community.docker.docker_container:
    name: blackbox
    image: "prom/blackbox-exporter:{{ monitor_blackbox_version | default('latest') }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ monitor_services.blackbox | default('9115') }}:9115"
    volumes:
      - "{{ monitor_compose_dir }}/config/blackbox:/etc/blackbox_exporter"
    networks:
      - name: monitor
    command:
      - '--config.file=/etc/blackbox_exporter/blackbox.yml'
    comparisons:
      image: strict
      networks: strict
  register: blackbox_container
{% endif %}

- name: Wait for services to be ready
  pause:
    seconds: 30
  when: prometheus_container.changed or grafana_container.changed or alertmanager_container.changed{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %} or blackbox_container.changed{% endif %}

- name: Verify Docker monitoring services
  uri:
    url: "http://localhost:{{ item.port }}{{ item.path }}"
    method: GET
    status_code: 200
  loop:
    - { port: "{{ monitor_services.prometheus }}", name: 'prometheus', path: '/-/healthy' }
    - { port: "{{ monitor_services.grafana }}", name: 'grafana', path: '/api/health' }
    - { port: "{{ monitor_services.alertmanager }}", name: 'alertmanager', path: '/-/healthy' }
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
    - { port: "{{ monitor_services.blackbox | default('9115') }}", name: 'blackbox', path: '/-/healthy' }
{% endif %}
  register: service_health_checks
  retries: 5
  delay: 10
  failed_when: false

- name: Report service health status
  debug:
    msg: |
      Monitoring Stack Health Status:
      {% for check in service_health_checks.results %}
      - {{ check.item.name }}: {{ 'HEALTHY' if check.status == 200 else 'UNHEALTHY (' + (check.status | string) + ')' }}
      {% endfor %}