---
# Docker-based Monitoring Stack for Gentoo/Universal Compatibility
# This role provides Prometheus, Grafana, and AlertManager as Docker containers

- name: Create monitoring compose directory
  file:
    path: '{{ monitor_compose_dir }}'
    state: directory
    mode: '0755'

- name: Set config directories list
  set_fact:
    config_directories: "{{ config_directories_base + (['blackbox'] if domain not in ['test.local', 'localhost.localdomain'] else []) }}"
  vars:
    config_directories_base:
      - prometheus
      - alertmanager
      - rules
      - grafana/provisioning/datasources

- name: Create monitoring config directories
  file:
    path: '{{ monitor_compose_dir }}/config/{{ item }}'
    state: directory
    mode: '0755'
    owner: '65534'
    group: '65534'
  loop: "{{ config_directories }}"

- name: Create Docker network for monitoring
  community.docker.docker_network:
    name: monitor

- name: Deploy Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: '{{ monitor_compose_dir }}/config/prometheus/prometheus.yml'
    mode: '0644'
    owner: '65534'
    group: '65534'
  register: prometheus_config
  notify: Restart monitoring stack

- name: Deploy AlertManager configuration
  template:
    src: alertmanager.yml.j2
    dest: '{{ monitor_compose_dir }}/config/alertmanager/alertmanager.yml'
    mode: '0644'
    owner: '65534'
    group: '65534'
  register: alertmanager_config

- name: Deploy Prometheus alert rules
  template:
    src: rules/alerts.yml.j2
    dest: '{{ monitor_compose_dir }}/config/rules/alerts.yml'
    mode: '0644'
    owner: '65534'
    group: '65534'
  register: alert_rules_config
  notify: Restart monitoring stack

- name: Deploy Blackbox Exporter configuration
  template:
    src: blackbox.yml.j2
    dest: '{{ monitor_compose_dir }}/config/blackbox/blackbox.yml'
    mode: '0644'
  register: blackbox_config
  when: domain not in ['test.local', 'localhost.localdomain']

# ==================================================
# Grafana Configuration (datasource only, no dashboards)
# ==================================================
- name: Deploy Grafana datasource configuration
  template:
    src: grafana/provisioning/datasources/prometheus.yml.j2
    dest: '{{ monitor_compose_dir }}/config/grafana/provisioning/datasources/prometheus.yml'
    mode: '0644'
  register: grafana_datasource_config

- name: Deploy monitoring Docker Compose
  template:
    src: docker-compose.yml.j2
    dest: '{{ monitor_compose_dir }}/docker-compose.yml'
    mode: '0644'
  register: compose_config

- name: Create .env file for Docker Compose
  ansible.builtin.copy:
    content: |
      DOMAIN={{ domain }}
      GRAFANA_PASSWORD={{ grafana_admin_password }}
    dest: '{{ monitor_compose_dir }}/.env'
    mode: '0600'

- name: Set Docker images list
  set_fact:
    docker_images: "{{ docker_images_base + (['prom/blackbox-exporter:' + (monitor_blackbox_version | default('latest'))] if domain not in ['test.local', 'localhost.localdomain'] else []) }}"
  vars:
    docker_images_base:
      - "prom/prometheus:{{ monitor_prometheus_version | default('latest') }}"
      - "grafana/grafana:{{ monitor_grafana_version | default('latest') }}"
      - "prom/alertmanager:{{ monitor_alertmanager_version | default('latest') }}"

- name: Pull Docker images for monitoring stack
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop: "{{ docker_images }}"

- name: Start monitoring stack with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ monitor_compose_dir }}"
    state: present
    pull: always
    remove_orphans: true
  register: compose_result
  retries: 3
  delay: 5
  until: compose_result is succeeded
  failed_when: false
  notify: Wait for monitoring services

- name: Verify Docker monitoring services
  uri:
    url: "http://localhost:{{ item.port }}{{ item.path }}"
    method: GET
    status_code: 200
  loop:
    - { port: "{{ monitor_services.prometheus }}", name: 'prometheus', path: '/-/healthy' }
    - { port: "{{ monitor_services.grafana }}", name: 'grafana', path: '/api/health' }
    - { port: "{{ monitor_services.alertmanager }}", name: 'alertmanager', path: '/-/healthy' }
  register: service_health_checks
  retries: 5
  delay: 10
  failed_when: false

- name: Report service health status
  debug:
    msg: |
      Monitoring Stack Health Status:
      {% for check in service_health_checks.results %}
      - {{ check.item.name }}: {{ 'HEALTHY' if check.status == 200 else 'UNHEALTHY (' + (check.status | string) + ')' }}
      {% endfor %}
