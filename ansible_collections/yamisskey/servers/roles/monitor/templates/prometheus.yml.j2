# ==================================================
# Yamisskey Monitor - Docker-based Prometheus Configuration
# ==================================================
# Optimized for Docker container deployment

global:
  scrape_interval: {{ monitor_scrape_interval | default('15s') }}
  evaluation_interval: {{ monitor_evaluation_interval | default('15s') }}
  external_labels:
    environment: '{{ environment | default("production") }}'
    cluster: 'yamisskey'
    region: '{{ monitor_region | default("ap-northeast-1") }}'

# ==================================================
# Alert Manager Configuration
# ==================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - 'alertmanager:9093'

# ==================================================
# Rule Files Configuration
# ==================================================
rule_files:
  - "/etc/prometheus/rules/*.yml"

# ==================================================
# Scrape Configurations - Docker Optimized
# ==================================================
scrape_configs:
  # --- Core Monitoring Services ---
  - job_name: 'prometheus'
    scrape_interval: 5s
    scrape_timeout: 5s
    static_configs:
      - targets: ['localhost:9090']

  # --- Grafana Health Check ---
  - job_name: 'grafana'
    scrape_interval: 30s
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: '/api/health'

  # --- External Node Exporters (Host Systems) ---
  - job_name: 'node-exporters'
    scrape_interval: 30s
    static_configs:
{% if monitor_targets is defined %}
{% for target in monitor_targets %}
      - targets: ['{{ target.host }}:{{ target.port | default("9100") }}']
        labels:
          instance: '{{ target.name }}'
          role: '{{ target.role | default("server") }}'
          environment: '{{ environment | default("production") }}'
{% endfor %}
{% else %}
      # Default localhost target for testing
      - targets: ['localhost:9100']
        labels:
          instance: 'localhost'
          role: 'test'
{% endif %}

  # --- Docker Container Monitoring (cAdvisor) ---
  - job_name: 'cadvisor'
    scrape_interval: 30s
    static_configs:
{% if monitor_targets is defined %}
{% for target in monitor_targets %}
      - targets: ['{{ target.host }}:{{ target.cadvisor_port | default("8085") }}']
        labels:
          instance: '{{ target.name }}'
          role: 'cadvisor'
{% endfor %}
{% else %}
      - targets: ['localhost:8085']
        labels:
          instance: 'localhost'
          role: 'cadvisor'
{% endif %}

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  # --- Blackbox HTTP/HTTPS Monitoring ---
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
{% if monitor_external_endpoints is defined %}
          # External Service Health Checks
{% for endpoint in monitor_external_endpoints %}
          - {{ endpoint }}
{% endfor %}
{% else %}
          # Default test endpoint
          - http://localhost:3000
{% endif %}
{% if primary_domain != 'localhost.localdomain' and primary_domain != 'test.local' %}
          # Domain Health Checks
          - https://{{ primary_domain }}
          - https://grafana.{{ primary_domain }}
{% endif %}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: 'blackbox:9115'
{% endif %}

  # --- Application-specific monitoring can be added here ---
{% if custom_monitor_jobs is defined %}
  # --- Custom Monitoring Jobs ---
{% for job in custom_monitor_jobs %}
  - job_name: '{{ job.name }}'
    scrape_interval: {{ job.scrape_interval | default('60s') }}
{% if job.metrics_path is defined %}
    metrics_path: {{ job.metrics_path }}
{% endif %}
{% if job.params is defined %}
    params:
{% for key, value in job.params.items() %}
      {{ key }}: {{ value | to_yaml }}
{% endfor %}
{% endif %}
    static_configs:
      - targets: {{ job.targets | to_yaml }}
{% if job.labels is defined %}
        labels:
{% for key, value in job.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}