# ==================================================
# Yamisskey Provision - AlertManager Configuration
# ==================================================
# Production-ready configuration with Slack and Discord notifications

global:
{% if alertmanager_smtp_host is defined %}
  smtp_smarthost: '{{ alertmanager_smtp_host }}'
{% endif %}
{% if alertmanager_smtp_from is defined %}
  smtp_from: '{{ alertmanager_smtp_from }}'
{% endif %}
{% if alertmanager_smtp_username is defined %}
  smtp_auth_username: '{{ alertmanager_smtp_username }}'
{% endif %}
{% if alertmanager_smtp_password is defined %}
  smtp_auth_password: '{{ alertmanager_smtp_password }}'
{% endif %}

# Routing configuration
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: {{ alertmanager_group_wait | default('10s') }}
  group_interval: {{ alertmanager_group_interval | default('10s') }}
  repeat_interval: {{ alertmanager_repeat_interval | default('1h') }}
  receiver: 'default'
{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  routes:
    # Critical alerts go to critical channels
    - match:
        severity: critical
      receiver: 'critical-alerts'
    # Misskey-specific alerts
    - match:
        service: misskey
      receiver: 'misskey-alerts'
    # Infrastructure alerts
    - match:
        category: infrastructure
      receiver: 'infra-alerts'
    # Security alerts
    - match:
        category: security
      receiver: 'security-alerts'
{% endif %}

# Receivers configuration
receivers:
  - name: 'default'
{% if primary_domain == 'test.local' or primary_domain == 'localhost.localdomain' %}
    # Test environment: simple console output
    webhook_configs:
      - url: 'http://localhost:9093/api/v1/alerts'
        send_resolved: true
{% else %}
{% if alertmanager_slack_webhook_url %}
    slack_configs:
      - api_url: '{{ alertmanager_slack_webhook_url }}'
        channel: '{{ alertmanager_slack_channel }}'
        title: 'Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% if alertmanager_discord_webhook_url %}
    discord_configs:
      - webhook_url: '{{ alertmanager_discord_webhook_url }}'
        title: 'Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        message: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% endif %}

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  - name: 'critical-alerts'
{% if alertmanager_slack_webhook_url %}
    slack_configs:
      - api_url: '{{ alertmanager_slack_webhook_url }}'
        channel: '{{ alertmanager_slack_critical_channel }}'
        title: 'üö® CRITICAL: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
        color: 'danger'
{% endif %}
{% if alertmanager_discord_webhook_url %}
    discord_configs:
      - webhook_url: '{{ alertmanager_discord_webhook_url }}'
        title: 'üö® CRITICAL: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        message: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% endif %}

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  - name: 'misskey-alerts'
{% if alertmanager_slack_webhook_url %}
    slack_configs:
      - api_url: '{{ alertmanager_slack_webhook_url }}'
        channel: '{{ alertmanager_slack_misskey_channel }}'
        title: 'üêà Misskey Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% if alertmanager_discord_webhook_url %}
    discord_configs:
      - webhook_url: '{{ alertmanager_discord_webhook_url }}'
        title: 'üêà Misskey Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        message: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% endif %}

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  - name: 'infra-alerts'
{% if alertmanager_slack_webhook_url %}
    slack_configs:
      - api_url: '{{ alertmanager_slack_webhook_url }}'
        channel: '{{ alertmanager_slack_infra_channel }}'
        title: 'üèóÔ∏è Infrastructure Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% if alertmanager_discord_webhook_url %}
    discord_configs:
      - webhook_url: '{{ alertmanager_discord_webhook_url }}'
        title: 'üèóÔ∏è Infrastructure Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        message: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% endif %}

{% if primary_domain != 'test.local' and primary_domain != 'localhost.localdomain' %}
  - name: 'security-alerts'
{% if alertmanager_slack_webhook_url %}
    slack_configs:
      - api_url: '{{ alertmanager_slack_webhook_url }}'
        channel: '{{ alertmanager_slack_security_channel }}'
        title: 'üîí Security Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
        color: 'warning'
{% endif %}
{% if alertmanager_discord_webhook_url %}
    discord_configs:
      - webhook_url: '{{ alertmanager_discord_webhook_url }}'
        title: 'üîí Security Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        message: '{% raw %}{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}{% endraw %}'
{% endif %}
{% endif %}

# Inhibit rules (to prevent alert spam)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: 'Node.*'
    equal: ['instance']