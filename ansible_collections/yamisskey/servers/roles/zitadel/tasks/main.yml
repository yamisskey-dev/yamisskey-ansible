# playbooks/roles/zitadel/tasks/main.yml
---
- name: Create Zitadel directory
  file:
    path: "{{ zitadel_dir }}"
    state: directory
    mode: '0755'

- name: Create Zitadel data directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "{{ zitadel_dir }}/data"
    - "{{ zitadel_dir }}/config"
    - "{{ zitadel_dir }}/logs"

# 秘密情報ファイルの存在確認
- name: Check if secrets file exists
  stat:
    path: '{{ zitadel_secrets_file }}'
  register: zitadel_secrets_file_stat

# 新規の場合の秘密情報生成
- name: Generate new secrets
  block:
    - name: Generate masterkey if not exists
      command: "openssl rand -hex 16"
      register: masterkey_output

    - name: Generate PostgreSQL password
      command: 'openssl rand -base64 32'
      register: pg_password_output

    - name: Set new secrets facts
      set_fact:
        masterkey: "{{ masterkey_output.stdout }}"
        postgresql_user: "zitadel"
        postgresql_password: "{{ pg_password_output.stdout }}"
        postgresql_database: "zitadel"
        postgresql_host: "db"
  when: not zitadel_secrets_file_stat.stat.exists

# 既存の秘密情報を読み込む
- name: Load existing secrets
  block:
    - name: Read secrets file from managed host
      ansible.builtin.slurp:
        src: "{{ zitadel_secrets_file }}"
      register: zitadel_secrets_file_content
      failed_when: false  # File may not exist or be malformed

    - name: Parse secrets content
      set_fact:
        existing_secrets: "{{ zitadel_secrets_file_content.content | b64decode | from_yaml }}"
      when:
        - zitadel_secrets_file_content is defined
        - zitadel_secrets_file_content.failed | default(false) | bool == false
        - zitadel_secrets_file_content.content is defined
      failed_when: false

    - name: Set existing secrets as facts
      set_fact:
        masterkey: "{{ existing_secrets.masterkey }}"
        postgresql_user: "{{ existing_secrets.postgresql.user }}"
        postgresql_password: "{{ existing_secrets.postgresql.password }}"
        postgresql_database: "{{ existing_secrets.postgresql.database }}"
        postgresql_host: "{{ existing_secrets.postgresql.host }}"
      when: existing_secrets is defined and existing_secrets is not none
  when: zitadel_secrets_file_stat.stat.exists

# 新しい秘密情報をファイルに保存
- name: Save secrets to file
  copy:
    dest: '{{ zitadel_secrets_file }}'
    content: |
      masterkey: "{{ masterkey }}"
      postgresql:
        user: "{{ postgresql_user }}"
        password: "{{ postgresql_password }}"
        database: "{{ postgresql_database }}"
        host: "{{ postgresql_host }}"
    mode: '0600'
  when: not zitadel_secrets_file_stat.stat.exists

- name: Create Docker Compose file
  template:
    src: zitadel_docker-compose.yml.j2
    dest: "{{ zitadel_dir }}/docker-compose.yml"
    mode: '0644'
  when: masterkey is defined

- name: Set correct permissions for Zitadel directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "1000"
    group: "1000"
  with_items:
    - "{{ zitadel_dir }}/data"
    - "{{ zitadel_dir }}/config"
    - "{{ zitadel_dir }}/logs"

- name: Start Zitadel services with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ zitadel_dir }}"
    pull: always
    state: present
  when: masterkey is defined
