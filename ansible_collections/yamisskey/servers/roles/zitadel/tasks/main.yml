---
- name: Load Zitadel secrets from inventory
  set_fact:
    zitadel_inventory_secrets: "{{ hostvars[inventory_hostname].zitadel | default({}) }}"
    zitadel_inventory_postgresql: "{{ (hostvars[inventory_hostname].zitadel | default({})).postgresql | default({}) }}"

- name: Prepare Zitadel secret values
  set_fact:
    masterkey: "{{ zitadel_inventory_secrets.masterkey | default('CHANGE_ME_ZITADEL_MASTERKEY') }}"
    postgresql_user: "{{ zitadel_inventory_postgresql.user | default('zitadel') }}"
    postgresql_password: "{{ zitadel_inventory_postgresql.password | default('CHANGE_ME_ZITADEL_DB_PASSWORD') }}"
    postgresql_database: "{{ zitadel_inventory_postgresql.database | default('zitadel') }}"
    postgresql_host: "{{ zitadel_inventory_postgresql.host | default('db') }}"

- name: Warn about placeholder Zitadel secrets
  debug:
    msg: >-
      Zitadel secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ zitadel.{{ item.key }}.
  loop:
    - { key: masterkey, value: "{{ masterkey }}" }
    - { key: postgresql_password, value: "{{ postgresql_password }}" }
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Create Zitadel directory
  file:
    path: "{{ zitadel_dir }}"
    state: directory
    mode: '0755'

- name: Create Zitadel data directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ zitadel_dir }}/data"
    - "{{ zitadel_dir }}/config"
    - "{{ zitadel_dir }}/logs"

- name: Create Docker Compose file
  template:
    src: zitadel_docker-compose.yml.j2
    dest: "{{ zitadel_dir }}/docker-compose.yml"
    mode: '0644'

- name: Set correct permissions for Zitadel directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "1000"
    group: "1000"
  loop:
    - "{{ zitadel_dir }}/data"
    - "{{ zitadel_dir }}/config"
    - "{{ zitadel_dir }}/logs"

- name: Start Zitadel services with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ zitadel_dir }}"
    pull: always
    state: present
