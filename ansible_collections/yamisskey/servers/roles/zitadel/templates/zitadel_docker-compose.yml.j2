---
services:
  zitadel:
    restart: 'always'
    networks:
      - 'zitadel'
    image: 'ghcr.io/zitadel/zitadel:{{ zitadel_version | default("latest") }}'
    extra_hosts:
      - "{{ zitadel_server_name }}:127.0.0.1"
    command: >
      start-from-init
      --masterkey "{{ masterkey }}"
      --tlsMode external
    environment:
      # 初期インスタンス設定
      ZITADEL_FIRSTINSTANCE_ORG_NAME: "{{ org_name }}"
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: "{{ admin_username }}"
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: "{{ admin_password }}"
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: "false"
      # Login v2設定
      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: /data/login-client.pat
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: login-client
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: "Login Client"
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: "{{ zitadel_pat_expiration | default('2029-01-01T00:00:00Z') }}"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "true"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: "https://{{ zitadel_server_name }}/ui/v2/login"
      ZITADEL_OIDC_DEFAULTLOGINURLV2: "https://{{ zitadel_server_name }}/ui/v2/login/login?authRequest="
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: "https://{{ zitadel_server_name }}/ui/v2/login/logout?post_logout_redirect="
      ZITADEL_SAML_DEFAULTLOGINURLV2: "https://{{ zitadel_server_name }}/ui/v2/login/login?samlRequest="
      # データベース設定
      ZITADEL_DATABASE_POSTGRES_HOST: "{{ postgresql_host }}"
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_DATABASE: "{{ postgresql_database }}"
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: "{{ postgresql_user }}"
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: "{{ postgresql_password }}"
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: "{{ postgresql_user }}"
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: "{{ postgresql_password }}"
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      # 外部アクセス設定
      ZITADEL_EXTERNALSECURE: "true"
      ZITADEL_EXTERNALDOMAIN: "{{ zitadel_server_name }}"
      ZITADEL_EXTERNALPORT: "443"
      # ログ設定
      ZITADEL_LOG_LEVEL: "{{ zitadel_log_level | default('info') }}"
    user: "0"
    volumes:
      - "{{ zitadel_dir }}/data:/data"
      - "{{ zitadel_dir }}/config:/config"
      - "{{ zitadel_dir }}/logs:/logs"
    depends_on:
      db:
        condition: 'service_healthy'
    ports:
      - '{{ zitadel_port | default(8993) }}:8080'
      - '{{ zitadel_login_port | default(3002) }}:3000'

  login:
    restart: 'always'
    image: 'ghcr.io/zitadel/zitadel-login:{{ zitadel_version | default("latest") }}'
    environment:
      ZITADEL_API_URL: "http://{{ zitadel_server_name }}:8080"
      NEXT_PUBLIC_BASE_PATH: "/ui/v2/login"
      ZITADEL_SERVICE_USER_TOKEN_FILE: "/data/login-client.pat"
    user: "0"
    volumes:
      - "{{ zitadel_dir }}/data:/data:ro"
    network_mode: "service:zitadel"

  db:
    restart: 'always'
    image: postgres:{{ postgresql_version | default('17-alpine') }}
    environment:
      POSTGRES_DB: "{{ postgresql_database }}"
      POSTGRES_USER: "{{ postgresql_user }}"
      POSTGRES_PASSWORD: "{{ postgresql_password }}"
    volumes:
      - "{{ zitadel_dir }}/postgres-data:/var/lib/postgresql/data"
      - "{{ zitadel_dir }}/postgres-init:/docker-entrypoint-initdb.d"
    networks:
      - 'zitadel'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d {{ postgresql_database }} -U {{ postgresql_user }}"]
      interval: '10s'
      timeout: '30s'
      retries: 5
      start_period: '20s'

networks:
  zitadel:
    name: zitadel_network