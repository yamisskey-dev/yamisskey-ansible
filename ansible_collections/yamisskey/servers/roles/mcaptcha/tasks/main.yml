# 事前に秘密情報ファイルの存在確認
- name: Check if mcaptcha secrets file exists
  stat:
    path: '{{ mcaptcha_secrets_file }}'
  register: mcaptcha_secrets_file_stat

# PostgreSQLパスワードの生成
- name: Generate PostgreSQL password if not exists
  shell: 'cat /dev/urandom | base64 -w 0 | fold -w 64 | head -n 1'
  register: postgres_password_output
  when: not mcaptcha_secrets_file_stat.stat.exists

# Cookie Secretの生成
- name: Generate cookie secret if not exists
  shell: 'cat /dev/urandom | base64 -w 0 | fold -w 64 | head -n 1'
  register: cookie_secret_output
  when: not mcaptcha_secrets_file_stat.stat.exists

# Captcha Saltの生成
- name: Generate captcha salt if not exists
  shell: 'cat /dev/urandom | base64 -w 0 | fold -w 64 | head -n 1'
  register: captcha_salt_output
  when: not mcaptcha_secrets_file_stat.stat.exists

- name: Cache generated secrets for current run
  set_fact:
    mcaptcha_generated_secrets:
      postgres_password: '{{ postgres_password_output.stdout }}'
      cookie_secret: '{{ cookie_secret_output.stdout }}'
      captcha_salt: '{{ captcha_salt_output.stdout }}'
  when:
    - not mcaptcha_secrets_file_stat.stat.exists
    - postgres_password_output is defined
    - cookie_secret_output is defined
    - captcha_salt_output is defined

- name: Load existing secrets from managed host
  when: mcaptcha_secrets_file_stat.stat.exists
  block:
    - name: Read secrets file
      slurp:
        src: '{{ mcaptcha_secrets_file }}'
      register: mcaptcha_secrets_raw
      failed_when: false

    - name: Parse existing secrets
      set_fact:
        mcaptcha_existing_secrets: '{{ mcaptcha_secrets_raw.content | b64decode | from_yaml }}'
      when:
        - mcaptcha_secrets_raw is defined
        - mcaptcha_secrets_raw.failed | default(false) | bool == false
        - mcaptcha_secrets_raw.content is defined
      failed_when: false

- name: Use existing PostgreSQL password when available
  set_fact:
    mcaptcha_postgres_password: '{{ mcaptcha_existing_secrets.postgresql.password }}'
  when:
    - mcaptcha_existing_secrets is defined
    - mcaptcha_existing_secrets.postgresql is defined
    - mcaptcha_existing_secrets.postgresql.password is defined

- name: Use generated PostgreSQL password when secrets were created
  set_fact:
    mcaptcha_postgres_password: '{{ mcaptcha_generated_secrets.postgres_password }}'
  when:
    - mcaptcha_postgres_password is not defined
    - mcaptcha_generated_secrets is defined
    - mcaptcha_generated_secrets.postgres_password is defined

- name: Use existing cookie secret when available
  set_fact:
    mcaptcha_cookie_secret: '{{ mcaptcha_existing_secrets.cookie_secret }}'
  when:
    - mcaptcha_existing_secrets is defined
    - mcaptcha_existing_secrets.cookie_secret is defined

- name: Use generated cookie secret when secrets were created
  set_fact:
    mcaptcha_cookie_secret: '{{ mcaptcha_generated_secrets.cookie_secret }}'
  when:
    - mcaptcha_cookie_secret is not defined
    - mcaptcha_generated_secrets is defined
    - mcaptcha_generated_secrets.cookie_secret is defined

- name: Use existing captcha salt when available
  set_fact:
    mcaptcha_captcha_salt: '{{ mcaptcha_existing_secrets.captcha_salt }}'
  when:
    - mcaptcha_existing_secrets is defined
    - mcaptcha_existing_secrets.captcha_salt is defined

- name: Use generated captcha salt when secrets were created
  set_fact:
    mcaptcha_captcha_salt: '{{ mcaptcha_generated_secrets.captcha_salt }}'
  when:
    - mcaptcha_captcha_salt is not defined
    - mcaptcha_generated_secrets is defined
    - mcaptcha_generated_secrets.captcha_salt is defined

- name: Ensure mCaptcha secrets are defined
  assert:
    that:
      - mcaptcha_postgres_password is defined
      - mcaptcha_postgres_password | length > 0
      - mcaptcha_cookie_secret is defined
      - mcaptcha_cookie_secret | length > 0
      - mcaptcha_captcha_salt is defined
      - mcaptcha_captcha_salt | length > 0
    fail_msg: >-
      mCaptcha secrets could not be determined. Ensure '{{ mcaptcha_secrets_file }}' exists
      or allow the role to generate new secrets.

# 必要なディレクトリの作成
- name: Create mCaptcha directories
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  loop:
    - '{{ mcaptcha_dir }}'
    - '{{ mcaptcha_dir }}/.config'
    - '{{ mcaptcha_dir }}/mcaptcha_db'

# 初回実行時のみ秘密情報をYAMLファイルに保存
- name: Save secrets to yaml file
  copy:
    dest: '{{ mcaptcha_secrets_file }}'
    content: |
      postgresql:
        user: "{{ mcaptcha_postgres_user }}"
        password: "{{ mcaptcha_postgres_password }}"
        database: "{{ mcaptcha_postgres_db }}"
      cookie_secret: "{{ mcaptcha_cookie_secret }}"
      captcha_salt: "{{ mcaptcha_captcha_salt }}"
  when: not mcaptcha_secrets_file_stat.stat.exists

# 環境変数ファイルの配置
- name: Configure mCaptcha environment
  template:
    src: mcaptcha.env-docker-compose.j2
    dest: '{{ mcaptcha_dir }}/.env-docker-compose'
    mode: '0600'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'

# docker-compose.yml の配置
- name: Copy docker-compose configuration
  template:
    src: mcaptcha_docker-compose.yml.j2
    dest: '{{ mcaptcha_dir }}/docker-compose.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'

- name: Ensure external Docker network exists
  community.docker.docker_network:
    name: external_network
    state: present

# サービスの起動
- name: Start mCaptcha services
  community.docker.docker_compose_v2:
    project_src: '{{ mcaptcha_dir }}'
    pull: "{{ 'never' if ansible_env.MOLECULE_SCENARIO_NAME is not defined else 'missing' }}"
    recreate: never
    state: present
  failed_when: false
