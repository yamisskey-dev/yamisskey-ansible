---
- name: Verify security deployment
  hosts: all
  gather_facts: true

  tasks:
    # ==========================================================================
    # Docker互換性テスト
    # ==========================================================================
    - name: Check if Docker is installed and running
      ansible.builtin.command: docker --version
      register: docker_version_check
      changed_when: false

    - name: Verify Docker is working
      ansible.builtin.command: docker ps
      register: docker_ps_check
      changed_when: false

    - name: Test Docker container creation
      ansible.builtin.command: docker run --rm hello-world
      register: docker_hello_world
      changed_when: false
      failed_when: false

    - name: Test Docker networking (container to container)
      ansible.builtin.shell: |
        docker network create test-net 2>/dev/null || true
        docker run -d --name test-server --network test-net nginx:alpine sleep 30 2>/dev/null || true
        docker run --rm --network test-net alpine ping -c 1 test-server 2>/dev/null || echo "ping test skipped"
        docker rm -f test-server 2>/dev/null || true
        docker network rm test-net 2>/dev/null || true
      register: docker_network_test
      changed_when: false
      failed_when: false

    # ==========================================================================
    # sysctl設定検証 (コンテナ内では一部スキップ)
    # ==========================================================================
    - name: Check IP forwarding is enabled for Docker
      ansible.builtin.command: sysctl net.ipv4.conf.all.forwarding
      register: ip_forward_check
      changed_when: false
      failed_when: false

    - name: Verify IP forwarding value
      ansible.builtin.assert:
        that:
          - "'1' in ip_forward_check.stdout"
        fail_msg: "IP forwarding is disabled - Docker networking will fail"
        success_msg: "IP forwarding is enabled"
      when: ip_forward_check.rc == 0

    # ==========================================================================
    # カーネルモジュールブラックリスト検証
    # ==========================================================================
    - name: Check if blacklist config exists
      ansible.builtin.stat:
        path: /etc/modprobe.d/security-blacklist.conf
      register: blacklist_config

    - name: Check if prevention config exists
      ansible.builtin.stat:
        path: /etc/modprobe.d/security-prevent.conf
      register: prevent_config

    # ==========================================================================
    # サービス稼働確認
    # ==========================================================================
    - name: Check UFW status
      ansible.builtin.command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false
      become: true

    # ==========================================================================
    # 基本検証
    # ==========================================================================
    - name: Verify role execution completed without errors
      ansible.builtin.stat:
        path: /tmp/test
      register: test_dir_check

    - name: Assert test directory exists
      ansible.builtin.assert:
        that:
          - test_dir_check.stat.exists
          - test_dir_check.stat.isdir
        fail_msg: "Test directory was not created"
        success_msg: "Test directory created successfully"

    # ==========================================================================
    # テスト結果サマリー
    # ==========================================================================
    - name: Display test summary
      ansible.builtin.debug:
        msg: |
          security Role Verification Summary:
          ====================================
          Docker Tests:
            - Version: {{ docker_version_check.stdout | default('N/A') }}
            - docker ps: {{ 'PASS' if docker_ps_check.rc == 0 else 'FAIL' }}
            - hello-world: {{ 'PASS' if docker_hello_world.rc == 0 else 'SKIPPED (network)' }}
            - Network test: {{ 'PASS' if 'ping test skipped' not in docker_network_test.stdout else 'SKIPPED' }}

          Sysctl Tests:
            - IP forwarding: {{ ip_forward_check.stdout | default('N/A') }}

          Config Files:
            - Blacklist config: {{ 'EXISTS' if blacklist_config.stat.exists | default(false) else 'NOT FOUND' }}
            - Prevent config: {{ 'EXISTS' if prevent_config.stat.exists | default(false) else 'NOT FOUND' }}

          Firewall:
            - UFW: {{ 'ACTIVE' if 'active' in (ufw_status.stdout | default('')) else 'INACTIVE/SKIPPED' }}

          Role: security
          Collection: yamisskey.servers
          Test Instance: security-test-instance
