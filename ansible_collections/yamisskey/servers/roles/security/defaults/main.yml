---
# Security role default variables

# Package management
security_packages:
  - rsyslog
  - logrotate
  - ufw
  - tailscale
  - lynis
  - clamav
  - clamav-daemon
  - dnscrypt-proxy

# UFW firewall configuration
security_ufw_enable: true
security_ufw_default_incoming: deny
security_ufw_default_outgoing: allow
security_ufw_logging: "off"

# SSH configuration
security_ssh_ports:
  - 22
  - 2222

security_ssh_settings:
  - 'AuthorizedKeysFile .ssh/authorized_keys'
  - 'RSAAuthentication yes'
  - 'PubkeyAuthentication yes'
  - 'AllowTcpForwarding yes'
  - 'ClientAliveCountMax 3'
  - 'Compression no'
  - 'LogLevel INFO'
  - 'MaxAuthTries 10'
  - 'MaxSessions 10'
  - 'TCPKeepAlive yes'
  - 'X11Forwarding no'
  - 'AllowAgentForwarding yes'

# ClamAV configuration
security_clamav_scan_schedule:
  minute: '0'
  hour: '19'  # UTC 19:00 = JST 04:00
  job: "/usr/bin/timeout 1h45m /usr/bin/nice -n 19 /usr/bin/clamdscan -m --fdpass --config-file=/etc/clamav/clamd.conf -l /var/log/clamav/clamav-$(date +\\%Y\\%m\\%d).log /"

# DNS over HTTPS configuration
security_dnscrypt_proxy_listen_address: "127.0.0.1:5300"
security_dnscrypt_proxy_servers:
  - "cloudflare"
  - "cloudflare-ipv6"
  - "quad9-dnscrypt-ip4-nofilter-pri"

# Docker DNS settings
security_docker_dns_servers:
  - "127.0.0.1"
  - "1.1.1.1"

# Service restart settings
security_restart_services_on_change: true

# Service management toggles
security_manage_clamav: true

# Docker network monitoring access
# Allow Docker containers to access monitoring ports on host
security_docker_monitoring_enabled: true
security_docker_networks:
  - "172.17.0.0/16"   # Default Docker bridge
  - "172.18.0.0/16"   # Docker compose networks
  - "172.20.0.0/16"   # Monitor network
security_monitoring_ports:
  - 9100  # Node Exporter
  - 8085  # cAdvisor
  - 49312 # Cloudflared metrics

# systemd-resolved configuration
security_systemd_resolved_dns: "127.0.0.1"
security_systemd_resolved_fallback_dns: "1.1.1.1"

# =============================================================================
# カーネルハードニング設定 (eBPF/grsecurity/PaX相当)
# =============================================================================

# GRUBカーネルパラメータ (ブート時のセキュリティ強化)
security_kernel_hardening_enabled: true
security_grub_cmdline_extra:
  # Spectre/Meltdown緩和
  - "spectre_v2=on"
  - "spec_store_bypass_disable=on"
  - "l1tf=full,force"
  - "mds=full,nosmt"
  # IOMMU保護
  - "iommu=force"
  - "intel_iommu=on"
  - "amd_iommu=on"
  # メモリ保護
  - "init_on_alloc=1"
  - "init_on_free=1"
  - "page_alloc.shuffle=1"
  - "slab_nomerge"
  - "pti=on"
  # デバッグ/情報漏洩防止
  - "debugfs=off"
  - "lockdown=confidentiality"
  # ランダム化強化
  - "randomize_kstack_offset=on"
  # vsyscall無効化 (ROPガジェット削減)
  - "vsyscall=none"
  # モジュール署名強制 (オプション)
  # - "module.sig_enforce=1"

# カーネルモジュールブラックリスト
# 不要な/危険なモジュールをロード禁止
security_kernel_module_blacklist:
  # 不要なファイルシステム
  - cramfs
  - freevxfs
  - hfs
  - hfsplus
  - jffs2
  # - squashfs  # Snapパッケージで必要なため除外
  - udf
  # 不要なネットワークプロトコル
  - dccp
  - sctp
  - rds
  - tipc
  # Firewire (DMA攻撃)
  - firewire-core
  - firewire-ohci
  - firewire-sbp2
  # Thunderbolt (DMA攻撃)
  - thunderbolt
  # Bluetooth (攻撃ベクトル削減)
  - bluetooth
  - btusb
  # USB storage (オプション - 必要に応じてコメントアウト)
  # - usb-storage
  # - uas
  # その他危険なモジュール
  - cramfs
  - vivid  # CAP_NET_ADMIN権限昇格

# lockdownモード設定 (integrity または confidentiality)
# integrity: カーネル整合性保護
# confidentiality: integrity + カーネルメモリ読み取り禁止
security_lockdown_mode: "confidentiality"

# io_uring制限レベル
# 0: 全ユーザー許可
# 1: CAP_SYS_ADMIN必要
# 2: 完全無効
security_io_uring_disabled: 2

# ユーザー名前空間の最大数
# 注意: 0はDocker rootlessモードと非互換
# 通常のDocker (root) では影響なし
# security_user_max_namespaces: 0  # 必要な場合のみ有効化
