- name: Validate rsyslog configuration
  ansible.builtin.command: rsyslogd -N1
  register: rsyslog_validation
  failed_when: 'rsyslog_validation.rc != 0'
  changed_when: false
  notify: Restart rsyslog

- name: Restart rsyslog
  ansible.builtin.systemd:
    name: rsyslog
    state: restarted
  become: true

- name: Restart fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: restarted
    enabled: true
  become: true
  when:
    - ansible_env.MOLECULE_SCENARIO_NAME is undefined
    - ansible_virtualization_type is undefined or ansible_virtualization_type not in ['docker', 'container']
  failed_when: false

- name: Restart crowdsec
  ansible.builtin.systemd:
    name: crowdsec
    state: restarted
    daemon_reload: true
  become: true

- name: Restart crowdsec-firewall-bouncer
  ansible.builtin.systemd:
    name: crowdsec-firewall-bouncer
    state: restarted
    daemon_reload: true
  become: true

- name: Reload sysctl
  ansible.builtin.command: sysctl -p
  become: true
  changed_when: false

- name: Restart SSH service
  ansible.builtin.systemd:
    name: ssh
    state: restarted
  when:
    - ansible_env.MOLECULE_SCENARIO_NAME is undefined
    - ansible_virtualization_type is undefined or ansible_virtualization_type not in ['docker', 'container']
  failed_when: false

- name: Restart systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    state: restarted
  become: true

- name: Restart dnscrypt-proxy
  ansible.builtin.systemd:
    name: dnscrypt-proxy
    state: restarted
  become: true

- name: Restart Docker
  ansible.builtin.systemd:
    name: docker
    state: restarted
  become: true

- name: Restart clamav-daemon
  ansible.builtin.systemd:
    name: clamav-daemon
    state: restarted
    enabled: true
  become: true
