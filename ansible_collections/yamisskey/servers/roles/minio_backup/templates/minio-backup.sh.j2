#!/bin/bash
# MinIO Backup Script - rsync to TrueNAS
# Generated by Ansible - do not edit manually

set -uo pipefail

# Configuration
SOURCE_DIR="{{ minio_backup_source_dir }}"
TRUENAS_HOST="{{ minio_backup_truenas_host }}"
TRUENAS_USER="{{ minio_backup_truenas_user }}"
TRUENAS_DEST="{{ minio_backup_truenas_dest }}"
SSH_KEY="{{ minio_backup_ssh_key }}"
LOG_DIR="{{ minio_backup_log_dir }}"
{% if minio_backup_bandwidth_limit %}
BANDWIDTH_LIMIT="{{ minio_backup_bandwidth_limit }}"
{% endif %}
{% if minio_backup_discord_webhook_url %}
DISCORD_WEBHOOK_URL="{{ minio_backup_discord_webhook_url }}"
{% endif %}

# Initialize
RSYNC_EXIT=0
SOURCE_SIZE="unknown"

{% if minio_backup_discord_webhook_url %}
# Discord notification function
send_discord_notification() {
    local status="$1"
    local color="$2"
    local message="$3"

    local payload=$(cat <<EOJSON
{
  "embeds": [{
    "title": "MinIO Backup ${status}",
    "description": "${message}",
    "color": ${color},
    "fields": [
      {"name": "Source", "value": "${SOURCE_DIR}", "inline": true},
      {"name": "Destination", "value": "${TRUENAS_HOST}:${TRUENAS_DEST}", "inline": true},
      {"name": "Size", "value": "${SOURCE_SIZE}", "inline": true}
    ],
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }]
}
EOJSON
)

    curl -s -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" >/dev/null 2>&1 || true
}
{% endif %}

# Logging
LOG_FILE="${LOG_DIR}/minio-backup-$(date +%Y%m%d-%H%M%S).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "========================================"
echo "MinIO Backup Started: $(date)"
echo "========================================"
echo "Source: ${SOURCE_DIR}"
echo "Destination: ${TRUENAS_USER}@${TRUENAS_HOST}:${TRUENAS_DEST}"
echo ""

# Check source directory exists
if [[ ! -d "$SOURCE_DIR" ]]; then
    echo "ERROR: Source directory does not exist: $SOURCE_DIR"
{% if minio_backup_discord_webhook_url %}
    send_discord_notification "Failed" "15158332" "Source directory does not exist"
{% endif %}
    exit 1
fi

# Check SSH connectivity
echo "Checking SSH connectivity..."
if ! ssh -i "$SSH_KEY" -o BatchMode=yes -o IdentitiesOnly=yes -o ConnectTimeout=10 \
    "${TRUENAS_USER}@${TRUENAS_HOST}" "echo 'SSH OK'" >/dev/null 2>&1; then
    echo "ERROR: Cannot connect to TrueNAS via SSH"
{% if minio_backup_discord_webhook_url %}
    send_discord_notification "Failed" "15158332" "Cannot connect to TrueNAS via SSH"
{% endif %}
    exit 1
fi
echo "SSH connection OK"
echo ""

# Get source size
SOURCE_SIZE=$(du -sh "$SOURCE_DIR" 2>/dev/null | cut -f1)
echo "Source size: $SOURCE_SIZE"
echo ""

# Run rsync
echo "Starting rsync..."
RSYNC_OPTS="{{ minio_backup_rsync_opts }}"
{% if minio_backup_bandwidth_limit %}
RSYNC_OPTS="${RSYNC_OPTS} --bwlimit=${BANDWIDTH_LIMIT}"
{% endif %}

rsync $RSYNC_OPTS \
    -e "ssh -i $SSH_KEY -o BatchMode=yes -o IdentitiesOnly=yes" \
    "$SOURCE_DIR/" \
    "${TRUENAS_USER}@${TRUENAS_HOST}:${TRUENAS_DEST}/"

RSYNC_EXIT=$?

echo ""
if [[ $RSYNC_EXIT -eq 0 ]]; then
    echo "========================================"
    echo "Backup completed successfully: $(date)"
    echo "========================================"
{% if minio_backup_discord_webhook_url %}
    send_discord_notification "Success" "3066993" "Backup completed successfully"
{% endif %}
else
    echo "========================================"
    echo "Backup FAILED with exit code: $RSYNC_EXIT"
    echo "========================================"
{% if minio_backup_discord_webhook_url %}
    send_discord_notification "Failed" "15158332" "Backup failed with exit code: $RSYNC_EXIT"
{% endif %}
fi

# Cleanup old logs (keep 30 days)
find "$LOG_DIR" -name "minio-backup-*.log" -mtime +30 -delete 2>/dev/null || true

echo "Log saved to: $LOG_FILE"

exit $RSYNC_EXIT
