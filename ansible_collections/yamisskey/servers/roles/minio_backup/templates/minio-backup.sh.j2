#!/bin/bash
# MinIO Backup Script - rsync to TrueNAS
# Generated by Ansible - do not edit manually

set -euo pipefail

# Configuration
SOURCE_DIR="{{ minio_backup_source_dir }}"
TRUENAS_HOST="{{ minio_backup_truenas_host }}"
TRUENAS_USER="{{ minio_backup_truenas_user }}"
TRUENAS_DEST="{{ minio_backup_truenas_dest }}"
SSH_KEY="{{ minio_backup_ssh_key }}"
LOG_DIR="{{ minio_backup_log_dir }}"
{% if minio_backup_bandwidth_limit %}
BANDWIDTH_LIMIT="{{ minio_backup_bandwidth_limit }}"
{% endif %}

# Logging
LOG_FILE="${LOG_DIR}/minio-backup-$(date +%Y%m%d-%H%M%S).log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "========================================"
echo "MinIO Backup Started: $(date)"
echo "========================================"
echo "Source: ${SOURCE_DIR}"
echo "Destination: ${TRUENAS_USER}@${TRUENAS_HOST}:${TRUENAS_DEST}"
echo ""

# Check source directory exists
if [[ ! -d "$SOURCE_DIR" ]]; then
    echo "ERROR: Source directory does not exist: $SOURCE_DIR"
    exit 1
fi

# Check SSH connectivity
echo "Checking SSH connectivity..."
if ! ssh -i "$SSH_KEY" -o BatchMode=yes -o ConnectTimeout=10 \
    "${TRUENAS_USER}@${TRUENAS_HOST}" "echo 'SSH OK'" >/dev/null 2>&1; then
    echo "ERROR: Cannot connect to TrueNAS via SSH"
    exit 1
fi
echo "SSH connection OK"
echo ""

# Get source size
SOURCE_SIZE=$(du -sh "$SOURCE_DIR" 2>/dev/null | cut -f1)
echo "Source size: $SOURCE_SIZE"
echo ""

# Run rsync
echo "Starting rsync..."
RSYNC_OPTS="{{ minio_backup_rsync_opts }}"
{% if minio_backup_bandwidth_limit %}
RSYNC_OPTS="${RSYNC_OPTS} --bwlimit=${BANDWIDTH_LIMIT}"
{% endif %}

rsync $RSYNC_OPTS \
    -e "ssh -i $SSH_KEY -o BatchMode=yes" \
    "$SOURCE_DIR/" \
    "${TRUENAS_USER}@${TRUENAS_HOST}:${TRUENAS_DEST}/"

RSYNC_EXIT=$?

echo ""
if [[ $RSYNC_EXIT -eq 0 ]]; then
    echo "========================================"
    echo "Backup completed successfully: $(date)"
    echo "========================================"
else
    echo "========================================"
    echo "Backup FAILED with exit code: $RSYNC_EXIT"
    echo "========================================"
    exit $RSYNC_EXIT
fi

# Cleanup old logs (keep 30 days)
find "$LOG_DIR" -name "minio-backup-*.log" -mtime +30 -delete 2>/dev/null || true

echo "Log saved to: $LOG_FILE"
