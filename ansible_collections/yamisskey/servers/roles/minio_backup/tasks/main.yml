---
- name: Create backup directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  loop:
    - "{{ minio_backup_dir }}"
    - "{{ minio_backup_log_dir }}"

- name: Deploy backup script
  template:
    src: minio-backup.sh.j2
    dest: "{{ minio_backup_dir }}/minio-backup.sh"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Deploy systemd service
  template:
    src: minio-backup.service.j2
    dest: /etc/systemd/system/minio-backup.service
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Reload systemd

- name: Deploy systemd timer
  template:
    src: minio-backup.timer.j2
    dest: /etc/systemd/system/minio-backup.timer
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Reload systemd
    - Enable minio-backup timer

- name: Ensure TrueNAS host key is known
  known_hosts:
    name: "{{ minio_backup_truenas_host }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 ' + minio_backup_truenas_host + ' 2>/dev/null') }}"
    state: present
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined
