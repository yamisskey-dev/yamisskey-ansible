---
- name: Verify minio-backup deployment
  hosts: all
  gather_facts: false

  tasks:
    - name: Check backup directory exists
      ansible.builtin.stat:
        path: /opt/minio-backup
      register: backup_dir_check

    - name: Assert backup directory exists
      assert:
        that:
          - backup_dir_check.stat.exists
          - backup_dir_check.stat.isdir
        fail_msg: "Backup directory was not created"
        success_msg: "Backup directory created successfully"

    - name: Check log directory exists
      ansible.builtin.stat:
        path: /var/log/minio-backup
      register: log_dir_check

    - name: Assert log directory exists
      assert:
        that:
          - log_dir_check.stat.exists
          - log_dir_check.stat.isdir
        fail_msg: "Log directory was not created"
        success_msg: "Log directory created successfully"

    - name: Check backup script exists
      ansible.builtin.stat:
        path: /opt/minio-backup/minio-backup.sh
      register: script_check

    - name: Assert backup script exists and is executable
      assert:
        that:
          - script_check.stat.exists
          - script_check.stat.executable
        fail_msg: "Backup script was not created or is not executable"
        success_msg: "Backup script created successfully"

    - name: Check systemd service file exists
      ansible.builtin.stat:
        path: /etc/systemd/system/minio-backup.service
      register: service_check

    - name: Assert systemd service file exists
      assert:
        that:
          - service_check.stat.exists
        fail_msg: "Systemd service file was not created"
        success_msg: "Systemd service file created successfully"

    - name: Check systemd timer file exists
      ansible.builtin.stat:
        path: /etc/systemd/system/minio-backup.timer
      register: timer_check

    - name: Assert systemd timer file exists
      assert:
        that:
          - timer_check.stat.exists
        fail_msg: "Systemd timer file was not created"
        success_msg: "Systemd timer file created successfully"

    - name: Display test summary
      debug:
        msg: |
          minio-backup Role Verification Summary:
          ====================================
          ✅ Backup directory: /opt/minio-backup
          ✅ Log directory: /var/log/minio-backup
          ✅ Backup script: /opt/minio-backup/minio-backup.sh
          ✅ Systemd service: /etc/systemd/system/minio-backup.service
          ✅ Systemd timer: /etc/systemd/system/minio-backup.timer

          Role: minio-backup
          Collection: yamisskey.servers
          Test Instance: minio-backup-test-instance
