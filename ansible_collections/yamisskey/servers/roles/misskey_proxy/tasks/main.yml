---
- name: Install required packages
  package:
    name:
      - docker.io
      - docker-compose-plugin
      - squid
      - git
  become: true
  when:
    - ansible_env.MOLECULE_SCENARIO_NAME is undefined
    - ansible_virtualization_type is undefined or ansible_virtualization_type not in ['docker', 'container']
  failed_when: false

- name: Install required packages for test environment
  package:
    name:
      - squid
      - git
  become: true
  when:
    - ansible_env.MOLECULE_SCENARIO_NAME is defined or (ansible_virtualization_type is defined and ansible_virtualization_type in ['docker', 'container'])
  failed_when: false

- name: Check Docker service status
  systemd:
    name: docker
  register: docker_service_status
  become: true
  when:
    - ansible_service_mgr | default('') == 'systemd'
  failed_when: false

- name: Check if Docker is running using command
  command: systemctl is-active docker
  register: docker_active_check
  become: true
  when:
    - ansible_service_mgr | default('') == 'systemd'
  failed_when: false
  changed_when: false

- name: Display Docker service status
  debug:
    msg: |
      Docker service status:
      - Status: {{ docker_service_status.status | default('unknown') }}
      - ActiveState: {{ docker_service_status.status.ActiveState | default('undefined') }}
      - SubState: {{ docker_service_status.status.SubState | default('undefined') }}
  when:
    - docker_service_status is defined
    - docker_service_status.status is defined

- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: true
  become: true
  register: docker_start_result
  when:
    - ansible_service_mgr | default('') == 'systemd'
    - docker_active_check is defined
    - docker_active_check.stdout != 'active'
  failed_when: false

- name: Try alternative Docker service start
  command: systemctl start docker
  become: true
  register: docker_alt_start_result
  when:
    - docker_start_result is defined
    - docker_start_result.failed | default(false)
    - ansible_service_mgr | default('') == 'systemd'
    - docker_active_check is defined
    - docker_active_check.stdout != 'active'
  failed_when: false

- name: Verify Docker is running
  command: docker --version
  register: docker_version_check
  failed_when: false
  changed_when: false

- name: Fail if Docker is not available
  fail:
    msg: "Docker is not available or not running"
  when:
    - docker_version_check.rc != 0
    - ansible_env.MOLECULE_SCENARIO_NAME is not defined

- name: Create proxy directories
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
  loop:
    - '{{ proxy_dir }}'
    - '{{ squid_cache_dir }}'
    - '{{ squid_log_dir }}'
  become: true

- name: Deploy Squid configuration
  template:
    src: squid.conf.j2
    dest: '{{ proxy_squid_config_dir }}/squid.conf'
    backup: true
    mode: '0644'
  become: true
  notify: restart squid

- name: Start and enable Squid service
  systemd:
    name: squid
    state: started
    enabled: true
  become: true

- name: Clone summaly-docker repository
  git:
    repo: '{{ summaly_repo }}'
    dest: '{{ summaly_dir }}'
    version: main
    force: true

- name: Initialize git submodules for summaly-docker
  shell: |
    cd {{ summaly_dir }}
    git submodule init
    git submodule update
  register: submodule_output
  changed_when: submodule_output.stdout != ""

- name: Deploy summaly-docker service
  shell: |
    cd {{ summaly_dir }}/example
    docker compose up -d
  register: summaly_deploy
  changed_when: "'Creating' in summaly_deploy.stdout or 'Starting' in summaly_deploy.stdout"

- name: Deploy media-proxy-rs container
  community.docker.docker_container:
    name: media-proxy-rs-server
    image: 'ghcr.io/yamisskey/media-proxy-rs:main'
    ports:
      - '{{ host_services[inventory_hostname].media_proxy_rs | default(default_proxy_ports.media_proxy_rs) }}:{{ host_services[inventory_hostname].media_proxy_rs | default(default_proxy_ports.media_proxy_rs) }}'
    state: started
    restart_policy: always
    detach: true
    pull: always

- name: Deploy nginx proxy container
  community.docker.docker_container:
    name: proxy
    image: nginx
    ports:
      - '{{ host_services[inventory_hostname].nginx | default(default_proxy_ports.nginx) }}:{{ host_services[inventory_hostname].nginx | default(default_proxy_ports.nginx) }}'
    state: started
    restart_policy: always
    detach: true
    pull: always

- name: Check running containers
  command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Ports{{ '}}' }}"
  register: container_status
  changed_when: false

- name: Display container status
  debug:
    var: container_status.stdout_lines
