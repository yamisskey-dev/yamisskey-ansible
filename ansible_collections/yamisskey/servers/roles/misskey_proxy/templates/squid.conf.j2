# キャッシング設定
cache_dir ufs {{ squid_cache_dir }} {{ squid_cache_size }} 16 256

# ロギング（詳細度を上げる）
access_log {{ squid_log_dir }}/access.log squid
cache_log {{ squid_log_dir }}/cache.log
debug_options ALL,1 # 一時的に詳細ログを有効化

# ActivityPub向けキャッシュパラメータ
refresh_pattern -i \.(gif|png|jpg|jpeg|ico|webp)$ 10080 90% 43200 ignore-no-cache
refresh_pattern -i \.(json|jrd)$ 60 20% 240
refresh_pattern -i /actor$ 60 20% 240
refresh_pattern -i /inbox$ 0 0% 0 # inboxはキャッシュしない
refresh_pattern -i /outbox$ 60 20% 240
refresh_pattern .               0       20%     4320

# 基本セキュリティ設定
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# ローカルネットワークへのアクセスを禁止
acl localdst dst 0.0.0.1-0.255.255.255
acl localdst dst 10.0.0.0/8
acl localdst dst 100.64.0.0/10
acl localdst dst 169.254.0.0/16
acl localdst dst 172.16.0.0/12
acl localdst dst 192.168.0.0/16
acl localdst dst fc00::/7
acl localdst dst fe80::/10
http_access deny localdst

# ローカルホストからのアクセスを許可
acl localhost src 127.0.0.0/8
http_access allow localhost

# ヘッダー処理（ActivityPub署名のため重要）
via off
forwarded_for off
request_header_access Via deny all
request_header_access X-Forwarded-For deny all
request_header_access From deny all

# タイムアウト設定を緩める
connect_timeout 30 seconds
read_timeout 5 minutes
request_timeout 5 minutes
persistent_request_timeout 2 minutes

# Misskeyサーバーからのアクセスのみ許可
acl misskey_servers src {% for ip in misskey_server_ips %}{{ ip }}{% if not loop.last %} {% endif %}{% endfor %}

http_access allow misskey_servers
http_access deny all

# ポート
http_port {{ squid_port }}

# DNS
dns_nameservers {% for dns in squid_dns_servers %}{{ dns }}{% if not loop.last %} {% endif %}{% endfor %}
