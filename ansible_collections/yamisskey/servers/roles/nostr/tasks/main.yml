---
- name: Create Nostr relay directory
  file:
    path: "{{ nostr_dir }}"
    state: directory
    mode: '0755'

- name: Create Nostr data directory
  file:
    path: "{{ nostr_dir }}/data"
    state: directory
    mode: '0755'
    owner: '100'
    group: '100'

- name: Create Nostr config file
  template:
    src: config.toml.j2
    dest: "{{ nostr_dir }}/config.toml"
    mode: '0644'
  notify: Restart nostr

- name: Create Docker Compose file
  template:
    src: nostr_docker-compose.yml.j2
    dest: "{{ nostr_dir }}/docker-compose.yml"
    mode: '0644'

- name: Start Nostr relay with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ nostr_dir }}"
    pull: "{{ 'never' if (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != '' else 'missing' }}"
    remove_orphans: true
  failed_when: false
  register: nostr_compose_result
  changed_when: nostr_compose_result.changed | default(false)
  when:
    - (ansible_env.MOLECULE_SCENARIO_NAME | default('')) == ''
    - ansible_virtualization_type | default('') not in ['docker', 'container']

- name: Start Nostr relay with Docker Compose v2 (test environment)
  community.docker.docker_compose_v2:
    project_src: "{{ nostr_dir }}"
    pull: never
    remove_orphans: true
  failed_when: false
  register: nostr_compose_test_result
  changed_when: false
  when: (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != ''
