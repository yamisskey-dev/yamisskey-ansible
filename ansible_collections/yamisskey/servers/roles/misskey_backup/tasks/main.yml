- name: Create backup directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
    mode: '0755'
  loop:
    - "{{ backup_dir }}/misskey"
    - "/opt/misskey-backup"
    - "/opt/misskey-backup/config"
    - "/opt/misskey-backup/src"
    - "/opt/misskey-backup/backups"

- name: Clone misskey-backup repository
  git:
    repo: "https://github.com/yamisskey-dev/yamisskey-backup.git"
    dest: "/opt/misskey-backup"
    version: "main"
    force: true
  register: git_clone
  failed_when: false

- name: Create rclone config file
  template:
    src: rclone.conf.j2
    dest: /opt/misskey-backup/config/rclone.conf
    mode: '0644'
  notify: Restart backup container
  when:
    - RCLONE_CONFIG_BACKUP_ACCESS_KEY_ID is defined
    - ansible_env.MOLECULE_SCENARIO_NAME is not defined
  failed_when: false

- name: Check if Docker Compose file exists
  stat:
    path: "{{ item }}"
  register: compose_file_check
  loop:
    - "/opt/misskey-backup/docker-compose.yml"
    - "/opt/misskey-backup/docker-compose.yaml"
    - "/opt/misskey-backup/compose.yml"
    - "/opt/misskey-backup/compose.yaml"

- name: Create basic Docker Compose file if not found
  copy:
    content: |
      services:
        misskey-backup:
          image: alpine:latest
          container_name: misskey-backup
          volumes:
            - /opt/misskey-backup:/backup
            - /opt/misskey-backup/config:/config
          command: /bin/sh -c "while true; do sleep 3600; done"
          restart: unless-stopped
    dest: /opt/misskey-backup/docker-compose.yml
    mode: '0644'
  when: not compose_file_check.results | selectattr('stat.exists') | list

- name: Re-check Docker Compose file after creation
  stat:
    path: "/opt/misskey-backup/docker-compose.yml"
  register: final_compose_check
  when: not compose_file_check.results | selectattr('stat.exists') | list

- name: Set Docker Compose file path
  set_fact:
    compose_file_path: "{{ (compose_file_check.results | selectattr('stat.exists') | first).item if compose_file_check.results | selectattr('stat.exists') | list else '/opt/misskey-backup/docker-compose.yml' }}"

- name: Check if backup service is already running
  command: docker inspect -f "{% raw %}{{.State.Status}}{% endraw %}" backup
  register: backup_container_status
  changed_when: false
  failed_when: false

- name: Determine backup container running state
  set_fact:
    backup_container_running: "{{ backup_container_status.rc == 0 and backup_container_status.stdout == 'running' }}"

- name: Pull and build Docker images
  community.docker.docker_compose_v2:
    project_src: /opt/misskey-backup
    pull: always
    build: always
  when: 
    - not backup_container_running | bool
    - compose_file_path is defined
  register: compose_pull_build

- name: Start Docker Compose services
  community.docker.docker_compose_v2:
    project_src: /opt/misskey-backup
  when: 
    - not backup_container_running | bool
    - compose_file_path is defined
  register: compose_start

- name: Check if backup container is running
  command: docker ps --filter name=misskey-backup --format "{{.Names}}"
  register: backup_container_check
  failed_when: false
  changed_when: false

- name: List files in backup container
  command: docker exec misskey-backup ls -la /
  register: container_files
  when: backup_container_check.stdout == 'misskey-backup'
  failed_when: false
  changed_when: false

- name: Display container files
  debug:
    msg: "Container files: {{ container_files.stdout_lines | default([]) }}"
  when: 
    - backup_container_check.stdout == 'misskey-backup'
    - container_files is defined

- name: Find backup script in container
  command: docker exec misskey-backup find / -name "*.sh" -type f 2>/dev/null
  register: backup_scripts
  when: backup_container_check.stdout == 'misskey-backup'
  failed_when: false
  changed_when: false

- name: Display found scripts
  debug:
    msg: "Found scripts: {{ backup_scripts.stdout_lines | default([]) }}"
  when: 
    - backup_container_check.stdout == 'misskey-backup'
    - backup_scripts is defined

- name: Run manual backup script
  command: docker exec misskey-backup /backup.sh
  when: 
    - backup_container_check.stdout == 'misskey-backup'
    - backup_scripts is defined
    - "'/backup.sh' in (backup_scripts.stdout_lines | default([]))"
  failed_when: false

- name: Run alternative backup script
  command: docker exec misskey-backup /usr/local/bin/backup.sh
  when: 
    - backup_container_check.stdout == 'misskey-backup'
    - backup_scripts is defined
    - "'/usr/local/bin/backup.sh' in (backup_scripts.stdout_lines | default([]))"
  failed_when: false

- name: Skip backup if no script found
  debug:
    msg: "No backup script found in container, skipping manual backup"
  when: 
    - backup_container_check.stdout == 'misskey-backup'
    - backup_scripts is defined
    - "'/backup.sh' not in (backup_scripts.stdout_lines | default([]))"
    - "'/usr/local/bin/backup.sh' not in (backup_scripts.stdout_lines | default([]))"

- name: Skip backup if container not running
  debug:
    msg: "Backup container is not running, skipping manual backup"
  when: backup_container_check.stdout != 'misskey-backup'

- name: Load secrets from secrets.yml
  include_vars:
    file: '{{ misskey_backup_secrets_file }}'
