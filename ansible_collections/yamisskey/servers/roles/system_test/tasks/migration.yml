---
- name: Test 5 - Check migrate role structure
  block:
    - name: Check migrate role directory
      stat:
        path: "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/migrate"
      register: migrate_role_check

    - name: Check migrate tasks file
      stat:
        path: "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/migrate/tasks/main.yml"
      register: migrate_tasks_check

    - name: Set migrate role test result
      set_fact:
        migrate_test: "{{ 'âœ… Complete' if migrate_role_check.stat.exists and migrate_tasks_check.stat.exists else 'âš ï¸ Incomplete' }}"

    - name: Display migrate role test
      debug:
        msg: |
          ğŸ” Test 5: Migrate role structure - {{ migrate_test }}
          ğŸ“ Role directory: {{ 'âœ…' if migrate_role_check.stat.exists else 'âŒ' }}
          ğŸ“„ Tasks file: {{ 'âœ…' if migrate_tasks_check.stat.exists else 'âŒ' }}

- name: Test 6 - Progress monitoring features
  block:
    - name: Check for async/poll patterns in migrate tasks
      shell: |
        if [ -f "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/migrate/tasks/main.yml" ]; then
          async_count=$(grep -c "async:" "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/migrate/tasks/main.yml" || echo "0")
          poll_count=$(grep -c "poll:" "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/migrate/tasks/main.yml" || echo "0")
          echo "async:$async_count,poll:$poll_count"
        else
          echo "async:0,poll:0"
        fi
      register: progress_features
      changed_when: false

    - name: Parse progress monitoring results
      set_fact:
        async_enabled: "{{ progress_features.stdout.split(',')[0].split(':')[1] | int > 0 }}"
        poll_enabled: "{{ progress_features.stdout.split(',')[1].split(':')[1] | int > 0 }}"

    - name: Set progress monitoring test result
      set_fact:
        progress_test: "{{ 'âœ… Configured' if async_enabled and poll_enabled else 'âš ï¸ Not configured' }}"

    - name: Display progress monitoring test
      debug:
        msg: |
          ğŸ” Test 6: Progress monitoring features - {{ progress_test }}
          â±ï¸ Async execution: {{ 'âœ…' if async_enabled else 'âš ï¸' }}
          ğŸ“Š Polling intervals: {{ 'âœ…' if poll_enabled else 'âš ï¸' }}