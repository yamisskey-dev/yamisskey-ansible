---
- name: Test 1 - Basic inventory generation test
  block:
    - name: Check if inventory file exists
      stat:
        path: "{{ ansible_env.PWD }}/deploy/servers/inventory"
      register: inventory_check

    - name: Set inventory test result
      set_fact:
        inventory_test: "{{ 'âœ… Pass' if inventory_check.stat.exists else 'âŒ Fail' }}"

    - name: Display inventory test
      debug:
        msg: "ğŸ” Test 1: Inventory file exists - {{ inventory_test }}"

- name: Test 2 - Tailscale availability
  block:
    - name: Check Tailscale installation
      command: which tailscale
      register: tailscale_installed
      failed_when: false
      changed_when: false

    - name: Get Tailscale status
      command: tailscale status
      register: tailscale_status
      failed_when: false
      changed_when: false
      when: tailscale_installed.rc == 0

    - name: Set Tailscale test result
      set_fact:
        tailscale_test: "{{ 'âœ… Available' if tailscale_installed.rc == 0 else 'âš ï¸ Not installed' }}"

    - name: Display Tailscale test
      debug:
        msg: |
          ğŸ” Test 2: Tailscale availability - {{ tailscale_test }}
          {% if tailscale_installed.rc == 0 and tailscale_status.stdout is defined %}
          ğŸŒ Network status (first 5 lines):
          {{ tailscale_status.stdout_lines[:5] | join('\n') }}
          {% endif %}

- name: Test 3 - Ansible availability
  block:
    - name: Check Ansible version
      command: ansible --version
      register: ansible_version_check
      failed_when: false
      changed_when: false

    - name: Set Ansible test result
      set_fact:
        ansible_test: "{{ 'âœ… Available' if ansible_version_check.rc == 0 else 'âŒ Not available' }}"

    - name: Display Ansible test
      debug:
        msg: |
          ğŸ” Test 3: Ansible availability - {{ ansible_test }}
          {% if ansible_version_check.rc == 0 %}
          ğŸ¤– Version: {{ ansible_version_check.stdout_lines[0] }}
          {% endif %}

- name: Test 4 - Docker availability
  block:
    - name: Check Docker installation
      command: docker --version
      register: docker_version
      failed_when: false
      changed_when: false

    - name: Check Docker service status
      systemd:
        name: docker
      register: docker_service
      failed_when: false
      become: true

    - name: Set Docker test result
      set_fact:
        docker_test: "{{ 'âœ… Running' if docker_service.status is defined and docker_service.status.ActiveState == 'active' else 'âš ï¸ Not running' }}"
      when: docker_service.status is defined and docker_service.status.ActiveState is defined

    - name: Set default Docker test result
      set_fact:
        docker_test: "âš ï¸ Not running"
      when: docker_service.status is not defined or docker_service.status.ActiveState is not defined

    - name: Display Docker test
      debug:
        msg: |
          ğŸ” Test 4: Docker availability - {{ docker_test }}
          {% if docker_version.rc == 0 %}
          ğŸ³ Version: {{ docker_version.stdout }}
          {% endif %}