---
- name: Test 7 - Service health endpoints
  block:
    - name: Filter endpoints for current host
      ansible.builtin.set_fact:
        host_endpoints: "{{ service_endpoints | selectattr('port', 'defined') | list }}"
      when: inventory_hostname in host_services

    - name: Test configured service endpoints
      ansible.builtin.uri:
        url: "http://localhost:{{ item.port }}{{ item.path }}"
        method: "{{ 'POST' if item.name == 'Misskey' else 'GET' }}"
        headers: "{{ {'Content-Type': 'application/json'} if item.name == 'Misskey' else {} }}"
        body: "{{ '{}' if item.name == 'Misskey' else omit }}"
        body_format: "{{ 'json' if item.name == 'Misskey' else omit }}"
        timeout: 5
      register: service_health
      failed_when:
        - service_health.status != 200
        - item.required | default(false)
      loop: "{{ host_endpoints | default([]) }}"
      when:
        - inventory_hostname in host_services
        - item.port != ""

    - name: Display service health results
      ansible.builtin.debug:
        msg: |
          üîç Test 7: Service health endpoints ({{ inventory_hostname }})
          {% if service_health.results is defined and service_health.results | length > 0 %}
          {% for result in service_health.results %}
          {{ result.item.name }}: {{ '‚úÖ OK' if result.status == 200 else ('‚ùå Failed' if result.item.required else '‚ö†Ô∏è Unavailable') }}
          {% endfor %}
          {% else %}
          ‚ö†Ô∏è No services configured for this host or services not running
          {% endif %}

- name: Set service test results for summary
  ansible.builtin.set_fact:
    service_test_results: |-
      {% if service_health.results is defined %}
      {% for result in service_health.results %}
      - {{ result.item.name }}: {{ '‚úÖ OK' if result.status == 200 else ('‚ùå Failed' if result.item.required else '‚ö†Ô∏è Unavailable') }}
      {% endfor %}
      {% else %}
      - No services tested (not configured for this host)
      {% endif %}
