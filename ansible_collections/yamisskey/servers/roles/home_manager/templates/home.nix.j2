{ config, pkgs, ... }:

{
  # User information
  home.username = "{{ ansible_user_id }}";
  home.homeDirectory = "{{ ansible_user_dir }}";
  home.stateVersion = "23.11";

  # Role-based package configuration
  home.packages = with pkgs; [
    # Base packages (always included)
    curl
    wget
    openssh
    git
    nettools
    nmap
    dnsutils
    htop
    btop
    sysstat
    lynis
    jq
    yq-go
    unzip
    zip
    tar
    gawk
    gnused
    findutils
    coreutils
    rsync
    lsof
    tmux

{% for pkg in home_manager_extra_packages %}
    {{ pkg }}
{% endfor %}

{% if 'common' in ansible_play_role_names or home_manager_config == 'development' or home_manager_config == 'server' or home_manager_config == 'ai-server' %}
    # Common role packages
    prometheus
    rclone
    apparmor
    auditd
    tor
    go
{% endif %}

{% if 'security' in ansible_play_role_names or home_manager_config == 'development' or home_manager_config == 'server' or home_manager_config == 'ai-server' %}
    # Security role packages
    fail2ban
    ufw
    dnscrypt-proxy
    clamav
{% endif %}

{% if 'watch' in ansible_play_role_names or home_manager_config == 'development' or home_manager_config == 'server' or home_manager_config == 'ai-server' %}
    # Watch/monitoring role packages
    prometheus-node-exporter
{% endif %}

{% if 'ai' in ansible_play_role_names or home_manager_config == 'ai-server' or home_manager_config == 'development' %}
    # AI role packages
    mecab
    mecab-ipadic
    python3
    python3Packages.pip
{% endif %}

{% if 'ghq' in ansible_play_role_names or home_manager_config == 'development' %}
    # GHQ role packages
    ghq
{% endif %}

{% if home_manager_config == 'development' %}
    # Development/control node packages
    ansible_2_17
    ansible-lint
    yamllint
    sops
    age
    gnupg
    docker
    docker-compose
    python3Packages.passlib
    nixpkgs-fmt
    statix
{% endif %}

{% if 'system_init' in ansible_play_role_names or home_manager_config == 'development' or home_manager_config == 'server' or home_manager_config == 'ai-server' %}
    # Infrastructure services
    cloudflared
    tailscale
{% endif %}
  ];

  # Enable programs that need special configuration
  programs = {
    # Basic shell configuration
    bash = {
      enable = true;
      bashrcExtra = ''
        # yamisskey-provision environment
        export PATH="$HOME/.nix-profile/bin:$PATH"
      '';
    };

{% if home_manager_config == 'development' %}
    # Development tools
    git = {
      enable = true;
      userName = "{{ ansible_user_id }}";
      userEmail = "{{ ansible_user_id }}@{{ inventory_hostname }}";
    };
{% endif %}
  };

  # Service configuration
  services = {
{% if home_manager_config != 'development' %}
    # Production services
{% endif %}
  };

  # Let Home Manager install and manage itself
  programs.home-manager.enable = true;
}
