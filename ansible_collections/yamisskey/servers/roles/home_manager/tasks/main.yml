---
- name: Check if Nix is available
  ansible.builtin.command: command -v nix
  register: nix_available
  changed_when: false
  failed_when: false
  environment:
    PATH: "/root/.nix-profile/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"

- name: Install Home Manager if Nix is available
  block:
    - name: Check if Home Manager is already installed
      ansible.builtin.command: command -v home-manager
      register: home_manager_available
      changed_when: false
      failed_when: false

    - name: Install Home Manager
      ansible.builtin.shell: |
        nix-channel --add https://github.com/nix-community/home-manager/archive/release-23.11.tar.gz home-manager
        nix-channel --update
        nix-shell '<home-manager>' -A install
      when: home_manager_available.rc != 0
      become: false

    - name: Determine host configuration type
      ansible.builtin.set_fact:
        home_manager_config: "{{ 'ai-server' if 'ai' in group_names else ('development' if 'development' in group_names or inventory_hostname == 'localhost' else 'server') }}"
      when: home_manager_config is not defined

    - name: Create Home Manager configuration directory
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.config/home-manager"
        state: directory
        mode: '0755'
      become: false

    - name: Deploy Home Manager configuration
      ansible.builtin.template:
        src: home.nix.j2
        dest: "{{ ansible_user_dir }}/.config/home-manager/home.nix"
        mode: '0644'
      become: false
      notify: Apply Home Manager configuration

    - name: Apply Home Manager configuration
      ansible.builtin.command: home-manager switch
      become: false
      register: home_manager_result
      changed_when: "'Building' in home_manager_result.stderr"

  when: nix_available.rc == 0
  environment:
    PATH: "/root/.nix-profile/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
