# ModSecurity-Nginx configuration for Nostr relay (nostr-rs-relay)
# This file is included in the main ModSecurity-Nginx container

# Upstream definition
upstream nostr_backend {
    server localhost:{{ host_services.caspar.nostr | default(8008) }};
    keepalive 32;
}

# Server block for Nostr relay
server {
    listen {{ modsecurity_nginx_port | default(8080) }};
    http2 on;
    server_name {{ nostr_server_name }};

    # Error page handling - redirect to maintenance page when backend is down
    error_page 502 503 504 @maintenance_redirect;

    # Maintenance page redirect location
    location @maintenance_redirect {
        return 302 https://down.yami.ski;
    }

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # WebSocket support (required for Nostr relay)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Landing page for non-WebSocket requests
    location = / {
        if ($http_upgrade = "websocket") {
            proxy_pass http://nostr_backend;
        }

        if ($http_upgrade = "") {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>やみのす - Yami Nostr Relay</title><link rel="icon" href="https://raw.githubusercontent.com/yamisskey-dev/yamisskey-assets/main/yami.ski/yami-logo-85x85.png"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#0f0a22 url(https://angelkawaii.com/wp-content/uploads/2024/01/33.png) center/cover fixed}.c{background:rgba(15,10,34,.95);padding:2rem;border-radius:20px;text-align:center;max-width:400px;width:90%;border:1px solid rgba(112,93,216,.2);box-shadow:0 8px 32px rgba(0,0,0,.5)}img{width:80px;height:80px;margin-bottom:1rem}h1{color:#fff;font-size:1.8rem;margin-bottom:.5rem}h2{color:#705dd8;font-size:1rem;margin-bottom:1rem}.f{text-align:center;background:rgba(112,93,216,.08);padding:1rem;border-radius:10px;margin-bottom:1.5rem}.f ul{list-style:none;color:#a8b1c2;font-size:.9rem;line-height:2}.f li::before{content:"✓ ";color:#705dd8}.m{color:#a8b1c2;line-height:1.6;margin-bottom:1rem}.u{display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:1.5rem}code{background:rgba(112,93,216,.2);padding:.5rem .8rem;border-radius:6px;font-size:.9rem;color:#fff;cursor:pointer}code:hover{background:rgba(112,93,216,.3)}.cp{background:rgba(112,93,216,.3);color:#fff;border:none;padding:.5rem .8rem;border-radius:6px;cursor:pointer;font-size:.8rem}.cp:hover{background:rgba(112,93,216,.5)}a{display:block;background:rgba(112,93,216,.1);color:#705dd8;padding:.7rem;border-radius:10px;text-decoration:none;margin-top:.5rem}a:hover{background:rgba(112,93,216,.2)}.ok{color:#4ade80}</style></head><body><div class="c"><img src="https://raw.githubusercontent.com/yamisskey-dev/yamisskey-assets/main/yami.ski/yami-logo-192x192.png" alt="Yamisskey"><h1>やみのす</h1><h2>Yami Nostr Relay</h2><div class="f"><ul><li>メンタルファースト</li><li>プライバシーファースト</li></ul></div><p class="m">Relay URL:</p><div class="u"><code id="r" onclick="copy()">wss://{{ nostr_server_name }}</code><button class="cp" onclick="copy()">Copy</button></div><a href="https://iris.to">Iris</a><a href="https://rabbit.syusui.net/">Rabbit</a><a href="https://hub.yami.ski/">やみはぶ</a></div><script>function copy(){navigator.clipboard.writeText("wss://{{ nostr_server_name }}");document.querySelector(".cp").textContent="Copied!";document.querySelector(".cp").classList.add("ok");setTimeout(()=>{document.querySelector(".cp").textContent="Copy";document.querySelector(".cp").classList.remove("ok")},2000)}</script></body></html>';
        }

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
        proxy_buffering off;
        proxy_cache off;
    }

    # WebSocket connections
    location / {
        proxy_pass http://nostr_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
        proxy_buffering off;
        proxy_cache off;
    }
}
