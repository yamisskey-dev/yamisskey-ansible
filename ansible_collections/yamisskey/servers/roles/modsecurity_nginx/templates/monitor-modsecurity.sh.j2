#!/bin/bash
# ModSecurity Security Monitoring Script
# Generated by Ansible

LOGFILE="/var/log/nginx/error.log"
ALERT_THRESHOLD={{ modsecurity_alert_threshold_per_minute }}
CHECK_INTERVAL=60  # seconds
LOCKFILE="/var/run/modsecurity-monitor.pid"
ALERT_LOG="/var/log/modsecurity-alerts.log"

# Function to log with timestamp
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$ALERT_LOG"
}

# Function to send alert (customize as needed)
send_alert() {
    local message="$1"
    log_message "ALERT: $message"

    # Add integration with your alerting system here
    # Examples:
    # curl -X POST "https://hooks.slack.com/..." -d "{\"text\":\"$message\"}"
    # echo "$message" | mail -s "ModSecurity Alert" admin@example.com
    # logger -t modsecurity-alert "$message"
}

# Check if already running
if [ -f "$LOCKFILE" ] && kill -0 "$(cat $LOCKFILE)" 2>/dev/null; then
    log_message "Monitor already running with PID $(cat $LOCKFILE)"
    exit 1
fi

# Create lockfile
echo $$ > "$LOCKFILE"

# Cleanup on exit
trap 'rm -f "$LOCKFILE"; exit' INT TERM EXIT

log_message "Starting ModSecurity monitoring"

# Main monitoring loop
while true; do
    if [ ! -f "$LOGFILE" ]; then
        log_message "Warning: Log file $LOGFILE not found"
        sleep $CHECK_INTERVAL
        continue
    fi

    # Count ModSecurity denials in the last minute
    CURRENT_TIME=$(date +%s)
    START_TIME=$((CURRENT_TIME - 60))

    # Parse nginx log for ModSecurity denials
    DENIAL_COUNT=$(tail -n 1000 "$LOGFILE" | awk -v start="$START_TIME" '
        BEGIN { count = 0 }
        /ModSecurity.*deny/ {
            # Extract timestamp and convert to epoch
            match($0, /\[([^\]]+)\]/, arr)
            timestamp = arr[1]
            cmd = "date -d \"" timestamp "\" +%s"
            cmd | getline epoch
            close(cmd)

            if (epoch >= start) {
                count++
            }
        }
        END { print count }
    ')

    # Check if threshold exceeded
    if [ "$DENIAL_COUNT" -gt "$ALERT_THRESHOLD" ]; then
        send_alert "High number of ModSecurity denials: $DENIAL_COUNT in the last minute (threshold: $ALERT_THRESHOLD)"
    fi

    # Check for specific attack patterns
    RECENT_ATTACKS=$(tail -n 100 "$LOGFILE" | grep -c -E "(SQL injection|XSS|Directory traversal|Command injection)")
    if [ "$RECENT_ATTACKS" -gt 5 ]; then
        send_alert "Multiple attack patterns detected: $RECENT_ATTACKS incidents in recent logs"
    fi

    # Check for repeated offenders
    REPEAT_OFFENDERS=$(tail -n 500 "$LOGFILE" | grep "ModSecurity.*deny" |
                      grep -oE "client: [0-9.]+" |
                      sort | uniq -c |
                      awk '$1 > 10 {print $2, $1}' |
                      wc -l)

    if [ "$REPEAT_OFFENDERS" -gt 0 ]; then
        OFFENDER_IPS=$(tail -n 500 "$LOGFILE" | grep "ModSecurity.*deny" |
                      grep -oE "client: [0-9.]+" |
                      sort | uniq -c |
                      awk '$1 > 10 {print $2 " (" $1 " attempts)"}' |
                      head -5)
        send_alert "Repeated attack attempts detected from: $OFFENDER_IPS"
    fi

    # Container health check
    if ! docker ps | grep -q "{{ modsecurity_nginx_name }}"; then
        send_alert "ModSecurity container {{ modsecurity_nginx_name }} is not running"
    fi

    # Log rotation check
    LOGSIZE=$(stat -c%s "$LOGFILE" 2>/dev/null || echo 0)
    if [ "$LOGSIZE" -gt $((100 * 1024 * 1024)) ]; then  # 100MB
        log_message "Warning: Log file size is ${LOGSIZE} bytes, consider log rotation"
    fi

    sleep $CHECK_INTERVAL
done
