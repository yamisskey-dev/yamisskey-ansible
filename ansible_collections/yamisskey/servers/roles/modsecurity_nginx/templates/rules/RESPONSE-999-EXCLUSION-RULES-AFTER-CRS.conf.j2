# OWASP ModSecurity Core Rule Set - RESPONSE-999-EXCLUSION-RULES-AFTER-CRS
# Enhanced Security Configuration for Yamisskey
# Generated by Ansible

# === Security Headers Injection ===
{% if modsecurity_security_headers %}
{% for header in modsecurity_security_headers %}
SecRule RESPONSE_STATUS "@rx ^2" \
    "id:999{{ loop.index0 + 100 }},\
    phase:3,\
    pass,\
    nolog,\
    setenv:'{{ header.split(':')[0] }}={{ header.split(':', 1)[1] | trim }}'"
{% endfor %}
{% endif %}

{% if modsecurity_hsts_enabled %}
# HSTS Header for HTTPS responses
SecRule REQUEST_SCHEME "@streq https" \
    "id:999200,\
    phase:3,\
    pass,\
    nolog,\
    setenv:'Strict-Transport-Security=max-age={{ modsecurity_hsts_max_age }}{% if modsecurity_hsts_include_subdomains %}; includeSubDomains{% endif %}{% if modsecurity_hsts_preload %}; preload{% endif %}'"
{% endif %}

# === Response Content Filtering ===

# Remove server information disclosure
SecRule RESPONSE_HEADERS:Server "@rx .*" \
    "id:999300,\
    phase:3,\
    pass,\
    nolog,\
    setenv:!Server"

SecRule RESPONSE_HEADERS:X-Powered-By "@rx .*" \
    "id:999301,\
    phase:3,\
    pass,\
    nolog,\
    setenv:!X-Powered-By"

# Block sensitive information in responses
SecRule RESPONSE_BODY "@rx (?i)(password|secret|token|api[_-]?key|private[_-]?key)" \
    "id:999400,\
    phase:4,\
    deny,\
    status:500,\
    msg:'Sensitive information disclosure prevented',\
    logdata:'Response contained sensitive data'"

# Block SQL error messages
SecRule RESPONSE_BODY "@rx (?i)(mysql|postgresql|oracle|sql server).*error" \
    "id:999401,\
    phase:4,\
    deny,\
    status:500,\
    msg:'SQL error message disclosure prevented',\
    logdata:'Database error message detected in response'"

# Block system path disclosure
SecRule RESPONSE_BODY "@rx (?i)(\/etc\/|\/var\/|\/usr\/|\/home\/|c:\\\\|d:\\\\)" \
    "id:999402,\
    phase:4,\
    deny,\
    status:500,\
    msg:'System path disclosure prevented',\
    logdata:'System path detected in response'"

# === Application-Specific Response Rules ===

{% if modsecurity_misskey_exclusions_enabled %}
# Allow JSON responses for Misskey API
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:999500,\
    phase:3,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=950110,\
    ctl:ruleRemoveById=950120,\
    ctl:ruleRemoveById=950130,\
    msg:'Misskey API - allow JSON responses'"

# Allow specific content types for media
SecRule REQUEST_URI "@rx ^/files/.*\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg)$" \
    "id:999501,\
    phase:3,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=950120,\
    msg:'Media files - allow binary content'"
{% endif %}

# === Monitoring and Alerting Rules ===

{% if modsecurity_alert_high_severity %}
# Alert on high severity incidents
SecRule TX:ANOMALY_SCORE "@ge 5" \
    "id:999600,\
    phase:5,\
    pass,\
    msg:'High severity security incident detected',\
    logdata:'Anomaly Score: %{TX.ANOMALY_SCORE}, Inbound: %{TX.INBOUND_ANOMALY_SCORE}, Outbound: %{TX.OUTBOUND_ANOMALY_SCORE}'"
{% endif %}

# === Cleanup and Performance ===

# Clean up collections for performance
SecAction \
    "id:999900,\
    phase:5,\
    pass,\
    nolog,\
    expirevar:ip.requests_per_minute={{ modsecurity_collection_timeout }},\
    expirevar:ip.requests_per_second={{ modsecurity_collection_timeout }}"

# Debug logging for troubleshooting (only when enabled)
{% if modsecurity_debug_log_level > 0 %}
SecRule TX:ANOMALY_SCORE "@gt 0" \
    "id:999901,\
    phase:5,\
    pass,\
    msg:'Debug: Transaction details',\
    logdata:'URI: %{REQUEST_URI}, Method: %{REQUEST_METHOD}, IP: %{REMOTE_ADDR}, User-Agent: %{REQUEST_HEADERS.User-Agent}, Anomaly Score: %{TX.ANOMALY_SCORE}'"
{% endif %}