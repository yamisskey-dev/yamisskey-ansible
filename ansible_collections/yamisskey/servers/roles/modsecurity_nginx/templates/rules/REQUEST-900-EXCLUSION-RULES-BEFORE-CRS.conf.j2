# OWASP ModSecurity Core Rule Set - REQUEST-900-EXCLUSION-RULES-BEFORE-CRS
# Enhanced Security Configuration for Yamisskey
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

{% if modsecurity_maintenance_mode %}
# Maintenance Mode - Allow specific IPs only
SecRule REMOTE_ADDR "!@ipMatchFromFile /etc/modsecurity-nginx/lists/maintenance_ips.txt" \
    "id:900001,\
    phase:1,\
    deny,\
    status:503,\
    msg:'Site under maintenance',\
    logdata:'Maintenance mode active - blocked IP: %{REMOTE_ADDR}'"
{% endif %}

# === Rate Limiting Rules ===
{% if modsecurity_rate_limit_enabled %}
# Track requests per IP
SecAction \
    "id:900010,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{remote_addr},\
    setvar:ip.requests_per_minute=+1,\
    expirevar:ip.requests_per_minute=60,\
    setvar:ip.requests_per_second=+1,\
    expirevar:ip.requests_per_second=1"

# Block if exceeding rate limit
SecRule IP:REQUESTS_PER_MINUTE "@gt {{ modsecurity_rate_limit_requests_per_minute }}" \
    "id:900011,\
    phase:1,\
    deny,\
    status:429,\
    msg:'Rate limit exceeded - requests per minute',\
    logdata:'IP: %{REMOTE_ADDR}, Requests: %{ip.requests_per_minute}',\
    setvar:ip.rate_limited=1"

SecRule IP:REQUESTS_PER_SECOND "@gt {{ modsecurity_rate_limit_requests_per_second }}" \
    "id:900012,\
    phase:1,\
    deny,\
    status:429,\
    msg:'Rate limit exceeded - requests per second',\
    logdata:'IP: %{REMOTE_ADDR}, Requests: %{ip.requests_per_second}'"
{% endif %}

# === IP-based Restrictions ===
{% if modsecurity_blocked_ips %}
# Block specific IP addresses
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/modsecurity-nginx/lists/blocked_ips.txt" \
    "id:900020,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Blocked IP address',\
    logdata:'Blocked IP: %{REMOTE_ADDR}'"
{% endif %}

{% if modsecurity_allowed_ips %}
# Allow whitelisted IPs to bypass most rules
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/modsecurity-nginx/lists/allowed_ips.txt" \
    "id:900021,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=DetectionOnly,\
    msg:'Whitelisted IP - detection mode only'"
{% endif %}

# === User-Agent Filtering ===
{% if modsecurity_blocked_user_agents %}
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity-nginx/lists/blocked_user_agents.txt" \
    "id:900030,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Blocked user agent',\
    logdata:'User-Agent: %{REQUEST_HEADERS.User-Agent}'"
{% endif %}

# === Application-Specific Exclusions ===

{% if modsecurity_misskey_exclusions_enabled %}
# Misskey API exclusions
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:900100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920170,\
    ctl:ruleRemoveById=920171,\
    ctl:ruleRemoveById=920172,\
    ctl:ruleRemoveById=921110,\
    ctl:ruleRemoveById=921151,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942200,\
    ctl:ruleRemoveById=942260,\
    ctl:ruleRemoveById=942300,\
    ctl:ruleRemoveById=942330,\
    ctl:ruleRemoveById=942340,\
    ctl:ruleRemoveById=942370,\
    ctl:ruleRemoveById=942380,\
    ctl:ruleRemoveById=942390,\
    ctl:ruleRemoveById=942400,\
    ctl:ruleRemoveById=942410,\
    ctl:ruleRemoveById=942430,\
    ctl:ruleRemoveById=942440,\
    ctl:ruleRemoveById=942450,\
    ctl:ruleRemoveById=942460,\
    msg:'Misskey API - relaxed rules for JSON payloads'"

# WebSocket connections for real-time features
SecRule REQUEST_HEADERS:Connection "@pm upgrade" \
    "id:900101,\
    phase:1,\
    pass,\
    nolog,\
    chain"
    SecRule REQUEST_HEADERS:Upgrade "@pm websocket" \
        "ctl:ruleEngine=DetectionOnly,\
        msg:'WebSocket connection - detection mode only'"

# Media upload exclusions
SecRule REQUEST_URI "@beginsWith /files/" \
    "id:900102,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200004,\
    ctl:ruleRemoveById=913110,\
    ctl:ruleRemoveById=920170,\
    ctl:ruleRemoveById=920171,\
    ctl:ruleRemoveById=920230,\
    ctl:ruleRemoveById=921110,\
    msg:'File upload - relaxed content-type rules'"
{% endif %}

# === Custom Security Rules ===

# Block common attack patterns
SecRule REQUEST_URI "@detectSQLi" \
    "id:900200,\
    phase:1,\
    deny,\
    status:403,\
    msg:'SQL injection attempt detected in URI',\
    logdata:'URI: %{REQUEST_URI}'"

SecRule ARGS "@detectSQLi" \
    "id:900201,\
    phase:2,\
    deny,\
    status:403,\
    msg:'SQL injection attempt detected in arguments',\
    logdata:'Args: %{ARGS}'"

# Block XSS attempts
SecRule REQUEST_FILENAME "@detectXSS" \
    "id:900202,\
    phase:1,\
    deny,\
    status:403,\
    msg:'XSS attempt detected',\
    logdata:'Filename: %{REQUEST_FILENAME}'"

# === Performance and Resource Limits ===

{% if modsecurity_enforce_body_limit %}
# Enforce request body size limits
SecRule REQUEST_BODY_LENGTH "@gt {{ modsecurity_max_request_size | regex_replace('M', '000000') | regex_replace('K', '000') }}" \
    "id:900300,\
    phase:1,\
    deny,\
    status:413,\
    msg:'Request body too large',\
    logdata:'Body size: %{REQUEST_BODY_LENGTH} bytes'"
{% endif %}

# Limit number of arguments
SecRule &ARGS "@gt 100" \
    "id:900301,\
    phase:2,\
    deny,\
    status:400,\
    msg:'Too many arguments',\
    logdata:'Argument count: %{&ARGS}'"

# Limit argument name length
SecRule ARGS_NAMES "@gt 100" \
    "id:900302,\
    phase:2,\
    deny,\
    status:400,\
    msg:'Argument name too long',\
    logdata:'Long argument name detected'"