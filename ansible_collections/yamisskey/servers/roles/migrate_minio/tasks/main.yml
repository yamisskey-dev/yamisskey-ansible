---
# MinIO Migration Tasks
- name: Display migration summary
  debug:
    msg: |
      ==============================================
      MinIO Migration Plan
      ==============================================
      Source: {{ source_minio_host }} ({{ source_minio_ip }}:{{ source_minio_port }})
      Target: {{ inventory_hostname }} (localhost:{{ host_services[inventory_hostname].minio_api | default('9000') }})
      Buckets: {{ buckets_to_migrate | join(', ') }}
      Encryption: Enabled (KMS)
      Method: API-based with transparent encryption
      ==============================================

- name: Verify source MinIO connectivity
  uri:
    url: "http://{{ source_minio_ip }}:{{ source_minio_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: source_health
  failed_when: source_health.status != 200

- name: Verify target MinIO connectivity
  uri:
    url: "http://localhost:{{ host_services[inventory_hostname].minio_api | default('9000') }}/minio/health/live"
    method: GET
    timeout: 10
  register: target_health
  failed_when: target_health.status != 200

- name: Verify encryption status
  block:
    - name: Check sample file encryption
      shell: |
        SAMPLE_FILE=$(ls /opt/minio/minio-data/{{ minio_bucket_name_for_misskey }}/ 2>/dev/null | head -1)
        if [ -n "$SAMPLE_FILE" ]; then
          file "/opt/minio/minio-data/{{ minio_bucket_name_for_misskey }}/$SAMPLE_FILE"
        else
          echo "No files found to check"
        fi
      register: encryption_check
      changed_when: false

    - name: Display encryption verification
      debug:
        msg: |
          Encryption verification:
          {{ encryption_check.stdout }}
          {% if 'data' in encryption_check.stdout %}
          ‚úÖ Files are encrypted on disk
          {% else %}
          ‚ö†Ô∏è Files may not be encrypted
          {% endif %}

- name: Test API access functionality
  block:
    - name: Test MinIO API access
      shell: |
        SAMPLE_FILE=$(mc ls {{ target_minio_alias }}/{{ minio_bucket_name_for_misskey }}/ | head -1 | awk '{print $NF}')
        if [ -n "$SAMPLE_FILE" ]; then
          mc cat {{ target_minio_alias }}/{{ minio_bucket_name_for_misskey }}/"$SAMPLE_FILE" | file -
        else
          echo "No files found to test"
        fi
      register: api_test
      changed_when: false

    - name: Display API access test
      debug:
        msg: |
          API Access Test:
          {{ api_test.stdout }}
          {% if 'image' in api_test.stdout or 'text' in api_test.stdout %}
          ‚úÖ MinIO API correctly decrypts files
          {% else %}
          ‚ö†Ô∏è API access test inconclusive
          {% endif %}

- name: Clean up temporary files
  file:
    path: "{{ migration_temp_dir }}"
    state: absent

- name: Display final migration summary
  debug:
    msg: |
      ==============================================
      MinIO Migration Complete
      ==============================================
      ‚úÖ Source connectivity verified
      ‚úÖ Target connectivity verified
      ‚úÖ Credentials loaded successfully
      ‚úÖ Buckets migrated: {{ buckets_to_migrate | join(', ') }}
      ‚úÖ Encryption enabled on target
      ‚úÖ API access functional
      ‚úÖ File counts verified
      ‚úÖ Temporary files cleaned up

      üîë Next Steps:
      1. Update Misskey configuration with new credentials
      2. Test file upload/download functionality
      3. Verify federation image display
      4. Consider stopping source MinIO ({{ source_minio_host }})
      ==============================================

- name: Generate application configuration
  debug:
    msg: |
      ==============================================
      Application Configuration Update Required
      ==============================================

      üîß Misskey Configuration ({{ source_minio_host }}):
      Update .env file:
      S3_ENDPOINT=http://{{ ansible_default_ipv4.address }}:{{ host_services[inventory_hostname].minio_api | default('9000') }}
      S3_ACCESS_KEY={{ target_secrets.minio.misskey_s3_access_key }}
      S3_SECRET_KEY={{ target_secrets.minio.misskey_s3_secret_key }}

      üîß Outline Configuration:
      AWS_ACCESS_KEY_ID={{ target_secrets.minio.misskey_s3_access_key }}
      AWS_SECRET_ACCESS_KEY={{ target_secrets.minio.misskey_s3_secret_key }}

      üìù DNS Update:
      drive.yami.ski ‚Üí {{ ansible_default_ipv4.address }}
      ==============================================
