---
# MinIO Migration Role - Unified Configuration
# Consolidates settings from migrate, migrate_minio, and migration_validator roles

# ===== Migration Execution Control =====
# 実行フェーズの制御 (タグベース)
minio_migration_phases:
  setup: true      # MinIO CLI設定
  validate: true   # 事前検証
  migrate: true    # データ移行
  verify: true     # 事後検証
  cleanup: true    # クリーンアップ

# ===== Source MinIO Configuration =====
source_minio_host: "source-server"  # Will be overridden by playbook vars
source_minio_port: 9000
source_minio_alias: "source_{{ ansible_date_time.epoch | default('temp') }}"

# ===== Target MinIO Configuration =====
target_minio_host: "{{ inventory_hostname }}"  # Default to current host
target_minio_port: 9000
target_minio_alias: "target_{{ ansible_date_time.epoch | default('temp') }}"

# ===== Migration Configuration =====
migration_temp_dir: "/tmp/minio-migration"
migration_timeout: 3600  # 1 hour timeout for large migrations
migration_retry_count: 3
migration_poll_interval: 10  # seconds

# ===== Bucket Configuration =====
minio_bucket_name_for_misskey: "files"
minio_bucket_name_for_outline: "assets"

# Use migration_buckets from playbook or default buckets
buckets_to_migrate:
  - "{{ minio_bucket_name_for_misskey }}"
  - "{{ minio_bucket_name_for_outline }}"

# Allow override from playbook
migration_buckets: "{{ migration_buckets | default(buckets_to_migrate) }}"

# ===== Validation Configuration =====
# From migration_validator role
validation_phase: pre_migration  # pre_migration, post_migration, all
migration_operation: validate    # validate, migrate, rollback

# Validation thresholds
min_disk_space_gb: 10
max_disk_usage_percent: 85
connectivity_timeout_seconds: 10
service_check_retries: 3
service_check_delay: 5

# Validation toggles
validate_parameters: true
validate_connectivity: true
validate_services: true
validate_capacity: true
validate_integrity: true
validate_readiness: true

# Network validation
network_check_ports:
  - "{{ source_minio_port }}"
  - "{{ target_minio_port }}"
  - 22  # SSH

# Critical services to validate
critical_services:
  - minio
  - docker

# Expected buckets for validation
expected_buckets:
  - "{{ minio_bucket_name_for_misskey }}"
  - "{{ minio_bucket_name_for_outline }}"

# ===== Safety and Error Handling =====
require_confirmation: true
backup_before_migration: true
verify_after_migration: true
fail_on_validation_error: true
continue_on_warning: true
max_validation_errors: 5

# ===== Reporting Configuration =====
generate_validation_report: true
generate_migration_report: true
report_format: markdown
report_detailed: true
save_report_to_file: true
report_output_dir: "{{ migration_temp_dir }}"

# ===== SSH Configuration =====
ssh_connect_timeout: 5
ssh_strict_host_key_checking: false

# ===== MinIO Console Configuration =====
minio_console_port: 9001
minio_default_port: 9000

# ===== Cleanup Configuration =====
cleanup_old_reports: false  # Remove old migration reports (7+ days)

# ===== Advanced Options =====
# 並列処理設定
migration_parallel_transfers: 4
migration_bandwidth_limit: ""  # e.g., "100MiB"

# デバッグ設定
debug_mode: false
verbose_logging: false

# テスト環境設定
test_environment: false

# ===== Validation Categories with Weights =====
validation_categories:
  parameters:
    weight: 20
    critical: true
  connectivity:
    weight: 25
    critical: true
  services:
    weight: 20
    critical: true
  capacity:
    weight: 15
    critical: false
  integrity:
    weight: 10
    critical: false
  readiness:
    weight: 10
    critical: false

# ===== Encryption Configuration =====
# KMS encryption support (enhancement over original migrate role)
enable_encryption: true   # Enhanced feature - KMS encryption support
kms_enabled: true         # Added capability beyond original migrate role

# ===== Proven Logic Preservation =====
# These settings maintain compatibility with the working migrate role
proven_logic_mode: true
respect_original_migrate_role: true
# KMS encryption is an enhancement - can be disabled for proven logic compatibility
use_enhanced_encryption: true  # Set to false to use original logic without KMS
