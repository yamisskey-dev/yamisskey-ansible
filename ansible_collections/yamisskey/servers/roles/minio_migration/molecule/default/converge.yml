---
- name: Converge minio_migration role
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 600
      when: ansible_os_family == "Debian"

    - name: Install required packages for testing
      package:
        name:
          - curl
          - wget
          - unzip
          - python3-pip
        state: present

    - name: Create mock MinIO CLI for testing
      copy:
        content: |
          #!/bin/bash
          # Mock MinIO CLI for testing
          case "$1" in
            "alias")
              case "$2" in
                "set")
                  echo "Added \`$3\` successfully."
                  exit 0
                  ;;
                "remove")
                  echo "Removed \`$3\` successfully."
                  exit 0
                  ;;
                "list")
                  echo "test-source"
                  echo "test-target"
                  exit 0
                  ;;
              esac
              ;;
            "ls")
              if [[ "$2" == *"test-source"* ]] || [[ "$2" == *"test-target"* ]]; then
                echo "[2024-01-01 00:00:00 UTC]     0B test-files/"
                echo "[2024-01-01 00:00:00 UTC]     0B test-assets/"
                exit 0
              fi
              ;;
            "du")
              echo "0B"
              exit 0
              ;;
            "mirror")
              echo "Mocked: mirror operation completed"
              exit 0
              ;;
            "cat")
              echo "mocked file content"
              exit 0
              ;;
            "--version")
              echo "mc version DEVELOPMENT.2024-01-01T00:00:00Z"
              exit 0
              ;;
            *)
              echo "Mock mc: Command not implemented: $*"
              exit 0
              ;;
          esac
        dest: /usr/local/bin/mc
        mode: '0755'
        owner: root
        group: root

    - name: Mock HTTP health checks for MinIO
      shell: |
        # Create mock HTTP responses for health checks
        mkdir -p /tmp/mock-http
        echo "OK" > /tmp/mock-http/health.txt

        # Mock curl to return success for health endpoints
        cat > /usr/local/bin/curl_mock << 'EOF'
        #!/bin/bash
        if [[ "$*" == *"health/live"* ]] || [[ "$*" == *"health/ready"* ]]; then
          echo "HTTP/1.1 200 OK"
          echo "Content-Type: text/plain"
          echo ""
          echo "OK"
          exit 0
        else
          /usr/bin/curl "$@"
        fi
        EOF
        chmod +x /usr/local/bin/curl_mock

    - name: Set test environment facts
      set_fact:
        ansible_date_time:
          epoch: "1234567890"
          iso8601: "2024-01-01T00:00:00Z"

  tasks:
    - name: Test minio_migration role with minimal configuration
      debug:
        msg: "Testing minio_migration role with basic setup and validation only"
      vars:
        # Test-specific configuration
        source_minio_host: "minio-migration-test-instance"
        target_minio_host: "minio-migration-test-instance"
        source_minio_ip: "127.0.0.1"
        source_minio_port: 9000
        target_minio_port: 9001
        source_minio_alias: "test-source"
        target_minio_alias: "test-target"
        migration_temp_dir: "/tmp/test-migration"
        minio_bucket_name_for_misskey: "test-files"
        minio_bucket_name_for_outline: "test-assets"

        # Migration bucket configuration
        buckets_to_migrate:
          - "test-files"
          - "test-assets"

        # Mock MinIO secrets
        minio:
          root_user: "test-access-key"
          root_password: "test-secret-key"

        # Host services mock
        host_services:
          minio-migration-test-instance:
            minio_api: 9000

        # Phase control - only test setup, validation, and cleanup
        minio_migration_phases:
          setup: true
          validate: true   # Parameter validation only in container
          migrate: false   # Skip actual migration
          verify: false    # Skip verification
          cleanup: true

        # Override validations for container environment
        validate_connectivity: false
        validate_services: false
        validate_capacity: false
        validate_integrity: false
        validate_readiness: false

        # Test environment settings
        test_environment: true
        debug_mode: true

    - name: Include minio_migration role
      include_role:
        name: yamisskey.servers.minio_migration
      tags: ['setup', 'validate', 'cleanup']

    - name: Verify role execution completed
      debug:
        msg: "minio_migration role applied successfully"
