---
- name: Verify minio_migration deployment
  hosts: all
  gather_facts: false

  tasks:
    - name: Check that migration temporary directory was created and cleaned up
      stat:
        path: /tmp/test-migration
      register: temp_dir_check

    - name: Verify MinIO CLI was installed (mocked)
      stat:
        path: /usr/local/bin/mc
      register: mc_cli_check

    - name: Test MinIO CLI functionality (mocked)
      command: /usr/local/bin/mc --version
      register: mc_version_check
      changed_when: false

    - name: Check that migration script template can be generated
      template:
        src: minio_migration_script.sh.j2
        dest: /tmp/test_migration_script.sh
        mode: '0700'
      vars:
        source_minio_alias: "test-source"
        target_minio_alias: "test-target"
        migration_temp_dir: "/tmp/test-migration"
        buckets_to_migrate:
          - "test-files"
          - "test-assets"
        source_minio_host: "test-source"
        source_minio_ip: "127.0.0.1"
        source_minio_port: 9000
        target_minio_host: "test-target"
        target_minio_port: 9001
        enable_encryption: true
        migration_parallel_transfers: 4
        migration_retry_count: 3
        debug_mode: true
        fail_on_validation_error: true
      register: template_generation

    - name: Verify migration script was generated correctly
      stat:
        path: /tmp/test_migration_script.sh
      register: script_check

    - name: Check migration script content
      shell: head -10 /tmp/test_migration_script.sh
      register: script_content
      changed_when: false

    - name: Verify role structure and files
      stat:
        path: "{{ item }}"
      register: role_files
      loop:
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/defaults/main.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/main.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/setup.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/validate.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/migrate.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/verify.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/tasks/cleanup.yml"
        - "{{ ansible_env.PWD }}/ansible_collections/yamisskey/servers/roles/minio_migration/templates/minio_migration_script.sh.j2"

    - name: Display verification results
      debug:
        msg: |
          minio_migration Role Verification Summary:
          ====================================

          Role: minio_migration
          Collection: yamisskey.servers
          Test Instance: minio-migration-test-instance

          âœ… MinIO CLI: {{ 'âœ… Present' if mc_cli_check.stat.exists else 'âŒ Missing' }}
          âœ… CLI Version: {{ mc_version_check.stdout if mc_version_check.stdout is defined else 'N/A' }}
          âœ… Template Generation: {{ 'âœ… Success' if template_generation is succeeded else 'âŒ Failed' }}
          âœ… Migration Script: {{ 'âœ… Generated' if script_check.stat.exists else 'âŒ Missing' }}
          âœ… Temp Directory: {{ 'âœ… Managed' if not temp_dir_check.stat.exists else 'âš ï¸ Not cleaned' }}

          ğŸ“ Role Files:
          {% for file_check in role_files.results %}
          {% set filename = file_check.item.split('/')[-1] %}
          â”œâ”€ {{ filename }}: {{ 'âœ…' if file_check.stat.exists else 'âŒ' }}
          {% endfor %}

          ğŸ¯ Tag-based Execution Support:
          â”œâ”€ setup: MinIO CLI installation and configuration
          â”œâ”€ validate: Pre-migration validation
          â”œâ”€ migrate: Data migration execution
          â”œâ”€ verify: Post-migration verification
          â”œâ”€ cleanup: Temporary files cleanup
          â””â”€ all: Execute all phases

          ğŸ“Š Test Results: {{ 'âœ… ALL PASSED' if mc_cli_check.stat.exists and template_generation is succeeded and script_check.stat.exists else 'âŒ SOME FAILED' }}

    - name: Clean up test files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/test_migration_script.sh
        - /tmp/test-migration

    - name: Verify unified role functionality
      assert:
        that:
          - mc_cli_check.stat.exists
          - template_generation is succeeded
          - script_check.stat.exists
          - role_files.results | selectattr('stat.exists') | list | length == role_files.results | length
        fail_msg: "minio_migration role verification failed"
        success_msg: "âœ… minio_migration role verification completed successfully"
