---
# MinIO Migration Role - Setup Tasks
# MinIO CLI installation and configuration

- name: Display setup phase banner
  debug:
    msg: |
      ğŸ”§ Setup Phase: MinIO CLI Configuration
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Installing MinIO CLI if needed
      â”œâ”€ Setting up source alias: {{ source_minio_alias }}
      â”œâ”€ Setting up target alias: {{ target_minio_alias }}
      â””â”€ Preparing migration environment
  tags: ['setup', 'info']

- name: Set up default variables
  set_fact:
    # Migration configuration with defaults
    minio_bucket_name_for_misskey: "{{ minio_bucket_name_for_misskey | default('files') }}"
    minio_bucket_name_for_outline: "{{ minio_bucket_name_for_outline | default('assets') }}"
    source_minio_port: "{{ source_minio_port | default(9000) }}"
    target_minio_port: "{{ target_minio_port | default(9000) }}"
    migration_temp_dir: "{{ migration_temp_dir | default('/tmp/minio-migration') }}"
    # MinIO aliases with unique timestamps
    source_minio_alias: "{{ source_minio_alias | default('source_' + ansible_date_time.epoch) }}"
    target_minio_alias: "{{ target_minio_alias | default('target_' + ansible_date_time.epoch) }}"
    # Bucket list
    buckets_to_migrate: "{{ buckets_to_migrate | default([minio_bucket_name_for_misskey, minio_bucket_name_for_outline]) }}"
  tags: ['setup']

- name: Get source host IP address from dynamic inventory
  set_fact:
    source_minio_ip: "{{ hostvars[source_minio_host]['ansible_host'] | default(source_minio_host) }}"
  when: source_minio_host in hostvars
  tags: ['setup']

- name: Fallback to hostname if IP not available
  set_fact:
    source_minio_ip: "{{ source_minio_host }}"
  when: source_minio_ip is not defined
  tags: ['setup']

- name: Display host resolution results
  debug:
    msg: |
      Host resolution results:
      â”œâ”€ Source host: {{ source_minio_host }}
      â”œâ”€ Resolved IP: {{ source_minio_ip }}
      â”œâ”€ Target host: {{ target_minio_host }}
      â””â”€ Available hosts: {{ groups['all'] }}
  tags: ['setup', 'info']

- name: Gather MinIO credentials from inventory
  set_fact:
    source_minio_inventory: "{{ (hostvars[source_minio_host] | default({})).minio | default({}) }}"
    target_minio_inventory: "{{ (hostvars[target_minio_host] | default({})).minio | default({}) }}"
  tags: ['setup']

- name: Build MinIO credential dictionaries
  set_fact:
    source_secrets:
      minio:
        root_user: "{{ source_minio_inventory.root_user | default('CHANGE_ME_SOURCE_ROOT_USER') }}"
        root_password: "{{ source_minio_inventory.root_password | default('CHANGE_ME_SOURCE_ROOT_PASSWORD') }}"
    target_secrets:
      minio:
        root_user: "{{ target_minio_inventory.root_user | default('CHANGE_ME_TARGET_ROOT_USER') }}"
        root_password: "{{ target_minio_inventory.root_password | default('CHANGE_ME_TARGET_ROOT_PASSWORD') }}"
  tags: ['setup']

- name: Warn about placeholder migration credentials
  debug:
    msg: >-
      âš ï¸  MinIO {{ item.role }} credentials are placeholders.
      Update host_vars/{{ item.host }}/secrets.yml â†’ minio.root_user/minio.root_password.
  loop:
    - { role: 'source', host: "{{ source_minio_host }}", user: "{{ source_secrets.minio.root_user }}", password: "{{ source_secrets.minio.root_password }}" }
    - { role: 'target', host: "{{ target_minio_host }}", user: "{{ target_secrets.minio.root_user }}", password: "{{ target_secrets.minio.root_password }}" }
  when: item.user is search('^CHANGE_ME_') or item.password is search('^CHANGE_ME_')
  tags: ['setup', 'warning']

- name: Install MinIO CLI if not present
  block:
    - name: Check if MinIO CLI exists
      ansible.builtin.stat:
        path: /usr/local/bin/mc
      register: mc_exists

    - name: Download and install MinIO CLI
      ansible.builtin.get_url:
        url: "https://dl.min.io/client/mc/release/linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/mc"
        dest: /usr/local/bin/mc
        mode: '0755'
        owner: root
        group: root
      when: not mc_exists.stat.exists
      become: true

    - name: Verify MinIO CLI installation
      command: /usr/local/bin/mc --version
      register: mc_version
      changed_when: false

    - name: Display MinIO CLI version
      debug:
        msg: "âœ… MinIO CLI installed: {{ mc_version.stdout_lines[0] }}"
  tags: ['setup']

- name: Create migration temporary directory
  file:
    path: "{{ migration_temp_dir }}"
    state: directory
    mode: '0700'
  tags: ['setup']

- name: Setup source MinIO alias
  command: >
    /usr/local/bin/mc alias set {{ source_minio_alias }}
    http://{{ source_minio_ip }}:{{ source_minio_port }}
    "{{ source_secrets.minio.root_user }}"
    "{{ source_secrets.minio.root_password }}"
  register: source_alias_result
  changed_when: source_alias_result.rc == 0
  tags: ['setup']

- name: Setup target MinIO alias
  command: >
    /usr/local/bin/mc alias set {{ target_minio_alias }}
    http://localhost:{{ target_minio_port }}
    "{{ target_secrets.minio.root_user }}"
    "{{ target_secrets.minio.root_password }}"
  register: target_alias_result
  changed_when: target_alias_result.rc == 0
  tags: ['setup']

- name: Verify source MinIO alias
  command: /usr/local/bin/mc ls {{ source_minio_alias }}/
  register: source_ls_result
  changed_when: false
  failed_when: false
  tags: ['setup']

- name: Handle source alias verification failure
  fail:
    msg: |
      âŒ Failed to list source MinIO buckets. Error: {{ source_ls_result.stderr }}
      Please check source credentials and connectivity.
  when: source_ls_result.rc != 0
  tags: ['setup']

- name: Display source bucket information
  debug:
    msg: |
      âœ… Source MinIO buckets found:
      {{ source_ls_result.stdout }}
  tags: ['setup', 'info']

- name: Display setup completion
  debug:
    msg: |
      âœ… Setup Phase Completed
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ MinIO CLI: âœ… Installed and verified
      â”œâ”€ Source alias: âœ… {{ source_minio_alias }}
      â”œâ”€ Target alias: âœ… {{ target_minio_alias }}
      â”œâ”€ Temp directory: âœ… {{ migration_temp_dir }}
      â””â”€ Credentials: âœ… Loaded
  tags: ['setup', 'info']
