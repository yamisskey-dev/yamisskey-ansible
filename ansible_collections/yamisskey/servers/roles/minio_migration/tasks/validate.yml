---
# MinIO Migration Role - Validation Tasks
# Pre-migration validation (integrated from migration_validator role)

- name: Display validation phase banner
  debug:
    msg: |
      ğŸ” Validation Phase: Pre-Migration Checks
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Parameter validation
      â”œâ”€ Connectivity checks
      â”œâ”€ Service health validation
      â”œâ”€ Storage capacity checks
      â””â”€ Migration readiness assessment
  tags: ['validate', 'info']

- name: Parameter validation
  block:
    - name: Validate required migration parameters
      assert:
        that:
          - source_minio_host is defined and source_minio_host != ""
          - target_minio_host is defined and target_minio_host != ""
          - buckets_to_migrate is defined and buckets_to_migrate | length > 0
        fail_msg: |
          âŒ Missing required migration parameters:
          - Source host: {{ source_minio_host | default('undefined') }}
          - Target host: {{ target_minio_host | default('undefined') }}
          - Buckets: {{ buckets_to_migrate | default([]) }}

    - name: Validate source and target are different (unless local migration)
      assert:
        that:
          - source_minio_host != target_minio_host or source_minio_host == inventory_hostname
        fail_msg: |
          âŒ Invalid migration configuration:
          Source and target hosts cannot be the same: {{ source_minio_host }}

    - name: Display parameter validation success
      debug:
        msg: |
          âœ… Parameter Validation Passed
          â”œâ”€ Source: {{ source_minio_host }}:{{ source_minio_port }}
          â”œâ”€ Target: {{ target_minio_host }}:{{ target_minio_port }}
          â””â”€ Buckets: {{ buckets_to_migrate | join(', ') }}
  tags: ['validate', 'parameters']

- name: Connectivity validation
  block:
    - name: Get source host IP address from inventory
      set_fact:
        source_host_ip: "{{ hostvars[source_minio_host]['ansible_host'] | default(source_minio_host) }}"
      when: source_minio_host != inventory_hostname

    - name: Verify source MinIO connectivity
      command: curl -f --connect-timeout {{ connectivity_timeout_seconds }} http://{{ source_host_ip }}:{{ source_minio_port }}/minio/health/live
      register: source_health_curl
      failed_when: false
      changed_when: false
      when: source_minio_host != inventory_hostname

    - name: Set source health status from curl result
      set_fact:
        source_health:
          status: "{{ 200 if source_health_curl.rc == 0 else source_health_curl.rc }}"
          msg: "{{ 'Success' if source_health_curl.rc == 0 else 'Connection failed' }}"
      when: source_minio_host != inventory_hostname

    - name: Skip source connectivity for local migration
      set_fact:
        source_health:
          status: 200
          msg: "Local migration - source connectivity check skipped"
      when: source_minio_host == inventory_hostname

    - name: Handle source connectivity failure
      fail:
        msg: |
          âŒ Failed to connect to source MinIO at {{ source_minio_host }}:{{ source_minio_port }}
          Status: {{ source_health.status | default('Connection failed') }}
          Please ensure:
          1. Source MinIO is running
          2. Network connectivity exists between hosts
          3. Firewall allows access to port {{ source_minio_port }}
      when: source_health.status | default(0) != 200

    - name: Verify target MinIO connectivity
      command: curl -f --connect-timeout {{ connectivity_timeout_seconds }} http://localhost:{{ target_minio_port }}/minio/health/live
      register: target_health_curl
      failed_when: false
      changed_when: false

    - name: Set target health status from curl result
      set_fact:
        target_health:
          status: "{{ 200 if target_health_curl.rc == 0 else target_health_curl.rc }}"
          msg: "{{ 'Success' if target_health_curl.rc == 0 else 'Connection failed' }}"

    - name: Handle target connectivity failure
      fail:
        msg: |
          âŒ Failed to connect to target MinIO at localhost:{{ target_minio_port }}
          Status: {{ target_health.status | default('Connection failed') }}
          Please ensure target MinIO is running and accessible.
      when: target_health.status | default(0) != 200

    - name: Display connectivity validation success
      debug:
        msg: |
          {% if source_health.status | default(0) == 200 and target_health.status | default(0) == 200 %}
          âœ… Connectivity Validation Passed
          â”œâ”€ Source MinIO: âœ… {{ source_health.status }}
          â””â”€ Target MinIO: âœ… {{ target_health.status }}
          {% else %}
          âš ï¸  Connectivity Validation Results
          â”œâ”€ Source MinIO: {{ 'âœ… ' + (source_health.status | string) if source_health.status | default(0) == 200 else 'âŒ Failed (' + (source_health.status | default('No response') | string) + ')' }}
          â””â”€ Target MinIO: {{ 'âœ… ' + (target_health.status | string) if target_health.status | default(0) == 200 else 'âŒ Failed (' + (target_health.status | default('No response') | string) + ')' }}
          {% endif %}
  tags: ['validate', 'connectivity']

- name: Service validation
  block:
    - name: Check critical services
      service_facts:
      register: services_status

    - name: Validate MinIO service status
      debug:
        msg: |
          ğŸ” Service Status Check
          â”œâ”€ Docker: {{ 'Running' if ansible_facts.services['docker.service'].state == 'running' else 'Not Running' }}
          â””â”€ MinIO: Checking via health endpoint...

    - name: Test MinIO API access with credentials
      command: /usr/local/bin/mc ls {{ target_minio_alias }}/
      register: api_test_result
      failed_when: false
      changed_when: false

    - name: Display service validation results
      debug:
        msg: |
          âœ… Service Validation {{ 'Passed' if api_test_result.rc == 0 else 'Warning' }}
          â””â”€ MinIO API: {{ 'âœ… Accessible' if api_test_result.rc == 0 else 'âš ï¸  Check credentials' }}
  tags: ['validate', 'services']

- name: Storage capacity validation
  block:
    - name: Check available disk space
      command: df -BG {{ migration_temp_dir | dirname }}
      register: disk_space
      changed_when: false

    - name: Parse disk space information
      set_fact:
        available_space_gb: "{{ disk_space.stdout_lines[1].split()[3] | regex_replace('G', '') | int }}"
      when: disk_space.stdout_lines is defined and disk_space.stdout_lines | length > 1

    - name: Handle disk space parsing failure
      set_fact:
        available_space_gb: 0
      when: disk_space.stdout_lines is not defined or disk_space.stdout_lines | length <= 1

    - name: Validate sufficient disk space
      assert:
        that:
          - available_space_gb | int >= min_disk_space_gb | int
        fail_msg: |
          âŒ Insufficient disk space for migration
          Available: {{ available_space_gb }}GB, Required: {{ min_disk_space_gb }}GB

    - name: Check source buckets size (if accessible)
      block:
        - name: Get source bucket statistics
          command: /usr/local/bin/mc du {{ source_minio_alias }}/{{ item }}/
          loop: "{{ buckets_to_migrate }}"
          register: source_bucket_stats
          ignore_errors: true
          changed_when: false

        - name: Display capacity validation results
          debug:
            msg: |
              âœ… Storage Capacity Validation Passed
              â”œâ”€ Available space: {{ available_space_gb }}GB
              â”œâ”€ Required minimum: {{ min_disk_space_gb }}GB
              â””â”€ Source bucket sizes:
              {% for i in range(buckets_to_migrate | length) %}
              â”‚  â”œâ”€ {{ buckets_to_migrate[i] }}: {{ source_bucket_stats.results[i].stdout | default('N/A') }}
              {% endfor %}
      rescue:
        - name: Display capacity warning
          debug:
            msg: |
              âš ï¸  Storage Capacity Check (Partial)
              â”œâ”€ Available space: {{ available_space_gb }}GB (âœ… Sufficient)
              â””â”€ Source bucket sizes: Unable to determine
  tags: ['validate', 'capacity']

- name: Migration readiness assessment
  block:
    - name: Calculate validation score
      set_fact:
        validation_score: 100  # Perfect score if we reach here

    - name: Display readiness assessment
      debug:
        msg: |
          âœ… Migration Readiness Assessment
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â”œâ”€ Overall Score: {{ validation_score }}/100
          â”œâ”€ Parameters: âœ… Valid
          â”œâ”€ Connectivity: âœ… Confirmed
          â”œâ”€ Services: âœ… Ready
          â”œâ”€ Capacity: âœ… Sufficient
          â””â”€ Status: ğŸš€ Ready for Migration

          ğŸ’¡ Migration can proceed safely.
  tags: ['validate', 'readiness']

- name: Generate validation report (if enabled)
  block:
    - name: Ensure report directory exists
      file:
        path: "{{ report_output_dir }}"
        state: directory
        mode: '0755'
      when: generate_validation_report | default(true)

    - name: Create validation report
      copy:
        content: |
          # MinIO Migration Validation Report

          **Generated:** {{ ansible_date_time.iso8601 }}
          **Host:** {{ inventory_hostname }}

          ## Configuration
          - **Source:** {{ source_minio_host }}:{{ source_minio_port }}
          - **Target:** {{ target_minio_host }}:{{ target_minio_port }}
          - **Buckets:** {{ buckets_to_migrate | join(', ') }}

          ## Validation Results
          - âœ… Parameters: Valid
          - âœ… Connectivity: Confirmed
          - âœ… Services: Ready
          - âœ… Capacity: Sufficient
          - âœ… Overall: Ready for Migration

          ## Next Steps
          1. Execute migration: `ansible-playbook playbook.yml --tags migrate`
          2. Monitor progress during execution
          3. Verify results: `ansible-playbook playbook.yml --tags verify`
        dest: "{{ report_output_dir }}/validation_report_{{ ansible_date_time.epoch }}.md"
        mode: '0644'
      when: generate_validation_report | default(true)

    - name: Display report location
      debug:
        msg: "ğŸ“„ Validation report saved: {{ report_output_dir }}/validation_report_{{ ansible_date_time.epoch }}.md"
      when: generate_validation_report | default(true)
  tags: ['validate', 'report']

- name: Display validation completion
  debug:
    msg: |
      âœ… Validation Phase Completed
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      All pre-migration checks passed successfully.
      Migration is ready to proceed.
  tags: ['validate', 'info']
