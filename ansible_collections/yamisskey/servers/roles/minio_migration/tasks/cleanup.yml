---
# MinIO Migration Role - Cleanup Tasks
# Temporary files and resource cleanup

- name: Display cleanup phase banner
  debug:
    msg: |
      ğŸ§¹ Cleanup Phase: Resource Cleanup
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Removing temporary migration files
      â”œâ”€ Cleaning up MinIO aliases
      â”œâ”€ Removing migration scripts
      â””â”€ Final resource cleanup
  tags: ['cleanup', 'info']

- name: Clean up temporary migration directory
  block:
    - name: Check if temporary directory exists
      stat:
        path: "{{ migration_temp_dir }}"
      register: temp_dir_stat

    - name: Remove temporary migration files
      file:
        path: "{{ migration_temp_dir }}"
        state: absent
      when: temp_dir_stat.stat.exists

    - name: Display temporary files cleanup status
      debug:
        msg: |
          ğŸ—‘ï¸  Temporary Files Cleanup:
          â”œâ”€ Directory: {{ migration_temp_dir }}
          â””â”€ Status: {{ 'âœ… Removed' if temp_dir_stat.stat.exists else 'âœ… Already clean' }}
  tags: ['cleanup', 'temp']

- name: Clean up MinIO aliases
  block:
    - name: Remove source MinIO alias
      command: /usr/local/bin/mc alias remove {{ source_minio_alias }}
      register: source_alias_removal
      failed_when: false
      changed_when: source_alias_removal.rc == 0

    - name: Remove target MinIO alias
      command: /usr/local/bin/mc alias remove {{ target_minio_alias }}
      register: target_alias_removal
      failed_when: false
      changed_when: target_alias_removal.rc == 0

    - name: Display alias cleanup status
      debug:
        msg: |
          ğŸ”— MinIO Aliases Cleanup:
          â”œâ”€ Source alias ({{ source_minio_alias }}): {{ 'âœ… Removed' if source_alias_removal.rc == 0 else 'âš ï¸  Not found or error' }}
          â””â”€ Target alias ({{ target_minio_alias }}): {{ 'âœ… Removed' if target_alias_removal.rc == 0 else 'âš ï¸  Not found or error' }}
  tags: ['cleanup', 'aliases']

- name: Clean up migration logs and reports (optional)
  block:
    - name: Find migration reports and logs
      find:
        paths:
          - "{{ report_output_dir | default('/tmp') }}"
          - "/tmp"
        patterns:
          - "migration_report_*.md"
          - "validation_report_*.md"
          - "verification_report_*.md"
          - "migration_*.log"
        age: "7d"  # 7æ—¥ä»¥ä¸Šå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«
      register: old_migration_files
      when: cleanup_old_reports | default(false)

    - name: Remove old migration reports and logs
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_migration_files.files | default([]) }}"
      when:
        - cleanup_old_reports | default(false)
        - old_migration_files.files is defined

    - name: Display reports cleanup status
      debug:
        msg: |
          ğŸ“„ Reports Cleanup:
          â””â”€ Old files (7+ days): {{ 'âœ… Removed ' + (old_migration_files.files | length | string) + ' files' if (cleanup_old_reports | default(false)) and old_migration_files.files is defined else 'â­ï¸  Skipped (disabled)' }}
  tags: ['cleanup', 'reports']

- name: Reset migration state variables
  set_fact:
    migration_start_time: null
    migration_result: null
    migration_verified: null
    source_minio_alias: null
    target_minio_alias: null
  tags: ['cleanup', 'state']

- name: Verify cleanup completion
  block:
    - name: Check for remaining temporary files
      find:
        paths: "/tmp"
        patterns: "minio-migration*"
        file_type: directory
      register: remaining_temp_dirs

    - name: Check for remaining MinIO aliases
      shell: /usr/local/bin/mc alias list | grep -E "(source_|target_)" || true
      register: remaining_aliases
      changed_when: false

    - name: Display cleanup verification
      debug:
        msg: |
          ğŸ” Cleanup Verification:
          â”œâ”€ Remaining temp dirs: {{ remaining_temp_dirs.files | length }}
          â”œâ”€ Remaining aliases: {{ 'None' if remaining_aliases.stdout == '' else remaining_aliases.stdout }}
          â””â”€ Status: {{ 'âœ… Clean' if remaining_temp_dirs.files | length == 0 and remaining_aliases.stdout == '' else 'âš ï¸  Some items remain' }}
  tags: ['cleanup', 'verify']

- name: Display final cleanup summary
  debug:
    msg: |
      âœ… Cleanup Phase Completed
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â”œâ”€ Temporary files: âœ… Removed
      â”œâ”€ MinIO aliases: âœ… Cleaned
      â”œâ”€ Migration state: âœ… Reset
      â””â”€ Reports: {{ 'âœ… Cleaned' if cleanup_old_reports | default(false) else 'â­ï¸  Preserved' }}

      ğŸ¯ Cleanup Options:
      â”œâ”€ Keep reports: Default behavior
      â”œâ”€ Clean old reports: Set cleanup_old_reports=true
      â””â”€ Custom temp dir: Set migration_temp_dir

      ğŸ’¡ Migration resources have been cleaned up.
      The system is ready for future migrations.
  tags: ['cleanup', 'info']

- name: Optional - Display system resource status
  block:
    - name: Check disk space after cleanup
      command: df -h {{ migration_temp_dir | dirname }}
      register: disk_space_after
      changed_when: false

    - name: Display resource status
      debug:
        msg: |
          ğŸ’¾ System Resources After Cleanup:
          {{ disk_space_after.stdout }}
  when: debug_mode | default(false)
  tags: ['cleanup', 'debug']
