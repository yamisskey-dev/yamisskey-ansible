- name: Load MinIO secrets from inventory
  set_fact:
    minio_inventory_secrets: "{{ hostvars[inventory_hostname].minio | default({}) }}"

- name: Prepare MinIO secret values
  set_fact:
    minio_root_user: "{{ minio_inventory_secrets.root_user | default('CHANGE_ME_MINIO_ROOT_USER') }}"
    minio_root_password: "{{ minio_inventory_secrets.root_password | default('CHANGE_ME_MINIO_ROOT_PASSWORD') }}"
    misskey_s3_access_key: "{{ minio_inventory_secrets.misskey_s3_access_key | default('CHANGE_ME_MISSKEY_ACCESS_KEY') }}"
    misskey_s3_secret_key: "{{ minio_inventory_secrets.misskey_s3_secret_key | default('CHANGE_ME_MISSKEY_SECRET_KEY') }}"
    minio_kms_master_key: "{{ minio_inventory_secrets.kms_master_key | default('CHANGE_ME_MINIO_KMS_KEY') }}"

- name: Warn about placeholder MinIO secrets
  debug:
    msg: >-
      MinIO secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ minio.{{ item.key }}.
  loop:
    - { key: root_user, value: "{{ minio_root_user }}" }
    - { key: root_password, value: "{{ minio_root_password }}" }
    - { key: misskey_s3_access_key, value: "{{ misskey_s3_access_key }}" }
    - { key: misskey_s3_secret_key, value: "{{ misskey_s3_secret_key }}" }
    - { key: kms_master_key, value: "{{ minio_kms_master_key }}" }
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Create required directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/minio
    - /opt/minio/minio-data

- name: Deploy Docker Compose file for Minio
  template:
    src: "{{ role_path | default('../..') }}/templates/minio_docker-compose.yml.j2"
    dest: /opt/minio/docker-compose.yml
    owner: root
    group: root
    mode: '0644'
    backup: true

- name: Create Docker network if not exists
  community.docker.docker_network:
    name: external_network

- name: Start Minio using Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: /opt/minio
    pull: always
  register: minio_start_result
  retries: 3
  delay: 5
  until: minio_start_result is succeeded
  failed_when: false

- name: Allow MinIO access from Tailscale network
  ansible.builtin.command: ufw allow from 100.64.0.0/10 to any port {{ host_services[inventory_hostname].minio_api }} proto tcp
  changed_when: false
  become: true
  when:
    - ansible_env.MOLECULE_SCENARIO_NAME is undefined
    - ansible_virtualization_type is not defined or ansible_virtualization_type not in ['docker', 'container']
  failed_when: false  # UFW command may fail if ufw is not installed or configured

- name: Check if Minio Client exists
  ansible.builtin.stat:
    path: /usr/local/bin/mc
  register: mc_check

- name: Download Minio Client (architecture-aware)
  ansible.builtin.get_url:
    url: "https://dl.min.io/client/mc/release/linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/mc"
    dest: /usr/local/bin/mc
    mode: '0755'
  when: not mc_check.stat.exists

- name: Get MinIO container IP
  command: docker inspect -f "{% raw %}{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}{% endraw %}" minio
  register: minio_ip
  changed_when: false
  failed_when: false
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined

- name: Set default MinIO IP for test environment
  set_fact:
    minio_ip:
      stdout: "localhost"
  when: minio_ip is not defined or minio_ip.stdout == ""

- name: Set Minio Client alias with retry mechanism
  command: >
    /usr/local/bin/mc alias set "{{ minio_alias }}"
    http://{{ minio_ip.stdout }}:{{ host_services[inventory_hostname].minio_api }}
    "{{ minio_root_user }}"
    "{{ minio_root_password }}"
  register: mc_alias_result
  until: mc_alias_result.rc == 0
  retries: 15
  delay: 10
  changed_when: mc_alias_result.rc == 0
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined
  failed_when: false

- name: Create and configure secure buckets
  block:
    - name: Check if files bucket exists
      command: /usr/local/bin/mc ls "{{ minio_alias }}/{{ minio_bucket_name_for_misskey }}"
      register: files_bucket_check
      changed_when: false
      failed_when: false

    - name: Check if assets bucket exists
      command: /usr/local/bin/mc ls "{{ minio_alias }}/{{ minio_bucket_name_for_outline }}"
      register: assets_bucket_check
      changed_when: false
      failed_when: false

    - name: Create files bucket if not exists
      command: /usr/local/bin/mc mb "{{ minio_alias }}/{{ minio_bucket_name_for_misskey }}"
      when: files_bucket_check.rc != 0
      failed_when: false

    - name: Create assets bucket if not exists
      command: /usr/local/bin/mc mb "{{ minio_alias }}/{{ minio_bucket_name_for_outline }}"
      when: assets_bucket_check.rc != 0
      failed_when: false

    - name: Create Misskey IAM user
      command: /usr/local/bin/mc admin user add "{{ minio_alias }}" "{{ misskey_s3_access_key }}" "{{ misskey_s3_secret_key }}"
      register: misskey_user_result
      changed_when: misskey_user_result.rc == 0
      failed_when: false
      no_log: true

    - name: Deploy IAM policy template
      template:
        src: "{{ role_path | default('../..') }}/templates/minio_iam_policy.json.j2"
        dest: /tmp/minio_iam_policy.json
        mode: '0600'
        backup: true

    - name: Check if IAM policy already exists
      command: /usr/local/bin/mc admin policy info "{{ minio_alias }}" misskey-policy
      register: iam_policy_check
      changed_when: false
      failed_when: false

    - name: Create IAM policy for Misskey user
      command: /usr/local/bin/mc admin policy create "{{ minio_alias }}" misskey-policy /tmp/minio_iam_policy.json
      register: policy_create_result
      changed_when: policy_create_result.rc == 0
      failed_when: false
      when: iam_policy_check.rc != 0

    - name: Clean up temporary policy file
      file:
        path: /tmp/minio_iam_policy.json
        state: absent

    - name: Check if policy is already attached to user
      command: /usr/local/bin/mc admin policy entities "{{ minio_alias }}" misskey-policy
      register: policy_attach_check
      changed_when: false
      failed_when: false

    - name: Attach policy to Misskey user
      command: /usr/local/bin/mc admin policy attach "{{ minio_alias }}" misskey-policy --user "{{ misskey_s3_access_key }}"
      register: policy_attach_result
      changed_when: policy_attach_result.rc == 0
      failed_when: false
      when:
        - iam_policy_check.rc == 0
        - misskey_s3_access_key not in (policy_attach_check.stdout | default(''))

    - name: Deploy bucket policy template
      template:
        src: "{{ role_path | default('../..') }}/templates/minio_cors_policy.json.j2"
        dest: /tmp/minio_bucket_policy.json
        mode: '0600'
        backup: true

    - name: Check current bucket anonymous policy
      command: /usr/local/bin/mc anonymous get "{{ minio_alias }}/{{ item }}"
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: bucket_anonymous_check
      changed_when: false
      failed_when: false

    - name: Apply secure bucket policy for ActivityPub federation access control
      command: /usr/local/bin/mc anonymous set download "{{ minio_alias }}/{{ item }}"
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: bucket_policy_result
      changed_when: bucket_policy_result.rc == 0
      failed_when: false
      when: item not in (bucket_anonymous_check.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list)

    - name: Check if advanced bucket policy already exists
      command: /usr/local/bin/mc admin policy info "{{ minio_alias }}" bucket-policy-{{ item }}
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: advanced_policy_check
      changed_when: false
      failed_when: false

    - name: Apply advanced bucket policy for User-Agent based access control
      command: /usr/local/bin/mc admin policy create "{{ minio_alias }}" bucket-policy-{{ item }} /tmp/minio_bucket_policy.json
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: advanced_policy_result
      changed_when: advanced_policy_result.rc == 0
      failed_when: false
      ignore_errors: true
      when: item not in (advanced_policy_check.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list)

    - name: Clean up temporary bucket policy file
      file:
        path: /tmp/minio_bucket_policy.json
        state: absent

    - name: Check if encryption is already enabled
      command: /usr/local/bin/mc encrypt info "{{ minio_alias }}/{{ item }}"
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: encryption_check
      changed_when: false
      failed_when: false

    - name: Enable Server-Side Encryption (SSE-S3) for data at rest protection
      command: /usr/local/bin/mc encrypt set sse-s3 "{{ minio_alias }}/{{ item }}"
      loop:
        - "{{ minio_bucket_name_for_misskey }}"
        - "{{ minio_bucket_name_for_outline }}"
      register: encryption_result
      failed_when: false
      changed_when: encryption_result.rc == 0
      when: item not in (encryption_check.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list)

    - name: Display essential configuration summary
      debug:
        msg: |
          ==============================================
          MinIO Essential Security Configuration Complete
          ==============================================
          âœ… Web UI disabled (CLI management only)
          âœ… Buckets: {{ minio_bucket_name_for_misskey }}, {{ minio_bucket_name_for_outline }}
          âœ… IAM User: {{ misskey_s3_access_key }} (auto-generated, restricted permissions)
          âœ… Server-Side Encryption enabled with KMS (privacy protection)
          âœ… KMS Master Key: {{ minio_kms_master_key }} (auto-generated)
          âœ… Federation access enabled (ActivityPub platforms)
          âœ… Direct browser access prevention (Nginx layer)
          âœ… Tailscale network access (internal communication)
          âœ… Rate limiting (basic DDoS protection)

          ðŸ”‘ Misskey Configuration (balthasar):
          S3_BUCKET={{ minio_bucket_name_for_misskey }}
          S3_ENDPOINT=http://[TAILSCALE_RASPBERRYPI_IP]:{{ host_services[inventory_hostname].minio_api }}
          S3_ACCESS_KEY={{ misskey_s3_access_key }}
          S3_SECRET_KEY={{ misskey_s3_secret_key }}
          S3_BASE_URL=https://{{ minio_api_server_name }}/{{ minio_bucket_name_for_misskey }}

          ðŸ”‘ Outline Configuration:
          AWS_ACCESS_KEY_ID={{ misskey_s3_access_key }}
          AWS_SECRET_ACCESS_KEY={{ misskey_s3_secret_key }}
          AWS_S3_UPLOAD_BUCKET_NAME={{ minio_bucket_name_for_outline }}
          AWS_S3_UPLOAD_BUCKET_URL=https://{{ minio_api_server_name }}/{{ minio_bucket_name_for_outline }}

          Testing Steps:
          1. âœ… Tailscale connectivity: balthasar â†’ raspberrypi
          2. âœ… Misskey file upload functionality
          3. âœ… Federation image display via Cloudflare
          4. âœ… URL preservation: https://{{ minio_api_server_name }}/{{ minio_bucket_name_for_misskey }}/
          ==============================================
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined
