---
- name: Check if running in Nix environment
  shell: command -v nix >/dev/null 2>&1
  register: nix_available
  failed_when: false
  changed_when: false
  tags:
    - always

- name: Ensure Nix environment
  fail:
    msg: |
      âŒ This infrastructure requires Nix environment!
      
      ğŸ“‹ Please install Nix and run in nix develop environment:
      1. Install Nix: https://nixos.org/download.html
      2. Run: nix develop
      3. Then run Ansible playbooks
  when: nix_available.rc != 0
  tags:
    - always

- name: Setup Home Manager for Nix environments
  include_role:
    name: yamisskey.servers.home_manager
  tags:
    - always

- name: Display package management strategy
  debug:
    msg: |
      âœ… Nix Infrastructure Environment Detected
      ğŸ“¦ All packages managed via Home Manager (Nix Flake)
      
      ğŸ“‹ Common role packages provided by Nix:
      - prometheus, rclone, apparmor, auditd, tor, go
      
      ğŸš€ Ready for infrastructure automation!
  tags:
    - always
