---
- name: Load Synapse secrets from inventory
  set_fact:
    synapse_inventory_secrets: "{{ hostvars[inventory_hostname].synapse | default({}) }}"
    synapse_inventory_postgresql: "{{ (hostvars[inventory_hostname].synapse | default({})).postgresql | default({}) }}"

- name: Build Synapse secret values
  set_fact:
    synapse: {
      "registration_shared_secret": "{{ synapse_inventory_secrets.registration_shared_secret | default('CHANGE_ME_REGISTRATION_SECRET') }}",
      "macaroon_secret_key": "{{ synapse_inventory_secrets.macaroon_secret_key | default('CHANGE_ME_MACAROON_SECRET') }}",
      "form_secret": "{{ synapse_inventory_secrets.form_secret | default('CHANGE_ME_FORM_SECRET') }}",
      "postgresql_user": "{{ synapse_inventory_postgresql.user | default('synapse') }}",
      "postgresql_password": "{{ synapse_inventory_postgresql.password | default('CHANGE_ME_DB_PASSWORD') }}",
      "postgresql_database": "{{ synapse_inventory_postgresql.database | default('synapse') }}",
      "postgresql_host": "{{ synapse_inventory_postgresql.host | default('db') }}"
    }

- name: Surface placeholder Synapse secrets
  debug:
    msg: >-
      Synapse secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ synapse.{{ item.key }}.
  loop: "{{ synapse | dict2items }}"
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Expose Synapse secrets as legacy variables
  set_fact:
    registration_shared_secret: "{{ synapse.registration_shared_secret }}"
    macaroon_secret_key: "{{ synapse.macaroon_secret_key }}"
    form_secret: "{{ synapse.form_secret }}"
    postgresql_user: "{{ synapse.postgresql_user }}"
    postgresql_password: "{{ synapse.postgresql_password }}"
    postgresql_database: "{{ synapse.postgresql_database }}"
    postgresql_host: "{{ synapse.postgresql_host }}"

- name: Create synapse directory
  file:
    path: /var/www/synapse
    state: directory

- name: Create element directory
  file:
    path: /var/www/element
    state: directory

- name: Create element-config directory
  file:
    path: /var/www/element/element-config
    state: directory

- name: Add required configurations to Docker Compose file
  template:
    src: synapse_docker-compose.yml.j2
    dest: /var/www/synapse/docker-compose.yml

- name: Copy docker-compose.yml for element
  template:
    src: element_docker-compose.yml.j2
    dest: /var/www/element/docker-compose.yml

- name: Check if synapse container is running
  shell: docker ps --filter "name=synapse" --format "{{ '{{.Names}}' }}"
  register: synapse_container
  changed_when: false

- name: Create synapse-data directory
  file:
    path: /var/www/synapse/synapse-data
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Check if homeserver.yaml exists
  ansible.builtin.stat:
    path: /var/www/synapse/synapse-data/homeserver.yaml
  register: homeserver_config_stat

- name: Generate synapse configuration using docker-compose
  shell: |
    docker compose run --rm synapse generate
  args:
    chdir: /var/www/synapse
  when: not homeserver_config_stat.stat.exists

- name: Add required configurations to Synapse configuration file
  template:
    src: synapse.homeserver.yaml.j2
    dest: /var/www/synapse/synapse-data/homeserver.yaml
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Create well-known directory for Synapse
  file:
    path: /var/www/synapse/.well-known/matrix
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  become: true

- name: Configure E2EE settings for Synapse
  template:
    src: synapse_well_known_client.json.j2
    dest: /var/www/synapse/.well-known/matrix/client
    owner: www-data
    group: www-data
    mode: '0644'

- name: Start Synapse container
  community.docker.docker_compose_v2:
    project_src: /var/www/synapse
    recreate: never

- name: Start element
  community.docker.docker_compose_v2:
    project_src: /var/www/element
    state: restarted

- name: Copy element custom configuration file
  template:
    src: "config.{{ element_server_name }}.json.j2"
    dest: "/var/www/element/element-config/config.{{ element_server_name }}.json"
    mode: '0644'
  notify: Restart element
  when:
    - element_server_name is defined
    - element_server_name | length > 0
  failed_when: false
