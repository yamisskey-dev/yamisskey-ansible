---
- name: Load Lemmy secrets from inventory
  set_fact:
    lemmy_inventory_secrets: "{{ hostvars[inventory_hostname].lemmy | default({}) }}"

- name: Prepare Lemmy postgres password
  set_fact:
    postgres_password: "{{ lemmy_inventory_secrets.postgres_password | default('CHANGE_ME_LEMMY_DB_PASSWORD') }}"

- name: Warn about placeholder Lemmy secret
  debug:
    msg: >-
      Lemmy postgres_password is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ lemmy.postgres_password.
  when: postgres_password == 'CHANGE_ME_LEMMY_DB_PASSWORD'

- name: Create Lemmy directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "{{ lemmy_dir }}"
    - "{{ lemmy_dir }}/volumes"
    - "{{ lemmy_dir }}/volumes/postgres"

- name: Deploy Lemmy config.hjson
  template:
    src: config.hjson.j2
    dest: "{{ lemmy_dir }}/lemmy.hjson"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy PostgreSQL configuration
  template:
    src: postgresql.conf.j2
    dest: "{{ lemmy_dir }}/customPostgresql.conf"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy Nginx internal configuration
  template:
    src: nginx_internal.conf.j2
    dest: "{{ lemmy_dir }}/nginx_internal.conf"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy proxy_params file
  template:
    src: proxy_params.j2
    dest: "{{ lemmy_dir }}/proxy_params"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ lemmy_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Set pictrs folder permissions
  file:
    path: "{{ lemmy_dir }}/volumes/pictrs"
    state: directory
    owner: 991
    group: 991
    mode: '0755'
    recurse: true
  become: true

- name: Start Lemmy Docker containers
  community.docker.docker_compose_v2:
    project_src: "{{ lemmy_dir }}"
    pull: "{{ 'never' if (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != '' else 'missing' }}"
    remove_orphans: true
  failed_when: false
  register: lemmy_compose_result
  changed_when: lemmy_compose_result.changed | default(false)
  when:
    - (ansible_env.MOLECULE_SCENARIO_NAME | default('')) == ''
    - ansible_virtualization_type | default('') not in ['docker', 'container']

- name: Start Lemmy Docker containers (test environment)
  community.docker.docker_compose_v2:
    project_src: "{{ lemmy_dir }}"
    pull: never
    remove_orphans: true
  failed_when: false
  register: lemmy_compose_test_result
  changed_when: false
  when: (ansible_env.MOLECULE_SCENARIO_NAME | default('')) != ''
