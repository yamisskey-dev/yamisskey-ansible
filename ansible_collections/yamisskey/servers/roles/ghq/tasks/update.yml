---
- name: Update yamisskey-dev repositories
  command: ghq get -u {{ item }}
  loop: "{{ yamisskey_repositories }}"
  register: ghq_update_results
  failed_when: false
  changed_when: ghq_update_results.rc == 0
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined

- name: Skip update in test environment
  debug:
    msg: "Skipping repository update in test environment"
  when: ansible_env.MOLECULE_SCENARIO_NAME is defined

- name: Display update results
  debug:
    msg: |
      üîÑ Repository Update Results:
      {% for result in ghq_update_results.results %}
      - {{ result.item }}: {{ '‚úÖ Updated successfully' if result.rc == 0 else '‚ùå Update failed' }}
      {% if result.rc != 0 and result.stderr is defined %}
        Error: {{ result.stderr }}
      {% endif %}
      {% endfor %}
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined

- name: List updated repositories
  command: ghq list
  register: ghq_list_result
  changed_when: false
  failed_when: false
  when: ansible_env.MOLECULE_SCENARIO_NAME is not defined

- name: Display updated repositories
  debug:
    msg: |
      üìÅ Updated repositories in {{ ghq_root }}:
      {{ ghq_list_result.stdout_lines | join('\n') }}
  when: 
    - ansible_env.MOLECULE_SCENARIO_NAME is not defined
    - ghq_list_result.rc == 0
