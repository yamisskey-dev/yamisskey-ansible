---
- name: Determine package profile
  ansible.builtin.set_fact:
    packages_profile_effective: "{{ packages_profile | default('server') }}"

- name: Initialize package selection with base packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_base[ansible_os_family] | default([]) }}"

- name: Get current play role names
  ansible.builtin.set_fact:
    current_role_names: "{{ ansible_play_role_names | default([]) }}"

- name: Get current play tags
  ansible.builtin.set_fact:
    current_tags: "{{ ansible_run_tags | default([]) }}"

- name: Collect packages from active roles
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_by_role[item][ansible_os_family] | default([])) }}"
  loop: "{{ current_role_names }}"
  when: 
    - item in packages_by_role
    - packages_by_role[item] is defined
    - packages_by_role[item][ansible_os_family] is defined

- name: Collect packages from active tags
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_by_tag[item][ansible_os_family] | default([])) }}"
  loop: "{{ current_tags }}"
  when: 
    - item in packages_by_tag
    - packages_by_tag[item] is defined
    - packages_by_tag[item][ansible_os_family] is defined

- name: Add profile-based packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_profiles[packages_profile_effective][ansible_os_family] | default([])) }}"
  when: 
    - packages_profile_effective in packages_profiles
    - packages_profiles[packages_profile_effective] is defined
    - packages_profiles[packages_profile_effective][ansible_os_family] is defined

- name: Add extra packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_extra | default([]) | map('string') | list) }}"

- name: Remove duplicate packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | unique | list }}"

- name: Display package selection summary
  ansible.builtin.debug:
    msg: |
      ðŸ“¦ Package Selection Summary:
      ðŸŽ¯ Profile: {{ packages_profile_effective }}
      ðŸŽ­ Active Roles: {{ current_role_names | join(', ') }}
      ðŸ·ï¸  Active Tags: {{ current_tags | join(', ') }}
      ðŸ“‹ Total Packages: {{ packages_selected | length }}
      ðŸ“¦ Packages: {{ packages_selected | join(', ') }}

# Install packages using different methods
- name: Install standard APT packages
  ansible.builtin.apt:
    name: "{{ packages_install_methods.apt | intersect(packages_selected) }}"
    state: present
    update_cache: true
  when: 
    - packages_install_methods.apt | intersect(packages_selected) | length > 0
    - ansible_os_family == "Debian"
  register: apt_install_result

- name: Install packages from APT repositories
  block:
    - name: Add GPG key for {{ item.key }}
      ansible.builtin.get_url:
        url: "{{ item.value.gpg_key_url }}"
        dest: "{{ item.value.gpg_key_file }}"
        mode: '0644'
      become: true

    - name: Add APT repository for {{ item.key }}
      ansible.builtin.apt_repository:
        repo: "{{ item.value.repo }}"
        filename: "{{ item.value.filename }}"
        update_cache: true
      become: true

    - name: Install packages from {{ item.key }} repository
      ansible.builtin.apt:
        name: "{{ item.value.packages }}"
        state: present
      become: true
  loop: "{{ packages_install_methods.apt_repo | dict2items }}"
  when: 
    - packages_install_methods.apt_repo is defined
    - ansible_os_family == "Debian"
  register: apt_repo_install_result

- name: Install packages via manual download
  block:
    - name: Check if {{ item.key }} is already installed
      ansible.builtin.command: "which {{ item.key }}"
      register: manual_check
      failed_when: false
      changed_when: false

    - name: Download {{ item.key }}
      ansible.builtin.get_url:
        url: "{{ item.value.download_url }}"
        dest: "{{ item.value.install_path }}"
        mode: "{{ item.value.mode }}"
        owner: "{{ item.value.owner }}"
        group: "{{ item.value.group }}"
      become: true
      when: manual_check.rc != 0

    - name: Verify {{ item.key }} installation
      ansible.builtin.command: "{{ item.value.version_check }}"
      register: manual_verify
      changed_when: false
      when: manual_check.rc != 0
  loop: "{{ packages_install_methods.manual_download | dict2items }}"
  when: 
    - packages_install_methods.manual_download is defined
  register: manual_download_result

- name: Install Python packages via pip
  ansible.builtin.pip:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
    state: present
  loop: "{{ packages_install_methods.pip | default([]) }}"
  when: 
    - packages_install_methods.pip is defined
    - packages_install_methods.pip | length > 0
  register: pip_install_result

- name: Install packages via manual scripts
  block:
    - name: Check if {{ item.key }} is already installed
      ansible.builtin.stat:
        path: "{{ item.value.check_path }}"
      register: script_check

    - name: Clone repository for {{ item.key }}
      ansible.builtin.git:
        repo: "{{ item.value.repo }}"
        dest: "{{ item.value.dest }}"
        depth: 1
        version: master
      when: not script_check.stat.exists

    - name: Run installation script for {{ item.key }}
      ansible.builtin.shell: "{{ item.value.script }}"
      args:
        chdir: "{{ item.value.dest }}"
        executable: /bin/bash
      become: true
      when: not script_check.stat.exists

    - name: Clean up {{ item.key }} repository
      ansible.builtin.file:
        path: "{{ item.value.dest }}"
        state: absent
      when: not script_check.stat.exists
  loop: "{{ packages_install_methods.manual_script | dict2items }}"
  when: 
    - packages_install_methods.manual_script is defined
  register: manual_script_result

- name: Display installation results
  ansible.builtin.debug:
    msg: |
      âœ… Package Installation Complete:
      ðŸ“¦ APT packages: {{ apt_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ðŸ“¦ APT repo packages: {{ apt_repo_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ðŸ“¦ Manual downloads: {{ manual_download_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ðŸ“¦ Python packages: {{ pip_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ðŸ“¦ Manual scripts: {{ manual_script_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ðŸ“‹ Total packages processed: {{ packages_selected | length }}
