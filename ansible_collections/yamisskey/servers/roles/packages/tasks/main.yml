---
- name: Determine package profile
  ansible.builtin.set_fact:
    packages_profile_effective: "{{ packages_profile | default('server') }}"

- name: Initialize package selection with base packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_base[ansible_os_family] | default([]) }}"

- name: Get current play role names
  ansible.builtin.set_fact:
    current_role_names: "{{ ansible_play_role_names | default([]) | map('regex_replace', '^yamisskey\\.servers\\.', '') | list }}"

- name: Get current play tags
  ansible.builtin.set_fact:
    current_tags: "{{ ansible_run_tags | default([]) }}"

- name: Collect packages from active roles
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_by_role[item][ansible_os_family] | default([])) }}"
  loop: "{{ current_role_names }}"
  when: 
    - item in packages_by_role
    - packages_by_role[item] is defined
    - packages_by_role[item][ansible_os_family] is defined

- name: Collect packages from active tags
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_by_tag[item][ansible_os_family] | default([])) }}"
  loop: "{{ current_tags }}"
  when: 
    - item in packages_by_tag
    - packages_by_tag[item] is defined
    - packages_by_tag[item][ansible_os_family] is defined

- name: Add profile-based packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_profiles[packages_profile_effective][ansible_os_family] | default([])) }}"
  when: 
    - packages_profile_effective in packages_profiles
    - packages_profiles[packages_profile_effective] is defined
    - packages_profiles[packages_profile_effective][ansible_os_family] is defined

- name: Add extra packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | union(packages_extra | default([]) | map('string') | list) }}"

- name: Remove duplicate packages
  ansible.builtin.set_fact:
    packages_selected: "{{ packages_selected | unique | list }}"

- name: Display package selection summary
  ansible.builtin.debug:
    msg: |
      ğŸ“¦ Package Selection Summary:
      ğŸ¯ Profile: {{ packages_profile_effective }}
      ğŸ­ Active Roles: {{ current_role_names | join(', ') }}
      ğŸ·ï¸ Active Tags: {{ current_tags | join(', ') }}
      ğŸ“‹ Total Packages: {{ packages_selected | length }}
      ğŸ“¦ Packages: {{ packages_selected | join(', ') }}

# Install packages using different methods
- name: Install standard APT packages
  ansible.builtin.apt:
    name: "{{ packages_install_methods.apt | intersect(packages_selected) }}"
    state: present
    update_cache: true
  when: 
    - packages_install_methods.apt | intersect(packages_selected) | length > 0
    - ansible_os_family == "Debian"
  register: apt_install_result

- name: Install packages from APT repositories
  include_tasks: apt_repo_install.yml
  when: 
    - packages_install_methods.apt_repo is defined
    - ansible_os_family == "Debian"
    - packages_selected is defined
    - packages_selected | length > 0
  register: apt_repo_install_result

- name: Install packages via manual download
  include_tasks: manual_download_install.yml
  when: 
    - packages_install_methods.manual_download is defined
  register: manual_download_result

- name: Install Python packages via pip
  ansible.builtin.pip:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
    state: present
  loop: "{{ packages_install_methods.pip | default([]) }}"
  when: 
    - packages_install_methods.pip is defined
    - packages_install_methods.pip | length > 0
  register: pip_install_result

- name: Install packages via manual scripts
  include_tasks: manual_script_install.yml
  when: 
    - packages_install_methods.manual_script is defined
  register: manual_script_result

- name: Display installation results
  ansible.builtin.debug:
    msg: |
      âœ… Package Installation Complete:
      ğŸ“¦ APT packages: {{ apt_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ğŸ“¦ APT repo packages: {{ apt_repo_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ğŸ“¦ Manual downloads: {{ manual_download_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ğŸ“¦ Python packages: {{ pip_install_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ğŸ“¦ Manual scripts: {{ manual_script_result.changed | default(false) | ternary('Installed', 'Already installed') }}
      ğŸ“‹ Total packages processed: {{ packages_selected | length }}
