# yamisskey.servers role: deeplx tasks
---
- name: Create DeepLX directory
  file:
    path: "{{ deeplx_dir }}"
    state: directory
    mode: '0755'

- name: Create docker-compose.yml for DeepLX
  template:
    src: deeplx_docker-compose.yml.j2
    dest: "{{ deeplx_dir }}/docker-compose.yml"
    mode: '0644'
  notify: restart deeplx

- name: Deploy DeepLX container
  block:
    - name: Start DeepLX services with docker compose v2
      community.docker.docker_compose_v2:
        project_src: "{{ deeplx_dir }}"
        pull: always
      register: deeplx_compose_v2_result
      ignore_errors: true

    - name: Start DeepLX services with legacy docker-compose
      community.docker.docker_compose:
        project_src: "{{ deeplx_dir }}"
        pulled: true
        restarted: true
      register: deeplx_compose_v1_result
      when: deeplx_compose_v2_result is failed

    - name: Ensure DeepLX compose execution succeeded
      ansible.builtin.assert:
        that:
          - (deeplx_compose_v2_result is defined and deeplx_compose_v2_result is not failed) or
            (deeplx_compose_v1_result is defined and deeplx_compose_v1_result is not failed)
        fail_msg: >-
          Failed to start DeepLX services with both docker compose v2 plugin and legacy docker-compose.
