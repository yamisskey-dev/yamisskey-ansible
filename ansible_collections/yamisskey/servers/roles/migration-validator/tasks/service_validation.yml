---
# Migration Validator - Service Validation Tasks
# Validates MinIO and Docker services on both hosts

- name: Check MinIO service status on source host
  shell: |
    docker ps --format "table {{.Names}}\t{{.Status}}" | grep -i minio || echo "MinIO not running"
  register: source_minio_status
  delegate_to: "{{ source_minio_host }}"
  failed_when: false
  changed_when: false
  tags: ['services', 'minio']

- name: Check MinIO service status on target host
  shell: |
    docker ps --format "table {{.Names}}\t{{.Status}}" | grep -i minio || echo "MinIO not running"
  register: target_minio_status
  delegate_to: "{{ target_minio_host }}"
  failed_when: false
  changed_when: false
  tags: ['services', 'minio']

- name: Test MinIO API endpoints
  uri:
    url: "http://{{ item.host }}:{{ minio_default_port }}/minio/health/live"
    method: GET
    timeout: 10
  register: minio_health_check
  failed_when: false
  loop:
    - { host: "{{ source_host_info.ansible_host }}", name: "source" }
    - { host: "{{ target_host_info.ansible_host }}", name: "target" }
  tags: ['services', 'health']

- name: Set service validation status
  set_fact:
    validation_results: "{{ validation_results | default({}) | combine({
      'services': {
        'status': 'passed' if (source_minio_status.stdout.find('minio') != -1 and target_minio_status.stdout.find('minio') != -1) else 'warning',
        'timestamp': ansible_date_time.iso8601,
        'details': 'MinIO service validation completed',
        'critical': true,
        'score': 100 if (source_minio_status.stdout.find('minio') != -1 and target_minio_status.stdout.find('minio') != -1) else 50
      }
    }) }}"
  tags: ['services', 'results']