---
- name: Converge searxng role
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Verify Nix installation
      command: which nix
      register: nix_check
      failed_when: nix_check.rc != 0
      changed_when: false

    - name: Fail if not running on Nix-enabled system
      fail:
        msg: "This test requires a Nix-enabled environment. Use 'nix develop' to enter development shell."
      when: nix_check.rc != 0

    - name: Verify Docker availability from Nix
      command: which docker
      register: docker_check
      failed_when: docker_check.rc != 0
      changed_when: false

    - name: Start Docker service (if available)
      service:
        name: docker
        state: started
        enabled: true
      failed_when: false

    - name: Create test directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/test

    - name: Prepare mock SearXNG repository
      block:
        - name: Ensure repository structure exists
          file:
            path: "{{ searxng_repo }}/{{ item }}"
            state: directory
            mode: '0755'
          loop:
            - ""
            - "searxng"

        - name: Create mock docker-compose file
          copy:
            dest: "{{ searxng_repo }}/docker-compose.yaml"
            mode: '0644'
            content: |
              services:
                web:
                  image: nginx:alpine
                  command: ["/bin/sh", "-c", "sleep 365d"]

        - name: Create mock settings file
          copy:
            dest: "{{ searxng_repo }}/searxng/settings.yml"
            mode: '0644'
            content: |
              secret_key: ultrasecretkey

        - name: Initialise git repository for mock SearXNG
          command: git init "{{ searxng_repo }}"
          args:
            creates: "{{ searxng_repo }}/.git"

        - name: Ensure main branch exists
          command: git -C "{{ searxng_repo }}" checkout -b main
          args:
            creates: "{{ searxng_repo }}/.git/refs/heads/main"

        - name: Stage repository contents
          command: git -C "{{ searxng_repo }}" add -A
          changed_when: false

        - name: Commit mock repository contents
          command: git -C "{{ searxng_repo }}" -c user.name="molecule" -c user.email="molecule@example.com" commit -m "Initial"
          register: searxng_git_commit
          changed_when: searxng_git_commit.rc == 0
          failed_when: >-
            searxng_git_commit.rc not in [0, 1]
            or (
              searxng_git_commit.rc == 1
              and ('nothing to commit' not in (searxng_git_commit.stdout | lower))
              and ('nothing to commit' not in (searxng_git_commit.stderr | lower))
            )

  tasks:
    - name: Apply searxng role
      include_role:
        name: yamisskey.servers.searxng
      vars:
        ansible_user: "root"

    - name: Basic role verification
      debug:
        msg: "searxng role applied successfully"

  post_tasks:
    - name: Show test environment status
      shell: echo "Test environment setup completed"
      register: test_status
      changed_when: false

    - name: Display test status
      debug:
        var: test_status.stdout
