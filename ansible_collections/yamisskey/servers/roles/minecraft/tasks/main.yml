---
- name: Load Minecraft secrets from inventory
  set_fact:
    minecraft_secrets: "{{ hostvars[inventory_hostname].minecraft | default({}) }}"

- name: Prepare Minecraft secrets
  set_fact:
    admin_uuid: "{{ minecraft_secrets.admin_uuid | default('00000000-0000-0000-0000-000000000000') }}"
    rcon_password: "{{ minecraft_secrets.rcon_password | default('CHANGE_ME_MINECRAFT_RCON') }}"

- name: Warn about placeholder Minecraft secrets
  debug:
    msg: >-
      Minecraft secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ minecraft.{{ item.key }}.
  loop:
    - { key: admin_uuid, value: "{{ admin_uuid }}" }
    - { key: rcon_password, value: "{{ rcon_password }}" }
  when: (item.key == 'rcon_password' and item.value == 'CHANGE_ME_MINECRAFT_RCON')
        or (item.key == 'admin_uuid' and item.value == '00000000-0000-0000-0000-000000000000')

- name: Create Minecraft directory
  file:
    path: '{{ minecraft_dir }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'

- name: Create Minecraft data directory
  file:
    path: '{{ minecraft_dir }}/data'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'

- name: Create ops.json
  ansible.builtin.copy:
    dest: '{{ minecraft_dir }}/data/ops.json'
    content: |
      [
        {
          "uuid": "{{ admin_uuid }}",
          "name": "admin",
          "level": 4,
          "bypassesPlayerLimit": true
        }
      ]
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'

- name: Copy .env file
  template:
    src: minecraft.env.j2
    dest: '{{ minecraft_dir }}/.env'
    mode: '0600'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  notify: restart minecraft

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: '{{ minecraft_dir }}/docker-compose.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  notify: restart minecraft

- name: Create Minecraft plugins config directories
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  loop:
    - '{{ minecraft_dir }}/data/plugins'
    - '{{ minecraft_dir }}/data/plugins/Geyser-Spigot'
    - '{{ minecraft_dir }}/data/plugins/floodgate'

- name: Copy Geyser config
  template:
    src: geyser-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/Geyser-Spigot/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  notify: restart minecraft

- name: Copy Floodgate config
  template:
    src: floodgate-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/floodgate/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  notify: restart minecraft

- name: Copy server.properties
  template:
    src: server.properties.j2
    dest: '{{ minecraft_dir }}/data/server.properties'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
  notify: restart minecraft

- name: Start Minecraft server
  community.docker.docker_compose_v2:
    project_src: '{{ minecraft_dir }}'
    pull: always

- name: Enable and start Docker service
  systemd:
    name: docker
    state: started
    enabled: true
  when: ansible_virtualization_type is not defined or ansible_virtualization_type not in ['docker', 'container']

- name: Wait for plugins to initialize
  ansible.builtin.wait_for:
    timeout: 60
  when: not ansible_check_mode

- name: Force copy Geyser config after initialization
  template:
    src: geyser-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/Geyser-Spigot/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
    force: true
  notify: restart minecraft

- name: Force copy Floodgate config after initialization
  template:
    src: floodgate-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/floodgate/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    ansible.builtin.file: '{{ ansible_user }}'
    force: true
  notify: restart minecraft

- name: PlayIt.gg setup helper
  block:
    - name: Install required packages for PlayIt.gg
      ansible.builtin.apt:
        name:
          - curl
          - gnupg
        update_cache: true
      become: true

    - name: Add PlayIt.gg APT repository key
      shell: |
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
      args:
        creates: /etc/apt/trusted.gpg.d/playit.gpg
      become: true

    - name: Add PlayIt.gg APT repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./"
        filename: playit-cloud
        update_cache: true
      become: true

    - name: Install PlayIt.gg package
      ansible.builtin.apt:
        name: playit
      become: true

    - name: Display PlayIt.gg manual setup information
      debug:
        msg: |
          ===============================================
          ğŸ”— PlayIt.gg ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - æ‰‹å‹•è¨­å®š
          ===============================================

          âœ… PlayIt.ggãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†

          ğŸ“‹ æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †:
          1. sudo /usr/local/bin/playit
             (åˆå›å®Ÿè¡Œã§Claim Codeã¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™)

          2. è¡¨ç¤ºã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š

          3. ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹:
             sudo systemctl start playit.service
             sudo systemctl enable playit.service

          âš ï¸ é‡è¦:
          - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„
          - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šå¾Œã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ‰‹å‹•ã§é–‹å§‹ã—ã¦ãã ã•ã„
          ===============================================
  when: playit_enabled | default(false)

- name: Create playit systemd service template
  template:
    src: playit.service.j2
    dest: /etc/systemd/system/playit.service
    mode: '0644'
  become: true
  when: playit_enabled | default(false)

- name: Reload systemd daemon for playit service
  systemd:
    daemon_reload: true
  become: true
  when: playit_enabled | default(false)
