---
# Migration Validator - Validation Report Generation
# Creates comprehensive validation reports

- name: Calculate overall validation score
  set_fact:
    overall_score: |
      {%- set total_score = 0 -%}
      {%- set total_weight = 0 -%}
      {%- for category, result in validation_results.items() -%}
        {%- set weight = validation_categories[category].weight | default(10) -%}
        {%- set score = result.score | default(0) -%}
        {%- set total_score = total_score + (score * weight) -%}
        {%- set total_weight = total_weight + weight -%}
      {%- endfor -%}
      {{ (total_score / total_weight) | round | int if total_weight > 0 else 0 }}

- name: Display comprehensive validation report
  debug:
    msg: |
      üìã Migration Validation Report:
      ===============================
      üìÖ Generated: {{ ansible_date_time.iso8601 }}
      üñ•Ô∏è Host: {{ inventory_hostname }}
      üìä Overall Score: {{ overall_score }}%

      üìà Validation Results:
      {% for category, result in validation_results.items() %}
      - {{ category | title }}: {{ result.status | upper }} ({{ result.score }}%)
        Details: {{ result.details }}
      {% endfor %}

      {% if overall_score | int >= 80 %}
      ‚úÖ Migration validation PASSED - Ready to proceed
      {% elif overall_score | int >= 60 %}
      ‚ö†Ô∏è Migration validation WARNING - Proceed with caution
      {% else %}
      ‚ùå Migration validation FAILED - Address issues before proceeding
      {% endif %}
  tags: ['report', 'summary']

- name: Generate validation report file
  ansible.builtin.copy:
    content: |
      # Migration Validation Report
      Generated: {{ ansible_date_time.iso8601 }}
      Overall Score: {{ overall_score }}%

      ## Validation Results
      {% for category, result in validation_results.items() %}
      ### {{ category | title }}
      - Status: {{ result.status | upper }}
      - Score: {{ result.score }}%
      - Details: {{ result.details }}
      - Timestamp: {{ result.timestamp }}

      {% endfor %}
    dest: "/tmp/migration_validation_{{ ansible_date_time.epoch }}.md"
    mode: '0644'
  when: save_report_to_file | bool
  tags: ['report', 'file']
