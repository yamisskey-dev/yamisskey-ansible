---
- name: Display system information
  ansible.builtin.debug:
    msg: |
      ğŸ–¥ï¸ System Information:
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      Architecture: {{ ansible_architecture }}
      Hostname: {{ ansible_hostname }}
      User: {{ ansible_user | default(ansible_user_id | default('root')) }}
  tags:
    - always

- name: Check if running in Nix environment
  shell: command -v nix >/dev/null 2>&1
  register: nix_available
  failed_when: false
  changed_when: false
  tags:
    - always

- name: Display package management strategy
  debug:
    msg: |
      ğŸ—ï¸ System Initialization Strategy:
      {{ 'âœ… Nix Flake environment - Docker/Tailscale/Cloudflared provided by Nix' if nix_available.rc == 0 else 'ğŸ“¦ System package manager - installing via distribution packages' }}
  tags:
    - always

- name: Update apt package index (non-Nix environments)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when:
    - ansible_os_family == "Debian"
    - not (test_mode | default(false))
    - nix_available.rc != 0
  tags:
    - packages

- name: Check if common role should be applied
  ansible.builtin.stat:
    path: "{{ ansible_env.PWD }}/deploy/servers/playbooks/common.yml"
  register: common_playbook_check
  become: false
  when: not (test_mode | default(false))
  tags:
    - always

- name: Apply common role for necessary packages (non-Nix environments)
  ansible.builtin.include_role:
    name: yamisskey.servers.common
  when:
    - not (test_mode | default(false))
    - common_playbook_check.stat.exists
    - nix_available.rc != 0
  tags:
    - packages
    - common

- name: Install base packages if common playbook not available (non-Nix environments)
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - gnupg
      - lsb-release
      - software-properties-common
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: true
  when:
    - not (test_mode | default(false))
    - not common_playbook_check.stat.exists
    - ansible_os_family == "Debian"
    - nix_available.rc != 0
  tags:
    - packages
    - base

- name: Skip base package installation (Nix environment)
  debug:
    msg: |
      ğŸ¯ Skipping system package installation - provided by Nix Flake:
      - curl, wget, git, gnupg (development tools)
      - Docker, Tailscale, Cloudflared (infrastructure tools)
      
      ğŸ“‹ All tools are available in the Nix development environment.
  when: nix_available.rc == 0
  tags:
    - packages

- name: Install Docker (non-Nix environments)
  ansible.builtin.include_tasks: docker.yml
  when:
    - install_docker | default(true)
    - nix_available.rc != 0
  tags:
    - docker

- name: Install Tailscale (non-Nix environments)
  ansible.builtin.include_tasks: tailscale.yml
  when:
    - install_tailscale | default(true)
    - nix_available.rc != 0
  tags:
    - tailscale

- name: Install Cloudflare products (non-Nix environments)
  ansible.builtin.include_tasks: cloudflare.yml
  when:
    - install_cloudflare | default(true)
    - nix_available.rc != 0
  tags:
    - cloudflare

- name: Skip infrastructure tool installation (Nix environment)
  debug:
    msg: |\n      ğŸ¯ Infrastructure Tools Status (Nix Environment):
      - Docker: âœ… Available via Nix Flake
      - Tailscale: âœ… Available via Nix Flake
      - Cloudflared: âœ… Available via Nix Flake
      
      ğŸ“‹ Use 'yamisskey-provision help' to verify all tools.
      ğŸš€ Ready for Ansible infrastructure automation!
  when: nix_available.rc == 0
  tags:
    - docker
    - tailscale
    - cloudflare

- name: Verify installations
  ansible.builtin.include_tasks: verify.yml
  when: verify_installations | default(true)
  tags:
    - verify
    - always

- name: Display next steps
  ansible.builtin.debug:
    msg: |
      ğŸ‰ System initialization completed!

      ğŸ“‹ Next steps:
      1. Configure Tailscale: sudo tailscale up
      2. Configure Cloudflare WARP (optional): warp-cli register
      3. Clone repositories: ansible-playbook -i inventory playbooks/clone-repos.yml
      4. Run system test: ansible-playbook -i inventory playbooks/system-test.yml
      5. Start provisioning: ansible-playbook -i inventory playbooks/common.yml
  tags:
    - always
