---
- name: Display system information
  ansible.builtin.debug:
    msg: |
      üñ•Ô∏è System Information:
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      Architecture: {{ ansible_architecture }}
      Hostname: {{ ansible_hostname }}
      User: {{ ansible_user | default(ansible_user_id | default('root')) }}
  tags:
    - always

- name: Update apt package index
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when:
    - ansible_os_family == "Debian"
    - not (test_mode | default(false))
  tags:
    - packages

- name: Check if common role should be applied
  ansible.builtin.stat:
    path: "{{ ansible_env.PWD }}/deploy/servers/playbooks/common.yml"
  register: common_playbook_check
  become: false
  when: not (test_mode | default(false))
  tags:
    - always

- name: Apply common role for necessary packages
  ansible.builtin.include_role:
    name: yamisskey.servers.common
  when:
    - not (test_mode | default(false))
    - common_playbook_check.stat.exists
  tags:
    - packages
    - common

- name: Install base packages if common playbook not available
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - gnupg
      - lsb-release
      - software-properties-common
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: true
  when:
    - not (test_mode | default(false))
    - not common_playbook_check.stat.exists
    - ansible_os_family == "Debian"
  tags:
    - packages
    - base

- name: Install Docker
  ansible.builtin.include_tasks: docker.yml
  when: install_docker | default(true)
  tags:
    - docker

- name: Install Tailscale
  ansible.builtin.include_tasks: tailscale.yml
  when: install_tailscale | default(true)
  tags:
    - tailscale

- name: Install Cloudflare products
  ansible.builtin.include_tasks: cloudflare.yml
  when: install_cloudflare | default(true)
  tags:
    - cloudflare

- name: Verify installations
  ansible.builtin.include_tasks: verify.yml
  when: verify_installations | default(true)
  tags:
    - verify
    - always

- name: Display next steps
  ansible.builtin.debug:
    msg: |
      üéâ System initialization completed!

      üìã Next steps:
      1. Configure Tailscale: sudo tailscale up
      2. Configure Cloudflare WARP (optional): warp-cli register
      3. Clone repositories: ansible-playbook -i inventory playbooks/clone-repos.yml
      4. Run system test: ansible-playbook -i inventory playbooks/system-test.yml
      5. Start provisioning: ansible-playbook -i inventory playbooks/common.yml
  tags:
    - always
