---
- name: Check if running in Nix environment
  shell: command -v nix >/dev/null 2>&1
  register: nix_available
  failed_when: false
  changed_when: false

- name: Ensure Nix environment for Cloudflare setup
  fail:
    msg: |
      âŒ Cloudflare setup requires Nix environment!
      
      ğŸ“‹ Cloudflare tools are now managed via Nix Flake:
      - cloudflared: Available via Home Manager
      - All networking tools: Available via Nix
      
      ğŸš€ Run in nix develop environment.
  when: nix_available.rc != 0

- name: Display Cloudflare package status
  debug:
    msg: |
      âœ… Cloudflare packages managed via Nix Flake
      ğŸ“¦ Available tools: cloudflared, tailscale
      â˜ï¸ Ready for Cloudflare operations!

- name: Verify Cloudflared is available
  command: cloudflared --version
  register: cloudflared_version_check
  failed_when: false
  changed_when: false

- name: Display Cloudflared version
  debug:
    msg: "Cloudflared version: {{ cloudflared_version_check.stdout }}"
  when: cloudflared_version_check.rc == 0

- name: Verify Tailscale is available
  command: tailscale version
  register: tailscale_version_check
  failed_when: false
  changed_when: false

- name: Display Tailscale version
  debug:
    msg: "Tailscale version: {{ tailscale_version_check.stdout }}"
  when: tailscale_version_check.rc == 0
