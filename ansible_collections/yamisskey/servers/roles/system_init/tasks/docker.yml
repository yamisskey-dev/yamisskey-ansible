---
- name: Check if running in Nix environment
  shell: command -v nix >/dev/null 2>&1
  register: nix_available
  failed_when: false
  changed_when: false

- name: Ensure Nix environment for Docker setup
  fail:
    msg: |
      âŒ Docker setup requires Nix environment!
      
      ğŸ“‹ Docker is now managed via Nix Flake:
      - docker: Available via Home Manager
      - docker-compose: Available via Home Manager
      
      ğŸš€ Run in nix develop environment.
  when: nix_available.rc != 0

- name: Display Docker package status
  debug:
    msg: |
      âœ… Docker packages managed via Nix Flake
      ğŸ“¦ Available tools: docker, docker-compose
      ğŸ³ Ready for container operations!

- name: Verify Docker is available
  command: docker --version
  register: docker_version_check
  failed_when: false
  changed_when: false

- name: Display Docker version
  debug:
    msg: "Docker version: {{ docker_version_check.stdout }}"
  when: docker_version_check.rc == 0

- name: Add user to docker group
  ansible.builtin.user:
    name: "{{ ansible_user | default(ansible_user_id | default('root')) }}"
    groups: docker
    append: true
  when: not ansible_check_mode

- name: Enable and start Docker service
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started
  when: not ansible_check_mode
  register: docker_service
  failed_when: false
