- name: Create project directory
  file:
    path: /var/www/vikunja
    state: directory

- name: Create necessary directories
  file:
    path: /var/www/vikunja/{{ item }}
    state: directory
    owner: 1000
    group: 1000
  loop:
    - files
    - db

# 秘密情報ファイルの状態管理
- name: Check if Vikunja secrets file exists
  stat:
    path: '{{ vikunja_secrets_file }}'
  register: vikunja_secrets_stat

- name: Initialize Vikunja secrets when missing
  when: not vikunja_secrets_stat.stat.exists
  block:
    - name: Generate JWT secret
      shell: 'cat /dev/urandom | tr -dc "a-zA-Z0-9" | fold -w 64 | head -n 1'
      register: vikunja_jwt_secret_output

    - name: Set initial Vikunja secrets
      set_fact:
        vikunja_secrets:
          jwt_secret: '{{ vikunja_jwt_secret_output.stdout }}'
          db_root_password: '{{ db_root_password | default("vikunja-root-password") }}'
          db_user: '{{ db_user | default("vikunja") }}'
          db_password: '{{ db_password | default("vikunja-password") }}'
          mailer_password: '{{ mailer_password | default("vikunja-mailer-password") }}'

    - name: Persist initial Vikunja secrets file
      copy:
        dest: '{{ vikunja_secrets_file }}'
        content: '{{ vikunja_secrets | to_nice_yaml(indent=2) }}\n'
        mode: '0600'
        owner: '{{ ansible_user | default("root") }}'
        group: '{{ ansible_user | default("root") }}'

- name: Load existing Vikunja secrets from file
  when: vikunja_secrets is not defined
  block:
    - name: Read secrets file content
      slurp:
        src: '{{ vikunja_secrets_file }}'
      register: vikunja_secrets_raw

    - name: Parse secrets file
      set_fact:
        vikunja_secrets: '{{ vikunja_secrets_raw.content | b64decode | from_yaml }}'

- name: Ensure Vikunja secrets include default values
  set_fact:
    vikunja_secrets: '{{ {
        "db_root_password": db_root_password | default("vikunja-root-password"),
        "db_user": db_user | default("vikunja"),
        "db_password": db_password | default("vikunja-password"),
        "mailer_password": mailer_password | default("vikunja-mailer-password")
      } | combine(vikunja_secrets | default({}), recursive=True) }}'

- name: Ensure JWT secret is defined
  when: vikunja_secrets.jwt_secret is not defined or vikunja_secrets.jwt_secret | length == 0
  block:
    - name: Generate JWT secret value
      shell: 'cat /dev/urandom | tr -dc "a-zA-Z0-9" | fold -w 64 | head -n 1'
      register: vikunja_jwt_secret_output

    - name: Update Vikunja secrets with generated JWT secret
      set_fact:
        vikunja_secrets: '{{ vikunja_secrets | combine({"jwt_secret": vikunja_jwt_secret_output.stdout}, recursive=True) }}'

- name: Persist Vikunja secrets to disk
  copy:
    dest: '{{ vikunja_secrets_file }}'
    content: '{{ vikunja_secrets | to_nice_yaml(indent=2) }}\n'
    mode: '0600'
    owner: '{{ ansible_user | default("root") }}'
    group: '{{ ansible_user | default("root") }}'
  when: not vikunja_secrets_stat.stat.exists

- name: Expose Vikunja secrets as individual facts
  set_fact:
    jwt_secret: '{{ vikunja_secrets.jwt_secret }}'

# Docker Composeファイルをテンプレートから生成
- name: Generate docker-compose.yml from template
  template:
    src: vikunja_docker-compose.yml.j2
    dest: '/var/www/vikunja/docker-compose.yml'

# Docker Composeでサービスを起動
- name: Start Vikunja services
  community.docker.docker_compose_v2:
    project_src: '/var/www/vikunja'
    pull: always
    state: present
