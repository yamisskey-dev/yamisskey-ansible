---
- name: Load Vikunja secrets from inventory
  set_fact:
    vikunja_inventory_secrets: "{{ hostvars[inventory_hostname].vikunja | default({}) }}"

- name: Prepare Vikunja secret values
  set_fact:
    vikunja_secrets: {
      "jwt_secret": "{{ vikunja_inventory_secrets.jwt_secret | default('CHANGE_ME_VIKUNJA_JWT') }}",
      "db_root_password": "{{ vikunja_inventory_secrets.db_root_password | default('CHANGE_ME_VIKUNJA_DB_ROOT') }}",
      "db_user": "{{ vikunja_inventory_secrets.db_user | default('vikunja') }}",
      "db_password": "{{ vikunja_inventory_secrets.db_password | default('CHANGE_ME_VIKUNJA_DB_PASSWORD') }}",
      "mailer_password": "{{ vikunja_inventory_secrets.mailer_password | default('CHANGE_ME_VIKUNJA_MAILER') }}"
    }

- name: Warn about placeholder Vikunja secrets
  debug:
    msg: >-
      Vikunja secret '{{ item.key }}' is using a placeholder value. Update
      deploy/servers/host_vars/{{ inventory_hostname }}/secrets.yml â†’ vikunja.{{ item.key }}.
  loop: "{{ vikunja_secrets | dict2items }}"
  when: item.value is string and item.value is search('^CHANGE_ME_')

- name: Expose Vikunja secrets as individual facts
  set_fact:
    jwt_secret: "{{ vikunja_secrets.jwt_secret }}"
    db_root_password: "{{ vikunja_secrets.db_root_password }}"
    db_user: "{{ vikunja_secrets.db_user }}"
    db_password: "{{ vikunja_secrets.db_password }}"
    mailer_password: "{{ vikunja_secrets.mailer_password }}"

- name: Create project directory
  file:
    path: /var/www/vikunja
    state: directory

- name: Create necessary directories
  file:
    path: /var/www/vikunja/{{ item }}
    state: directory
    owner: 1000
    ansible.builtin.file: 1000
  loop:
    - files
    - db

- name: Generate docker-compose.yml from template
  template:
    src: vikunja_docker-compose.yml.j2
    dest: '/var/www/vikunja/docker-compose.yml'

- name: Start Vikunja services
  community.docker.docker_compose_v2:
    project_src: '/var/www/vikunja'
    pull: always
    state: present
