- name: Create Impostor directories
  file:
    path: "{{ impostor_dir }}/{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "data"
    - "data/plugins"
    - "data/libraries"
    - "logs"

- name: Template config.json
  template:
    src: impostor_config.json.j2
    dest: "{{ impostor_dir }}/data/config.json"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Copy docker-compose.yml
  template:
    src: impostor_docker-compose.yml.j2
    dest: "{{ impostor_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Ensure Docker service is running
  service:
    name: docker
    state: started
    enabled: true
  become: true
  when: ansible_service_mgr != 'unknown'
  failed_when: false

- name: Deploy Impostor server
  community.docker.docker_compose_v2:
    project_src: "{{ impostor_dir }}"
    pull: always
  when: ansible_play_hosts_all | length > 1

- name: Create playit service
  template:
    src: playit.service.j2
    dest: /etc/systemd/system/playit.service
    mode: '0644'
  become: true
  when: ansible_play_hosts_all | length > 1

- name: Configure playit service
  systemd:
    name: playit
    state: started
    enabled: true
    daemon_reload: true
  become: true
  when: ansible_play_hosts_all | length > 1
