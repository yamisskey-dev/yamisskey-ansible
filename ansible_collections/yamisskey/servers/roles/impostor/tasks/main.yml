- name: Create Impostor directories
  file:
    path: "{{ impostor_dir }}/{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "data"
    - "data/plugins"
    - "data/libraries"
    - "logs"

- name: Template config.json
  template:
    src: impostor_config.json.j2
    dest: "{{ impostor_dir }}/data/config.json"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Copy docker-compose.yml
  template:
    src: impostor_docker-compose.yml.j2
    dest: "{{ impostor_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Ensure Docker service is running
  service:
    name: docker
    state: started
    enabled: true
  become: true
  when: ansible_service_mgr != 'unknown'

- name: Deploy Impostor server
  block:
    - name: Launch Impostor with docker compose v2
      community.docker.docker_compose_v2:
        project_src: "{{ impostor_dir }}"
        pull: always
      register: compose_v2_result
      ignore_errors: true

    - name: Launch Impostor with legacy docker-compose
      community.docker.docker_compose:
        project_src: "{{ impostor_dir }}"
        pulled: true
        restarted: true
      register: compose_v1_result
      when: compose_v2_result is failed

    - name: Validate docker compose run
      ansible.builtin.assert:
        that:
          - (compose_v2_result is defined and compose_v2_result is not failed) or
            (compose_v1_result is defined and compose_v1_result is not failed)
        fail_msg: >-
          Failed to start Impostor services with both docker compose v2 plugin and
          the legacy docker-compose binary.

- name: Create playit service
  template:
    src: playit.service.j2
    dest: /etc/systemd/system/playit.service
    mode: '0644'
  become: true

- name: Configure playit service
  systemd:
    name: playit
    state: started
    enabled: true
    daemon_reload: true
  become: true
