---
- name: Get service logs for all containers
  shell: |
    for container in $(docker ps --format "{{ '{{' }}.Names{{ '}}' }}"); do
      echo "=== Logs for $container ==="
      docker logs --tail={{ log_lines }} $container 2>&1
      echo ""
    done
  register: all_service_logs
  changed_when: false
  when: target_service == 'all'

- name: Get logs for specific service
  shell: |
    cd {{ single_service_dir }}
    echo "=== Logs for {{ target_service }} service ==="
    docker compose logs --tail={{ log_lines }}
  register: specific_service_logs
  changed_when: false
  when: target_service != 'all'

- name: Get logs with filtering options
  shell: |
    {% if target_service == 'all' %}
    for container in $(docker ps --format "{{ '{{' }}.Names{{ '}}' }}"); do
      echo "=== Filtered logs for $container ==="
      docker logs --tail={{ log_lines }} $container 2>&1 | {% if log_filter is defined %}grep -i "{{ log_filter }}"{% else %}cat{% endif %}
      echo ""
    done
    {% else %}
    cd {{ single_service_dir }}
    echo "=== Filtered logs for {{ target_service }} ==="
    docker compose logs --tail={{ log_lines }} | {% if log_filter is defined %}grep -i "{{ log_filter }}"{% else %}cat{% endif %}
    {% endif %}
  register: filtered_logs
  changed_when: false
  when: log_filter is defined

- name: Get error logs only
  shell: |
    {% if target_service == 'all' %}
    for container in $(docker ps --format "{{ '{{' }}.Names{{ '}}' }}"); do
      echo "=== Error logs for $container ==="
      docker logs --tail={{ log_lines }} $container 2>&1 | grep -i -E "(error|fail|exception|panic|fatal)"
      echo ""
    done
    {% else %}
    cd {{ single_service_dir }}
    echo "=== Error logs for {{ target_service }} ==="
    docker compose logs --tail={{ log_lines }} | grep -i -E "(error|fail|exception|panic|fatal)"
    {% endif %}
  register: error_logs
  changed_when: false
  failed_when: false
  when: log_level is defined and log_level == 'error'

- name: Get recent logs with timestamps
  shell: |
    {% if target_service == 'all' %}
    for container in $(docker ps --format "{{ '{{' }}.Names{{ '}}' }}"); do
      echo "=== Recent logs for $container (with timestamps) ==="
      docker logs --tail={{ log_lines }} --timestamps $container 2>&1
      echo ""
    done
    {% else %}
    cd {{ single_service_dir }}
    echo "=== Recent logs for {{ target_service }} (with timestamps) ==="
    docker compose logs --tail={{ log_lines }} --timestamps
    {% endif %}
  register: timestamped_logs
  changed_when: false
  when: log_timestamps | default(false)

- name: Export logs to file
  shell: |
    LOG_DIR="/tmp/yamisskey-logs"
    mkdir -p $LOG_DIR
    LOG_FILE="$LOG_DIR/{{ target_service }}-{{ ansible_date_time.epoch }}.log"
    
    {% if target_service == 'all' %}
    for container in $(docker ps --format "{{ '{{' }}.Names{{ '}}' }}"); do
      echo "=== Logs for $container ===" >> $LOG_FILE
      docker logs --tail={{ log_lines }} --timestamps $container >> $LOG_FILE 2>&1
      echo "" >> $LOG_FILE
    done
    {% else %}
    cd {{ single_service_dir }}
    echo "=== Logs for {{ target_service }} ===" >> $LOG_FILE
    docker compose logs --tail={{ log_lines }} --timestamps >> $LOG_FILE
    {% endif %}
    
    echo "Logs exported to: $LOG_FILE"
    ls -lh $LOG_FILE
  register: log_export
  when: export_logs | default(false)

- name: Display logs based on operation type
  debug:
    msg: |
      ğŸ“„ Log Results for {{ target_service }} ({{ log_lines }} lines):
      
      {% if log_filter is defined %}
      ğŸ” Filtered logs (filter: {{ log_filter }}):
      {{ filtered_logs.stdout_lines | join('\n') }}
      {% elif log_level == 'error' %}
      âŒ Error logs only:
      {{ error_logs.stdout_lines | join('\n') if error_logs.stdout_lines else 'No errors found in recent logs' }}
      {% elif log_timestamps %}
      â° Timestamped logs:
      {{ timestamped_logs.stdout_lines | join('\n') }}
      {% elif target_service == 'all' %}
      ğŸ“Š All container logs:
      {{ all_service_logs.stdout_lines | join('\n') }}
      {% else %}
      ğŸ“‹ Service logs:
      {{ specific_service_logs.stdout_lines | join('\n') }}
      {% endif %}
      
      {% if export_logs %}
      ğŸ’¾ Log export results:
      {{ log_export.stdout_lines | join('\n') }}
      {% endif %}

- name: Generate log analysis summary
  set_fact:
    log_analysis:
      service: "{{ target_service }}"
      lines_requested: "{{ log_lines }}"
      filter_applied: "{{ log_filter | default('none') }}"
      level_filter: "{{ log_level | default('all') }}"
      timestamps_enabled: "{{ log_timestamps | default(false) }}"
      export_enabled: "{{ export_logs | default(false) }}"
      analysis_time: "{{ ansible_date_time.iso8601 }}"

- name: Display log management summary
  debug:
    msg: |
      ğŸ“Š Log Management Summary:
      - Service: {{ log_analysis.service }}
      - Lines retrieved: {{ log_analysis.lines_requested }}
      - Filter applied: {{ log_analysis.filter_applied }}
      - Level filter: {{ log_analysis.level_filter }}
      - Timestamps: {{ log_analysis.timestamps_enabled }}
      - Export to file: {{ log_analysis.export_enabled }}
      - Analysis completed: {{ log_analysis.analysis_time }}
      
      ğŸ’¡ Tips:
      - Use -e log_filter="keyword" to filter logs
      - Use -e log_level="error" to show only errors
      - Use -e log_timestamps=true to include timestamps
      - Use -e export_logs=true to save logs to file
      - Use -e log_lines=N to change number of lines (default: {{ log_lines }})