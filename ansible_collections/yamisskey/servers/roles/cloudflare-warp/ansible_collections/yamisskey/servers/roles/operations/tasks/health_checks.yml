---
- name: Check Docker service health
  systemd:
    name: docker
  register: docker_health
  become: true

- name: Check MinIO health endpoint
  uri:
    url: "http://localhost:{{ host_services[inventory_hostname].minio_api | default(9000) }}/minio/health/live"
    method: GET
    timeout: 5
  register: minio_health
  failed_when: false
  when:
    - (target_service in ['minio', 'all'])
    - inventory_hostname in host_services
    - minio_api in host_services[inventory_hostname]

- name: Check Misskey health endpoint
  uri:
    url: "http://localhost:{{ host_services[inventory_hostname].misskey | default(3000) }}/api/ping"
    method: POST
    headers:
      Content-Type: "application/json"
    body: "{}"
    body_format: json
    timeout: 5
  register: misskey_health
  failed_when: false
  when:
    - (target_service in ['misskey', 'all'])
    - inventory_hostname in host_services
    - misskey in host_services[inventory_hostname]

- name: Check Prometheus health endpoint
  uri:
    url: "http://localhost:{{ host_services[inventory_hostname].prometheus | default(9090) }}/-/healthy"
    method: GET
    timeout: 5
  register: prometheus_health
  failed_when: false
  when:
    - (target_service in ['monitoring', 'all'])
    - inventory_hostname in host_services
    - prometheus in host_services[inventory_hostname]

- name: Check Grafana health endpoint
  uri:
    url: "http://localhost:{{ host_services[inventory_hostname].grafana | default(3000) }}/api/health"
    method: GET
    timeout: 5
  register: grafana_health
  failed_when: false
  when:
    - (target_service in ['monitoring', 'all'])
    - inventory_hostname in host_services
    - grafana in host_services[inventory_hostname]

- name: Check custom service health endpoints
  uri:
    url: "http://localhost:{{ item.port }}{{ item.path | default('/health') }}"
    method: "{{ item.method | default('GET') }}"
    timeout: "{{ item.timeout | default(5) }}"
  register: custom_health_results
  failed_when: false
  loop: "{{ custom_health_endpoints | default([]) }}"
  when:
    - (target_service == 'all' or target_service == item.service)
    - inventory_hostname in host_services

- name: Display comprehensive health check results
  debug:
    msg: |
      ğŸ¥ Health Check Results for {{ inventory_hostname }}:
      ğŸ³ Docker Service: {{ 'Running' if docker_health.status.ActiveState == 'active' else 'Not Running' }}
      {% if minio_health is defined %}
      ğŸ’¾ MinIO: {{ 'OK' if minio_health.status == 200 else 'Failed (' + (minio_health.status | string) + ')' }}
      {% endif %}
      {% if misskey_health is defined %}
      ğŸ¦ Misskey: {{ 'OK' if misskey_health.status == 200 else 'Failed (' + (misskey_health.status | string) + ')' }}
      {% endif %}
      {% if prometheus_health is defined %}
      ğŸ“Š Prometheus: {{ 'OK' if prometheus_health.status == 200 else 'Failed (' + (prometheus_health.status | string) + ')' }}
      {% endif %}
      {% if grafana_health is defined %}
      ğŸ“ˆ Grafana: {{ 'OK' if grafana_health.status == 200 else 'Failed (' + (grafana_health.status | string) + ')' }}
      {% endif %}
      {% if custom_health_results is defined and custom_health_results.results %}
      {% for result in custom_health_results.results %}
      ğŸ”§ {{ result.item.service | title }}: {{ 'OK' if result.status == 200 else 'Failed (' + (result.status | string) + ')' }}
      {% endfor %}
      {% endif %}

      â„¹ï¸ Only services configured for this host ({{ inventory_hostname }}) are checked.
      
      {% set total_checks = [docker_health] + ([minio_health] if minio_health is defined else []) + ([misskey_health] if misskey_health is defined else []) + ([prometheus_health] if prometheus_health is defined else []) + ([grafana_health] if grafana_health is defined else []) + (custom_health_results.results if custom_health_results is defined else []) %}
      {% set healthy_checks = total_checks | selectattr('status', 'defined') | selectattr('status', 'equalto', 200) | list %}
      {% set docker_healthy = 1 if docker_health.status.ActiveState == 'active' else 0 %}
      ğŸ“Š Overall Health: {{ (healthy_checks | length + docker_healthy) }}/{{ total_checks | length }} services healthy

- name: Set health check summary facts
  set_fact:
    health_check_summary:
      docker_healthy: "{{ docker_health.status.ActiveState == 'active' }}"
      services_checked: >-
        {{
          ([] + 
           (['minio'] if minio_health is defined else []) +
           (['misskey'] if misskey_health is defined else []) +
           (['prometheus'] if prometheus_health is defined else []) +
           (['grafana'] if grafana_health is defined else []) +
           (custom_health_results.results | map(attribute='item.service') | list if custom_health_results is defined else [])
          ) | unique
        }}
      healthy_services: >-
        {{
          ([] +
           (['minio'] if minio_health is defined and minio_health.status == 200 else []) +
           (['misskey'] if misskey_health is defined and misskey_health.status == 200 else []) +
           (['prometheus'] if prometheus_health is defined and prometheus_health.status == 200 else []) +
           (['grafana'] if grafana_health is defined and grafana_health.status == 200 else []) +
           (custom_health_results.results | selectattr('status', 'equalto', 200) | map(attribute='item.service') | list if custom_health_results is defined else [])
          ) | unique
        }}
      timestamp: "{{ ansible_date_time.iso8601 }}"