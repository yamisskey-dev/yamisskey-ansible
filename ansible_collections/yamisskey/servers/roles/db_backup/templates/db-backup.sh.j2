#!/bin/bash
# Database Backup Script - pg_dump + rsync to TrueNAS
# Generated by Ansible - do not edit manually

set -uo pipefail

# Configuration
BACKUP_DIR="{{ db_backup_dir }}"
LOG_DIR="{{ db_backup_log_dir }}"
TRUENAS_HOST="{{ db_backup_truenas_host }}"
TRUENAS_USER="{{ db_backup_truenas_user }}"
TRUENAS_DEST="{{ db_backup_truenas_dest }}"
SSH_KEY="{{ db_backup_ssh_key }}"
LOCAL_RETENTION_DAYS="{{ db_backup_local_retention_days }}"
{% if db_backup_discord_webhook_url %}
DISCORD_WEBHOOK_URL="{{ db_backup_discord_webhook_url }}"
{% endif %}

# Initialize
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
DATE_PREFIX=$(date +%Y%m%d)
OVERALL_SUCCESS=true
FAILED_DBS=""
SUCCESS_DBS=""
TOTAL_SIZE="0"

{% if db_backup_discord_webhook_url %}
# Discord notification function
send_discord_notification() {
    local status="$1"
    local color="$2"
    local message="$3"
    local details="$4"

    local payload=$(cat <<EOJSON
{
  "embeds": [{
    "title": "Database Backup ${status}",
    "description": "${message}",
    "color": ${color},
    "fields": [
      {"name": "Databases", "value": "${details}", "inline": false},
      {"name": "Total Size", "value": "${TOTAL_SIZE}", "inline": true},
      {"name": "Destination", "value": "${TRUENAS_HOST}:${TRUENAS_DEST}", "inline": true}
    ],
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }]
}
EOJSON
)

    curl -s -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" >/dev/null 2>&1 || true
}
{% endif %}

# Logging
LOG_FILE="${LOG_DIR}/db-backup-${TIMESTAMP}.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "========================================"
echo "Database Backup Started: $(date)"
echo "========================================"
echo ""

# Create backup directory with date
DUMP_DIR="${BACKUP_DIR}/dumps/${DATE_PREFIX}"
mkdir -p "$DUMP_DIR"

# Check SSH connectivity to TrueNAS
echo "Checking SSH connectivity to TrueNAS..."
if ! ssh -i "$SSH_KEY" -o BatchMode=yes -o IdentitiesOnly=yes -o ConnectTimeout=10 \
    "${TRUENAS_USER}@${TRUENAS_HOST}" "echo 'SSH OK'" >/dev/null 2>&1; then
    echo "ERROR: Cannot connect to TrueNAS via SSH"
{% if db_backup_discord_webhook_url %}
    send_discord_notification "Failed" "15158332" "Cannot connect to TrueNAS via SSH" "Backup aborted"
{% endif %}
    exit 1
fi
echo "SSH connection OK"
echo ""

# Backup each database
{% for db in db_backup_databases %}
echo "----------------------------------------"
echo "Backing up: {{ db.name }}"
echo "  Container: {{ db.container }}"
echo "  Database: {{ db.database }}"
echo "----------------------------------------"

DUMP_FILE="${DUMP_DIR}/{{ db.name }}-${TIMESTAMP}.dump"

if docker exec {{ db.container }} pg_dump \
    -U {{ db.user | default(db_backup_default_user) }} \
    {{ db_backup_pg_dump_opts }} \
    {{ db.database }} > "$DUMP_FILE" 2>&1; then

    DUMP_SIZE=$(du -h "$DUMP_FILE" | cut -f1)
    echo "SUCCESS: {{ db.name }} - Size: $DUMP_SIZE"
    SUCCESS_DBS="${SUCCESS_DBS}{{ db.name }} (${DUMP_SIZE}), "
else
    echo "FAILED: {{ db.name }}"
    rm -f "$DUMP_FILE"
    FAILED_DBS="${FAILED_DBS}{{ db.name }}, "
    OVERALL_SUCCESS=false
fi
echo ""

{% endfor %}

# Calculate total size
TOTAL_SIZE=$(du -sh "$DUMP_DIR" 2>/dev/null | cut -f1)
echo "Total dump size: $TOTAL_SIZE"
echo ""

# Sync to TrueNAS
echo "----------------------------------------"
echo "Syncing to TrueNAS..."
echo "----------------------------------------"

if rsync {{ db_backup_rsync_opts }} \
    -e "ssh -i $SSH_KEY -o BatchMode=yes -o IdentitiesOnly=yes" \
    "${BACKUP_DIR}/dumps/" \
    "${TRUENAS_USER}@${TRUENAS_HOST}:${TRUENAS_DEST}/"; then
    echo "Sync to TrueNAS: SUCCESS"
else
    echo "Sync to TrueNAS: FAILED"
    OVERALL_SUCCESS=false
fi
echo ""

# Cleanup old local dumps
echo "Cleaning up local dumps older than ${LOCAL_RETENTION_DAYS} days..."
find "${BACKUP_DIR}/dumps" -type d -mtime +${LOCAL_RETENTION_DAYS} -exec rm -rf {} \; 2>/dev/null || true
find "${BACKUP_DIR}/dumps" -type f -name "*.dump" -mtime +${LOCAL_RETENTION_DAYS} -delete 2>/dev/null || true

# Cleanup old logs
find "$LOG_DIR" -name "db-backup-*.log" -mtime +30 -delete 2>/dev/null || true

echo ""
echo "========================================"
if $OVERALL_SUCCESS; then
    echo "Backup completed successfully: $(date)"
    echo "========================================"
{% if db_backup_discord_webhook_url %}
    # Remove trailing comma and space
    SUCCESS_DBS="${SUCCESS_DBS%, }"
    send_discord_notification "Success" "3066993" "All database backups completed successfully" "$SUCCESS_DBS"
{% endif %}
    exit 0
else
    echo "Backup completed with ERRORS: $(date)"
    echo "========================================"
{% if db_backup_discord_webhook_url %}
    FAILED_DBS="${FAILED_DBS%, }"
    SUCCESS_DBS="${SUCCESS_DBS%, }"
    send_discord_notification "Partial Failure" "15105570" "Some databases failed to backup" "Failed: ${FAILED_DBS:-none}\\nSuccess: ${SUCCESS_DBS:-none}"
{% endif %}
    exit 1
fi
