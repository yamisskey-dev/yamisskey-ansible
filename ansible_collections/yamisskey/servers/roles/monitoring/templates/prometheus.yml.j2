# ==================================================
# Yamisskey Provision - Dynamic Prometheus Configuration
# ==================================================
# This configuration is auto-generated from Ansible inventory
# Environment: {{ environment | default('production') }}
# Generated: {{ ansible_date_time.iso8601 }}

global:
  scrape_interval: {{ monitoring_scrape_interval | default('15s') }}
  evaluation_interval: {{ monitoring_evaluation_interval | default('15s') }}
  external_labels:
    environment: '{{ environment | default("production") }}'
    cluster: 'yamisskey'
    region: '{{ monitoring_region | default("ap-northeast-1") }}'

# ==================================================
# Alert Manager Configuration
# ==================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets:
{% if alertmanager_enabled | default(true) %}
          - '{{ monitoring_alertmanager_host | default("localhost") }}:{{ monitoring_alertmanager_port | default("9093") }}'
{% endif %}

# ==================================================
# Rule Files Configuration
# ==================================================
rule_files:
{% if monitoring_rules_enabled | default(true) %}
  - "/etc/prometheus/rules/*.yml"
{% endif %}

# ==================================================
# Scrape Configurations - Auto-Generated from Inventory
# ==================================================
scrape_configs:
  # --- Core Monitoring Services ---
  - job_name: 'prometheus'
    scrape_interval: 5s
    scrape_timeout: 5s
    static_configs:
      - targets: ['localhost:9090']
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'prometheus_(.+)'
        target_label: service
        replacement: 'prometheus'

{% if groups['monitoring_servers'] is defined %}
  # --- Monitoring Servers (Node Exporters) ---
  - job_name: 'monitoring-node'
    scrape_interval: {{ monitoring_node_scrape_interval | default('30s') }}
    static_configs:
{% for host in groups['monitoring_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:9100']
        labels:
          instance: '{{ host }}'
          role: 'monitoring'
          environment: '{{ environment | default("production") }}'
          security_level: '{{ hostvars[host]['security_level'] | default("high") }}'
{% endfor %}
{% endif %}

{% if groups['social_servers'] is defined %}
  # --- Social Servers (Apps & Services) ---
  - job_name: 'social-node'
    scrape_interval: {{ monitoring_social_scrape_interval | default('30s') }}
    static_configs:
{% for host in groups['social_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:9100']
        labels:
          instance: '{{ host }}'
          role: 'social'
          environment: '{{ environment | default("production") }}'
          service_priority: '{{ hostvars[host]['service_priority'] | default("high") }}'
{% endfor %}
{% endif %}

{% if groups['proxy_servers'] is defined %}
  # --- Proxy Servers ---
  - job_name: 'proxy-node'
    scrape_interval: {{ monitoring_proxy_scrape_interval | default('60s') }}
    static_configs:
{% for host in groups['proxy_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:9100']
        labels:
          instance: '{{ host }}'
          role: 'proxy'
          environment: '{{ environment | default("production") }}'
          egress_route: '{{ hostvars[host]['egress_route'] | default("unknown") }}'
{% endfor %}
{% endif %}

{% if groups['storage_servers'] is defined %}
  # --- Storage Servers (Including TrueNAS) ---
  - job_name: 'storage-node'
    scrape_interval: {{ monitoring_storage_scrape_interval | default('60s') }}
    static_configs:
{% for host in groups['storage_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:9100']
        labels:
          instance: '{{ host }}'
          role: 'storage'
          environment: '{{ environment | default("production") }}'
          platform: '{{ hostvars[host]['minio_platform'] | default("generic") }}'
{% endfor %}
{% endif %}

  # --- Container Monitoring (cAdvisor) ---
  - job_name: 'cadvisor'
    scrape_interval: {{ monitoring_cadvisor_scrape_interval | default('30s') }}
    static_configs:
{% if groups['social_servers'] is defined %}
{% for host in groups['social_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:8085']
        labels:
          instance: '{{ host }}'
          role: 'cadvisor'
          host_type: 'social'
{% endfor %}
{% endif %}
{% if groups['monitoring_servers'] is defined %}
{% for host in groups['monitoring_servers'] %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:8085']
        labels:
          instance: '{{ host }}'
          role: 'cadvisor'
          host_type: 'monitoring'
{% endfor %}
{% endif %}

  # --- Blackbox HTTP/HTTPS Monitoring ---
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          # Core Monitoring Services
          - http://localhost:3000  # Grafana
          - http://localhost:9090  # Prometheus
          - http://localhost:9100  # Node Exporter
{% if monitoring_external_endpoints is defined %}
          # External Service Health Checks
{% for endpoint in monitoring_external_endpoints %}
          - {{ endpoint }}
{% endfor %}
{% endif %}
          # Yamisskey Services (via Cloudflared)
          - https://{{ primary_domain }}
          - https://drive.{{ primary_domain }}
          - https://grafana.{{ primary_domain }}
          - https://uptime.{{ primary_domain }}
          - https://search.{{ primary_domain }}
          - https://wiki.{{ primary_domain }}
          - https://pad.{{ primary_domain }}
          - https://task.{{ primary_domain }}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: localhost:9115

  # --- Cloudflared Tunnel Monitoring ---
  - job_name: 'cloudflared'
    scrape_interval: {{ monitoring_cloudflared_scrape_interval | default('60s') }}
    static_configs:
{% if groups['social_servers'] is defined %}
{% for host in groups['social_servers'] if hostvars[host]['cloudflare_tunnel_id'] is defined %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:49312']
        labels:
          instance: '{{ host }}'
          tunnel_type: 'social'
          tunnel_id: '{{ hostvars[host]['cloudflare_tunnel_id'] }}'
{% endfor %}
{% endif %}
{% if groups['monitoring_servers'] is defined %}
{% for host in groups['monitoring_servers'] if hostvars[host]['cloudflare_tunnel_id'] is defined %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:49312']
        labels:
          instance: '{{ host }}'
          tunnel_type: 'monitoring'
          tunnel_id: '{{ hostvars[host]['cloudflare_tunnel_id'] }}'
{% endfor %}
{% endif %}

{% if groups['truenas'] is defined %}
  # --- TrueNAS MinIO Monitoring ---
  - job_name: 'minio'
    scrape_interval: {{ monitoring_minio_scrape_interval | default('30s') }}
    metrics_path: /minio/v2/metrics/cluster
    static_configs:
{% for host in groups['truenas'] %}
      - targets: ['{{ hostvars[host]['truenas_internal_ip'] }}:{{ minio_api_port | default('9000') }}']
        labels:
          instance: '{{ host }}'
          service: 'minio'
          platform: 'truenas'
          region: '{{ minio_region | default("ap-northeast-3") }}'
{% endfor %}
{% endif %}

{% if modsecurity_monitoring_enabled | default(false) %}
  # --- ModSecurity WAF Monitoring ---
  - job_name: 'modsecurity'
    scrape_interval: {{ monitoring_modsecurity_scrape_interval | default('60s') }}
    static_configs:
{% if groups['social_servers'] is defined %}
{% for host in groups['social_servers'] if hostvars[host]['modsecurity_enabled'] | default(false) %}
      - targets: ['{{ hostvars[host]['internal_ip'] | default(hostvars[host]['ansible_host']) }}:9113']
        labels:
          instance: '{{ host }}'
          service: 'modsecurity'
          security_level: '{{ hostvars[host]['security_level'] | default("high") }}'
{% endfor %}
{% endif %}
{% endif %}

{% if custom_monitoring_jobs is defined %}
  # --- Custom Monitoring Jobs ---
{% for job in custom_monitoring_jobs %}
  - job_name: '{{ job.name }}'
    scrape_interval: {{ job.scrape_interval | default('60s') }}
{% if job.metrics_path is defined %}
    metrics_path: {{ job.metrics_path }}
{% endif %}
{% if job.params is defined %}
    params:
{% for key, value in job.params.items() %}
      {{ key }}: {{ value | to_yaml }}
{% endfor %}
{% endif %}
    static_configs:
      - targets: {{ job.targets | to_yaml }}
{% if job.labels is defined %}
        labels:
{% for key, value in job.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

# ==================================================
# Advanced Relabeling and Filtering
# ==================================================
# Global metric relabeling for performance optimization
metric_relabel_configs:
  # Drop high-cardinality metrics to reduce storage
  - source_labels: [__name__]
    regex: 'go_.*'
    action: drop
  
  # Add environment labels to all metrics
  - target_label: deployment
    replacement: 'yamisskey'
  
  # Standardize instance labels
  - source_labels: [instance]
    regex: '(.+)'
    target_label: host
    replacement: '${1}'