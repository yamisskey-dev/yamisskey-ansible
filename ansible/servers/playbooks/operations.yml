---
- name: Operations and maintenance tasks
  hosts: all
  become: false
  gather_facts: false
  vars:
    operation: "{{ op | default('status') }}"
    target_service: "{{ service | default('all') }}"
    log_lines: "{{ lines | default('50') }}"
    # Service directories based on existing deployment structure
    known_services:
      - misskey
      - minio
      - modsecurity-nginx
      - cloudflared
      - monitoring
      - ai
      - cryptpad
      - lemmy
      - matrix
      - neo-quesdon
      - outline
      - vikunja
      - ctfd
      - zitadel
      - mcaptcha
      - uptime
      - deeplx
      - impostor
      - minecraft
      - stalwart
      - searxng
    
  tasks:
    - name: Validate operation parameter
      fail:
        msg: "Operation '{{ operation }}' is not supported. Supported operations: status, health, logs, restart, stop, start, update, cleanup"
      when: operation not in ['status', 'health', 'logs', 'restart', 'stop', 'start', 'update', 'cleanup']

    - name: Validate service parameter
      fail:
        msg: "Service '{{ target_service }}' is not supported. Supported services: {{ known_services | join(', ') }}, all"
      when:
        - target_service != 'all'
        - target_service not in known_services

    - name: Find service directories
      find:
        paths: /opt
        file_type: directory
        patterns: "{{ known_services }}"
      register: service_dirs
      when: target_service == 'all'
      
    - name: Check if specific service directory exists
      stat:
        path: "/opt/{{ target_service }}"
      register: service_dir_check
      when: target_service != 'all'
      
    - name: Fail if specific service directory doesn't exist
      fail:
        msg: "Service directory /opt/{{ target_service }} does not exist"
      when:
        - target_service != 'all'
        - not service_dir_check.stat.exists

    - name: Set single service directory
      set_fact:
        single_service_dir: "/opt/{{ target_service }}"
      when: target_service != 'all'

    # Status Operation
    - name: Get Docker container status
      shell: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      register: docker_status
      changed_when: false
      when: operation == 'status'

    - name: Get specific service status
      shell: |
        cd {{ single_service_dir }}
        echo "=== Status for {{ target_service }} ==="
        docker compose ps
      register: service_status
      changed_when: false
      failed_when: false
      when: operation == 'status' and target_service != 'all'

    - name: Display status results
      debug:
        msg: |
          {% if target_service == 'all' %}
          üê≥ All Docker Containers:
          {{ docker_status.stdout_lines | join('\n') }}
          {% else %}
          {{ service_status.stdout_lines | join('\n') }}
          {% endif %}
      when: operation == 'status'

    # Health Check Operation  
    - name: Check Docker service health
      systemd:
        name: docker
      register: docker_health
      become: true
      when: operation == 'health'

    - name: Check MinIO health endpoint
      uri:
        url: "http://localhost:{{ host_services[inventory_hostname].minio_api | default(9000) }}/minio/health/live"
        method: GET
        timeout: 5
      register: minio_health
      failed_when: false
      when:
        - operation == 'health'
        - (target_service in ['minio', 'all'])
        - inventory_hostname in host_services
        - 'minio_api' in host_services[inventory_hostname]

    - name: Check Misskey health endpoint
      uri:
        url: "http://localhost:{{ host_services[inventory_hostname].misskey | default(3000) }}/api/ping"
        method: POST
        headers:
          Content-Type: "application/json"
        body: "{}"
        body_format: json
        timeout: 5
      register: misskey_health
      failed_when: false
      when:
        - operation == 'health'
        - (target_service in ['misskey', 'all'])
        - inventory_hostname in host_services
        - 'misskey' in host_services[inventory_hostname]
        
    - name: Check Prometheus health endpoint
      uri:
        url: "http://localhost:{{ host_services[inventory_hostname].prometheus | default(9090) }}/-/healthy"
        method: GET
        timeout: 5
      register: prometheus_health
      failed_when: false
      when:
        - operation == 'health'
        - (target_service in ['monitoring', 'all'])
        - inventory_hostname in host_services
        - 'prometheus' in host_services[inventory_hostname]
        
    - name: Check Grafana health endpoint
      uri:
        url: "http://localhost:{{ host_services[inventory_hostname].grafana | default(3000) }}/api/health"
        method: GET
        timeout: 5
      register: grafana_health
      failed_when: false
      when:
        - operation == 'health'
        - (target_service in ['monitoring', 'all'])
        - inventory_hostname in host_services
        - 'grafana' in host_services[inventory_hostname]

    - name: Display health check results
      debug:
        msg: |
          üè• Health Check Results for {{ inventory_hostname }}:
          üê≥ Docker Service: {{ 'Running' if docker_health.status.ActiveState == 'active' else 'Not Running' }}
          {% if minio_health is defined %}
          üíæ MinIO: {{ 'OK' if minio_health.status == 200 else 'Failed' }}
          {% endif %}
          {% if misskey_health is defined %}
          üê¶ Misskey: {{ 'OK' if misskey_health.status == 200 else 'Failed' }}
          {% endif %}
          {% if prometheus_health is defined %}
          üìä Prometheus: {{ 'OK' if prometheus_health.status == 200 else 'Failed' }}
          {% endif %}
          {% if grafana_health is defined %}
          üìà Grafana: {{ 'OK' if grafana_health.status == 200 else 'Failed' }}
          {% endif %}
          
          ‚ÑπÔ∏è Only services configured for this host ({{ inventory_hostname }}) are checked.
      when: operation == 'health'

    # Logs Operation
    - name: Get service logs
      shell: |
        {% if target_service == 'all' %}
        for container in $(docker ps --format "{{.Names}}"); do
          echo "=== Logs for $container ==="
          docker logs --tail={{ log_lines }} $container 2>&1
          echo ""
        done
        {% else %}
        cd {{ single_service_dir }}
        docker compose logs --tail={{ log_lines }}
        {% endif %}
      register: service_logs
      changed_when: false
      when: operation == 'logs'

    - name: Display logs
      debug:
        msg: "{{ service_logs.stdout_lines }}"
      when: operation == 'logs'

    # Restart Operation
    - name: Check if docker-compose.yml exists for specific service
      stat:
        path: "{{ single_service_dir }}/docker-compose.yml"
      register: compose_file_check
      when: operation in ['restart', 'stop', 'start', 'update'] and target_service != 'all'
      
    - name: Restart specific service
      shell: |
        cd {{ single_service_dir }}
        echo "Restarting {{ target_service }}..."
        docker compose restart
      register: restart_result
      when:
        - operation == 'restart'
        - target_service != 'all'
        - compose_file_check.stat.exists
        
    - name: Warn if docker-compose.yml not found
      debug:
        msg: "‚ö†Ô∏è docker-compose.yml not found in {{ single_service_dir }}. Skipping {{ operation }} for {{ target_service }}."
      when:
        - operation in ['restart', 'stop', 'start', 'update']
        - target_service != 'all'
        - not compose_file_check.stat.exists

    - name: Check for docker-compose.yml in each service directory
      stat:
        path: "{{ item.path }}/docker-compose.yml"
      register: compose_files_check
      loop: "{{ service_dirs.files }}"
      when: operation in ['restart', 'stop', 'start', 'update'] and target_service == 'all'
    
    - name: Restart all services
      shell: |
        cd {{ item.item.path }}
        echo "Restarting service in {{ item.item.path }}"
        docker compose restart
      register: restart_all_result
      failed_when: false
      loop: "{{ compose_files_check.results }}"
      when:
        - operation == 'restart'
        - target_service == 'all'
        - item.stat.exists

    # Stop/Start Operations
    - name: Stop/Start specific service
      shell: |
        cd {{ single_service_dir }}
        echo "{{ operation | title }}ping {{ target_service }}..."
        docker compose {{ operation }}
      register: stop_start_result
      when: operation in ['stop', 'start'] and target_service != 'all'

    - name: Stop/Start all services
      shell: |
        cd {{ item.path }}
        echo "{{ operation | title }}ping service in {{ item.path }}"
        docker compose {{ operation }}
      register: stop_start_all_result
      failed_when: false
      loop: "{{ service_dirs.files }}"
      when: operation in ['stop', 'start'] and target_service == 'all'

    # Update Operation
    - name: Update specific service
      shell: |
        cd {{ single_service_dir }}
        echo "Updating {{ target_service }}..."
        docker compose pull
        docker compose up -d
      register: update_result
      when: operation == 'update' and target_service != 'all'

    - name: Update all services
      shell: |
        cd {{ item.path }}
        echo "Updating service in {{ item.path }}"
        docker compose pull
        docker compose up -d
      register: update_all_result
      failed_when: false
      loop: "{{ service_dirs.files }}"
      when: operation == 'update' and target_service == 'all'

    # Cleanup Operation
    - name: Docker system cleanup
      shell: |
        echo "üßπ Cleaning up Docker system..."
        docker system prune -f
        docker volume prune -f
        docker image prune -f
      register: cleanup_result
      when: operation == 'cleanup'

    - name: Display operation results
      debug:
        msg: |
          {% if operation == 'restart' %}
          üîÑ Restart Results:
          {% if target_service != 'all' %}
          {{ restart_result.stdout_lines | join('\n') }}
          {% else %}
          {% for result in restart_all_result.results %}
          {{ result.stdout_lines | join('\n') }}
          {% endfor %}
          {% endif %}
          {% elif operation in ['stop', 'start'] %}
          {{ operation | title }} Results:
          {% if target_service != 'all' %}
          {{ stop_start_result.stdout_lines | join('\n') }}
          {% else %}
          {% for result in stop_start_all_result.results %}
          {{ result.stdout_lines | join('\n') }}
          {% endfor %}
          {% endif %}
          {% elif operation == 'update' %}
          üì¶ Update Results:
          {% if target_service != 'all' %}
          {{ update_result.stdout_lines | join('\n') }}
          {% else %}
          {% for result in update_all_result.results %}
          {{ result.stdout_lines | join('\n') }}
          {% endfor %}
          {% endif %}
          {% elif operation == 'cleanup' %}
          üßπ Cleanup Results:
          {{ cleanup_result.stdout_lines | join('\n') }}
          {% endif %}
      when: operation in ['restart', 'stop', 'start', 'update', 'cleanup']

    - name: Final status check
      shell: docker ps --format "table {{.Names}}\t{{.Status}}"
      register: final_status
      changed_when: false
      when: operation in ['restart', 'start', 'update']

    - name: Display final status
      debug:
        msg: |
          üìä Final Service Status:
          {{ final_status.stdout_lines | join('\n') }}
      when: operation in ['restart', 'start', 'update']