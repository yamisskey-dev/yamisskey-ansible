---
# Cloudflared Service Setup

- name: Check if cloudflared service exists
  systemd:
    name: cloudflared
  register: cloudflared_service_status
  failed_when: false

- name: Install cloudflared service
  command: cloudflared service install
  become: yes
  when: cloudflared_service_status.status is not defined
  register: service_install_result

- name: Display service installation result
  debug:
    msg: |
      Service Installation:
      {{ service_install_result.stdout if service_install_result is defined else 'Service already exists' }}

- name: Enable cloudflared service
  systemd:
    name: cloudflared
    enabled: "{{ cloudflared_service_enable }}"
    daemon_reload: yes
  become: yes
  when: cloudflared_service_enable

- name: Start cloudflared service
  systemd:
    name: cloudflared
    state: "{{ 'started' if cloudflared_service_start else 'stopped' }}"
  become: yes
  register: service_start_result

- name: Wait for service to be active
  systemd:
    name: cloudflared
  register: service_status
  retries: 10
  delay: 3
  until: service_status.status.ActiveState == "active"
  become: yes
  when: cloudflared_service_start

- name: Get service status
  systemd:
    name: cloudflared
  register: final_service_status
  become: yes

- name: Display service status
  debug:
    msg: |
      Cloudflared Service Status:
      State: {{ final_service_status.status.ActiveState }}
      Sub-state: {{ final_service_status.status.SubState }}
      Enabled: {{ final_service_status.status.UnitFileState }}
      
      {% if final_service_status.status.ActiveState == "active" %}
      ✅ Service is running
      {% else %}
      ❌ Service is not active
      {% endif %}