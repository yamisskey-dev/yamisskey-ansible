---
# Cloudflared installation task
# This is only used when cloudflared_skip_install is false
# For manual installation, set cloudflared_skip_install: true and use 'make install'

- name: Check if cloudflared is already installed
  command: which cloudflared
  register: cloudflared_installed
  failed_when: false
  changed_when: false

- name: Get latest cloudflared release info from GitHub API
  uri:
    url: https://api.github.com/repos/cloudflare/cloudflared/releases/latest
    method: GET
    return_content: true
  register: cloudflared_release
  when:
    - cloudflared_installed.rc != 0
    - cloudflared_version == "latest"

- name: Set cloudflared download URL for latest version
  set_fact:
    cloudflared_download_url: "{{ cloudflared_release.json.assets | selectattr('name', 'match', '.*linux-amd64$') | map(attribute='browser_download_url') | first }}"
  when:
    - cloudflared_installed.rc != 0
    - cloudflared_version == "latest"

- name: Set cloudflared download URL for specific version
  set_fact:
    cloudflared_download_url: "https://github.com/cloudflare/cloudflared/releases/download/{{ cloudflared_version }}/cloudflared-linux-amd64"
  when:
    - cloudflared_installed.rc != 0
    - cloudflared_version != "latest"

- name: Download cloudflared binary
  get_url:
    url: "{{ cloudflared_download_url }}"
    dest: "{{ cloudflared_install_dir }}/cloudflared"
    mode: '0755'
    owner: root
    group: root
  become: true
  when: cloudflared_installed.rc != 0

- name: Verify cloudflared installation
  command: cloudflared --version
  register: cloudflared_version_check
  changed_when: false
  when: cloudflared_installed.rc != 0

- name: Display installation result
  debug:
    msg: |
      Cloudflared installation completed:
      Version: {{ cloudflared_version_check.stdout if cloudflared_version_check is defined else 'Already installed' }}
      Location: {{ cloudflared_install_dir }}/cloudflared
