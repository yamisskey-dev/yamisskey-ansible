---
- name: Ensure Cloudflare WARP service enabled and started
  become: yes
  ansible.builtin.systemd:
    name: "{{ warp_service_name }}"
    enabled: true
    state: started

- name: Check if warp-cli exists
  ansible.builtin.command: which warp-cli
  register: warp_cli_check
  changed_when: false
  failed_when: false

- name: Fail if warp-cli is not installed
  ansible.builtin.fail:
    msg: "warp-cli not found. Please install Cloudflare WARP client before running this role."
  when: warp_cli_check.rc != 0

- name: Check registration status
  become: yes
  ansible.builtin.command: warp-cli registration show
  register: warp_registration
  changed_when: false
  failed_when: false

- name: Register WARP (if not registered)
  become: yes
  ansible.builtin.command: warp-cli registration new
  when: warp_registration.rc != 0 or (warp_registration.stdout is defined and 'not registered' in warp_registration.stdout | lower)
  notify: restart warp

- name: Apply WARP license (if provided)
  become: yes
  no_log: true
  ansible.builtin.command: warp-cli registration license {{ warp_license_key }}
  when: (warp_license_key | default('')) | length > 0
  register: warp_license_applied
  changed_when: warp_license_applied.rc == 0
  notify: restart warp

- name: Ensure WARP is connected
  become: yes
  ansible.builtin.command: warp-cli connect
  register: warp_connect
  changed_when: "connected" in (warp_connect.stdout | lower) or warp_connect.rc == 0

- name: Get current WARP settings
  become: yes
  ansible.builtin.command: warp-cli settings
  register: warp_settings
  changed_when: false

- name: Set WARP mode
  become: yes
  ansible.builtin.command: warp-cli mode {{ warp_mode }}
  when: warp_settings.stdout is not defined or (warp_mode | lower) not in (warp_settings.stdout | lower)
  notify: restart warp

- name: Verify WARP connectivity via Cloudflare trace
  ansible.builtin.uri:
    url: https://www.cloudflare.com/cdn-cgi/trace/
    method: GET
    return_content: true
    timeout: "{{ warp_verify_timeout }}"
  register: warp_trace

- name: Assert WARP is active (warp=on)
  ansible.builtin.assert:
    that:
      - warp_trace.content is search('warp=on')
    fail_msg: "WARP does not appear to be active (warp=on not found in trace)."
    success_msg: "WARP is active (warp=on)."

- name: Get current excluded hosts
  become: yes
  ansible.builtin.command: warp-cli tunnel host list
  register: warp_excluded_current
  changed_when: false
  failed_when: false

- name: Exclude hosts from WARP
  become: yes
  ansible.builtin.command: warp-cli tunnel host add {{ item }}
  loop: "{{ warp_excluded_hosts }}"
  when: warp_excluded_current.stdout is not defined or (item not in (warp_excluded_current.stdout | default('')))
  register: warp_exclude_add
  changed_when: warp_exclude_add.rc == 0
  notify: restart warp

- name: Restart WARP service after configuration changes
  ansible.builtin.meta: flush_handlers

- name: Show excluded hosts
  become: yes
  ansible.builtin.command: warp-cli tunnel host list
  register: warp_excluded_final
  changed_when: false

- name: Debug final excluded hosts
  ansible.builtin.debug:
    var: warp_excluded_final.stdout

