---
# TrueNAS Scale専用 MinIO移行プレイブック
# Cloudflare Tunnel統合対応（アプライアンス境界尊重）
- name: MinIO Migration to TrueNAS Scale with Cloudflare Tunnel
  hosts: truenas
  become: yes
  gather_facts: yes
  
  vars:
    # 移行設定（TrueNAS専用）
    source_minio_host: "{{ migration_source | default('raspberrypi') }}"
    # appliances インベントリ外のホストでも動作するよう IP解決は直接変数で渡す
    source_minio_address: "{{ source_minio_ip | default(source_minio_host) }}"
    source_minio_port: 9000
    source_minio_alias: "source-minio"
    target_minio_alias: "truenas-tunnel"
    migration_temp_dir: "/tmp/truenas-minio-migration"
    
    # TrueNAS Cloudflare Tunnel設定
    target_minio_endpoint: "https://{{ truenas_minio_domain }}"
    target_platform: "truenas-tunnel"
    
    # 移行するバケット
    buckets_to_migrate:
      - "{{ minio_bucket_name_for_misskey }}"

  tasks:
    - import_tasks: tasks/migrate/00_preamble.yml
      tags: [precheck]

    - import_tasks: tasks/migrate/05_preflight.yml
      tags: [preflight]

    - import_tasks: tasks/migrate/10_aliases_and_buckets.yml
      tags: [aliases, buckets, encryption]

    - import_tasks: tasks/migrate/20_warmup.yml
      tags: [warmup]

    # Optional versioning/ILM and Misskey quiesce removed for simplicity

    - import_tasks: tasks/migrate/40_final_mirror.yml
      tags: [final]

    - import_tasks: tasks/migrate/50_iam_and_cors.yml
      tags: [iam, cors]

    - import_tasks: tasks/migrate/90_verify_and_cleanup.yml
      tags: [verify, cleanup]
