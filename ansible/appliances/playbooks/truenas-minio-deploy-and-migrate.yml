---
# End-to-end: Prepare TrueNAS → Deploy MinIO App → Migrate buckets
- name: "TrueNAS MinIO: Deploy and Migrate"
  hosts: truenas
  become: yes
  gather_facts: yes

  vars:
    # Optional flags for migration safety/perf
    perform_cutover: true
    enable_bucket_versioning: false
    enable_minimal_ilm: false
    mc_workers: 8

  pre_tasks:
    - name: Assert critical variables exist
      assert:
        that:
          - truenas_pool_name is defined
          - truenas_minio_app_name is defined
          - truenas_minio_domain is defined
        fail_msg: "Missing required TrueNAS variables (pool/app/domain). Check host_vars/truenas.yml"

  roles:
    - role: core
      tags: [core]
    - role: apps
      tags: [apps]

  post_tasks:
    - name: Include migration tasks (Raspberry Pi → TrueNAS over Tunnel)
      include_tasks: ../roles/migrate-minio/tasks/main.yml
      tags: [migration]
      when: perform_cutover | bool
