# TrueNAS Scale 25.04 Custom App - MinIO Docker Compose Configuration
# Raspberry Pi MinIO → TrueNAS Scale 移行用

version: '3.8'

services:
  minio:
    image: quay.io/minio/minio:latest
    container_name: {{ truenas_minio_app_name }}
    restart: unless-stopped
    
    # TrueNAS Scale 25.04でのリソース制限
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
    
    # 環境変数（現在のRaspberry Pi設定と同じ）
    environment:
      - MINIO_ROOT_USER={{ minio_root_user }}
      - MINIO_ROOT_PASSWORD={{ minio_root_password }}
      - MINIO_API_CORS_ALLOW_ORIGIN=*
      - MINIO_BROWSER=off
      - MINIO_REGION=ap-northeast-3
      - MINIO_DOMAIN={{ minio_api_server_name }}
      - MINIO_COMPRESS=on
      # KMS暗号化設定（現在の設定を継承）
      - MINIO_KMS_SECRET_KEY={{ minio_kms_master_key }}
      - MINIO_KMS_AUTO_ENCRYPTION=on
    
    # ポート設定
    ports:
      - "{{ truenas_minio_api_port }}:9000"
    
    # ストレージ設定（ZFS dataset直接マウント）
    volumes:
      - {{ truenas_minio_data_path }}:/data:rw
    
    # ヘルスチェック
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 60s
    
    # MinIOサーバー起動コマンド
    command: server /data
    
    # TrueNAS Scale 25.04のネットワーク設定
    networks:
      - truenas_minio_network

# TrueNAS Scale 25.04 ネットワーク設定
networks:
  truenas_minio_network:
    driver: bridge
    name: {{ truenas_minio_app_name }}_network

# 注意事項:
# 1. TrueNAS Scale Web UI → Apps → Discover → "Install via YAML" からこのファイルを使用
# 2. Storage設定で Host Path を選択し、{{ truenas_minio_data_path }} を指定
# 3. 移行前にZFSデータセットを作成: 'zfs create {{ truenas_pool_name }}/minio-data'