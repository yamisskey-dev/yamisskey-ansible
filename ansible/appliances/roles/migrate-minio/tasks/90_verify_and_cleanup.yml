---
- name: Verify migration integrity (zero diff)
  shell: mc diff {{ source_minio_alias }}/{{ item }}/ {{ target_minio_alias }}/{{ item }}/
  loop: "{{ buckets_to_migrate }}"
  environment:
    MC_CONFIG_DIR: "{{ migration_temp_dir }}/.mc"
  register: diff_results
  failed_when: diff_results.rc not in [0,1]
  changed_when: false
  loop_control:
    label: "{{ item }}"

- name: Clean up migration workspace
  file:
    path: "{{ migration_temp_dir }}"
    state: absent

- name: Display migration completion summary
  debug:
    msg: |
      ==============================================
      TrueNAS Cloudflare Tunnel Migration Complete
      ==============================================
      âœ… Source: {{ source_minio_host }} (verified)
      âœ… Target: {{ target_minio_endpoint }} (Cloudflare Tunnel)
      âœ… Buckets migrated: {{ buckets_to_migrate | join(', ') }}
      âœ… IAM policies configured
      âœ… CORS policies applied
      âœ… Encryption enabled (KMS)
      
      ğŸ”§ Misskey Configuration Update:
      S3_ENDPOINT={{ target_minio_endpoint }}
      S3_ACCESS_KEY={{ misskey_s3_access_key | default('define-in-vault') }}
      S3_SECRET_KEY={{ misskey_s3_secret_key | default('define-in-vault') }}
      S3_REGION={{ truenas_minio_region | default('ap-northeast-3') }}
      
      ğŸŒ TrueNAS Scale Cloudflare Tunnel:
      - MinIO API: {{ target_minio_endpoint }}
      - Security: End-to-End TLS + Tunnel Isolation
      - Management: TrueNAS Scale Custom App UI
      - Data Path: {{ truenas_minio_data_path }}
      
      ğŸ“ DNS Configuration:
      {{ truenas_minio_domain }} â†’ Cloudflare Tunnel (Automatic)
      ==============================================

