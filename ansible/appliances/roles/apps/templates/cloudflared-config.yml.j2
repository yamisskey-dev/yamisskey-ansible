# Cloudflared Configuration for TrueNAS Scale MinIO
# Generated by Ansible TrueNAS Apps Role

# Tunnel Protocol
tunnel: {{ truenas_tunnel_id }}
credentials-file: /etc/cloudflared/credentials.json

# Connection Settings
protocol: http2
originRequest:
  disableChunkedEncoding: true
  http2Origin: true
  noHappyEyeballs: true
  connectTimeout: 2s
  keepAliveTimeout: 15s
  
# Ingress Rules
ingress:
{% if truenas_minio_wildcard_domain | default(false) %}
  # Wildcard subdomain routing (bucket.drive.yami.ski)
  - hostname: '*.{{ truenas_minio_domain }}'
    service: http://minio:9000
  - hostname: {{ truenas_minio_domain }}
    service: http://minio:9000
{% else %}
  # Single hostname routing (drive.yami.ski)
  - hostname: {{ truenas_minio_domain }}
    service: http://minio:9000
{% endif %}
  # Default catch-all
  - service: http_status:404

# Logging
logLevel: info
logFile: /var/log/cloudflared.log

# Metrics (optional)
metrics: localhost:2000