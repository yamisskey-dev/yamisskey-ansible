---
- name: System test for migration and infrastructure
  hosts: all
  become: false
  gather_facts: true
  vars:
    test_results: []
    # Test configuration
    required_tools:
      - ansible
      - docker
      - git
    optional_tools:
      - tailscale
      - cloudflared
      - warp-cli
    service_endpoints:
      - { port: "{{ host_services[inventory_hostname].minio_api | default(9000) }}", path: "/minio/health/live", name: "MinIO", required: false }
      - { port: "{{ host_services[inventory_hostname].misskey | default(3000) }}", path: "/api/ping", name: "Misskey", required: false }
      - { port: "{{ host_services[inventory_hostname].prometheus | default(9090) }}", path: "/-/healthy", name: "Prometheus", required: false }
      - { port: "{{ host_services[inventory_hostname].grafana | default(3000) }}", path: "/api/health", name: "Grafana", required: false }

  tasks:
    - name: Test 1 - Basic inventory generation test
      block:
        - name: Check if inventory file exists
          stat:
            path: "{{ ansible_env.PWD }}/ansible/servers/inventory"
          register: inventory_check
          delegate_to: localhost

        - name: Set inventory test result
          set_fact:
            inventory_test: "{{ 'âœ… Pass' if inventory_check.stat.exists else 'âŒ Fail' }}"

        - name: Display inventory test
          debug:
            msg: "ğŸ” Test 1: Inventory file exists - {{ inventory_test }}"

    - name: Test 2 - Tailscale availability
      block:
        - name: Check Tailscale installation
          command: which tailscale
          register: tailscale_installed
          failed_when: false
          changed_when: false

        - name: Get Tailscale status
          command: tailscale status
          register: tailscale_status
          failed_when: false
          changed_when: false
          when: tailscale_installed.rc == 0

        - name: Set Tailscale test result
          set_fact:
            tailscale_test: "{{ 'âœ… Available' if tailscale_installed.rc == 0 else 'âš ï¸ Not installed' }}"

        - name: Display Tailscale test
          debug:
            msg: |
              ğŸ” Test 2: Tailscale availability - {{ tailscale_test }}
              {% if tailscale_installed.rc == 0 and tailscale_status.stdout is defined %}
              ğŸŒ Network status (first 5 lines):
              {{ tailscale_status.stdout_lines[:5] | join('\n') }}
              {% endif %}

    - name: Test 3 - Ansible availability
      block:
        - name: Check Ansible version
          command: ansible --version
          register: ansible_version_check
          failed_when: false
          changed_when: false

        - name: Set Ansible test result
          set_fact:
            ansible_test: "{{ 'âœ… Available' if ansible_version_check.rc == 0 else 'âŒ Not available' }}"

        - name: Display Ansible test
          debug:
            msg: |
              ğŸ” Test 3: Ansible availability - {{ ansible_test }}
              {% if ansible_version_check.rc == 0 %}
              ğŸ¤– Version: {{ ansible_version_check.stdout_lines[0] }}
              {% endif %}

    - name: Test 4 - Docker availability
      block:
        - name: Check Docker installation
          command: docker --version
          register: docker_version
          failed_when: false
          changed_when: false

        - name: Check Docker service status
          systemd:
            name: docker
          register: docker_service
          failed_when: false
          become: true

        - name: Set Docker test result
          set_fact:
            docker_test: "{{ 'âœ… Running' if docker_service.status.ActiveState == 'active' else 'âš ï¸ Not running' }}"

        - name: Display Docker test
          debug:
            msg: |
              ğŸ” Test 4: Docker availability - {{ docker_test }}
              {% if docker_version.rc == 0 %}
              ğŸ³ Version: {{ docker_version.stdout }}
              {% endif %}

    - name: Test 5 - Check migrate role structure
      block:
        - name: Check migrate role directory
          stat:
            path: "{{ ansible_env.PWD }}/ansible/servers/roles/migrate"
          register: migrate_role_check
          delegate_to: localhost

        - name: Check migrate tasks file
          stat:
            path: "{{ ansible_env.PWD }}/ansible/servers/roles/migrate/tasks/main.yml"
          register: migrate_tasks_check
          delegate_to: localhost

        - name: Set migrate role test result
          set_fact:
            migrate_test: "{{ 'âœ… Complete' if migrate_role_check.stat.exists and migrate_tasks_check.stat.exists else 'âš ï¸ Incomplete' }}"

        - name: Display migrate role test
          debug:
            msg: |
              ğŸ” Test 5: Migrate role structure - {{ migrate_test }}
              ğŸ“ Role directory: {{ 'âœ…' if migrate_role_check.stat.exists else 'âŒ' }}
              ğŸ“„ Tasks file: {{ 'âœ…' if migrate_tasks_check.stat.exists else 'âŒ' }}

    - name: Test 6 - Progress monitoring features
      block:
        - name: Check for async/poll patterns in migrate tasks
          shell: |
            if [ -f "{{ ansible_env.PWD }}/ansible/servers/roles/migrate/tasks/main.yml" ]; then
              async_count=$(grep -c "async:" "{{ ansible_env.PWD }}/ansible/servers/roles/migrate/tasks/main.yml" || echo "0")
              poll_count=$(grep -c "poll:" "{{ ansible_env.PWD }}/ansible/servers/roles/migrate/tasks/main.yml" || echo "0")
              echo "async:$async_count,poll:$poll_count"
            else
              echo "async:0,poll:0"
            fi
          register: progress_features
          delegate_to: localhost
          changed_when: false

        - name: Parse progress monitoring results
          set_fact:
            async_enabled: "{{ progress_features.stdout.split(',')[0].split(':')[1] | int > 0 }}"
            poll_enabled: "{{ progress_features.stdout.split(',')[1].split(':')[1] | int > 0 }}"

        - name: Set progress monitoring test result
          set_fact:
            progress_test: "{{ 'âœ… Configured' if async_enabled and poll_enabled else 'âš ï¸ Not configured' }}"

        - name: Display progress monitoring test
          debug:
            msg: |
              ğŸ” Test 6: Progress monitoring features - {{ progress_test }}
              â±ï¸ Async execution: {{ 'âœ…' if async_enabled else 'âš ï¸' }}
              ğŸ“Š Polling intervals: {{ 'âœ…' if poll_enabled else 'âš ï¸' }}

    - name: Test 7 - Service health endpoints
      block:
        - name: Filter endpoints for current host
          set_fact:
            host_endpoints: "{{ service_endpoints | selectattr('port', 'defined') | list }}"
          when: inventory_hostname in host_services

        - name: Test configured service endpoints
          uri:
            url: "http://localhost:{{ item.port }}{{ item.path }}"
            method: "{{ 'POST' if item.name == 'Misskey' else 'GET' }}"
            headers: "{{ {'Content-Type': 'application/json'} if item.name == 'Misskey' else {} }}"
            body: "{{ '{}' if item.name == 'Misskey' else omit }}"
            body_format: "{{ 'json' if item.name == 'Misskey' else omit }}"
            timeout: 5
          register: service_health
          failed_when:
            - service_health.status != 200
            - item.required | default(false)
          loop: "{{ host_endpoints | default([]) }}"
          when:
            - inventory_hostname in host_services
            - item.port != ""

        - name: Display service health results
          debug:
            msg: |
              ğŸ” Test 7: Service health endpoints ({{ inventory_hostname }})
              {% if service_health.results is defined and service_health.results | length > 0 %}
              {% for result in service_health.results %}
              {{ result.item.name }}: {{ 'âœ… OK' if result.status == 200 else ('âŒ Failed' if result.item.required else 'âš ï¸ Unavailable') }}
              {% endfor %}
              {% else %}
              âš ï¸ No services configured for this host or services not running
              {% endif %}

    - name: Calculate test scores
      set_fact:
        passed_tests: >-
          {{
            [
              inventory_test | default('âŒ'),
              tailscale_test | default('âŒ'),
              ansible_test | default('âŒ'),
              docker_test | default('âŒ'),
              migrate_test | default('âŒ'),
              progress_test | default('âŒ')
            ] | select('match', 'âœ….*') | list | length
          }}
        total_tests: 6

    - name: Compile test summary
      set_fact:
        test_summary: |
          ğŸ¯ === System Test Summary for {{ inventory_hostname }} ===

          ğŸ“Š Overall Score: {{ passed_tests }}/{{ total_tests }} tests passed

          ğŸ“‹ Infrastructure Tests:
          - Inventory: {{ inventory_test | default('âŒ Error') }}
          - Tailscale: {{ tailscale_test | default('âŒ Error') }}
          - Ansible: {{ ansible_test | default('âŒ Error') }}
          - Docker: {{ docker_test | default('âŒ Error') }}

          ğŸ”§ Migration System Tests:
          - Migrate Role: {{ migrate_test | default('âŒ Error') }}
          - Progress Monitoring: {{ progress_test | default('âŒ Error') }}

          ğŸ¥ Service Health:
          {% if service_health.results is defined %}
          {% for result in service_health.results %}
          - {{ result.item.name }}: {{ 'âœ… OK' if result.status == 200 else ('âŒ Failed' if result.item.required else 'âš ï¸ Unavailable') }}
          {% endfor %}
          {% else %}
          - No services tested (not configured for this host)
          {% endif %}

          ğŸš€ Available Operations:
          - Repository cloning: ansible-playbook -i inventory playbooks/clone-repos.yml
          - Service operations: ansible-playbook -i inventory playbooks/operations.yml -e op=status
          - System initialization: ansible-playbook -i inventory playbooks/system-init.yml

          ğŸ“Š Legend: âœ… = Pass, âš ï¸ = Warning, âŒ = Fail

          {% if passed_tests | int >= (total_tests | int * 0.8) %}
          ğŸ‰ System is ready for production use!
          {% elif passed_tests | int >= (total_tests | int * 0.5) %}
          âš ï¸ System has some issues but may be functional
          {% else %}
          âŒ System has critical issues that need to be resolved
          {% endif %}

    - name: Display final test summary
      debug:
        msg: "{{ test_summary }}"

    - name: Set overall test result
      set_fact:
        test_passed: "{{ passed_tests | int >= (total_tests | int * 0.8) }}"

    - name: Fail if critical tests failed
      fail:
        msg: "Critical system tests failed. Please resolve issues before proceeding."
      when:
        - not test_passed
        - ansible_test is defined and 'âŒ' in ansible_test
        - docker_test is defined and 'âŒ' in docker_test
