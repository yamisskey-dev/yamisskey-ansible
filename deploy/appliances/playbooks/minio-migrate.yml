---
# MinIO移行専用Playbook
# 責任: MinIOデータ移行のみ（構築は別Playbook）
- name: "MinIO Migration from Servers to TrueNAS"
  hosts: truenas
  become: yes
  gather_facts: yes

  vars:
    # Migration configuration
    source_minio_host: "{{ migration_source | default('raspberrypi') }}"
    source_minio_address: "{{ source_minio_ip | default(source_minio_host) }}"
    source_minio_port: 9000
    source_minio_alias: "source-minio"
    target_minio_alias: "truenas-tunnel"
    target_minio_endpoint: "https://{{ truenas_minio_domain }}"
    migration_temp_dir: "/var/tmp/truenas-minio-migration"
    buckets_to_migrate:
      - "{{ minio_bucket_name_for_misskey | default('files') }}"
      - "{{ minio_bucket_name_for_outline | default('assets') }}"
    # Performance settings
    mc_workers: 8
    perform_incremental_sync: true
    perform_final_remove: false

  pre_tasks:
    - name: Assert migration prerequisites
      assert:
        that:
          - truenas_minio_domain is defined
          - source_minio_host is defined
          - buckets_to_migrate | length > 0
        fail_msg: "Missing required migration variables"

    - name: Display migration plan
      debug:
        msg: |
          ==============================================
          MinIO Migration Plan
          ==============================================
          Source: {{ source_minio_host }} → TrueNAS
          Target: {{ truenas_minio_domain }}
          Buckets: {{ buckets_to_migrate | join(', ') }}
          Method: Cloudflare Tunnel
          ==============================================

  roles:
    - role: yamisskey.appliances.migrate_minio
      tags: [migration, data]

  post_tasks:
    - name: Migration completion summary
      debug:
        msg: |
          ==============================================
          ✅ MinIO Migration Complete
          ==============================================
          Source: {{ source_minio_host }}
          Target: {{ truenas_minio_domain }}
          Buckets: {{ buckets_to_migrate | join(', ') }}

          Next Steps:
          1. Update application configurations (Misskey, Outline)
          2. Test file access via new endpoint
          3. Stop source MinIO service
          4. Update DNS records if needed
          ==============================================
