---
# TrueNAS Scale専用 MinIO移行プレイブック
# Cloudflare Tunnel統合対応（アプライアンス境界尊重）
- name: MinIO Migration to TrueNAS Scale with Cloudflare Tunnel
  hosts: truenas
  become: yes
  gather_facts: yes
  
  vars:
    # 移行設定（TrueNAS専用）
    source_minio_host: "{{ migration_source | default('raspberrypi') }}"
    # appliances インベントリ外のホストでも動作するよう IP解決は直接変数で渡す
    source_minio_address: "{{ source_minio_ip | default(source_minio_host) }}"
    source_minio_port: 9000
    source_minio_alias: "source-minio"
    target_minio_alias: "truenas-tunnel"
    migration_temp_dir: "/tmp/truenas-minio-migration"
    
    # TrueNAS Cloudflare Tunnel設定
    target_minio_endpoint: "https://{{ truenas_minio_domain }}"
    target_platform: "truenas-tunnel"
    
    # 移行するバケット
    buckets_to_migrate: "{{ [minio_bucket_name_for_misskey] if (minio_bucket_name_for_misskey is defined) else [] }}"

  tasks:
    - name: Run full migration sequence via role
      include_role:
        name: migrate-minio
        tasks_from: main.yml
      tags: [migration]
