---
# MinIO フルワークフロー Playbook
# 責任: MinIO構築 → 移行の一連の流れ
- name: "TrueNAS MinIO: Full Deployment and Migration Workflow"
  hosts: truenas
  become: yes
  gather_facts: yes

  vars:
    # Migration configuration
    source_minio_host: "{{ migration_source | default('raspberrypi') }}"
    migration_enabled: "{{ enable_migration | default(true) }}"
    buckets_to_migrate:
      - "{{ minio_bucket_name_for_misskey | default('files') }}"
      - "{{ minio_bucket_name_for_outline | default('assets') }}"

  pre_tasks:
    - name: Assert critical variables exist
      assert:
        that:
          - truenas_pool_name is defined
          - truenas_minio_app_name is defined
          - truenas_minio_domain is defined
          - truenas_minio_root_user is defined
          - truenas_minio_root_password is defined
          - truenas_tunnel_token is defined
        fail_msg: "Missing required TrueNAS variables. Check host_vars/truenas.yml"

    - name: Display workflow plan
      debug:
        msg: |
          ==============================================
          MinIO Full Workflow Plan
          ==============================================
          Phase 1: TrueNAS infrastructure setup
          Phase 2: MinIO deployment
          Phase 3: Data migration ({{ 'enabled' if migration_enabled else 'disabled' }})

          Target: {{ truenas_minio_domain }}
          Source: {{ source_minio_host if migration_enabled else 'N/A' }}
          ==============================================

  roles:
    # Phase 1: Infrastructure
    - role: yamisskey.appliances.core
      tags: [core, infrastructure, phase1]

    # Phase 2: MinIO Deployment
    - role: yamisskey.appliances.minio
      tags: [minio, deployment, phase2]

  tasks:
    # Phase 3: Migration (conditional)
    - name: Include migration tasks
      include_role:
        name: yamisskey.appliances.migrate_minio
      when: migration_enabled | bool
      tags: [migration, data, phase3]

  post_tasks:
    - name: Full workflow completion
      debug:
        msg: |
          ==============================================
          ✅ MinIO Full Workflow Complete
          ==============================================
          Phase 1: ✅ Infrastructure setup
          Phase 2: ✅ MinIO deployment
          Phase 3: {{ '✅ Data migration' if migration_enabled else '⏭️ Migration skipped' }}

          Result:
          - MinIO URL: https://{{ truenas_minio_domain }}
          - App Name: {{ truenas_minio_app_name }}
          - Status: Ready for production

          Usage Examples:
          # Deploy only (no migration)
          ansible-playbook minio-full.yml -e "enable_migration=false"

          # Deploy and migrate from specific source
          ansible-playbook minio-full.yml -e "migration_source=balthasar"
          ==============================================
