---
- name: Deploy Misskey Proxy Services
  hosts: linode_prox
  become: true
  gather_facts: true
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    docker_compose_cmd: 'docker compose'
    
  roles:
    - role: yamisskey.servers.common
      tags: [common, base]
      
    - role: yamisskey.servers.security
      tags: [security, hardening]
      
    - role: yamisskey.servers.misskey-proxy
      tags: [proxy, nginx]
      
    - role: yamisskey.servers.monitoring
      tags: [monitoring, observability]
      when: "enable_monitoring | default(false) | bool"
      
  post_tasks:
    - name: Display proxy deployment summary
      debug:
        msg: |
          ğŸŒ Misskey Proxy Services Deployment Complete!
          
          ğŸ“¦ Deployed Services:
          - âœ… Base system configuration and security
          - âœ… Squid proxy on port {{ squid_port | default(3128) }}
          - âœ… Media proxy (media-proxy-rs) on port 12766
          - âœ… Nginx reverse proxy on port 80
          - âœ… Summaly service via docker compose
          
          ğŸ”§ Service Management:
          - Check status: docker ps
          - Squid status: systemctl status squid
          - Nginx status: systemctl status nginx
          - View logs: docker compose logs -f
          
          ğŸ¯ yamisskey.servers Collection - Proxy Ready!
