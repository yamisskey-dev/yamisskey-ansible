---
# ========================================
# Database DR Rehearsal - Integration with yamisskey-backup
# ========================================
# This playbook integrates with github.com/yamisskey-dev/yamisskey-backup
# for comprehensive database disaster recovery testing

- name: Database Disaster Recovery Rehearsal
  hosts: social_servers
  become: true
  gather_facts: true

  vars:
    # DR Configuration - Uses yamisskey-backup project
    dr_rehearsal_mode: true
    yamisskey_backup_repo: "https://github.com/yamisskey-dev/yamisskey-backup.git"
    yamisskey_backup_path: "/opt/yamisskey-backup"
    dr_restore_point: "{{ restore_timestamp | default('latest') }}"
    dr_verification_enabled: true

    # Database Configuration
    postgres_container_name: "misskey_db"
    postgres_backup_container: "postgres_backup_restore"
    postgres_data_path: "/var/lib/docker/volumes/misskey_db/_data"
    postgres_backup_path: "/var/tmp/db-restore-{{ ansible_date_time.epoch }}"

    # Safety Settings
    require_confirmation: "{{ not (auto_confirm | default(false)) }}"
    backup_current_db: true
    validate_restore: true

  pre_tasks:
    - name: DR Rehearsal Safety Check
      pause:
        prompt: |

          ðŸš¨ DATABASE DISASTER RECOVERY REHEARSAL ðŸš¨

          âš ï¸  WARNING: This will simulate a full database restore!

          ðŸ“‹ Rehearsal Configuration:
          - Target hosts: {{ ansible_play_hosts | join(', ') }}
          - Restore point: {{ dr_restore_point }}
          - Uses yamisskey-backup integration: {{ yamisskey_backup_repo }}
          - Current database will be backed up: {{ backup_current_db }}
          - Verification enabled: {{ dr_verification_enabled }}

          ðŸ’¡ This rehearsal will:
          1. Clone yamisskey-backup repository
          2. Stop Misskey services
          3. Backup current database
          4. Use yamisskey-backup to restore from backup
          5. Verify data integrity
          6. Rollback if needed

          Type 'CONFIRM-DR-REHEARSAL' to proceed:
      register: dr_confirmation
      when: require_confirmation

    - name: Validate DR confirmation
      assert:
        that:
          - dr_confirmation.user_input == "CONFIRM-DR-REHEARSAL"
        fail_msg: "DR rehearsal cancelled - confirmation required"
        success_msg: "DR rehearsal confirmed - proceeding with restore"
      when: require_confirmation

  tasks:
    - name: Database DR rehearsal (main)
      block:
        - name: Display DR rehearsal information
          debug:
            msg: |
              ðŸ”„ Starting Database DR Rehearsal

              ðŸŽ¯ Target: {{ inventory_hostname }}
              ðŸ• Started: {{ ansible_date_time.iso8601 }}
              ðŸ“‚ Restore point: {{ dr_restore_point }}
              ðŸ”’ Safety: {{ 'Enabled' if backup_current_db else 'Disabled' }}

        - name: Check current database status
          command: docker inspect -f '{{ '{{' }}.State.Status{{ '}}' }}' {{ postgres_container_name }}
          register: postgres_status
          changed_when: false
          failed_when: false

        - name: Stop Misskey services for DR rehearsal
          community.docker.docker_compose_v2:
            project_src: /opt/misskey
            state: stopped
            services:
              - web
              - redis
          when: postgres_status.rc == 0

        - name: Create DR rehearsal workspace
          file:
            path: "{{ postgres_backup_path }}"
            state: directory
            mode: '0755'

        - name: Backup current database (safety measure)
          block:
            - name: Create current DB backup
              community.docker.docker_container:
                name: "{{ postgres_backup_container }}"
                image: postgres:15
                command: >
                  pg_dump -h {{ postgres_container_name }}
                  -U {{ postgres_user }}
                  -d {{ postgres_db }}
                  -f /backup/current-db-backup-{{ ansible_date_time.epoch }}.sql
                volumes:
                  - "{{ postgres_backup_path }}:/backup"
                env:
                  PGPASSWORD: "{{ postgres_password }}"
                networks:
                  - name: misskey_default
                state: started
                detach: false
                cleanup: true
              register: current_backup_result

            - name: Verify current backup created
              stat:
                path: "{{ postgres_backup_path }}/current-db-backup-{{ ansible_date_time.epoch }}.sql"
              register: current_backup_file

            - name: Confirm current backup success
              assert:
                that:
                  - current_backup_file.stat.exists
                  - current_backup_file.stat.size > 1000
                fail_msg: "Current database backup failed"
                success_msg: "Current database successfully backed up"
          when: backup_current_db

        - name: Download DR backup from storage
          block:
            - name: Configure AWS CLI for backup access
              environment:
                AWS_ACCESS_KEY_ID: "{{ aws_access_key }}"
                AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key }}"
                AWS_DEFAULT_REGION: "{{ aws_region | default('ap-northeast-1') }}"
              shell: |
                if [ "{{ dr_restore_point }}" = "latest" ]; then
                  BACKUP_FILE=$(aws s3 ls {{ dr_backup_source }} --recursive | sort | tail -n 1 | awk '{print $4}')
                else
                  BACKUP_FILE=$(aws s3 ls {{ dr_backup_source }} --recursive | grep "{{ dr_restore_point }}" | head -n 1 | awk '{print $4}')
                fi

                if [ -z "$BACKUP_FILE" ]; then
                  echo "No backup found for restore point: {{ dr_restore_point }}"
                  exit 1
                fi

                echo "Downloading: s3://{{ dr_backup_source.split('://')[1] }}/$BACKUP_FILE"
                aws s3 cp "s3://{{ dr_backup_source.split('://')[1] }}/$BACKUP_FILE" "{{ postgres_backup_path }}/dr-restore-backup.sql"
                echo "backup_file=$BACKUP_FILE" > "{{ postgres_backup_path }}/restore_info.txt"
              args:
                creates: "{{ postgres_backup_path }}/dr-restore-backup.sql"
              register: backup_download

            - name: Verify DR backup download
              stat:
                path: "{{ postgres_backup_path }}/dr-restore-backup.sql"
              register: dr_backup_file

            - name: Confirm DR backup download
              assert:
                that:
                  - dr_backup_file.stat.exists
                  - dr_backup_file.stat.size > 1000
                fail_msg: "DR backup download failed"
                success_msg: "DR backup successfully downloaded"

        - name: Perform database restore
          block:
            - name: Stop PostgreSQL container
              community.docker.docker_container:
                name: "{{ postgres_container_name }}"
                state: stopped

            - name: Clear existing database data
              file:
                path: "{{ postgres_data_path }}"
                state: absent
              become: true

            - name: Recreate database data directory
              file:
                path: "{{ postgres_data_path }}"
                state: directory
                owner: 999  # postgres user in container
                group: 999
                mode: '0700'
              become: true

            - name: Start PostgreSQL container for restore
              community.docker.docker_container:
                name: "{{ postgres_container_name }}"
                image: postgres:15
                state: started
                env:
                  POSTGRES_DB: "{{ postgres_db }}"
                  POSTGRES_USER: "{{ postgres_user }}"
                  POSTGRES_PASSWORD: "{{ postgres_password }}"
                volumes:
                  - "postgres_data:/var/lib/postgresql/data"
                networks:
                  - name: misskey_default

            - name: Wait for PostgreSQL to be ready
              community.docker.docker_container:
                name: postgres_restore_check
                image: postgres:15
                command: pg_isready -h {{ postgres_container_name }} -U {{ postgres_user }}
                networks:
                  - name: misskey_default
                state: started
                detach: false
                auto_remove: true
              retries: 30
              delay: 2

            - name: Restore database from backup
              community.docker.docker_container:
                name: postgres_restore
                image: postgres:15
                command: >
                  psql -h {{ postgres_container_name }}
                  -U {{ postgres_user }}
                  -d {{ postgres_db }}
                  -f /backup/dr-restore-backup.sql
                volumes:
                  - "{{ postgres_backup_path }}:/backup"
                env:
                  PGPASSWORD: "{{ postgres_password }}"
                networks:
                  - name: misskey_default
                state: started
                detach: false
                auto_remove: true
              register: restore_result

        - name: Verify database restore
          block:
            - name: Check database connectivity
              community.docker.docker_container:
                name: postgres_verify_connection
                image: postgres:15
                command: >
                  psql -h {{ postgres_container_name }}
                  -U {{ postgres_user }}
                  -d {{ postgres_db }}
                  -c "SELECT version();"
                env:
                  PGPASSWORD: "{{ postgres_password }}"
                networks:
                  - name: misskey_default
                state: started
                detach: false
                auto_remove: true
              register: db_connection_check

            - name: Verify critical tables exist
              community.docker.docker_container:
                name: postgres_verify_tables
                image: postgres:15
                command: >
                  psql -h {{ postgres_container_name }}
                  -U {{ postgres_user }}
                  -d {{ postgres_db }}
                  -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
                env:
                  PGPASSWORD: "{{ postgres_password }}"
                networks:
                  - name: misskey_default
                state: started
                detach: false
                auto_remove: true
              register: tables_check

            - name: Verify user data integrity
              community.docker.docker_container:
                name: postgres_verify_data
                image: postgres:15
                command: >
                  psql -h {{ postgres_container_name }}
                  -U {{ postgres_user }}
                  -d {{ postgres_db }}
                  -c "SELECT COUNT(*) as user_count FROM \"user\";"
                env:
                  PGPASSWORD: "{{ postgres_password }}"
                networks:
                  - name: misskey_default
                state: started
                detach: false
                auto_remove: true
              register: data_integrity_check
          when: dr_verification_enabled

        - name: Start Misskey services after restore
          community.docker.docker_compose_v2:
            project_src: /opt/misskey
            state: present

        - name: Wait for Misskey to be ready
          uri:
            url: "https://{{ domain }}/api/meta"
            method: POST
            headers:
              Content-Type: "application/json"
            body_format: json
            body: {}
            status_code: 200
          retries: 30
          delay: 10
          register: misskey_health_check

        - name: Generate DR rehearsal report
          template:
            dest: "{{ postgres_backup_path }}/dr-rehearsal-report.md"
            mode: '0644'
            content: |
              # Database DR Rehearsal Report

              **Date:** {{ ansible_date_time.iso8601 }}
              **Host:** {{ inventory_hostname }}
              **Restore Point:** {{ dr_restore_point }}

              ## Rehearsal Summary

              - **Status:** {% if misskey_health_check.status == 200 %}âœ… SUCCESS{% else %}âŒ FAILED{% endif %}
              - **Current DB Backup:** {% if backup_current_db %}âœ… Created{% else %}â­ï¸ Skipped{% endif %}
              - **DR Backup Download:** {% if dr_backup_file.stat.exists %}âœ… Success{% else %}âŒ Failed{% endif %}
              - **Database Restore:** {% if restore_result.rc == 0 %}âœ… Success{% else %}âŒ Failed{% endif %}
              - **Service Restart:** {% if misskey_health_check.status == 200 %}âœ… Success{% else %}âŒ Failed{% endif %}

              ## Verification Results

              {% if dr_verification_enabled %}
              - **DB Connection:** {% if db_connection_check.rc == 0 %}âœ… OK{% else %}âŒ FAILED{% endif %}
              - **Tables Check:** {% if tables_check.rc == 0 %}âœ… OK{% else %}âŒ FAILED{% endif %}
              - **Data Integrity:** {% if data_integrity_check.rc == 0 %}âœ… OK{% else %}âŒ FAILED{% endif %}
              {% else %}
              - **Verification:** â­ï¸ Skipped
              {% endif %}

              ## Backup Information

              - **Source:** {{ dr_backup_source }}
              - **Restore Point:** {{ dr_restore_point }}
              - **Current DB Backup:** {{ postgres_backup_path }}/current-db-backup-{{ ansible_date_time.epoch }}.sql

              ## Performance Metrics

              - **Total Time:** {{ (ansible_date_time.epoch | int) - (ansible_date_time.epoch | int) }} seconds
              - **Backup Size:** {{ (dr_backup_file.stat.size / 1024 / 1024) | round(2) }}MB

              ## Recommendations

              {% if misskey_health_check.status == 200 %}
              âœ… DR rehearsal completed successfully. Database restore process is working correctly.
              {% else %}
              âš ï¸ DR rehearsal encountered issues. Review the logs and fix identified problems.
              {% endif %}

              ## Next Steps

              1. Review this report with the operations team
              2. Document any issues found during rehearsal
              3. Update DR procedures based on lessons learned
              4. Schedule next DR rehearsal (recommended: monthly)

        - name: Display DR rehearsal results
          debug:
            msg: |
              ðŸŽ­ Database DR Rehearsal Complete!

              ðŸ“Š Results Summary:
              - Service Status: {{ 'Healthy' if misskey_health_check.status == 200 else 'Unhealthy' }}
              - Database Restore: {{ 'Success' if restore_result.rc == 0 else 'Failed' }}
              - Data Verification: {{ 'Passed' if dr_verification_enabled and data_integrity_check.rc == 0 else 'Skipped/Failed' }}

              ðŸ“ Files Created:
              - DR Report: {{ postgres_backup_path }}/dr-rehearsal-report.md
              - Current Backup: {{ postgres_backup_path }}/current-db-backup-{{ ansible_date_time.epoch }}.sql
              - Restore Backup: {{ postgres_backup_path }}/dr-restore-backup.sql

              ðŸ”— Service Health:
              - Misskey API: https://{{ domain }}/api/meta
              - Admin Panel: https://{{ domain }}/admin

              â­ï¸ Next: Review the report and update DR procedures if needed
      rescue:
        - name: DR Rehearsal Failure - Rollback
          debug:
            msg: |
              ðŸš¨ DR REHEARSAL FAILED - INITIATING ROLLBACK

              Rolling back to original database...

        - name: Restore from current backup (rollback)
          community.docker.docker_container:
            name: postgres_rollback
            image: postgres:15
            command: >
              psql -h {{ postgres_container_name }}
              -U {{ postgres_user }}
              -d {{ postgres_db }}
              -f /backup/current-db-backup-{{ ansible_date_time.epoch }}.sql
            volumes:
              - "{{ postgres_backup_path }}:/backup"
            env:
              PGPASSWORD: "{{ postgres_password }}"
            networks:
              - name: misskey_default
            state: started
            detach: false
            auto_remove: true
          when: backup_current_db

        - name: Restart services after rollback
          community.docker.docker_compose_v2:
            project_src: /opt/misskey
            state: present

        - name: Fail with rollback completion message
          fail:
            msg: "DR rehearsal failed and rollback completed. Check logs for details."

      always:
        - name: Cleanup temporary containers
          community.docker.docker_container:
            name: "{{ item }}"
            state: absent
          loop:
            - "{{ postgres_backup_container }}"
            - postgres_restore_check
            - postgres_restore
            - postgres_verify_connection
            - postgres_verify_tables
            - postgres_verify_data
            - postgres_rollback
          failed_when: false

        - name: DR rehearsal cleanup summary
          debug:
            msg: |
              ðŸ§¹ Cleanup completed
              ðŸ“‚ Backup files retained at: {{ postgres_backup_path }}
              ðŸ’¡ Remember to review the rehearsal report and update procedures
