---
# Molecule verify playbook for common role testing
- name: Verify - Test common role functionality
  hosts: all
  gather_facts: true
  become: true
  tasks:
    - name: Check if system packages are installed
      package_facts:
        manager: auto
        
    - name: Verify essential packages are present
      assert:
        that:
          - "'curl' in ansible_facts.packages"
          - "'wget' in ansible_facts.packages"
          - "'gnupg' in ansible_facts.packages"
        fail_msg: "Essential packages are not installed"
        success_msg: "Essential packages verified"

    - name: Check timezone configuration
      command: timedatectl show --property=Timezone --value
      register: current_timezone
      changed_when: false
      
    - name: Verify timezone is set
      assert:
        that:
          - current_timezone.stdout != ""
          - current_timezone.stdout != "n/a"
        fail_msg: "Timezone is not properly configured"
        success_msg: "Timezone configuration verified"

    - name: Check systemd-timesyncd service
      systemd:
        name: systemd-timesyncd
        state: started
      check_mode: true
      register: timesyncd_service
      
    - name: Verify time synchronization
      assert:
        that:
          - not timesyncd_service.changed
        fail_msg: "systemd-timesyncd service is not running"
        success_msg: "Time synchronization verified"

    - name: Check unattended-upgrades configuration (Debian/Ubuntu)
      stat:
        path: /etc/apt/apt.conf.d/20auto-upgrades
      register: auto_upgrades_stat
      when: ansible_os_family == "Debian"
      
    - name: Verify auto-upgrades configuration (Debian/Ubuntu)
      assert:
        that:
          - auto_upgrades_stat.stat.exists
        fail_msg: "Auto-upgrades configuration not found"
        success_msg: "Auto-upgrades configuration verified"
      when: ansible_os_family == "Debian"

    - name: Check system locale
      command: localectl status
      register: locale_status
      changed_when: false
      
    - name: Verify locale is configured
      assert:
        that:
          - "'LANG=' in locale_status.stdout"
        fail_msg: "System locale is not properly configured"
        success_msg: "System locale verified"

    - name: Test network connectivity
      uri:
        url: https://www.google.com
        method: HEAD
        timeout: 10
      register: connectivity_test
      failed_when: false
      
    - name: Verify network connectivity
      assert:
        that:
          - connectivity_test.status == 200
        fail_msg: "Network connectivity test failed"
        success_msg: "Network connectivity verified"

    - name: Check if Python is properly installed
      command: "{{ ansible_python_interpreter | default('python3') }} --version"
      register: python_version
      changed_when: false
      
    - name: Verify Python installation
      assert:
        that:
          - python_version.rc == 0
          - "'Python 3.' in python_version.stdout"
        fail_msg: "Python 3 is not properly installed"
        success_msg: "Python installation verified"

    - name: Summary of verification results
      debug:
        msg:
          - "✅ Common role verification completed successfully"
          - "✅ Essential packages installed"
          - "✅ Timezone configured: {{ current_timezone.stdout }}"
          - "✅ Time synchronization active"
          - "✅ Network connectivity working"
          - "✅ Python {{ python_version.stdout.split()[1] }} available"